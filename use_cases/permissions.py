"""
Use-case: –ø—Ä–∞–≤–∞ –¥–æ—Å—Ç—É–ø–∞ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤ (–∏–∑ Google –¢–∞–±–ª–∏—Ü—ã).

–§–æ—Ä–º–∞—Ç –ª–∏—Å—Ç–∞ ¬´–ü—Ä–∞–≤–∞ –¥–æ—Å—Ç—É–ø–∞¬ª:
  –°—Ç—Ä–æ–∫–∞ 1 (–º–µ—Ç–∞, —Å–∫—Ä—ã—Ç–∞—è):  "", telegram_id, perm_key_1, perm_key_2, ...
  –°—Ç—Ä–æ–∫–∞ 2 (–∑–∞–≥–æ–ª–æ–≤–∫–∏):      "–°–æ—Ç—Ä—É–¥–Ω–∏–∫", "Telegram ID", "üìù –°–ø–∏—Å–∞–Ω–∏—è", "üì¶ –ù–∞–∫–ª–∞–¥–Ω—ã–µ", ...
  –°—Ç—Ä–æ–∫–∞ 3+:                 "–ò–≤–∞–Ω–æ–≤", 123456789, "‚úÖ", "", "‚úÖ", ...

–ü–æ—Ç–æ–∫:
  1. –ü—Ä–∏ –∫–∞–∂–¥–æ–º –∑–∞–ø—Ä–æ—Å–µ ‚Üí –ø—Ä–æ–≤–µ—Ä–∫–∞ –ø—Ä–∞–≤ –∏–∑ in-memory –∫–µ—à–∞ (TTL 5 –º–∏–Ω)
  2. –ü—Ä–æ–º–∞—Ö –∫–µ—à–∞ ‚Üí —á—Ç–µ–Ω–∏–µ –≤—Å–µ–≥–æ –ª–∏—Å—Ç–∞ –∏–∑ Google –¢–∞–±–ª–∏—Ü—ã (read_permissions_sheet)
  3. –ö–Ω–æ–ø–∫–∞ ¬´üîë –ü—Ä–∞–≤–∞ ‚Üí GSheet¬ª (admin) ‚Äî –≤—ã–≥—Ä—É–∑–∫–∞ –Ω–æ–≤—ã—Ö —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤/–∫–Ω–æ–ø–æ–∫
     —Å —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ–º —Å—É—â–µ—Å—Ç–≤—É—é—â–∏—Ö ‚úÖ/‚ùå

–ö–ª—é—á–∏ –ø—Ä–∞–≤ (perm_key) —Å–æ–≤–ø–∞–¥–∞—é—Ç —Å —Ç–µ–∫—Å—Ç–æ–º –∫–Ω–æ–ø–æ–∫ –±–æ—Ç–∞:
  üìù –°–ø–∏—Å–∞–Ω–∏—è, üì¶ –ù–∞–∫–ª–∞–¥–Ω—ã–µ, üìã –ó–∞—è–≤–∫–∏, üìä –û—Ç—á—ë—Ç—ã, ‚öôÔ∏è –ù–∞—Å—Ç—Ä–æ–π–∫–∏

–ê–¥–º–∏–Ω—ã –≤—Å–µ–≥–¥–∞ –∏–º–µ—é—Ç –í–°–ï –ø—Ä–∞–≤–∞ (bypass).
"""

import asyncio
import logging
import time
from typing import Any

from adapters import google_sheets as gsheet
from use_cases import admin as admin_uc

logger = logging.getLogger(__name__)

LABEL = "Permissions"

# ‚îÄ‚îÄ‚îÄ –ö–∞–∫–∏–µ –∫–Ω–æ–ø–∫–∏ –∫–æ–Ω—Ç—Ä–æ–ª–∏—Ä—É—é—Ç—Å—è –ø—Ä–∞–≤–∞–º–∏ ‚îÄ‚îÄ‚îÄ
# –ü–æ—Ä—è–¥–æ–∫ = –ø–æ—Ä—è–¥–æ–∫ —Å—Ç–æ–ª–±—Ü–æ–≤ –≤ Google –¢–∞–±–ª–∏—Ü–µ
PERMISSION_KEYS: list[str] = [
    "üìù –°–ø–∏—Å–∞–Ω–∏—è",
    "üì¶ –ù–∞–∫–ª–∞–¥–Ω—ã–µ",
    "üìã –ó–∞—è–≤–∫–∏",
    "üìä –û—Ç—á—ë—Ç—ã",
    "‚öôÔ∏è –ù–∞—Å—Ç—Ä–æ–π–∫–∏",
]

# –ó–Ω–∞—á–µ–Ω–∏—è –≤ —è—á–µ–π–∫–µ, –∫–æ—Ç–æ—Ä—ã–µ –æ–∑–Ω–∞—á–∞—é—Ç ¬´—Ä–∞–∑—Ä–µ—à–µ–Ω–æ¬ª
_TRUTHY = {"‚úÖ", "1", "–¥–∞", "yes", "true", "+"}

# ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
# In-memory –∫–µ—à –ø—Ä–∞–≤ (TTL 5 –º–∏–Ω)
# ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

_CACHE_TTL: float = 5 * 60  # 5 –º–∏–Ω—É—Ç

# {telegram_id: {perm_key: bool}}
_perms_cache: dict[int, dict[str, bool]] | None = None
_perms_cache_ts: float = 0.0


def _is_cache_valid() -> bool:
    return _perms_cache is not None and (time.monotonic() - _perms_cache_ts) < _CACHE_TTL


def invalidate_cache() -> None:
    """–ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ —Å–±—Ä–æ—Å–∏—Ç—å –∫–µ—à –ø—Ä–∞–≤ (–≤—ã–∑—ã–≤–∞–µ—Ç—Å—è –ø–æ—Å–ª–µ sync)."""
    global _perms_cache, _perms_cache_ts
    _perms_cache = None
    _perms_cache_ts = 0.0
    logger.info("[%s] –ö–µ—à –ø—Ä–∞–≤ –∏–Ω–≤–∞–ª–∏–¥–∏—Ä–æ–≤–∞–Ω", LABEL)


async def _ensure_cache() -> dict[int, dict[str, bool]]:
    """–ó–∞–≥—Ä—É–∑–∏—Ç—å –º–∞—Ç—Ä–∏—Ü—É –ø—Ä–∞–≤ –∏–∑ GSheet –µ—Å–ª–∏ –∫–µ—à —É—Å—Ç–∞—Ä–µ–ª."""
    global _perms_cache, _perms_cache_ts
    if _is_cache_valid():
        return _perms_cache  # type: ignore

    t0 = time.monotonic()
    try:
        raw = await gsheet.read_permissions_sheet()
        # raw = [{telegram_id: int, perms: {key: bool, ...}}, ...]
        new_cache: dict[int, dict[str, bool]] = {}
        for entry in raw:
            tg_id = entry.get("telegram_id")
            if tg_id:
                new_cache[tg_id] = entry.get("perms", {})

        _perms_cache = new_cache
        _perms_cache_ts = time.monotonic()
        logger.info(
            "[%s] –ö–µ—à –æ–±–Ω–æ–≤–ª—ë–Ω: %d –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –∑–∞ %.2f —Å–µ–∫",
            LABEL, len(new_cache), time.monotonic() - t0,
        )
        return new_cache
    except Exception:
        logger.exception("[%s] –û—à–∏–±–∫–∞ —á—Ç–µ–Ω–∏—è –ø—Ä–∞–≤ –∏–∑ GSheet", LABEL)
        # –ï—Å–ª–∏ –∫–µ—à –±—ã–ª ‚Äî –∏—Å–ø–æ–ª—å–∑—É–µ–º —Å—Ç–∞—Ä—ã–π (graceful degradation)
        if _perms_cache is not None:
            logger.warning("[%s] –ò—Å–ø–æ–ª—å–∑—É–µ–º —É—Å—Ç–∞—Ä–µ–≤—à–∏–π –∫–µ—à (%d –∑–∞–ø–∏—Å–µ–π)", LABEL, len(_perms_cache))
            return _perms_cache
        # –ï—Å–ª–∏ –∫–µ—à–∞ –≤–æ–æ–±—â–µ –Ω–µ –±—ã–ª–æ ‚Äî –ø—É—Å—Ç–æ–π dict (–Ω–∏—á–µ–≥–æ –Ω–µ —Ä–∞–∑—Ä–µ—à–µ–Ω–æ)
        return {}


# ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
# –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø—Ä–∞–≤
# ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

async def has_permission(telegram_id: int, perm_key: str) -> bool:
    """
    –ü—Ä–æ–≤–µ—Ä–∏—Ç—å, –µ—Å—Ç—å –ª–∏ —É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –ø—Ä–∞–≤–æ –Ω–∞ –∫–Ω–æ–ø–∫—É.

    –ê–¥–º–∏–Ω—ã –∏–º–µ—é—Ç –í–°–ï –ø—Ä–∞–≤–∞ (bypass).
    –ï—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –Ω–µ—Ç –≤ —Ç–∞–±–ª–∏—Ü–µ ‚Üí –Ω–µ—Ç –ø—Ä–∞–≤.
    """
    # –ê–¥–º–∏–Ω = –≤—Å—ë —Ä–∞–∑—Ä–µ—à–µ–Ω–æ
    if await admin_uc.is_admin(telegram_id):
        return True

    cache = await _ensure_cache()
    user_perms = cache.get(telegram_id)
    if user_perms is None:
        # –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –Ω–µ—Ç –≤ —Ç–∞–±–ª–∏—Ü–µ –ø—Ä–∞–≤ ‚Üí –Ω–µ—Ç –¥–æ—Å—Ç—É–ø–∞
        return False
    return user_perms.get(perm_key, False)


async def get_allowed_keys(telegram_id: int) -> set[str]:
    """
    –ü–æ–ª—É—á–∏—Ç—å –º–Ω–æ–∂–µ—Å—Ç–≤–æ —Ä–∞–∑—Ä–µ—à—ë–Ω–Ω—ã—Ö perm_key –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è.
    –ê–¥–º–∏–Ω—ã ‚Üí –≤—Å–µ –∫–ª—é—á–∏.
    """
    if await admin_uc.is_admin(telegram_id):
        return set(PERMISSION_KEYS)

    cache = await _ensure_cache()
    user_perms = cache.get(telegram_id)
    if user_perms is None:
        return set()
    return {k for k, v in user_perms.items() if v}


# ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
# –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è: —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∏ + –∫–Ω–æ–ø–∫–∏ ‚Üí GSheet
# (–∑–∞—â–∏—Ç–∞ –æ—Ç ¬´–¥—É—Ä–∞–∫–∞¬ª ‚Äî –Ω–µ —Å—Ç–∏—Ä–∞–µ—Ç –ø—Ä–∞–≤–∞, –Ω–µ —É–¥–∞–ª—è–µ—Ç —Å—Ç—Ä–æ–∫–∏)
# ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

async def sync_permissions_to_gsheet(triggered_by: str | None = None) -> int:
    """
    –í—ã–≥—Ä—É–∑–∏—Ç—å –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω–Ω—ã—Ö —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤ –∏ –∫–Ω–æ–ø–∫–∏ –≤ Google –¢–∞–±–ª–∏—Ü—É.

    - –î–æ–±–∞–≤–ª—è–µ—Ç –Ω–æ–≤—ã—Ö —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤ (—Å –ø—É—Å—Ç—ã–º–∏ –ø—Ä–∞–≤–∞–º–∏)
    - –î–æ–±–∞–≤–ª—è–µ—Ç –Ω–æ–≤—ã–µ —Å—Ç–æ–ª–±—Ü—ã –∫–Ω–æ–ø–æ–∫ (–µ—Å–ª–∏ PERMISSION_KEYS —Ä–∞—Å—à–∏—Ä–∏–ª—Å—è)
    - –ù–ï —É–¥–∞–ª—è–µ—Ç —Å—Ç—Ä–æ–∫–∏ ‚Äî –¥–∞–∂–µ –µ—Å–ª–∏ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫ —É–≤–æ–ª–∏–ª—Å—è
    - –ù–ï —Å—Ç–∏—Ä–∞–µ—Ç —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ ‚úÖ/‚ùå
    - –°–æ—Ä—Ç–∏—Ä—É–µ—Ç —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤ –ø–æ —Ñ–∞–º–∏–ª–∏–∏

    –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç –∫–æ–ª-–≤–æ —Å—Ç—Ä–æ–∫ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤.
    """
    t0 = time.monotonic()
    logger.info("[%s] –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è –ø—Ä–∞–≤ ‚Üí GSheet (by=%s)...", LABEL, triggered_by)

    # 1. –ü–æ–ª—É—á–∏—Ç—å –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω–Ω—ã—Ö —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤ –∏–∑ –ë–î
    employees = await admin_uc.get_employees_with_telegram()
    # [{id, name, last_name, first_name, telegram_id}, ...]

    emp_list = [
        {"name": e["name"], "telegram_id": e["telegram_id"]}
        for e in employees
        if e.get("telegram_id")
    ]

    # 2. –ó–∞–ø–∏—Å–∞—Ç—å –≤ GSheet (–∞–¥–∞–ø—Ç–µ—Ä —Å–∞–º –æ–±–µ—Å–ø–µ—á–∏–≤–∞–µ—Ç merge)
    count = await gsheet.sync_permissions_to_sheet(
        employees=emp_list,
        permission_keys=PERMISSION_KEYS,
    )

    # 3. –ò–Ω–≤–∞–ª–∏–¥–∏—Ä–æ–≤–∞—Ç—å –∫–µ—à —á—Ç–æ–±—ã –ø—Ä–∏ —Å–ª–µ–¥—É—é—â–µ–º –∑–∞–ø—Ä–æ—Å–µ –ø–æ–¥—Ç—è–Ω—É–ª–∏—Å—å —Å–≤–µ–∂–∏–µ –¥–∞–Ω–Ω—ã–µ
    invalidate_cache()

    elapsed = time.monotonic() - t0
    logger.info("[%s] ‚Üí GSheet: %d —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤ –∑–∞ %.1f —Å–µ–∫", LABEL, count, elapsed)
    return count
