# üóÇ –ö–∞—Ä—Ç–∞ –ø—Ä–æ–µ–∫—Ç–∞ iiko + FinTablo Sync Bot

> –ü–æ—Å–ª–µ–¥–Ω–µ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ: 2026-02-17
> –Ø–∑—ã–∫ –æ–±—â–µ–Ω–∏—è —Å —Ä–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫–æ–º: **—Ä—É—Å—Å–∫–∏–π**

---

## üéØ –û –ø—Ä–æ–µ–∫—Ç–µ

Telegram-–±–æ—Ç –¥–ª—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏ —Å–ø—Ä–∞–≤–æ—á–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö –∏–∑ **iiko REST API** –∏ **FinTablo REST API** –≤ **PostgreSQL**.
–í—Å–µ –¥–∞—Ç—ã –∏ –≤—Ä–µ–º—è –≤ –ø—Ä–æ–µ–∫—Ç–µ ‚Äî –ø–æ **–ö–∞–ª–∏–Ω–∏–Ω–≥—Ä–∞–¥—É** (`Europe/Kaliningrad`, UTC+2).
–ï–∂–µ–¥–Ω–µ–≤–Ω–∞—è –∞–≤—Ç–æ—Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è –≤—Å–µ—Ö –¥–∞–Ω–Ω—ã—Ö –≤ **07:00** –ø–æ –∫–∞–ª–∏–Ω–∏–Ω–≥—Ä–∞–¥—Å–∫–æ–º—É –≤—Ä–µ–º–µ–Ω–∏ (—á–µ—Ä–µ–∑ APScheduler).
–≠—Ç–æ **—Å–∫–µ–ª–µ—Ç –±–æ–ª—å—à–æ–≥–æ –ø—Ä–æ–µ–∫—Ç–∞** ‚Äî –≤–ø–µ—Ä–µ–¥–∏ –Ω–æ–≤—ã–µ –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏, –∏—Å—Ç–æ—á–Ω–∏–∫–∏ –¥–∞–Ω–Ω—ã—Ö, –∞–Ω–∞–ª–∏—Ç–∏–∫–∞.
–¢–µ–∫—É—â–∞—è —Ñ–∞–∑–∞: –≤—ã–≥—Ä—É–∑–∫–∞ –≤—Å–µ—Ö —Å–ø—Ä–∞–≤–æ—á–Ω–∏–∫–æ–≤ iiko + FinTablo –≤ –ë–î –ø–æ –∫–Ω–æ–ø–∫–∞–º –±–æ—Ç–∞ + **–∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤ —á–µ—Ä–µ–∑ Telegram** + **–∞–∫—Ç—ã —Å–ø–∏—Å–∞–Ω–∏—è —Å –ø—Ä–æ–≤–µ—Ä–∫–æ–π –∞–¥–º–∏–Ω–∞–º–∏** + **–∑–∞–≥—Ä—É–∑–∫–∞ –Ω–∞–∫–ª–∞–¥–Ω—ã—Ö** + **—Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è –æ—Å—Ç–∞—Ç–∫–æ–≤ –ø–æ —Å–∫–ª–∞–¥–∞–º** + **–ø—Ä–æ–≤–µ—Ä–∫–∞ –º–∏–Ω–∏–º–∞–ª—å–Ω—ã—Ö –æ—Å—Ç–∞—Ç–∫–æ–≤ –ø–æ –ø–æ–¥—Ä–∞–∑–¥–µ–ª–µ–Ω–∏—è–º** + **–∏—Å—Ç–æ—Ä–∏—è —Å–ø–∏—Å–∞–Ω–∏–π —Å –ø–æ–≤—Ç–æ—Ä–æ–º –∏ —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–µ–π –ø–æ —Ä–æ–ª—è–º** + **—Ä–∞—Å—Ö–æ–¥–Ω—ã–µ –Ω–∞–∫–ª–∞–¥–Ω—ã–µ –∏–∑ —à–∞–±–ª–æ–Ω–æ–≤ —Å –ø—Ä–∞–π—Å-–ª–∏—Å—Ç–æ–º –∏–∑ –ë–î** + **XML-–∏–º–ø–æ—Ä—Ç –≤ iiko** + **–∑–∞—è–≤–∫–∏ –Ω–∞ —Ç–æ–≤–∞—Ä—ã (—Å–æ–∑–¥–∞–Ω–∏–µ ‚Üí –æ–¥–æ–±—Ä–µ–Ω–∏–µ ‚Üí —Ä–∞—Å—Ö–æ–¥–Ω–∞—è –Ω–∞–∫–ª–∞–¥–Ω–∞—è –≤ iiko) + –∏—Å—Ç–æ—Ä–∏—è –∑–∞—è–≤–æ–∫ —Å –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏–µ–º + –∞–≤—Ç–æ-–æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ —Å–∫–ª–∞–¥–æ–≤ –∏–∑ –ø—Ä–∞–π—Å-–ª–∏—Å—Ç–∞ + –∞–≤—Ç–æ-—Ä–∞–∑–±–∏–≤–∫–∞ –∑–∞—è–≤–∫–∏ –ø–æ —Å–∫–ª–∞–¥–∞–º (N –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤)** + **–≥—Ä–∞–Ω—É–ª—è—Ä–Ω—ã–µ –ø—Ä–∞–≤–∞ –¥–æ—Å—Ç—É–ø–∞ + —Ä–æ–ª–∏ (–∞–¥–º–∏–Ω, –ø–æ–ª—É—á–∞—Ç–µ–ª—å, –æ—Å—Ç–∞—Ç–∫–∏, —Å—Ç–æ–ø-–ª–∏—Å—Ç) —á–µ—Ä–µ–∑ Google –¢–∞–±–ª–∏—Ü—É** + **PDF-–¥–æ–∫—É–º–µ–Ω—Ç—ã —Ä–∞—Å—Ö–æ–¥–Ω—ã—Ö –Ω–∞–∫–ª–∞–¥–Ω—ã—Ö –∏ –∑–∞—è–≤–æ–∫ (2 –∫–æ–ø–∏–∏, –∞–¥–∞–ø—Ç–∏–≤–Ω—ã–π —Ä–∞–∑–º–µ—Ä, –∫–∏—Ä–∏–ª–ª–∏—Ü–∞)** + **–≥–ª–æ–±–∞–ª—å–Ω–∞—è –æ—Ç–º–µ–Ω–∞ /cancel + NavResetMiddleware (–∑–∞—â–∏—Ç–∞ –æ—Ç –∑–∞–≤–∏—Å–∞–Ω–∏—è FSM)** + **iikoCloud –≤–µ–±—Ö—É–∫–∏ ‚Üí –∞–≤—Ç–æ–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∑–∞–∫—Ä–µ–ø–ª—ë–Ω–Ω—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π —Å –æ—Å—Ç–∞—Ç–∫–∞–º–∏ –Ω–∏–∂–µ –º–∏–Ω–∏–º—É–º–∞** + **—Å—Ç–æ–ø-–ª–∏—Å—Ç iikoCloud ‚Üí –∑–∞–∫—Ä–µ–ø–ª—ë–Ω–Ω—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è + –µ–∂–µ–≤–µ—á–µ—Ä–Ω–∏–π –æ—Ç—á—ë—Ç (22:00) + StopListUpdate –≤–µ–±—Ö—É–∫** + **–≥–∏–±–∫–∏–π –º–∞–ø–ø–∏–Ω–≥ –ø–æ–¥—Ä–∞–∑–¥–µ–ª–µ–Ω–∏–π ‚Üí Cloud-–æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏–π —á–µ—Ä–µ–∑ GSheet ¬´–ù–∞—Å—Ç—Ä–æ–π–∫–∏¬ª (–≤—ã–ø–∞–¥–∞—é—â–∏–µ —Å–ø–∏—Å–∫–∏ + VLOOKUP)** + **–ø–æ–¥–ø–∏—Å–∫–∏ –Ω–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è (–æ—Å—Ç–∞—Ç–∫–∏ / —Å—Ç–æ–ø-–ª–∏—Å—Ç) —á–µ—Ä–µ–∑ —Ä–æ–ª–∏ –≤ GSheet** + **OCR-—Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏–µ –±—É–º–∞–∂–Ω—ã—Ö –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤ —á–µ—Ä–µ–∑ Gemini Vision (—Ñ–æ—Ç–æ ‚Üí JSON ‚Üí –º–∞–ø–ø–∏–Ω–≥ ‚Üí iiko –ø—Ä–∏—Ö–æ–¥–Ω–∞—è –Ω–∞–∫–ª–∞–¥–Ω–∞—è) + —Å–∞–º–æ–æ–±—É—á–∞—é—â–∏–π—Å—è –º–∞–ø–ø–∏–Ω–≥ (fuzzy match + GSheet) + —Ä–∞–∑–¥–µ–ª–µ–Ω–∏–µ —Ç–æ–≤–∞—Ä—ã/—É—Å–ª—É–≥–∏ —Å –∞–≤—Ç–æ–æ–±—É—á–µ–Ω–∏–µ–º + –ø–æ–¥–¥–µ—Ä–∂–∫–∞ –ø–∞—á–∫–∏ —Ñ–æ—Ç–æ (media group)** + **–ø—Ä–∞–π—Å-–ª–∏—Å—Ç: –∫–æ–ª–æ–Ω–∫–∞ ¬´–°–∫–ª–∞–¥¬ª —Å –≤—ã–ø–∞–¥–∞—é—â–∏–º —Å–ø–∏—Å–∫–æ–º + –Ω–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º—ã–µ —Å–∫–ª–∞–¥—ã –¥–ª—è –∑–∞—è–≤–æ–∫ –≤ GSheet ¬´–ù–∞—Å—Ç—Ä–æ–π–∫–∏¬ª**.

---

## üó∫ –ù–∞–≤–∏–≥–∞—Ü–∏—è –ø–æ –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏

> **–≠—Ç–æ—Ç —Ñ–∞–π–ª (PROJECT_MAP.md) —á–∏—Ç–∞–µ—Ç—Å—è –í–°–ï–ì–î–ê.** –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ —Ñ–∞–π–ª—ã ‚Äî –ø–æ –∑–∞–¥–∞—á–µ.

| –ó–∞–¥–∞—á–∞ | –ß—Ç–æ —á–∏—Ç–∞—Ç—å –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ |
|--------|--------------------------|
| –ù–æ–≤–∞—è —Ñ–∏—á–∞, —Ä–µ—Ñ–∞–∫—Ç–æ—Ä, –ø–æ–∏—Å–∫ –º–æ–¥—É–ª—è | [`docs/FILE_STRUCTURE.md`](docs/FILE_STRUCTURE.md) ‚Äî –¥–µ—Ä–µ–≤–æ —Ñ–∞–π–ª–æ–≤, –æ–ø–∏—Å–∞–Ω–∏—è –º–æ–¥—É–ª–µ–π, FSM-–ø–æ—Ç–æ–∫–∏, –∫–Ω–æ–ø–∫–∏ –±–æ—Ç–∞ |
| –ú–∏–≥—Ä–∞—Ü–∏—è, –Ω–æ–≤–∞—è —Ç–∞–±–ª–∏—Ü–∞, sync-–∑–∞–¥–∞—á–∞, —Ä–∞–±–æ—Ç–∞ —Å –¥–∞–Ω–Ω—ã–º–∏ | [`docs/DATABASE.md`](docs/DATABASE.md) ‚Äî –≤—Å–µ 42 —Ç–∞–±–ª–∏—Ü—ã |
| –ù–æ–≤—ã–π sync, –≤–Ω–µ—à–Ω–∏–π API, –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å, Railway | [`docs/API_INTEGRATIONS.md`](docs/API_INTEGRATIONS.md) ‚Äî iiko/FinTablo API, –∏–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä–∞, –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏, –≥—Ä–∞–±–ª–∏ |
| –ß—Ç–æ —É–∂–µ –±—ã–ª–æ —Å–¥–µ–ª–∞–Ω–æ, –∏—Å—Ç–æ—Ä–∏—è —Ä–µ—à–µ–Ω–∏–π | [`docs/CHANGELOG.md`](docs/CHANGELOG.md) ‚Äî –≤—Å–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è —Å –¥–∞—Ç–∞–º–∏ |
| –ó–∞—Å—Ç—Ä—è–ª, –±–∞–≥ –Ω–µ —Ä–µ—à–∞–µ—Ç—Å—è, –æ—Ç–ª–∞–¥–∫–∞ | [`docs/KNOWN_ISSUES.md`](docs/KNOWN_ISSUES.md) ‚Äî —Ä–µ—à—ë–Ω–Ω—ã–µ –ø—Ä–æ–±–ª–µ–º—ã –∏ –≥—Ä–∞–±–ª–∏ |
| –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å, –≤–∞–ª–∏–¥–∞—Ü–∏—è, –∫–æ–Ω–∫—É—Ä–µ–Ω—Ç–Ω–æ—Å—Ç—å, –¥–µ–ø–ª–æ–π | [`docs/SECURITY_AND_RELIABILITY.md`](docs/SECURITY_AND_RELIABILITY.md) ‚Äî –ø–∞—Ç—Ç–µ—Ä–Ω—ã –∑–∞—â–∏—Ç—ã —Å –ø—Ä–∏–º–µ—Ä–∞–º–∏ –∫–æ–¥–∞ |
| –ù–æ–≤—ã–π handler, UX, —Å–∫–æ—Ä–æ—Å—Ç—å –æ—Ç–∫–ª–∏–∫–∞, –∫–µ—à–∏—Ä–æ–≤–∞–Ω–∏–µ | [`docs/UX_PATTERNS.md`](docs/UX_PATTERNS.md) ‚Äî –ø–∞—Ç—Ç–µ—Ä–Ω—ã –±—ã—Å—Ç—Ä–æ–≥–æ –∏ —á–∏—Å—Ç–æ–≥–æ UI —Å –ø—Ä–∏–º–µ—Ä–∞–º–∏ –∫–æ–¥–∞ |
| –ö—É–¥–∞ –ø–∏—Å–∞—Ç—å –Ω–æ–≤—ã–π changelog | [`docs/CHANGELOG.md`](docs/CHANGELOG.md) ‚Äî –¥–æ–±–∞–≤–ª—è—Ç—å —Å–≤–µ—Ä—Ö—É (–Ω–æ–≤–æ–µ –ø–µ—Ä–≤—ã–º) |

---

## üß† –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–Ω—ã–µ –ø—Ä–∏–Ω—Ü–∏–ø—ã (–û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–û —Å–æ–±–ª—é–¥–∞—Ç—å)

1. **–¢–æ–Ω–∫–∏–µ —Ö—ç–Ω–¥–ª–µ—Ä—ã** ‚Äî `bot/handlers.py` —Ç–æ–ª—å–∫–æ –ø—Ä–∏–Ω–∏–º–∞–µ—Ç –∫–æ–º–∞–Ω–¥—É, –≤—ã–∑—ã–≤–∞–µ—Ç use_case, –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –æ—Ç–≤–µ—Ç. –ù–∏–∫–∞–∫–æ–π –±–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫–∏.
2. **–ë–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫–∞ –≤ use_cases/** ‚Äî sync, –≤–∞–ª–∏–¥–∞—Ü–∏—è, —Ç—Ä–∞–Ω—Å—Ñ–æ—Ä–º–∞—Ü–∏—è –¥–∞–Ω–Ω—ã—Ö.
3. **–ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏ –≤ adapters/** ‚Äî HTTP, XML, –≤–Ω–µ—à–Ω–∏–µ API. Use_cases –Ω–µ –∑–Ω–∞—é—Ç –ø—Ä–æ HTTP/XML.
4. **–ù–∏–∫–∞–∫–æ–≥–æ —Ö–∞—Ä–¥–∫–æ–¥–∞** ‚Äî –≤—Å–µ —Å–µ–∫—Ä–µ—Ç—ã –∏ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –≤ `.env`, —á–∏—Ç–∞—é—Ç—Å—è —á–µ—Ä–µ–∑ `config.py`.
5. **1 –∫–Ω–æ–ø–∫–∞ = 1 —Ç–∞–±–ª–∏—Ü–∞** ‚Äî –Ω–µ –ø–ª–æ–¥–∏—Ç—å —Ç–∞–±–ª–∏—Ü—ã –±–µ–∑ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏.
6. **UPSERT-–ø–∞—Ç—Ç–µ—Ä–Ω** ‚Äî INSERT ON CONFLICT DO UPDATE, –±–∞—Ç—á–∞–º–∏ –ø–æ 500 —Å—Ç—Ä–æ–∫.
7. **Mirror-sync** ‚Äî –ø–æ—Å–ª–µ UPSERT, DELETE –∏–∑ –ë–î –∑–∞–ø–∏—Å–µ–π, –∫–æ—Ç–æ—Ä—ã—Ö –±–æ–ª—å—à–µ –Ω–µ—Ç –≤ API. –ë–î = –∑–µ—Ä–∫–∞–ª–æ iiko/FinTablo.
8. **raw_json –≤ –∫–∞–∂–¥–æ–π —Ç–∞–±–ª–∏—Ü–µ** ‚Äî —Å—Ç—Ä–∞—Ö–æ–≤–∫–∞: –ø–æ–ª–Ω—ã–π –æ—Ç–≤–µ—Ç API —Ö—Ä–∞–Ω–∏—Ç—Å—è –∫–∞–∫ JSONB.
9. **SyncLog ‚Äî –∞—É–¥–∏—Ç –≤—Å–µ–≥–æ** ‚Äî –∫–∞–∂–¥–∞—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è –ø–∏—à–µ—Ç—Å—è –≤ iiko_sync_log.
10. **–õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –≤–µ–∑–¥–µ** ‚Äî —Ç–∞–π–º–∏–Ω–≥–∏ API-–∑–∞–ø—Ä–æ—Å–æ–≤, –ø—Ä–æ–≥—Ä–µ—Å—Å batch, –∏—Ç–æ–≥–∏. Verbose, –Ω–µ silent.
11. **–ë—ã—Å—Ç—Ä—ã–π —Å—Ç–∞—Ä—Ç –±–æ—Ç–∞** ‚Äî `SELECT 1` –≤–º–µ—Å—Ç–æ `create_all` –ø—Ä–∏ –∫–∞–∂–¥–æ–º –∑–∞–ø—É—Å–∫–µ.
12. **üõ°Ô∏è FOOL-PROOF DESIGN (–ö–†–ò–¢–ò–ß–ï–°–ö–ò –í–ê–ñ–ù–û)** ‚Äî **—Å–∏—Å—Ç–µ–º–∞ –ù–ï –¥–æ–ª–∂–Ω–∞ –ª–æ–º–∞—Ç—å—Å—è –æ—Ç –Ω–µ–≤–µ—Ä–Ω–æ–≥–æ –¥–µ–π—Å—Ç–≤–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è**.
    - –õ—é–±–æ–π —Å–æ—Ç—Ä—É–¥–Ω–∏–∫ –¥–æ–ª–∂–µ–Ω –ø—Ä–æ—Å—Ç–æ –≤—ã–ø–æ–ª–Ω–∏—Ç—å –¥–µ–π—Å—Ç–≤–∏–µ (–æ—Ç–ø—Ä–∞–≤–∏—Ç—å —Ñ–æ—Ç–æ, –Ω–∞–∂–∞—Ç—å –∫–Ω–æ–ø–∫—É) ‚Äî —Å–∏—Å—Ç–µ–º–∞ —Å–∞–º–∞ —Ä–∞–∑–±–µ—Ä—ë—Ç—Å—è —á—Ç–æ –¥–µ–ª–∞—Ç—å
    - –ù–ï–¢ —Ä–µ–∂–∏–º–æ–≤ –≤—ã–±–æ—Ä–∞ "–∫–∞–∫ –æ–±—Ä–∞–±–æ—Ç–∞—Ç—å" ‚Üí —Å–∏—Å—Ç–µ–º–∞ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –æ–ø—Ä–µ–¥–µ–ª—è–µ—Ç –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π –ø—É—Ç—å
    - –ù–µ–≤–∞–ª–∏–¥–Ω—ã–π –≤–≤–æ–¥ ‚Üí –ø–æ–Ω—è—Ç–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ + –≤–æ–∑–≤—Ä–∞—Ç –∫ –ø—Ä–µ–¥—ã–¥—É—â–µ–º—É —à–∞–≥—É (–ù–ï –∫—Ä–∞—Ö, –ù–ï —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞)
    - –ù–µ–æ–¥–Ω–æ–∑–Ω–∞—á–Ω–æ—Å—Ç—å ‚Üí —Å–∏—Å—Ç–µ–º–∞ –¥–µ–ª–∞–µ—Ç **–±–µ–∑–æ–ø–∞—Å–Ω—ã–π –≤—ã–±–æ—Ä –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é** –∏–ª–∏ —Å–ø—Ä–∞—à–∏–≤–∞–µ—Ç –º–∏–Ω–∏–º–∞–ª—å–Ω–æ
    - –ü—Ä–∏–º–µ—Ä—ã: OCR –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –æ–ø—Ä–µ–¥–µ–ª—è–µ—Ç –≥—Ä–∞–Ω–∏—Ü—ã –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤, –º–∞–ø–ø–∏–Ω–≥ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –æ–±—É—á–∞–µ—Ç—Å—è, —Å–∫–ª–∞–¥—ã –æ–ø—Ä–µ–¥–µ–ª—è—é—Ç—Å—è —á–µ—Ä–µ–∑ fuzzy match
    - **–ü—Ä–∞–≤–∏–ª–æ:** –ï—Å–ª–∏ —Ñ–∏—á–∞ —Ç—Ä–µ–±—É–µ—Ç –æ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–æ–≥–æ –ø–æ–Ω–∏–º–∞–Ω–∏—è —Å–∏—Å—Ç–µ–º—ã ‚Äî **—Ñ–∏—á–∞ —Å–ø—Ä–æ–µ–∫—Ç–∏—Ä–æ–≤–∞–Ω–∞ –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω–æ**

---

## üèó –ö–æ–Ω–≤–µ–Ω—Ü–∏–∏ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏

- **Python 3.12**, async everywhere (asyncio, asyncpg, httpx, aiogram 3)
- **SQLAlchemy 2.0** declarative models, async session
- **–ß–∞—Å–æ–≤–æ–π –ø–æ—è—Å** ‚Äî **Europe/Kaliningrad** (UTC+2). –í—Å–µ `datetime` –≤ –ö–æ–¥–µ/–ë–î/PDF/API ‚Äî –∫–∞–ª–∏–Ω–∏–Ω–≥—Ä–∞–¥—Å–∫–æ–µ –≤—Ä–µ–º—è. –•–µ–ª–ø–µ—Ä: `now_kgd()` –∏–∑ `_helpers.py`.
- **APScheduler** ‚Äî –µ–∂–µ–¥–Ω–µ–≤–Ω–∞—è –∞–≤—Ç–æ—Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è –≤ 07:00 –ø–æ –ö–∞–ª–∏–Ω–∏–Ω–≥—Ä–∞–¥—É (`use_cases/scheduler.py`)
- **–ú–∞–ª–µ–Ω—å–∫–∏–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è** ‚Äî –Ω–µ –ø–µ—Ä–µ–ø–∏—Å—ã–≤–∞—Ç—å –≤—Å—ë —Å—Ä–∞–∑—É, –∏–Ω–∫—Ä–µ–º–µ–Ω—Ç–∞–ª—å–Ω—ã–µ –ø—Ä–∞–≤–∫–∏
- **DRY** ‚Äî generic `_run_sync()` + `_batch_upsert()` –≤–º–µ—Å—Ç–æ –∫–æ–ø–∏–ø–∞—Å—Ç—ã –Ω–∞ –∫–∞–∂–¥—É—é —Ç–∞–±–ª–∏—Ü—É
- **–ü–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ—Å—Ç—å** ‚Äî `asyncio.gather` –¥–ª—è –Ω–µ–∑–∞–≤–∏—Å–∏–º—ã—Ö API-–∑–∞–ø—Ä–æ—Å–æ–≤ –∏ sync-–æ–ø–µ—Ä–∞—Ü–∏–π
- **Persistent HTTP client** ‚Äî –æ–¥–∏–Ω `httpx.AsyncClient` —Å connection pool, –Ω–µ —Å–æ–∑–¥–∞–≤–∞—Ç—å –Ω–æ–≤—ã–π –Ω–∞ –∫–∞–∂–¥—ã–π –∑–∞–ø—Ä–æ—Å

---

## üö´ –ê–Ω—Ç–∏–ø–∞—Ç—Ç–µ—Ä–Ω—ã –∏ –∑–∞–ø—Ä–µ—Ç—ã (–ù–ï –î–ï–õ–ê–¢–¨)

### Python / asyncio
- **–ù–ï –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å** `asyncio.get_event_loop()` ‚Äî deprecated —Å Python 3.10+. –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å `asyncio.run()` –∏–ª–∏ `asyncio.get_running_loop()`
- **–ù–ï –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å** —Å–∏–Ω—Ö—Ä–æ–Ω–Ω—ã–µ –±–ª–æ–∫–∏—Ä—É—é—â–∏–µ –≤—ã–∑–æ–≤—ã (`time.sleep`, `requests`) –≤ async-–∫–æ–¥–µ ‚Äî —Ç–æ–ª—å–∫–æ `asyncio.sleep`, `httpx.AsyncClient`
- **–ù–ï –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å** `print()` ‚Äî —Ç–æ–ª—å–∫–æ `logging` (—É–∂–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω —á–µ—Ä–µ–∑ `logging_config.py`)
- **–ù–ï –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å** `typing.Optional` ‚Äî `X | None` (Python 3.12 syntax)
- **–ù–ï –≥–ª–æ—Ç–∞—Ç—å –∏—Å–∫–ª—é—á–µ–Ω–∏—è** ‚Äî `except Exception: pass` –∑–∞–ø—Ä–µ—â—ë–Ω. –õ–æ–≥–∏—Ä–æ–≤–∞—Ç—å –≤—Å—ë —á–µ—Ä–µ–∑ `logger.exception()`

### URLs / —Å–µ—Ç–∏
- **–í—Å–µ –≤–Ω–µ—à–Ω–∏–µ URL** –¥–æ–ª–∂–Ω—ã –Ω–∞—á–∏–Ω–∞—Ç—å—Å—è —Å `https://` ‚Äî –µ—Å–ª–∏ –ø–µ—Ä–µ–º–µ–Ω–Ω–∞—è –º–æ–∂–µ—Ç –ø—Ä–∏–π—Ç–∏ –±–µ–∑ —Å—Ö–µ–º—ã, –¥–æ–±–∞–≤–ª—è—Ç—å –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ (—Å–º. `WEBHOOK_URL` –≤ `config.py`)
- **DATABASE_URL** ‚Äî –Ω–æ—Ä–º–∞–ª–∏–∑–æ–≤–∞—Ç—å –ø—Ä–µ—Ñ–∏–∫—Å –ø–æ–¥ `asyncpg` (—É–∂–µ —Å–¥–µ–ª–∞–Ω–æ –≤ `config.py`). –ù–∏–∫–æ–≥–¥–∞ –Ω–µ –ø–æ–ª–∞–≥–∞—Ç—å—Å—è –Ω–∞ —Ç–æ, —á—Ç–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∑–∞–¥–∞—Å—Ç –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π –¥—Ä–∞–π–≤–µ—Ä

### –î–µ–ø–ª–æ–π / Railway
- **Procfile: `web`** –¥–ª—è webhook-–±–æ—Ç–∞ (Railway –¥–æ–ª–∂–µ–Ω –ø—Ä–æ–±—Ä–æ—Å–∏—Ç—å –ø–æ—Ä—Ç), `worker` ‚Äî —Ç–æ–ª—å–∫–æ –¥–ª—è polling –±–µ–∑ –ø–æ—Ä—Ç–∞
- **PORT** ‚Äî –≤—Å–µ–≥–¥–∞ —á–∏—Ç–∞—Ç—å –∏–∑ `os.getenv("PORT")`, Railway –∑–∞–¥–∞—ë—Ç —Å–≤–æ–π. –ù–µ —Ö–∞—Ä–¥–∫–æ–¥–∏—Ç—å
- **`0.0.0.0`** ‚Äî —Å–ª—É—à–∞—Ç—å –Ω–∞ –≤—Å–µ—Ö –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞—Ö, –Ω–µ –Ω–∞ `127.0.0.1` (–∫–æ–Ω—Ç–µ–π–Ω–µ—Ä)
- **–°–µ–∫—Ä–µ—Ç—ã** ‚Äî —Ç–æ–ª—å–∫–æ —á–µ—Ä–µ–∑ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è Railway. –ù–∏–∫–æ–≥–¥–∞ –Ω–µ –∫–æ–º–º–∏—Ç–∏—Ç—å `.env`
- **Internal vs Public DB URL** ‚Äî –Ω–∞ Railway –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å `railway.internal` (–±—ã—Å—Ç—Ä–µ–µ), –ª–æ–∫–∞–ª—å–Ω–æ ‚Äî –ø—É–±–ª–∏—á–Ω—ã–π proxy

### Telegram Bot
- **Webhook** ‚Äî —Ç–æ–ª—å–∫–æ `https://`, Telegram –Ω–µ –ø—Ä–∏–Ω–∏–º–∞–µ—Ç `http://`
- **`drop_pending_updates=True`** –ø—Ä–∏ set_webhook / start_polling ‚Äî —á—Ç–æ–±—ã –Ω–µ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—Ç—å —Å—Ç–∞—Ä—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è –ø–æ—Å–ª–µ —Ä–µ—Å—Ç–∞—Ä—Ç–∞
- **delete_webhook** –ø–µ—Ä–µ–¥ polling ‚Äî –∏–Ω–∞—á–µ Telegram –ø—Ä–æ–¥–æ–ª–∂–∏—Ç —Å–ª–∞—Ç—å –∞–ø–¥–µ–π—Ç—ã –Ω–∞ —Å—Ç–∞—Ä—ã–π –≤–µ–±—Ö—É–∫ –∏ polling –Ω–µ –ø–æ–ª—É—á–∏—Ç –Ω–∏—á–µ–≥–æ
- **–≠–º–æ–¥–∑–∏ –≤ –∫–æ–¥–µ** ‚Äî –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å **—Ç–æ–ª—å–∫–æ —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–µ –æ–¥–Ω–æ–∫–æ–¥–ø–æ–∏–Ω—Ç–æ–≤—ã–µ Unicode-—ç–º–æ–¥–∑–∏** (üì∏, üìë, üì¶, üîÑ, üóÇ, üëë –∏ —Ç.–¥.). **–ó–ê–ü–†–ï–©–ï–ù–û** –≤—Å—Ç–∞–≤–ª—è—Ç—å —ç–º–æ–¥–∑–∏ —á–µ—Ä–µ–∑ copy-paste –∏–∑ –Ω–µ—Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã—Ö –∏—Å—Ç–æ—á–Ω–∏–∫–æ–≤ ‚Äî —ç—Ç–æ –ø—Ä–∏–≤–æ–¥–∏—Ç –∫ –ø–æ—è–≤–ª–µ–Ω–∏—é `U+FFFD` (replacement character / —Ä–æ–º–±–∏–∫ —Å –≤–æ–ø—Ä–æ—Å–æ–º) –∏ –Ω–µ—Å–æ–≤–ø–∞–¥–µ–Ω–∏—é —Ç–µ–∫—Å—Ç–∞ –∫–Ω–æ–ø–∫–∏ —Å `F.text ==` —Ñ–∏–ª—å—Ç—Ä–æ–º. –í—Å–µ–≥–¥–∞ –ø—Ä–æ–≤–µ—Ä—è—Ç—å: —Ç–µ–∫—Å—Ç –≤ `KeyboardButton(text=...)` –¥–æ–ª–∂–µ–Ω **–ø–æ–±–∞–π—Ç–æ–≤–æ** —Å–æ–≤–ø–∞–¥–∞—Ç—å —Å–æ —Å—Ç—Ä–æ–∫–æ–π –≤ `F.text == "..."` —Ö–µ–Ω–¥–ª–µ—Ä–∞.

### –ë–î / SQLAlchemy
- **–ù–µ —Å–æ–∑–¥–∞–≤–∞—Ç—å** engine –Ω–∞ —É—Ä–æ–≤–Ω–µ —Ñ—É–Ω–∫—Ü–∏–∏ ‚Äî —Ç–æ–ª—å–∫–æ singleton –≤ `db/engine.py`
- **`expire_on_commit=False`** ‚Äî –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ –¥–ª—è async-—Å–µ—Å—Å–∏–π, –∏–Ω–∞—á–µ lazy load –ø–æ—Å–ª–µ commit –∫—Ä–∞—à–Ω–µ—Ç
- **`pool_pre_ping=True`** ‚Äî –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ –¥–ª—è Railway (–¥—Ä–æ–ø–∞–µ—Ç idle-—Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è)
- **–ú–∏–≥—Ä–∞—Ü–∏–∏** ‚Äî `IF NOT EXISTS` / `ADD COLUMN IF NOT EXISTS` –¥–ª—è –∏–¥–µ–º–ø–æ—Ç–µ–Ω—Ç–Ω–æ—Å—Ç–∏

---

## üõ° Guardrails –º–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–∏—è –∏ –∑–∞—â–∏—Ç—ã –æ—Ç —Ä–µ–≥—Ä–µ—Å—Å–∏–π (–û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–û)

### 1) –ö–æ–Ω—Ç—Ä–∞–∫—Ç –∏–∑–º–µ–Ω–µ–Ω–∏–π (–ª—é–±–æ–π –∫–æ–¥, –æ—Å–æ–±–µ–Ω–Ω–æ —Å AI)
- –õ—é–±–æ–µ –∏–∑–º–µ–Ω–µ–Ω–∏–µ = (–∞) —Ü–µ–ª—å/—Å–∏–º–ø—Ç–æ–º ‚Üí (–±) –º–∏–Ω–∏–º–∞–ª—å–Ω—ã–π –ø–ª–∞–Ω ‚Üí (–≤) –ø—Ä–∞–≤–∫–∞ use_cases/adapters ‚Üí (–≥) —Ç–æ–Ω–∫–∏–π handler ‚Üí (–¥) —Ç–µ—Å—Ç/–ø—Ä–æ–≤–µ—Ä–∫–∞ ‚Üí (–µ) –æ–±–Ω–æ–≤–∏—Ç—å –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—é.
- –ó–∞–ø—Ä–µ—â–µ–Ω—ã "—Ç–∏—Ö–∏–µ" —Ä–µ—Ñ–∞–∫—Ç–æ—Ä—ã: –µ—Å–ª–∏ –Ω–µ –∑–∞–ø—Ä–æ—à–µ–Ω–æ —è–≤–Ω–æ ‚Äî –Ω–µ —Ç—Ä–æ–≥–∞—Ç—å –∏–º–µ–Ω–∞, –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å—ã, —Å—Ç—Ä—É–∫—Ç—É—Ä—É –º–æ–¥—É–ª–µ–π.
- –ö–∞–∂–¥–∞—è –ø—Ä–∞–≤–∫–∞ –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å –Ω–∞–±–ª—é–¥–∞–µ–º–æ–π: +–ª–æ–≥ –Ω–∞ –≤—Ö–æ–¥–µ –∏ –ª–æ–≥ –∏—Ç–æ–≥–æ–≤ (ok/error + —Ç–∞–π–º–∏–Ω–≥).

### 2) Definition of Done (DoD) –¥–ª—è –ª—é–±–æ–π —Ñ–∏—á–∏/—Ñ–∏–∫—Å–∞
- ‚úÖ –ï—Å—Ç—å –≤–æ—Å–ø—Ä–æ–∏–∑–≤–æ–¥–∏–º–æ—Å—Ç—å: —à–∞–≥–∏ –∏–ª–∏ –ª–æ–≥/stacktrace + –≤—Ö–æ–¥–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ
- ‚úÖ –ï—Å—Ç—å –∑–∞—â–∏—Ç–∞ –æ—Ç —Ä–µ–≥—Ä–µ—Å—Å–∏–∏: —Ö–æ—Ç—è –±—ã –æ–¥–∏–Ω —Ç–µ—Å—Ç/—Å–º–æ—É–∫-—Å–∫—Ä–∏–ø—Ç –∏–ª–∏ "–∫–æ–Ω—Ç—Ä–∞–∫—Ç" (–º–æ–∫–∏ API + –ø—Ä–æ–≤–µ—Ä–∫–∞ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞)
- ‚úÖ –õ–æ–≥–∏ —Å–æ–¥–µ—Ä–∂–∞—Ç –º–∏–Ω–∏–º—É–º: tg_id, employee_id/department_id (–µ—Å–ª–∏ –µ—Å—Ç—å), doc_id (–µ—Å–ª–∏ –µ—Å—Ç—å)
- ‚úÖ –ù–µ—Ç —É—Ç–µ—á–µ–∫ —Å–µ–∫—Ä–µ—Ç–æ–≤/—Ç–æ–∫–µ–Ω–æ–≤ –≤ –ª–æ–≥–∞—Ö
- ‚úÖ –ò–∑–º–µ–Ω–µ–Ω–∏–µ –Ω–µ —É–≤–µ–ª–∏—á–∏–ª–æ round-trip'—ã –∫ –ë–î –±–µ–∑ –ø—Ä–∏—á–∏–Ω—ã (Railway latency)
- ‚úÖ –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è –æ–±–Ω–æ–≤–ª–µ–Ω–∞ (–µ—Å–ª–∏ –∏–∑–º–µ–Ω–∏–ª–∏—Å—å –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å—ã, –º–æ–¥—É–ª–∏, —Å—Ö–µ–º–∞ –ë–î)

### 3) –ò–Ω–≤–∞—Ä–∏–∞–Ω—Ç—ã –¥–∞–Ω–Ω—ã—Ö –∏ –≤–Ω–µ—à–Ω–∏—Ö API
- –í—Å–µ –≤–Ω–µ—à–Ω–∏–µ –æ–ø–µ—Ä–∞—Ü–∏–∏ –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å –∏–¥–µ–º–ø–æ—Ç–µ–Ω—Ç–Ω—ã –∏–ª–∏ –∏–º–µ—Ç—å –∑–∞—â–∏—Ç—É –æ—Ç –¥—É–±–ª–µ–π (–ø–æ–≤—Ç–æ—Ä–Ω—ã–π –∫–ª–∏–∫/—Ä–µ—Ç—Ä–∞–π/—Ç–∞–π–º–∞—É—Ç).
- –õ—é–±–æ–π retry = exponential backoff + –ª–∏–º–∏—Ç –ø–æ–ø—ã—Ç–æ–∫ + –ª–æ–≥ –ø—Ä–∏—á–∏–Ω—ã.
- –õ—é–±–æ–π –ø–∞—Ä—Å–∏–Ω–≥/–º–∞–ø–ø–∏–Ω–≥ –¥–∞–Ω–Ω—ã—Ö –¥–æ–ª–∂–µ–Ω —Å–æ—Ö—Ä–∞–Ω—è—Ç—å raw_json (–µ—Å–ª–∏ —Å—É—â–Ω–æ—Å—Ç—å —Ö—Ä–∞–Ω–∏—Ç—Å—è –≤ –ë–î) –∏ –±—ã—Ç—å —É—Å—Ç–æ–π—á–∏–≤ –∫ –æ—Ç—Å—É—Ç—Å—Ç–≤—É—é—â–∏–º –ø–æ–ª—è–º.

### 4) Mirror-delete: –±–µ–∑–æ–ø–∞—Å–Ω—ã–µ –ø—Ä–∞–≤–∏–ª–∞
- Mirror-delete —Ä–∞–∑—Ä–µ—à—ë–Ω —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏:
  - API-–æ—Ç–≤–µ—Ç –≤–∞–ª–∏–¥–µ–Ω (200/ok) –∏ —Å–ø–∏—Å–æ–∫ IDs –Ω–µ –ø—É—Å—Ç,
  - sanity-check –ø—Ä–æ–π–¥–µ–Ω: —É–¥–∞–ª—è–µ–º –Ω–µ –±–æ–ª–µ–µ 50% –æ—Ç —Ç–µ–∫—É—â–µ–≥–æ —Ä–∞–∑–º–µ—Ä–∞ —Ç–∞–±–ª–∏—Ü—ã –∑–∞ –æ–¥–Ω—É —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—é,
  - –ø—Ä–∏ –ø—Ä–æ–≤–∞–ª–µ sanity-check: skip + warning + –∑–∞–ø–∏—Å—å –≤ SyncLog –∫–∞–∫ error/partial (–±–µ–∑ —É–¥–∞–ª–µ–Ω–∏—è).
- –í—Å–µ–≥–¥–∞ –≤—ã–ø–æ–ª–Ω—è—Ç—å delete –≤ —Ç–æ–π –∂–µ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ —á—Ç–æ –∏ upsert + sync_log.

### 5) –°–æ—Å—Ç–æ—è–Ω–∏—è –∏ –∫–æ–Ω–∫—É—Ä–µ–Ω—Ç–Ω–æ—Å—Ç—å
- –õ—é–±–æ–µ "in-memory state" (pending docs, locks, –∫–µ—à–∏) –∏–º–µ–µ—Ç –ø–æ—Ç–æ–ª–æ–∫:
  - 1 –∏–Ω—Å—Ç–∞–Ω—Å –±–æ—Ç–∞ –∏ —Ä–µ—Å—Ç–∞—Ä—Ç = –¥–æ–ø—É—Å—Ç–∏–º–∞—è –ø–æ—Ç–µ—Ä—è —Å–æ—Å—Ç–æ—è–Ω–∏—è (—ç—Ç–æ –û–ö –Ω–∞ —Ç–µ–∫—É—â–µ–º —ç—Ç–∞–ø–µ).
  - –ï—Å–ª–∏ –Ω—É–∂–µ–Ω HA/2+ –∏–Ω—Å—Ç–∞–Ω—Å–∞/–≥–∞—Ä–∞–Ω—Ç–∏–∏ ‚Äî –ø–µ—Ä–µ–Ω–æ—Å —Å–æ—Å—Ç–æ—è–Ω–∏—è –≤ –ë–î/Redis.
- –í—Å–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–µ —Ñ–ª–æ—É –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å —É—Å—Ç–æ–π—á–∏–≤—ã –∫: double-click, –ø–æ–≤—Ç–æ—Ä—É —Å–æ–æ–±—â–µ–Ω–∏—è, —Ç–∞–π–º–∞—É—Ç–∞–º, —á–∞—Å—Ç–∏—á–Ω–æ–π –ø–æ—Ç–µ—Ä–µ state.

### 6) –°—Ö–µ–º–∞ –ë–î
- –ò–∑–º–µ–Ω–µ–Ω–∏–µ —Å—Ö–µ–º—ã = –º–∏–≥—Ä–∞—Ü–∏—è —á–µ—Ä–µ–∑ `_MIGRATIONS` –≤ `init_db.py` (—Å `IF NOT EXISTS` / `ADD COLUMN IF NOT EXISTS`).
- –õ—é–±–æ–π destructive-change (DROP/DELETE —Å—Ç–æ–ª–±—Ü–æ–≤/—Ç–∞–±–ª–∏—Ü) —Ç—Ä–µ–±—É–µ—Ç –æ—Ç–¥–µ–ª—å–Ω–æ–≥–æ —Ä—É—á–Ω–æ–≥–æ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è –∏ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è.
- –ü–µ—Ä–µ—Ö–æ–¥ –Ω–∞ Alembic ‚Äî –ø—Ä–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏ rollback-–º–∏–≥—Ä–∞—Ü–∏–π –∏–ª–∏ –∫–æ–≥–¥–∞ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –º–∏–≥—Ä–∞—Ü–∏–π –ø—Ä–µ–≤—ã—Å–∏—Ç 10+.

### 7) –í–∞–ª–∏–¥–∞—Ü–∏—è –≤—Ö–æ–¥–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö (TRUST NOTHING)
- **callback_data** ‚Äî –í–°–ï–ì–î–ê –≤–∞–ª–∏–¥–∏—Ä–æ–≤–∞—Ç—å –ø–æ—Å–ª–µ `split(":", 1)[1]`:
  - UUID –∑–Ω–∞—á–µ–Ω–∏—è: `try: UUID(value) except ValueError: await callback.answer("–û—à–∏–±–∫–∞ –¥–∞–Ω–Ω—ã—Ö"); return`
  - int –∑–Ω–∞—á–µ–Ω–∏—è: `try: int(value) except ValueError: ...`
  - –ù–∏–∫–æ–≥–¥–∞ –Ω–µ –ø–µ—Ä–µ–¥–∞–≤–∞—Ç—å —Å—ã—Ä–æ–π callback_data –Ω–∞–ø—Ä—è–º—É—é –≤ –ë–î-–∑–∞–ø—Ä–æ—Å –±–µ–∑ –≤–∞–ª–∏–¥–∞—Ü–∏–∏ —Ñ–æ—Ä–º–∞—Ç–∞.
- **–¢–µ–∫—Å—Ç–æ–≤—ã–π –≤–≤–æ–¥** ‚Äî –æ–≥—Ä–∞–Ω–∏—á–∏–≤–∞—Ç—å –¥–ª–∏–Ω—É (–∏–º–µ–Ω–∞ ‚â§100, –ø—Ä–∏—á–∏–Ω—ã ‚â§500, –æ–±—â–∏–π —Ç–µ–∫—Å—Ç ‚â§2000 —Å–∏–º–≤–æ–ª–æ–≤).
- **FSM-–ø–µ—Ä–µ—Ö–æ–¥—ã** ‚Äî –ø—Ä–æ–≤–µ—Ä—è—Ç—å –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—é/admin-–ø—Ä–∞–≤–∞ –Ω–∞ **–∫–∞–∂–¥–æ–º** —à–∞–≥–µ FSM, –∞ –Ω–µ —Ç–æ–ª—å–∫–æ –Ω–∞ –≤—Ö–æ–¥–µ –≤ flow.
  –ï—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø–æ—Ç–µ—Ä—è–ª –ø—Ä–∞–≤–∞ –≤ –ø—Ä–æ—Ü–µ—Å—Å–µ ‚Äî graceful exit —Å —Å–æ–æ–±—â–µ–Ω–∏–µ–º.
- **–ß–∏—Å–ª–æ–≤—ã–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã** ‚Äî –ø—Ä–æ–≤–µ—Ä—è—Ç—å –≥—Ä–∞–Ω–∏—Ü—ã (min/max) –∏ —Ç–∏–ø –¥–æ –ø–µ—Ä–µ–¥–∞—á–∏ –≤ –±–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫—É.
- **–ü—Ä–∞–≤–∏–ª–æ**: –µ—Å–ª–∏ –¥–∞–Ω–Ω—ã–µ –ø—Ä–∏—Ö–æ–¥—è—Ç –æ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (callback, text, inline query) ‚Äî —ç—Ç–æ **–≤—Ä–∞–∂–¥–µ–±–Ω—ã–π –≤–≤–æ–¥** –¥–æ –ø—Ä–æ–≤–µ—Ä–∫–∏.

### 8) –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å
- **Webhook secret** ‚Äî –û–ë–Ø–ó–ê–¢–ï–õ–ï–ù `secret_token` –ø—Ä–∏ `set_webhook()`. –ì–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å —á–µ—Ä–µ–∑ `secrets.token_hex(32)`, —Ö—Ä–∞–Ω–∏—Ç—å –≤ env.
  –ë–µ–∑ secret –ª—é–±–æ–π, –∫—Ç–æ –∑–Ω–∞–µ—Ç webhook URL, –º–æ–∂–µ—Ç –∏–Ω–∂–µ–∫—Ç–∏—Ä–æ–≤–∞—Ç—å —Ñ–µ–π–∫–æ–≤—ã–µ Telegram-–∞–ø–¥–µ–π—Ç—ã.
- **–ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è sync-–æ–ø–µ—Ä–∞—Ü–∏–π** ‚Äî –≤—Å–µ –∫–Ω–æ–ø–∫–∏ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏ (iiko/FinTablo) = **admin-only** –∏–ª–∏ –∫–∞–∫ –º–∏–Ω–∏–º—É–º –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω–Ω—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å.
  Sync ‚Äî –¥–æ—Ä–æ–≥–∞—è –æ–ø–µ—Ä–∞—Ü–∏—è (API-–∑–∞–ø—Ä–æ—Å—ã + batch DB write). –ù–µ–∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω–Ω—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –¥–æ–ª–∂–µ–Ω –∏–º–µ—Ç—å –¥–æ—Å—Ç—É–ø–∞.
- **–ì—Ä–∞–Ω—É–ª—è—Ä–Ω—ã–µ –ø—Ä–∞–≤–∞ –¥–æ—Å—Ç—É–ø–∞ + —Ä–æ–ª–∏** ‚Äî –≤—Å—ë —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —á–µ—Ä–µ–∑ Google –¢–∞–±–ª–∏—Ü—É (–ª–∏—Å—Ç ¬´–ü—Ä–∞–≤–∞ –¥–æ—Å—Ç—É–ø–∞¬ª):
  - **–°—Ç–æ–ª–±—Ü—ã —Ä–æ–ª–µ–π:** ¬´üëë –ê–¥–º–∏–Ω¬ª, ¬´üì¨ –ü–æ–ª—É—á–∞—Ç–µ–ª—å¬ª, ¬´üì¶ –û—Å—Ç–∞—Ç–∫–∏¬ª, ¬´üö´ –°—Ç–æ–ø-–ª–∏—Å—Ç¬ª ‚Äî –≥–∞–ª–æ—á–∫–∏ –æ–ø—Ä–µ–¥–µ–ª—è—é—Ç, –∫—Ç–æ –∞–¥–º–∏–Ω, –∫—Ç–æ –ø–æ–ª—É—á–∞—Ç–µ–ª—å –∑–∞—è–≤–æ–∫, –∫–æ–º—É —à–ª—ë–º –æ—Å—Ç–∞—Ç–∫–∏ –∏ —Å—Ç–æ–ø-–ª–∏—Å—Ç.
  - **–°—Ç–æ–ª–±—Ü—ã –ø—Ä–∞–≤:** ¬´üìù –°–ø–∏—Å–∞–Ω–∏—è¬ª, ¬´üì¶ –ù–∞–∫–ª–∞–¥–Ω—ã–µ¬ª, ¬´üìã –ó–∞—è–≤–∫–∏¬ª, ¬´üìä –û—Ç—á—ë—Ç—ã¬ª, ¬´‚öôÔ∏è –ù–∞—Å—Ç—Ä–æ–π–∫–∏¬ª.
  - 3 —É—Ä–æ–≤–Ω—è –∑–∞—â–∏—Ç—ã –¥–ª—è –∫–∞–∂–¥–æ–≥–æ —Ä–∞–∑–¥–µ–ª–∞:
    1. **–ö–ª–∞–≤–∏–∞—Ç—É—Ä–∞:** `_main_keyboard(allowed)` ‚Äî –∫–Ω–æ–ø–∫–∏ –±–µ–∑ –ø—Ä–∞–≤ **–Ω–µ –ø–æ–∫–∞–∑—ã–≤–∞—é—Ç—Å—è** –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é.
    2. **–î–µ–∫–æ—Ä–∞—Ç–æ—Ä:** `@permission_required(perm_key)` –Ω–∞ handler ‚Äî –¥–∞–∂–µ –µ—Å–ª–∏ –∫–Ω–æ–ø–∫—É –ø—Ä–∏—Å–ª–∞–ª–∏ –Ω–∞–ø—Ä—è–º—É—é, –¥–æ—Å—Ç—É–ø –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω.
    3. **–ê–¥–º–∏–Ω bypass:** –∞–¥–º–∏–Ω—ã (‚úÖ –≤ ¬´üëë –ê–¥–º–∏–Ω¬ª) –∏–º–µ—é—Ç –≤—Å–µ –ø—Ä–∞–≤–∞ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏.
  - –ö–µ—à –≤ –ø–∞–º—è—Ç–∏ (TTL 5 –º–∏–Ω). –ö–Ω–æ–ø–∫–∞ ¬´üîë –ü—Ä–∞–≤–∞ –¥–æ—Å—Ç—É–ø–∞ ‚Üí GSheet¬ª ‚Äî –≤—ã–≥—Ä—É–∑–∫–∞ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤ + —Å—Ç–æ–ª–±—Ü–æ–≤ (–∞–¥–º–∏–Ω-only).
  - **–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∞–¥–º–∏–Ω–∞–º–∏ –∏ –ø–æ–ª—É—á–∞—Ç–µ–ª—è–º–∏ —É–±—Ä–∞–Ω–æ –∏–∑ –±–æ—Ç–∞** ‚Äî —Ç–æ–ª—å–∫–æ —á–µ—Ä–µ–∑ GSheet-–≥–∞–ª–æ—á–∫–∏. –°—Ç–∞—Ä—ã–µ DB-—Ç–∞–±–ª–∏—Ü—ã `bot_admin` / `request_receiver` –±–æ–ª—å—à–µ –Ω–µ —á–∏—Ç–∞—é—Ç—Å—è.
- **–¢–æ–∫–µ–Ω—ã –≤ –ª–æ–≥–∞—Ö** ‚Äî iiko API –ø–µ—Ä–µ–¥–∞—ë—Ç `key` –≤ URL query params. –ü—Ä–∏ `LOG_LEVEL=DEBUG` httpx –ª–æ–≥–∏—Ä—É–µ—Ç –ø–æ–ª–Ω—ã–µ URL.
  –ü—Ä–∞–≤–∏–ª–æ: httpx/httpcore –ª–æ–≥–≥–µ—Ä—ã = –º–∏–Ω–∏–º—É–º `WARNING`. –ù–∏–∫–æ–≥–¥–∞ –Ω–µ –ø–æ–Ω–∏–∂–∞—Ç—å. –í error-—Å–æ–æ–±—â–µ–Ω–∏—è—Ö –º–∞—Å–∫–∏—Ä–æ–≤–∞—Ç—å —Ç–æ–∫–µ–Ω—ã.
- **Admin self-removal** ‚Äî –∞–¥–º–∏–Ω—ã –Ω–∞–∑–Ω–∞—á–∞—é—Ç—Å—è —á–µ—Ä–µ–∑ GSheet-–≥–∞–ª–æ—á–∫—É ¬´üëë –ê–¥–º–∏–Ω¬ª. –£–¥–∞–ª–µ–Ω–∏–µ –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ –∞–¥–º–∏–Ω–∞ –∫–æ–Ω—Ç—Ä–æ–ª–∏—Ä—É–µ—Ç—Å—è –≤—Ä—É—á–Ω—É—é –≤ —Ç–∞–±–ª–∏—Ü–µ (–≥–∞–ª–æ—á–∫—É —Å–Ω—è—Ç—å –Ω–µ–ª—å–∑—è –ø—Ä–æ–≥—Ä–∞–º–º–Ω–æ ‚Äî —Ç–æ–ª—å–∫–æ —Ä—É–∫–∞–º–∏ –≤–ª–∞–¥–µ–ª—å—Ü–∞ —Ç–∞–±–ª–∏—Ü—ã).
- **`/admin_init` –∞—Ç–æ–º–∞—Ä–Ω–æ—Å—Ç—å** ‚Äî –ø—Ä–æ–≤–µ—Ä–∫–∞ ¬´—Ç–∞–±–ª–∏—Ü–∞ –ø—É—Å—Ç–∞?¬ª –∏ –≤—Å—Ç–∞–≤–∫–∞ –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å –≤ –æ–¥–Ω–æ–π —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏. –ò–Ω–∞—á–µ race condition –ø—Ä–∏ –¥–≤—É—Ö –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω—ã—Ö –≤—ã–∑–æ–≤–∞—Ö.
- **Rate limiting** ‚Äî aiogram `ThrottlingMiddleware` –∏–ª–∏ —Ä—É—á–Ω–æ–π cooldown (1 sec –º–µ–∂–¥—É sync-–∫–Ω–æ–ø–∫–∞–º–∏, 0.5 sec –º–µ–∂–¥—É –æ–±—ã—á–Ω—ã–º–∏).

### 9) Health-–º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –∏ –∞–ª–µ—Ä—Ç–∏–Ω–≥
- **`/health` endpoint** ‚Äî –æ–±—è–∑–∞—Ç–µ–ª–µ–Ω –≤ webhook-—Ä–µ–∂–∏–º–µ. –ü—Ä–æ–≤–µ—Ä—è–µ—Ç: (1) DB `SELECT 1`, (2) –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç `200 OK` + JSON —Å–æ —Å—Ç–∞—Ç—É—Å–æ–º.
  Railway –∏ –ª—é–±–æ–π –±–∞–ª–∞–Ω—Å–∏—Ä–æ–≤—â–∏–∫ –∏—Å–ø–æ–ª—å–∑—É—é—Ç health-check –¥–ª—è –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞ –º—ë—Ä—Ç–≤—ã—Ö –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤.
- **–ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ –æ—à–∏–±–∫–∏ ‚Üí —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ** ‚Äî –ø—Ä–∏ `logger.exception()` –≤ –±–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫–µ –æ—Ç–ø—Ä–∞–≤–ª—è—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ –∞–¥–º–∏–Ω–∞–º (Telegram).
  –õ–æ–≥–∏ –Ω–∞ Railway –Ω–∏–∫—Ç–æ –Ω–µ –º–æ–Ω–∏—Ç–æ—Ä–∏—Ç –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏. –ê–ª–µ—Ä—Ç –≤ Telegram ‚Äî –±–µ—Å–ø–ª–∞—Ç–Ω—ã–π –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥.
- **Staleness detection** ‚Äî –µ—Å–ª–∏ –ø–æ—Å–ª–µ–¥–Ω–∏–π `SyncLog` —Å—Ç–∞—Ä—à–µ 24—á, –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ –ø—Ä–∏ —Å–ª–µ–¥—É—é—â–µ–º –∑–∞–ø—É—Å–∫–µ –±–æ—Ç–∞ –∏–ª–∏ –ø–æ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏—é.
- **Startup self-check** ‚Äî –ø—Ä–∏ —Å—Ç–∞—Ä—Ç–µ –±–æ—Ç–∞ –ø—Ä–æ–≤–µ—Ä—è—Ç—å: DB alive, iiko token –ø–æ–ª—É—á–∞–µ—Ç—Å—è, FinTablo –¥–æ—Å—Ç—É–ø–µ–Ω. Fail-fast –µ—Å–ª–∏ –Ω–µ—Ç.

### 10) Graceful Shutdown & –¶–µ–ª–æ—Å—Ç–Ω–æ—Å—Ç—å —Å–æ—Å—Ç–æ—è–Ω–∏—è
- **Pending writeoffs ‚Üí –≤ –ë–î** ‚Äî in-memory `_pending` dict —Ç–µ—Ä—è–µ—Ç—Å—è –ø—Ä–∏ —Ä–µ—Å—Ç–∞—Ä—Ç–µ. –î–ª—è production: —Ö—Ä–∞–Ω–∏—Ç—å –≤ —Ç–∞–±–ª–∏—Ü–µ `pending_writeoffs` —Å TTL.
  –ü–æ–∫–∞ –≤ RAM ‚Äî –ø—Ä–∏–Ω—è—Ç—å —Ä–∏—Å–∫, –Ω–æ **–ª–æ–≥–∏—Ä–æ–≤–∞—Ç—å –ø—Ä–∏ shutdown** —á—Ç–æ –∏–º–µ–Ω–Ω–æ –ø–æ—Ç–µ—Ä—è–Ω–æ (doc_id, user_id).
- **SIGTERM** ‚Äî Railway —à–ª—ë—Ç `SIGTERM`, –Ω–µ `KeyboardInterrupt`. –î–æ–±–∞–≤–∏—Ç—å `signal.signal(SIGTERM, handler)` –¥–ª—è polling-—Ä–µ–∂–∏–º–∞.
- **Background tasks** ‚Äî –≤—Å–µ `asyncio.create_task()` —Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å –≤ `set()`.
  –ü—Ä–∏ shutdown: `await asyncio.gather(*tasks, return_exceptions=True)` —Å timeout 10 —Å–µ–∫.
- **Cleanup order**: (1) –æ—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –ø—Ä–∏—ë–º –æ–±–Ω–æ–≤–ª–µ–Ω–∏–π ‚Üí (2) –¥–æ–∂–¥–∞—Ç—å—Å—è background tasks ‚Üí (3) flush pending state ‚Üí (4) –∑–∞–∫—Ä—ã—Ç—å HTTP-–∫–ª–∏–µ–Ω—Ç—ã ‚Üí (5) dispose DB engine.

### 11) –ö–æ–Ω–∫—É—Ä–µ–Ω—Ç–Ω–æ—Å—Ç—å –æ–ø–µ—Ä–∞—Ü–∏–π
- **Sync-lock** ‚Äî `asyncio.Lock()` per entity type. –û–¥–Ω–∞ –∏ —Ç–∞ –∂–µ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è –Ω–µ –º–æ–∂–µ—Ç –∑–∞–ø—É—Å–∫–∞—Ç—å—Å—è –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ –¥–≤—É–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º–∏.
  –ü—Ä–∏ –ø–æ–ø—ã—Ç–∫–µ: `await callback.answer("‚è≥ –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è —É–∂–µ –∑–∞–ø—É—â–µ–Ω–∞"); return`.
- **Double-click –Ω–∞ –¥–æ—Ä–æ–≥–∏–µ –æ–ø–µ—Ä–∞—Ü–∏–∏** ‚Äî –ø–∞—Ç—Ç–µ—Ä–Ω: `if user_id in _lock: answer("‚è≥"); return` ‚Üí `_lock.add(user_id)` ‚Üí `try: ... finally: _lock.discard(user_id)`.
- **Atomic admin operations** ‚Äî —Ä–æ–ª–∏ (–∞–¥–º–∏–Ω, –ø–æ–ª—É—á–∞—Ç–µ–ª—å) —á–∏—Ç–∞—é—Ç—Å—è –∏–∑ GSheet-–∫–µ—à–∞ (TTL 5 –º–∏–Ω). –ò–∑–º–µ–Ω–µ–Ω–∏—è –≤ —Ç–∞–±–ª–∏—Ü–µ –ø–æ–¥—Ö–≤–∞—Ç—ã–≤–∞—é—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø—Ä–∏ —Å–ª–µ–¥—É—é—â–µ–º –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ –∫–µ—à–∞.
- **Write-after-read consistency** ‚Äî –µ—Å–ª–∏ —á–∏—Ç–∞–µ—à—å –∏–∑ –∫–µ—à–∞ –∏ –ø–∏—à–µ—à—å –ø–æ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—É, —É–±–µ–¥–∏—Å—å —á—Ç–æ –∫–µ—à –Ω–µ —É—Å—Ç–∞—Ä–µ–ª (re-fetch –µ—Å–ª–∏ TTL > 50%).

### 13) UX: —Å–∫–æ—Ä–æ—Å—Ç—å –∏ —á–∏—Å—Ç–æ—Ç–∞ —á–∞—Ç–∞ (–û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–û)
- **–û–¥–Ω–æ –æ–∫–Ω–æ:** inline-–∫–Ω–æ–ø–∫–∏ ‚Üí `edit_text()`, –ù–ò–ö–û–ì–î–ê `answer()`. Reply-–∫–Ω–æ–ø–∫–∏ ‚Üí delete old + send new (—á–µ—Ä–µ–∑ `_menu_msg_id` –≤ state).
- **Edit-first –ø–∞—Ç—Ç–µ—Ä–Ω:** `_send_prompt()` –∏ `_update_summary()` —Å–Ω–∞—á–∞–ª–∞ `edit_message_text()`, fallback –Ω–∞ `send_message()`. **–ù–µ —É–¥–∞–ª—è—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ + –æ—Ç–ø—Ä–∞–≤–ª—è—Ç—å –Ω–æ–≤–æ–µ** ‚Äî —Ç–æ–ª—å–∫–æ edit.
- **`/cancel` ‚Üí edit prompt:** –ø—Ä–∏ –æ—Ç–º–µ–Ω–µ ‚Äî —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å prompt-—Å–æ–æ–±—â–µ–Ω–∏–µ, –∞ –Ω–µ —É–¥–∞–ª—è—Ç—å + –ø—Ä–∏—Å—ã–ª–∞—Ç—å –Ω–æ–≤–æ–µ.
- **NavResetMiddleware:** outer-middleware –Ω–∞ `dp.message`, –ø–µ—Ä–µ—Ö–≤–∞—Ç—ã–≤–∞–µ—Ç 55+ Reply-–∫–Ω–æ–ø–æ–∫ –Ω–∞–≤–∏–≥–∞—Ü–∏–∏ –ø—Ä–∏ –∞–∫—Ç–∏–≤–Ω–æ–º FSM ‚Üí —Å–±—Ä–æ—Å + cleanup ‚Üí –∫–Ω–æ–ø–∫–∞ –ø—Ä–æ—Ö–æ–¥–∏—Ç –∫ —à—Ç–∞—Ç–Ω–æ–º—É —Ö—ç–Ω–¥–ª–µ—Ä—É. –ò—Å–∫–ª—é—á–∞–µ—Ç ¬´–∑–∞–≤–∏—Å–∞–Ω–∏–µ¬ª –±–æ—Ç–∞.
- **Cancel-keyboard –≤–æ flow'–∞—Ö:** –ø—Ä–∏ –≤—Ö–æ–¥–µ –≤ dialog-flow ‚Üí `set_cancel_kb()` —Å–∫—Ä—ã–≤–∞–µ—Ç Reply-–∫–ª–∞–≤–∏–∞—Ç—É—Ä—É –ø–æ–¥–º–µ–Ω—é –∏ –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç —Ç–æ–ª—å–∫–æ ¬´‚ùå –û—Ç–º–µ–Ω–∞¬ª. –ü—Ä–∏ –≤—ã—Ö–æ–¥–µ ‚Üí `restore_menu_kb()` –≤–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç –∫–ª–∞–≤–∏–∞—Ç—É—Ä—É –ø–æ–¥–º–µ–Ω—é. Keyboard-—Ñ—É–Ω–∫—Ü–∏–∏ ‚Äî –≤ `bot/middleware.py`.
- **Placeholder ‚Üí edit:** –ª—é–±–∞—è –æ–ø–µ—Ä–∞—Ü–∏—è >1 —Å–µ–∫ ‚Üí `"‚è≥ ..."` placeholder ‚Üí `edit_text("‚úÖ —Ä–µ–∑—É–ª—å—Ç–∞—Ç")`. –ù–µ –æ—Ç–ø—Ä–∞–≤–ª—è—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç –æ—Ç–¥–µ–ª—å–Ω—ã–º —Å–æ–æ–±—â–µ–Ω–∏–µ–º.
- **–ü—Ä–æ–≥—Ä–µ—Å—Å –¥–ª–∏–Ω–Ω—ã—Ö –æ–ø–µ—Ä–∞—Ü–∏–π (>5 —Å–µ–∫):** –æ–±–Ω–æ–≤–ª—è—Ç—å placeholder –ø–æ—à–∞–≥–æ–≤–æ (¬´‚úÖ –°–ø—Ä–∞–≤–æ—á–Ω–∏–∫–∏... ‚è≥ –ù–æ–º–µ–Ω–∫–ª–∞—Ç—É—Ä–∞...¬ª).
- **ChatAction.typing** ‚Äî –ø–µ—Ä–µ–¥ –ª—é–±–æ–π DB/API –æ–ø–µ—Ä–∞—Ü–∏–µ–π –≤ text-handler'e –≥–¥–µ –Ω–µ—Ç inline-–∫–Ω–æ–ø–æ–∫.
- **–¢–µ–∫—Å—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è ‚Üí —É–¥–∞–ª—è—Ç—å –í–°–ï–ì–î–ê** (`try: await message.delete()`). –ù–µ—Ç –∏—Å–∫–ª—é—á–µ–Ω–∏–π.
- **–û—à–∏–±–∫–∏ –≤–∞–ª–∏–¥–∞—Ü–∏–∏ ‚Üí edit prompt**, –Ω–µ –Ω–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ. 5 –æ—à–∏–±–æ–∫ –ø–æ–¥—Ä—è–¥ = 1 —Å–æ–æ–±—â–µ–Ω–∏–µ –±–æ—Ç–∞, –Ω–µ 5.
- **Prefetch** ‚Äî –ø—Ä–∏ –≤—Ö–æ–¥–µ –≤ —Ä–∞–∑–¥–µ–ª –≥—Ä—É–∑–∏—Ç—å –¥–∞–Ω–Ω—ã–µ —Å–ª–µ–¥—É—é—â–µ–≥–æ —à–∞–≥–∞ —Ñ–æ–Ω–æ–º (`asyncio.create_task`).
- **Cache warmup** ‚Äî –ø—Ä–∏ —Å—Ç–∞—Ä—Ç–µ –±–æ—Ç–∞ –ø—Ä–æ–≥—Ä–µ–≤–∞—Ç—å user_context –∏ admin_ids.
- **user_context TTL** ‚Äî 30 –º–∏–Ω (–Ω–µ –±–µ—Å–∫–æ–Ω–µ—á–Ω—ã–π). –ò–Ω–∞—á–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è –≤ iiko –Ω–µ –æ—Ç—Ä–∞–∂–∞—é—Ç—Å—è.
- –ü–æ–¥—Ä–æ–±–Ω—ã–µ –ø–∞—Ç—Ç–µ—Ä–Ω—ã —Å –∫–æ–¥–æ–º ‚Äî —Å–º. `docs/UX_PATTERNS.md`.

### 14) –ß–µ–∫–ª–∏—Å—Ç –¥–µ–ø–ª–æ—è (–æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–π)

**–ü–µ—Ä–µ–¥ –¥–µ–ø–ª–æ–µ–º:**
- [ ] –í—Å–µ env vars –∑–∞–¥–∞–Ω—ã (–ø—Ä–æ–≤–µ—Ä–∏—Ç—å `config.py _require()`)
- [ ] DB –º–∏–≥—Ä–∞—Ü–∏–∏ –ø—Ä–∏–º–µ–Ω–µ–Ω—ã (`python -m db.init_db`)
- [ ] –ù–µ—Ç `print()`, –Ω–µ—Ç hardcoded secrets, –Ω–µ—Ç `LOG_LEVEL=DEBUG` –≤ production
- [ ] Health endpoint –æ—Ç–≤–µ—á–∞–µ—Ç (–µ—Å–ª–∏ webhook-—Ä–µ–∂–∏–º)
- [ ] `Procfile` —É–∫–∞–∑—ã–≤–∞–µ—Ç –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π —Ç–∏–ø (`web` –¥–ª—è webhook, `worker` –¥–ª—è polling)
- [ ] Webhook URL –∫–æ—Ä—Ä–µ–∫—Ç–µ–Ω –∏ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç `https://`

**–ü–æ—Å–ª–µ –¥–µ–ø–ª–æ—è:**
- [ ] –ë–æ—Ç –æ—Ç–≤–µ—á–∞–µ—Ç –Ω–∞ `/start` –≤ —Ç–µ—á–µ–Ω–∏–µ 5 —Å–µ–∫
- [ ] Health endpoint –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç `200`
- [ ] SyncLog –ø–∏—à–µ—Ç—Å—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ (–∑–∞–ø—É—Å—Ç–∏—Ç—å –ª—é–±—É—é sync –≤—Ä—É—á–Ω—É—é)
- [ ] –õ–æ–≥–∏ —á–∏—Å—Ç—ã–µ –Ω–∞ INFO-—É—Ä–æ–≤–Ω–µ (–Ω–µ—Ç —Ç–æ–∫–µ–Ω–æ–≤, –Ω–µ—Ç —Ç—Ä–µ–π—Å–±–µ–∫–æ–≤)
- [ ] Webhook –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω —Å `secret_token`

---

## ‚öôÔ∏è –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è (.env)

| –ü–µ—Ä–µ–º–µ–Ω–Ω–∞—è | –û–±—è–∑–∞—Ç. | –û–ø–∏—Å–∞–Ω–∏–µ |
|------------|---------|-------------------------------------------|
| `DATABASE_URL` | ‚úÖ | PostgreSQL connection string (`postgresql+asyncpg://...`) |
| `IIKO_BASE_URL` | ‚úÖ | –ë–∞–∑–æ–≤—ã–π URL iiko API (`https://ip-merzlyakov-e-a-co.iiko.it`) |
| `IIKO_LOGIN` | ‚úÖ | –õ–æ–≥–∏–Ω iiko API |
| `IIKO_SHA1_PASSWORD` | ‚úÖ | SHA1-—Ö–µ—à –ø–∞—Ä–æ–ª—è iiko |
| `FINTABLO_TOKEN` | ‚úÖ | Bearer-—Ç–æ–∫–µ–Ω FinTablo API |
| `TELEGRAM_BOT_TOKEN` | ‚úÖ | –¢–æ–∫–µ–Ω Telegram-–±–æ—Ç–∞ (–æ—Ç @BotFather) |
| `TIMEZONE` | ‚Äî | –ó–∞—Ö–∞—Ä–¥–∫–æ–∂–µ–Ω `Europe/Kaliningrad` –≤ `config.py`. Env-–ø–µ—Ä–µ–º–µ–Ω–Ω–∞—è **–Ω–µ —á–∏—Ç–∞–µ—Ç—Å—è** |
| `FINTABLO_BASE_URL` | ‚ùå | Base URL FinTablo (–¥–µ—Ñ–æ–ª—Ç `https://api.fintablo.ru`) |
| `WEBHOOK_URL` | ‚ùå | URL —Å–µ—Ä–≤–∏—Å–∞ –Ω–∞ Railway (`https://xxx.up.railway.app`). –ï—Å–ª–∏ –∑–∞–¥–∞–Ω ‚Äî webhook, –∏–Ω–∞—á–µ polling |
| `WEBHOOK_PATH` | ‚ùå | –ü—É—Ç—å –≤–µ–±—Ö—É–∫–∞ (–¥–µ—Ñ–æ–ª—Ç `/webhook`) |
| `PORT` | ‚ùå | –ü–æ—Ä—Ç –≤–µ–±-—Å–µ—Ä–≤–µ—Ä–∞ (Railway –∑–∞–¥–∞—ë—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏, –¥–µ—Ñ–æ–ª—Ç `8080`) |
| `LOG_LEVEL` | ‚ùå | –£—Ä–æ–≤–µ–Ω—å –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è (–¥–µ—Ñ–æ–ª—Ç `INFO`) |
| `INVOICE_PRICE_SHEET_ID` | ‚ùå | Google Sheet ID –¥–ª—è –ø—Ä–∞–π—Å-–ª–∏—Å—Ç–∞ (—Ü–µ–Ω—ã –ø–æ—Å—Ç–∞–≤—â–∏–∫–æ–≤ ‚Üí –ë–î) |
| `GOOGLE_SHEETS_CREDENTIALS` | ‚úÖ | –ü—É—Ç—å –∫ JSON-—Ñ–∞–π–ª—É Service Account **–∏–ª–∏** inline JSON (Railway). –ö–æ–¥ –æ–ø—Ä–µ–¥–µ–ª—è–µ—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø–æ `startswith("{")` |
| `MIN_STOCK_SHEET_ID` | ‚ùå | ID Google –¢–∞–±–ª–∏—Ü—ã (–º–∏–Ω. –æ—Å—Ç–∞—Ç–∫–∏, –ø—Ä–∞–≤–∞, –Ω–∞—Å—Ç—Ä–æ–π–∫–∏). –î–µ—Ñ–æ–ª—Ç –∑–∞—Ö–∞—Ä–¥–∫–æ–∂–µ–Ω –≤ `config.py` |
| `IIKO_CLOUD_ORG_ID` | ‚ùå | UUID –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏–∏ –≤ iikoCloud (–¥–ª—è –≤–µ–±—Ö—É–∫–æ–≤). Fallback: `ORG_ID` (—Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å). –ï—Å–ª–∏ –Ω–µ –∑–∞–¥–∞–Ω ‚Äî –ø–æ–ª—É—á–∏—Ç—å —á–µ—Ä–µ–∑ –∫–Ω–æ–ø–∫—É ¬´üìã –ü–æ–ª—É—á–∏—Ç—å –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏–∏¬ª |
| `IIKO_CLOUD_BASE_URL` | ‚ùå | –ë–∞–∑–æ–≤—ã–π URL iikoCloud (–¥–µ—Ñ–æ–ª—Ç `https://api-ru.iiko.services`) |
| `STOCK_CHANGE_THRESHOLD_PCT` | ‚ùå | –ü–æ—Ä–æ–≥ –∏–∑–º–µ–Ω–µ–Ω–∏—è **–ª—é–±–æ–π –ø–æ–∑–∏—Ü–∏–∏** –≤ % (–¥–µ—Ñ–æ–ª—Ç `3.0`, –±—ã–ª–æ `5.0`). –ü—Ä–∏ –∏–∑–º–µ–Ω. >= –ø–æ—Ä–æ–≥–∞ ‚Üí —Ç—Ä–∏–≥–≥–µ—Ä –æ—Ç–ø—Ä–∞–≤–∫–∏ |
| `STOCK_UPDATE_INTERVAL_MIN` | ‚ùå | –ú–∏–Ω–∏–º–∞–ª—å–Ω—ã–π –∏–Ω—Ç–µ—Ä–≤–∞–ª –º–µ–∂–¥—É –æ—Ç–ø—Ä–∞–≤–∫–∞–º–∏ –æ—Å—Ç–∞—Ç–∫–æ–≤ –≤ –º–∏–Ω—É—Ç–∞—Ö (–¥–µ—Ñ–æ–ª—Ç `30`). –ê–Ω—Ç–∏—Å–ø–∞–º: –Ω–µ —á–∞—â–µ 1 —Ä–∞–∑–∞ –≤ N –º–∏–Ω |
| `IIKO_CLOUD_WEBHOOK_SECRET` | ‚ùå | authToken –¥–ª—è –≤–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏–∏ –≤—Ö–æ–¥—è—â–∏—Ö –≤–µ–±—Ö—É–∫–æ–≤ –æ—Ç iikoCloud (–¥–µ—Ñ–æ–ª—Ç: auto-generated) |
| `IIKO_VERIFY_SSL` | ‚ùå | SSL-–≤–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏—è –¥–ª—è iiko on-premise (`true`/`false`/–ø—É—Ç—å –∫ CA-bundle). –î–µ—Ñ–æ–ª—Ç `false` |
| `WEBHOOK_SECRET` | ‚ùå | –°–µ–∫—Ä–µ—Ç –¥–ª—è Telegram webhook `secret_token`. –î–µ—Ñ–æ–ª—Ç: auto-generated –ø—Ä–∏ –∫–∞–∂–¥–æ–º —Å—Ç–∞—Ä—Ç–µ |
| `WEBAPP_HOST` | ‚ùå | –•–æ—Å—Ç –≤–µ–±-—Å–µ—Ä–≤–µ—Ä–∞ (–¥–µ—Ñ–æ–ª—Ç `0.0.0.0`) |
| `GEMINI_API_KEY` | ‚úÖ* | API-–∫–ª—é—á Google Gemini –¥–ª—è OCR (Gemini Vision). *–û–±—è–∑–∞—Ç–µ–ª–µ–Ω –µ—Å–ª–∏ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è OCR |
| `GEMINI_MODEL` | ‚ùå | –ú–æ–¥–µ–ª—å Gemini (–¥–µ—Ñ–æ–ª—Ç `gemini-3-flash-preview`) |
| `OCR_DEFAULT_STORE_ID` | ‚ùå | UUID —Å–∫–ª–∞–¥–∞ –¥–ª—è –ø—Ä–∏—Ö–æ–¥–Ω—ã—Ö –Ω–∞–∫–ª–∞–¥–Ω—ã—Ö. –ï—Å–ª–∏ –Ω–µ –∑–∞–¥–∞–Ω ‚Äî –∞–≤—Ç–æ-–æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –ø–æ buyer —á–µ—Ä–µ–∑ fuzzy match |

> **–£–¥–∞–ª–µ–Ω–æ –∏–∑ config.py:** `STOCK_CHECK_ORDER_INTERVAL` (–±—ã–ª deprecated, —É–¥–∞–ª—ë–Ω), `OPENAI_API_KEY`, `GOOGLE_SHEETS_ID` (—Ñ–∞–Ω—Ç–æ–º–Ω—ã–µ –∑–∞–ø–∏—Å–∏).

–í—Å–µ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ —á–∏—Ç–∞—é—Ç—Å—è —á–µ—Ä–µ–∑ `_require()` –≤ `config.py` ‚Äî **fail-fast** —Å –ø–æ–Ω—è—Ç–Ω–æ–π –æ—à–∏–±–∫–æ–π –µ—Å–ª–∏ –ø—É—Å—Ç–æ.

---

## üõ† –ö–æ–º–∞–Ω–¥—ã

```bash
# –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π
pip install -r requirements.txt

# –°–æ–∑–¥–∞–Ω–∏–µ —Ç–∞–±–ª–∏—Ü
python -m db.init_db

# –ó–∞–ø—É—Å–∫ –±–æ—Ç–∞
python main.py
```

---

## ‚è∞ –ê–≤—Ç–æ—Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è (APScheduler)

| –ü–∞—Ä–∞–º–µ—Ç—Ä | –ó–Ω–∞—á–µ–Ω–∏–µ |
|-----------|----------|
| –õ–∏–±—Ä–∞ | `apscheduler` (AsyncIOScheduler + CronTrigger) |
| –†–∞—Å–ø–∏—Å–∞–Ω–∏–µ | –ï–∂–µ–¥–Ω–µ–≤–Ω–æ –≤ **07:00** –ø–æ `Europe/Kaliningrad` (–ø–æ–ª–Ω–∞—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è) + **22:00** (–æ—Ç—á—ë—Ç —Å—Ç–æ–ø-–ª–∏—Å—Ç–∞) |
| –ß—Ç–æ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä—É–µ—Ç—Å—è | 07:00: iiko (—Å–ø—Ä–∞–≤–æ—á–Ω–∏–∫–∏ + –ø–æ–¥—Ä–∞–∑–¥–µ–ª–µ–Ω–∏—è + –Ω–æ–º–µ–Ω–∫–ª–∞—Ç—É—Ä–∞) + FinTablo (–≤—Å–µ 13) + –æ—Å—Ç–∞—Ç–∫–∏ + min/max –∏–∑ GSheet |
| | 22:00: –µ–∂–µ–≤–µ—á–µ—Ä–Ω–∏–π –æ—Ç—á—ë—Ç —Å—Ç–æ–ø-–ª–∏—Å—Ç–∞ (—Å—É–º–º–∞—Ä–Ω–æ–µ –≤—Ä–µ–º—è –≤ —Å—Ç–æ–ø–µ –∑–∞ –¥–µ–Ω—å) |
| –ú–æ–¥—É–ª—å | `use_cases/scheduler.py` |
| –ó–∞–ø—É—Å–∫ | `start_scheduler(bot)` –≤ `main.py` (–æ–±–∞ —Ä–µ–∂–∏–º–∞: webhook + polling) |
| Shutdown | `stop_scheduler()` –≤ `on_shutdown()` + `run_polling()` finally |
| `triggered_by` | `"scheduler"` (–≤ SyncLog –¥–ª—è –∞—É–¥–∏—Ç–∞) |
| –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è | –ê–¥–º–∏–Ω—ã –ø–æ–ª—É—á–∞—é—Ç –æ—Ç—á—ë—Ç –≤ Telegram –ø–æ—Å–ª–µ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏ |
| misfire_grace_time | 3600—Å (1 —á–∞—Å) ‚Äî –µ—Å–ª–∏ –±–æ—Ç –±—ã–ª –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω, –∑–∞–¥–∞—á–∞ –≤—ã–ø–æ–ª–Ω–∏—Ç—Å—è |

---

## üîî –í–µ–±—Ö—É–∫–∏ iikoCloud –∏ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è

### –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –≤–µ–±—Ö—É–∫–æ–≤

```
iikoCloud POST /iiko-webhook
  ‚îú‚îÄ StopListUpdate ‚Üí debounce 60 —Å–µ–∫ ‚Üí fetch ‚Üí diff ‚Üí delete old msg ‚Üí send new ‚Üí pin
  ‚îÇ   ‚îî‚îÄ –ü–æ–ª—É—á–∞—Ç–µ–ª–∏: –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ —Å —Ñ–ª–∞–≥–æ–º ¬´üö´ –°—Ç–æ–ø-–ª–∏—Å—Ç¬ª –≤ GSheet (–∏–ª–∏ –≤—Å–µ, –µ—Å–ª–∏ –Ω–∏–∫—Ç–æ –Ω–µ –æ—Ç–º–µ—á–µ–Ω)
  ‚îÇ   ‚îî‚îÄ Debounce: –ø—Ä–∏ —Å–µ—Ä–∏–∏ –≤–µ–±—Ö—É–∫–æ–≤ (10 –ø–æ–∑–∏—Ü–∏–π = 10 –≤–µ–±—Ö—É–∫–æ–≤) ‚Äî –∂–¥—ë–º 60 —Å–µ–∫ —Ç–∏—à–∏–Ω—ã, –ø–æ—Ç–æ–º –æ–¥–∏–Ω flush
  ‚îÇ   ‚îî‚îÄ UX: –≤—Å–µ–≥–¥–∞ **delete ‚Üí send ‚Üí pin** (–Ω–µ edit) ‚Äî –∫–∞–∂–¥–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –≤—Å–ø–ª—ã–≤–∞–µ—Ç –Ω–∞–≤–µ—Ä—Ö –≤ —á–∞—Ç–µ
  ‚îî‚îÄ DeliveryOrderUpdate / TableOrderUpdate (status=Closed)
      ‚Üí sync –æ—Å—Ç–∞—Ç–∫–æ–≤ –∏–∑ iiko REST API
      ‚Üí –ø–æ–∫–æ–º–ø–æ–Ω–µ–Ω—Ç–Ω–æ–µ —Å—Ä–∞–≤–Ω–µ–Ω–∏–µ: –ø—Ä–æ–≤–µ—Ä—è–µ–º –ö–ê–ñ–î–£–Æ –ø–æ–∑–∏—Ü–∏—é –Ω–∏–∂–µ –º–∏–Ω–∏–º—É–º–∞ –æ—Ç–¥–µ–ª—å–Ω–æ
      ‚Üí —Ç—Ä–∏–≥–≥–µ—Ä –æ—Ç–ø—Ä–∞–≤–∫–∏ –µ—Å–ª–∏ —Ö–æ—Ç—è –±—ã –æ–¥–Ω–æ –∏–∑:
          ‚Ä¢ –õ—é–±–∞—è –ø–æ–∑–∏—Ü–∏—è –∏–∑–º–µ–Ω–∏–ª–∞—Å—å >= 3% (–Ω–∞—Å—Ç—Ä.: STOCK_CHANGE_THRESHOLD_PCT)
          ‚Ä¢ –ü–æ—è–≤–∏–ª–∏—Å—å –Ω–æ–≤—ã–µ –ø–æ–∑–∏—Ü–∏–∏ –Ω–∏–∂–µ –º–∏–Ω–∏–º—É–º–∞
          ‚Ä¢ –ö–∞–∫–∏–µ-—Ç–æ –ø–æ–∑–∏—Ü–∏–∏ –∏—Å—á–µ–∑–ª–∏ (—Å—Ç–∞–ª–∏ –≤—ã—à–µ –º–∏–Ω–∏–º—É–º–∞)
          ‚Ä¢ –ü—Ä–æ—à–ª–æ >= 30 –º–∏–Ω —Å –ø–æ—Å–ª–µ–¥–Ω–µ–π –æ—Ç–ø—Ä–∞–≤–∫–∏ –ò –µ—Å—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è (–∞–Ω—Ç–∏—Å–ø–∞–º)
      ‚Üí delete old msg ‚Üí send new ‚Üí pin
      ‚îî‚îÄ –ü–æ–ª—É—á–∞—Ç–µ–ª–∏: –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ —Å —Ñ–ª–∞–≥–æ–º ¬´üì¶ –û—Å—Ç–∞—Ç–∫–∏¬ª –≤ GSheet (–∏–ª–∏ –≤—Å–µ, –µ—Å–ª–∏ –Ω–∏–∫—Ç–æ –Ω–µ –æ—Ç–º–µ—á–µ–Ω)
```

### –°—Ç–æ–ø-–ª–∏—Å—Ç: —Ñ–æ—Ä–º–∞—Ç —Å–æ–æ–±—â–µ–Ω–∏—è

```
–ù–æ–≤—ã–µ –±–ª—é–¥–∞ –≤ —Å—Ç–æ–ø-–ª–∏—Å—Ç–µ üö´
‚ñ´Ô∏è –ë–ª—é –º–∞–Ω–∫–∏ ‚Äî —Å—Ç–æ–ø
‚ñ´Ô∏è –¢–∞—Ä—Ç–∞—Ä –∏–∑ –≥–æ–≤—è–¥–∏–Ω—ã ‚Äî —Å—Ç–æ–ø

–£–¥–∞–ª–µ–Ω—ã –∏–∑ —Å—Ç–æ–ø-–ª–∏—Å—Ç–∞ ‚úÖ
‚ñ´Ô∏è ‚Äî

–û—Å—Ç–∞–ª–∏—Å—å –≤ —Å—Ç–æ–ø-–ª–∏—Å—Ç–µ
‚ñ´Ô∏è –ö–æ–∫–æ—Å–æ–≤–æ–µ –º–æ–ª–æ–∫–æ ‚Äî —Å—Ç–æ–ø

#—Å—Ç–æ–ø–ª–∏—Å—Ç
```

- –í—Å–µ–≥–¥–∞ **delete ‚Üí send ‚Üí pin** (–Ω–µ edit) ‚Äî —Å–≤–µ–∂–µ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –ø—Ä–∏ –∫–∞–∂–¥–æ–º –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ –≤—Å–ø–ª—ã–≤–∞–µ—Ç –Ω–∞–≤–µ—Ä—Ö
- –ü–æ–∑–∏—Ü–∏–∏ –æ—Ç—Å–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω—ã –ø–æ –∞–ª—Ñ–∞–≤–∏—Ç—É –≤–Ω—É—Ç—Ä–∏ –∫–∞–∂–¥–æ–≥–æ –±–ª–æ–∫–∞
- –ü—Ä–∏ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ / —Å–º–µ–Ω–µ –ø–æ–¥—Ä–∞–∑–¥–µ–ª–µ–Ω–∏—è ‚Äî –ø–æ–ª–Ω—ã–π —Å—Ç–æ–ø-–ª–∏—Å—Ç (–±–µ–∑ –¥–∏—Ñ–∞)

### –û—Å—Ç–∞—Ç–∫–∏: –ª–æ–≥–∏–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è (–ø–æ–∫–æ–º–ø–æ–Ω–µ–Ω—Ç–Ω–∞—è, —Å –∞–Ω—Ç–∏—Å–ø–∞–º–æ–º)

**–ß—Ç–æ –æ—Ç—Å–ª–µ–∂–∏–≤–∞–µ—Ç—Å—è:**
- –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø—Ä–∏ **–∫–∞–∂–¥–æ–º** –∑–∞–∫—Ä—ã—Ç–æ–º –∑–∞–∫–∞–∑–µ
- –°—Ä–∞–≤–Ω–∏–≤–∞—é—Ç—Å—è **—Ç–æ–ª—å–∫–æ –ø–æ–∑–∏—Ü–∏–∏ –Ω–∏–∂–µ –º–∏–Ω–∏–º–∞–ª—å–Ω—ã—Ö –æ—Å—Ç–∞—Ç–∫–æ–≤** (check_min_stock_levels)
- **–ü–æ–∫–æ–º–ø–æ–Ω–µ–Ω—Ç–Ω–æ–µ —Å—Ä–∞–≤–Ω–µ–Ω–∏–µ**: –∫–∞–∂–¥–∞—è –ø–æ–∑–∏—Ü–∏—è –ø—Ä–æ–≤–µ—Ä—è–µ—Ç—Å—è –æ—Ç–¥–µ–ª—å–Ω–æ (–Ω–µ —Å—É–º–º–∞—Ä–Ω–æ–µ –∏–∑–º–µ–Ω–µ–Ω–∏–µ!)

**–¢—Ä–∏–≥–≥–µ—Ä—ã –æ—Ç–ø—Ä–∞–≤–∫–∏** (–µ—Å–ª–∏ —Ö–æ—Ç—è –±—ã –æ–¥–∏–Ω —Å—Ä–∞–±–æ—Ç–∞–ª):
1. ‚úÖ **–ü–µ—Ä–≤–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞** –ø–æ—Å–ª–µ —Ä–µ—Å—Ç–∞—Ä—Ç–∞ (–Ω–µ—Ç –ø—Ä–µ–¥—ã–¥—É—â–µ–≥–æ —Å–Ω—ç–ø—à–æ—Ç–∞)
2. ‚úÖ **–õ—é–±–∞—è –ø–æ–∑–∏—Ü–∏—è** –∏–∑–º–µ–Ω–∏–ª–∞—Å—å >= `STOCK_CHANGE_THRESHOLD_PCT` (–¥–µ—Ñ–æ–ª—Ç 3%)
   ```
   –ú–æ–ª–æ–∫–æ: 10–ª ‚Üí 6.5–ª = -35% >= 3% ‚Üí –û–¢–ü–†–ê–í–ò–ú
   ```
3. ‚úÖ **–ü–æ—è–≤–∏–ª–∏—Å—å –Ω–æ–≤—ã–µ** –ø–æ–∑–∏—Ü–∏–∏ –Ω–∏–∂–µ –º–∏–Ω–∏–º—É–º–∞
   ```
   –°–∞—Ö–∞—Ä: –Ω–µ –±—ã–ª–æ ‚Üí 5–∫–≥ (–º–∏–Ω 20–∫–≥) ‚Üí –û–¢–ü–†–ê–í–ò–ú
   ```
4. ‚úÖ **–ò—Å—á–µ–∑–ª–∏ –ø–æ–∑–∏—Ü–∏–∏** (—Å—Ç–∞–ª–∏ –≤—ã—à–µ –º–∏–Ω–∏–º—É–º–∞)
   ```
   –ú–∞—Å–ª–æ: –±—ã–ª–æ –≤ —Å–ø–∏—Å–∫–µ ‚Üí –∏—Å—á–µ–∑–ª–æ ‚Üí –û–¢–ü–†–ê–í–ò–ú
   ```
5. ‚úÖ **–ü—Ä–æ—à–ª–æ >= `STOCK_UPDATE_INTERVAL_MIN`** (–¥–µ—Ñ–æ–ª—Ç 30 –º–∏–Ω) —Å –ø–æ—Å–ª–µ–¥–Ω–µ–π –æ—Ç–ø—Ä–∞–≤–∫–∏ **–ò** –µ—Å—Ç—å —Ö–æ—Ç—å –∫–∞–∫–∏–µ-—Ç–æ –∏–∑–º–µ–Ω–µ–Ω–∏—è

**–ê–Ω—Ç–∏—Å–ø–∞–º** (–ù–ï –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º):
- ‚ùå –•–µ—à –Ω–µ –∏–∑–º–µ–Ω–∏–ª—Å—è (–Ω–∏—á–µ–≥–æ –Ω–µ –∏–∑–º–µ–Ω–∏–ª–æ—Å—å)
- ‚ùå –í—Å–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è < 3% **–ò** –ø—Ä–æ—à–ª–æ < 30 –º–∏–Ω

**UX:**
- –í—Å–µ–≥–¥–∞ **delete ‚Üí send ‚Üí pin** (–Ω–µ edit) ‚Äî —Å–≤–µ–∂–µ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –≤—Å–ø–ª—ã–≤–∞–µ—Ç –Ω–∞–≤–µ—Ä—Ö
- Per-department: –∫–∞–∂–¥—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤–∏–¥–∏—Ç –æ—Å—Ç–∞—Ç–∫–∏ **—Å–≤–æ–µ–≥–æ** –ø–æ–¥—Ä–∞–∑–¥–µ–ª–µ–Ω–∏—è

**–ü—Ä–∏–º–µ—Ä—ã –ª–æ–≥–æ–≤:**
```
[iikoWebhook] –ü–æ–∑–∏—Ü–∏—è '–ú–æ–ª–æ–∫–æ / –ö—É—Ö–Ω—è' –∏–∑–º–µ–Ω–∏–ª–∞—Å—å 35.2% >= 3.0% (10.0 ‚Üí 6.5) ‚Äî –æ–±–Ω–æ–≤–ª—è–µ–º
[iikoWebhook] –ü–æ—è–≤–∏–ª–æ—Å—å 2 –Ω–æ–≤—ã—Ö –ø–æ–∑–∏—Ü–∏–π –Ω–∏–∂–µ –º–∏–Ω–∏–º—É–º–∞: [('–°–∞—Ö–∞—Ä', '–ö—É—Ö–Ω—è'), ...] ‚Äî –æ–±–Ω–æ–≤–ª—è–µ–º
[iikoWebhook] –í—Å–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è < 3.0% (–º–∞–∫—Å 1.8% —É '–ú—É–∫–∞') –ò –ø—Ä–æ—à–ª–æ 12 –º–∏–Ω < 30 –º–∏–Ω ‚Äî –ø—Ä–æ–ø—É—Å–∫–∞–µ–º (–∞–Ω—Ç–∏—Å–ø–∞–º)
[iikoWebhook] –ü—Ä–æ—à–ª–æ 45 –º–∏–Ω >= 30 –º–∏–Ω + –µ—Å—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è (–º–∞–∫—Å 2.1%) ‚Äî –æ–±–Ω–æ–≤–ª—è–µ–º
```

### –ú–∞–ø–ø–∏–Ω–≥ –ø–æ–¥—Ä–∞–∑–¥–µ–ª–µ–Ω–∏–π ‚Üí Cloud-–æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏–π

- **iiko Server** department UUID ‚â† **iikoCloud** organization UUID (—Ä–∞–∑–Ω—ã–µ —Å–∏—Å—Ç–µ–º—ã)
- –ú–∞–ø–ø–∏–Ω–≥ —Ö—Ä–∞–Ω–∏—Ç—Å—è –≤ GSheet ¬´–ù–∞—Å—Ç—Ä–æ–π–∫–∏¬ª (–ª–∏—Å—Ç —Å–æ–∑–¥–∞—ë—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏)
- –ö–æ–ª–æ–Ω–∫–∞ C ‚Äî **–≤—ã–ø–∞–¥–∞—é—â–∏–π —Å–ø–∏—Å–æ–∫** —Å Cloud-–æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏—è–º–∏, UUID –ø–æ–¥—Å—Ç–∞–≤–ª—è–µ—Ç—Å—è —Ñ–æ—Ä–º—É–ª–æ–π VLOOKUP
- –ö–µ—à: in-memory dict —Å TTL 5 –º–∏–Ω (`use_cases/cloud_org_mapping.py`)
- Fallback: env `IIKO_CLOUD_ORG_ID` ‚Üí env `ORG_ID` ‚Üí None
- –ö–Ω–æ–ø–∫–∞ ¬´üîó –ü—Ä–∏–≤—è–∑–∞—Ç—å –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏–∏¬ª ‚Äî —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è –ø–æ–¥—Ä–∞–∑–¥–µ–ª–µ–Ω–∏–π + Cloud-–æ—Ä–≥ –≤ GSheet

### –ü–æ–¥–ø–∏—Å–∫–∏ –Ω–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è (—Ä–æ–ª–∏ –≤ ¬´–ü—Ä–∞–≤–∞ –¥–æ—Å—Ç—É–ø–∞¬ª)

| –†–æ–ª—å | –°—Ç–æ–ª–±–µ—Ü GSheet | –ß—Ç–æ –ø–æ–ª—É—á–∞–µ—Ç |
|------|----------------|--------------|
| üëë –ê–¥–º–∏–Ω | ¬´üëë –ê–¥–º–∏–Ω¬ª | Bypass –≤—Å–µ—Ö –ø—Ä–∞–≤, –æ—Ç—á—ë—Ç—ã —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏ |
| üì¨ –ü–æ–ª—É—á–∞—Ç–µ–ª—å | ¬´üì¨ –ü–æ–ª—É—á–∞—Ç–µ–ª—å¬ª | –ó–∞—è–≤–∫–∏ –Ω–∞ —Ç–æ–≤–∞—Ä—ã |
| üì¶ –û—Å—Ç–∞—Ç–∫–∏ | ¬´üì¶ –û—Å—Ç–∞—Ç–∫–∏¬ª | –ó–∞–∫—Ä–µ–ø–ª—ë–Ω–Ω—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è —Å –æ—Å—Ç–∞—Ç–∫–∞–º–∏ –Ω–∏–∂–µ –º–∏–Ω–∏–º—É–º–∞ |
| üö´ –°—Ç–æ–ø-–ª–∏—Å—Ç | ¬´üö´ –°—Ç–æ–ø-–ª–∏—Å—Ç¬ª | –ó–∞–∫—Ä–µ–ø–ª—ë–Ω–Ω—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è —Å–æ —Å—Ç–æ–ø-–ª–∏—Å—Ç–æ–º |
| üìë –ë—É—Ö–≥–∞–ª—Ç–µ—Ä | ¬´üìë –ë—É—Ö–≥–∞–ª—Ç–µ—Ä¬ª | OCR-–¥–æ–∫—É–º–µ–Ω—Ç—ã –Ω–∞ —Å–æ–≥–ª–∞—Å–æ–≤–∞–Ω–∏–µ (–ø—Ä–∏—Ö–æ–¥–Ω—ã–µ –Ω–∞–∫–ª–∞–¥–Ω—ã–µ / —É—Å–ª—É–≥–∏) |

- –ï—Å–ª–∏ **–Ω–∏ —É –∫–æ–≥–æ** –Ω–µ—Ç ‚úÖ –≤ —Å—Ç–æ–ª–±—Ü–µ ‚Äî —Ä–∞—Å—Å—ã–ª–∫–∞ –∏–¥—ë—Ç **–≤—Å–µ–º** –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω–Ω—ã–º (bootstrap)
- –ö–∞–∫ —Ç–æ–ª—å–∫–æ —Ö–æ—Ç—è –±—ã –æ–¥–∏–Ω –æ—Ç–º–µ—á–µ–Ω ‚Äî —Ç–æ–ª—å–∫–æ –æ—Ç–º–µ—á–µ–Ω–Ω—ã–º

---

## üì¶ –ó–∞—è–≤–∫–∏ –Ω–∞ —Ç–æ–≤–∞—Ä—ã: –∞–≤—Ç–æ-–æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ —Å–∫–ª–∞–¥–æ–≤ –∏ –∫–æ–Ω—Ç—Ä–∞–≥–µ–Ω—Ç–æ–≤

### –ü–æ—Ç–æ–∫ —Å–æ–∑–¥–∞–Ω–∏—è –∑–∞—è–≤–∫–∏ (FSM)

```
üìã –ó–∞—è–≤–∫–∏ ‚Üí [–±–ª–æ–∫–∏—Ä–æ–≤–∫–∏] ‚Üí –ø–æ–∏—Å–∫ —Ç–æ–≤–∞—Ä–æ–≤ ‚Üí –≤–≤–æ–¥ –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ ‚Üí –ø—Ä–µ–≤—å—é ‚Üí –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ
  ‚îî‚îÄ –ë–ª–æ–∫–∏—Ä–æ–≤–∫–∏:
  ‚îÇ   ‚îú‚îÄ –ì–æ—Å—Ç—å (–Ω–µ—Ç department) ‚Üí ¬´–°–≤—è–∂–∏—Ç–µ—Å—å —Å –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–º¬ª
  ‚îÇ   ‚îî‚îÄ department == ¬´–ó–∞–≤–µ–¥–µ–Ω–∏–µ –¥–ª—è –∑–∞—è–≤–æ–∫¬ª ‚Üí ¬´–°–º–µ–Ω–∏—Ç–µ –ø–æ–¥—Ä–∞–∑–¥–µ–ª–µ–Ω–∏–µ¬ª
  ‚îî‚îÄ –ê–≤—Ç–æ-—Å–æ–ø–æ—Å—Ç–∞–≤–ª–µ–Ω–∏–µ —Å–∫–ª–∞–¥–æ–≤:
  ‚îÇ   ‚îú‚îÄ source store = PriceProduct.store_name (—Å–∫–ª–∞–¥ –∏–∑ –ø—Ä–∞–π—Å-–ª–∏—Å—Ç–∞, –ø—Ä–∏–Ω–∞–¥–ª–µ–∂–∏—Ç ¬´–ó–∞–≤–µ–¥. –¥–ª—è –∑–∞—è–≤–æ–∫¬ª)
  ‚îÇ   ‚îú‚îÄ target store = —Å–∫–ª–∞–¥ —Ç–æ–≥–æ –∂–µ —Ç–∏–ø–∞ –≤ –ø–æ–¥—Ä–∞–∑–¥–µ–ª–µ–Ω–∏–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
  ‚îÇ   ‚îî‚îÄ —Ç–∏–ø –∏–∑–≤–ª–µ–∫–∞–µ—Ç—Å—è: ¬´PizzaYolo: –ö—É—Ö–Ω—è (–ú–æ—Å–∫–æ–≤—Å–∫–∏–π)¬ª ‚Üí ¬´–∫—É—Ö–Ω—è¬ª
  ‚îî‚îÄ –ê–≤—Ç–æ-–æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –∫–æ–Ω—Ç—Ä–∞–≥–µ–Ω—Ç–∞:
      ‚îî‚îÄ –∏—â–µ—Ç—Å—è iiko_supplier –ø–æ –∏–º–µ–Ω–∏ target-—Å–∫–ª–∞–¥–∞ (exact ‚Üí partial)
```

**FSM-—Å–æ—Å—Ç–æ—è–Ω–∏—è:** `CreateRequestStates`: `add_items ‚Üí enter_item_qty ‚Üí confirm`
(—à–∞–≥ –≤—ã–±–æ—Ä–∞ –ø–æ—Å—Ç–∞–≤—â–∏–∫–∞ —É–¥–∞–ª—ë–Ω ‚Äî –∫–æ–Ω—Ç—Ä–∞–≥–µ–Ω—Ç –∞–≤—Ç–æ-–æ–ø—Ä–µ–¥–µ–ª—è–µ—Ç—Å—è –ø–æ —Ü–µ–ª–µ–≤–æ–º—É —Å–∫–ª–∞–¥—É)

### –ê–≤—Ç–æ-—Å–æ–ø–æ—Å—Ç–∞–≤–ª–µ–Ω–∏–µ —Å–∫–ª–∞–¥–æ–≤ (store type matching)

- –ö–∞–∂–¥—ã–π —Ç–æ–≤–∞—Ä –≤ –ø—Ä–∞–π—Å-–ª–∏—Å—Ç–µ –ø—Ä–∏–≤—è–∑–∞–Ω –∫ **source-—Å–∫–ª–∞–¥—É** (–∫–æ–ª–æ–Ω–∫–∞ C ¬´–°–∫–ª–∞–¥¬ª –≤ GSheet, –ø—Ä–∏–Ω–∞–¥–ª–µ–∂–∏—Ç ¬´–ó–∞–≤–µ–¥–µ–Ω–∏—é –¥–ª—è –∑–∞—è–≤–æ–∫¬ª)
- –ü—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –∑–∞—è–≤–∫–∏ –¥–ª—è –∫–∞–∂–¥–æ–≥–æ —Ç–æ–≤–∞—Ä–∞:
  1. –ò–∑ –∏–º–µ–Ω–∏ source-—Å–∫–ª–∞–¥–∞ –∏–∑–≤–ª–µ–∫–∞–µ—Ç—Å—è **—Ç–∏–ø** (`extract_store_type`): —É–±–∏—Ä–∞–µ—Ç—Å—è –±—Ä–µ–Ω–¥ –¥–æ `:` –∏ —Å—É—Ñ—Ñ–∏–∫—Å –≤ —Å–∫–æ–±–∫–∞—Ö ‚Üí `"–∫—É—Ö–Ω—è"`, `"–±–∞—Ä"`, `"—Ç–º—Ü"`
  2. –í –ø–æ–¥—Ä–∞–∑–¥–µ–ª–µ–Ω–∏–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏—â–µ—Ç—Å—è —Å–∫–ª–∞–¥ —Ç–æ–≥–æ –∂–µ —Ç–∏–ø–∞ (`build_store_type_map` ‚Üí `resolve_target_store`)
  3. `target_store_id` / `target_store_name` —Å–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è –≤ item dict
- –ì—Ä—É–ø–ø–∏—Ä–æ–≤–∫–∞ –∏ –æ—Ç–ø—Ä–∞–≤–∫–∞ ‚Äî –ø–æ **target-—Å–∫–ª–∞–¥–∞–º** (–Ω–µ source)
- –ï—Å–ª–∏ —Å–æ–ø–æ—Å—Ç–∞–≤–ª–µ–Ω–∏–µ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ ‚Äî –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è source-—Å–∫–ª–∞–¥ –∫–∞–∫ fallback
- –ü—Ä–µ–≤—å—é: `üè® <target_store_name>:` + —Å–ø–∏—Å–æ–∫ –ø–æ–∑–∏—Ü–∏–π

### –ê–≤—Ç–æ-–æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –∫–æ–Ω—Ç—Ä–∞–≥–µ–Ω—Ç–∞

- –ü—Ä–∏ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–∏ –∑–∞—è–≤–∫–∏ –¥–ª—è –∫–∞–∂–¥–æ–π –≥—Ä—É–ø–ø—ã (target store):
  1. `find_counteragent_for_store(target_store_name)` ‚Äî –ø–æ–∏—Å–∫ `iiko_supplier` –ø–æ —Ç–æ—á–Ω–æ–º—É –∏–º–µ–Ω–∏, –∑–∞—Ç–µ–º –ø–æ `ILIKE %name%`
  2. Fallback: `find_counteragent_for_store(source_store_name)`
  3. –ï—Å–ª–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω ‚Äî –±–æ—Ç —Å–æ–æ–±—â–∞–µ—Ç –æ–± –æ—à–∏–±–∫–µ
- –ö–æ–Ω—Ç—Ä–∞–≥–µ–Ω—Ç –æ–ø—Ä–µ–¥–µ–ª—è–µ—Ç—Å—è **per group**, —Ç.–∫. —Ä–∞–∑–Ω—ã–µ —Å–∫–ª–∞–¥—ã ‚Üí —Ä–∞–∑–Ω—ã–µ –∫–æ–Ω—Ç—Ä–∞–≥–µ–Ω—Ç—ã

### –ë–ª–æ–∫–∏—Ä–æ–≤–∫–∏

| –£—Å–ª–æ–≤–∏–µ | –†–µ–∞–∫—Ü–∏—è |
|---------|---------|
| –ì–æ—Å—Ç—å (–Ω–µ—Ç `department_id` –≤ `user_context`) | ¬´–°–≤—è–∂–∏—Ç–µ—Å—å —Å –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–º¬ª ‚Äî –∫–Ω–æ–ø–∫–∏ –Ω–µ –ø–æ–∫–∞–∑—ã–≤–∞—é—Ç—Å—è |
| `department_id` == UUID ¬´–ó–∞–≤–µ–¥–µ–Ω–∏—è –¥–ª—è –∑–∞—è–≤–æ–∫¬ª –∏–∑ –Ω–∞—Å—Ç—Ä–æ–µ–∫ | ¬´–í–∞—à–µ –ø–æ–¥—Ä–∞–∑–¥–µ–ª–µ–Ω–∏–µ —Å–æ–≤–ø–∞–¥–∞–µ—Ç —Å –∑–∞–≤–µ–¥–µ–Ω–∏–µ–º –¥–ª—è –∑–∞—è–≤–æ–∫. –°–º–µ–Ω–∏—Ç–µ –ø–æ–¥—Ä–∞–∑–¥–µ–ª–µ–Ω–∏–µ¬ª |
| –ù–µ—Ç —Å–∫–ª–∞–¥–æ–≤ –¥–ª—è –ø–æ–¥—Ä–∞–∑–¥–µ–ª–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è | ¬´–î–ª—è –≤–∞—à–µ–≥–æ –ø–æ–¥—Ä–∞–∑–¥–µ–ª–µ–Ω–∏—è –Ω–µ –Ω–∞–π–¥–µ–Ω—ã —Å–∫–ª–∞–¥—ã¬ª |

### –ú–æ–¥—É–ª–∏

| –ú–æ–¥—É–ª—å | –†–æ–ª—å |
|--------|------|
| `bot/request_handlers.py` | FSM-—Ö—ç–Ω–¥–ª–µ—Ä—ã, –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏, –≥—Ä—É–ø–ø–∏—Ä–æ–≤–∫–∞ –ø–æ target-—Å–∫–ª–∞–¥–∞–º, –ø—Ä–µ–≤—å—é, –∞–≤—Ç–æ-–∫–æ–Ω—Ç—Ä–∞–≥–µ–Ω—Ç, –æ—Ç–ø—Ä–∞–≤–∫–∞ N –∑–∞—è–≤–æ–∫ |
| `use_cases/outgoing_invoice.py` | `search_price_products()` ‚Äî –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç store_id/store_name; `get_product_store_map()` ‚Äî bulk-–∑–∞–ø—Ä–æ—Å —Å–∫–ª–∞–¥–æ–≤ |
| `use_cases/product_request.py` | `create_request()`, `extract_store_type()`, `build_store_type_map()`, `resolve_target_store()`, `find_counteragent_for_store()` |

### GSheet ¬´–ü—Ä–∞–π—Å-–ª–∏—Å—Ç¬ª ‚Äî —Å—Ç—Ä—É–∫—Ç—É—Ä–∞

| –ö–æ–ª–æ–Ω–∫–∞ | –°–æ–¥–µ—Ä–∂–∞–Ω–∏–µ |
|---------|------------|
| A | –ù–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ —Ç–æ–≤–∞—Ä–∞ |
| B | product_id (UUID) |
| C | **–°–∫–ª–∞–¥** (dropdown ‚Äî —Å–∫–ª–∞–¥—ã –≤—ã–±—Ä–∞–Ω–Ω–æ–≥–æ –∑–∞–≤–µ–¥–µ–Ω–∏—è –∏–∑ `iiko_store` –ø–æ `parent_id`) |
| D | –°—Ç–æ–∏–º–æ—Å—Ç—å |
| E..N | –ü–æ—Å—Ç–∞–≤—â–∏–∫–∏ (–¥–æ 10 –∫–æ–ª–æ–Ω–æ–∫) |

`num_fixed = 4` (—Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –∫–æ–ª–æ–Ω–∫–∏ A‚ÄìD, –¥–∞–ª–µ–µ –ø–æ—Å—Ç–∞–≤—â–∏–∫–∏)

### GSheet ¬´–ù–∞—Å—Ç—Ä–æ–π–∫–∏¬ª ‚Äî –∑–∞–≤–µ–¥–µ–Ω–∏–µ –¥–ª—è –∑–∞—è–≤–æ–∫

–°–µ–∫—Ü–∏—è `## –ó–∞–≤–µ–¥–µ–Ω–∏–µ –¥–ª—è –∑–∞—è–≤–æ–∫` (–≥–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª—å–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç, –æ–¥–Ω–∞ —Å—Ç—Ä–æ–∫–∞):
- A = "–ó–∞–≤–µ–¥–µ–Ω–∏–µ –∫—É–¥–∞ –ø—Ä–∏—Ö–æ–¥—è—Ç –∑–∞—è–≤–∫–∏" (label)
- C = –≤—ã–ø–∞–¥–∞—é—â–∏–π —Å–ø–∏—Å–æ–∫ –ø–æ–¥—Ä–∞–∑–¥–µ–ª–µ–Ω–∏–π (dropdown, `department_type=DEPARTMENT`)
- D = VLOOKUP ‚Üí department_uuid (–∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∏–∑ —Å–ø—Ä–∞–≤–æ—á–Ω–∏–∫–∞ E:F)
- E:F = —Å–∫—Ä—ã—Ç—ã–π —Å–ø—Ä–∞–≤–æ—á–Ω–∏–∫ (name ‚Üí uuid) –¥–ª—è VLOOKUP
- –°—Ç–æ–ª–±–µ—Ü B/D —Å–∫—Ä—ã—Ç—ã —Å–µ–∫—Ü–∏–µ–π iikoCloud; —Å—Ç–æ–ª–±–µ—Ü C —è–≤–Ω–æ UNHIDE
- –ü—Ä–∏ —Å–º–µ–Ω–µ dropdown ‚Üí UUID –≤ D –æ–±–Ω–æ–≤–ª—è–µ—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏
- –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ: `read_request_stores()` / `sync_request_stores_to_sheet()`

---

## üåç –ß–∞—Å–æ–≤–æ–π –ø–æ—è—Å

| –ü–∞—Ä–∞–º–µ—Ç—Ä | –ó–Ω–∞—á–µ–Ω–∏–µ |
|-----------|----------|
| Timezone | `Europe/Kaliningrad` (UTC+2) |
| –ö–æ–Ω—Å—Ç–∞–Ω—Ç–∞ | `config.TIMEZONE` |
| –•–µ–ª–ø–µ—Ä | `use_cases._helpers.now_kgd()` ‚Üí naive datetime –ø–æ –ö–∞–ª–∏–Ω–∏–Ω–≥—Ä–∞–¥—É |
| –ë–î –º–æ–¥–µ–ª–∏ | `db/models.py:_utcnow()` –∏ `db/ft_models.py:_utcnow()` ‚Äî –≤–æ–∑–≤—Ä–∞—â–∞—é—Ç –∫–∞–ª–∏–Ω–∏–Ω–≥—Ä–∞–¥—Å–∫–æ–µ –≤—Ä–µ–º—è |
| –§–æ—Ä–º–∞—Ç –ë–î | `TIMESTAMP WITHOUT TIME ZONE` (–≤—Å–µ –∑–Ω–∞—á–µ–Ω–∏—è = –ö–∞–ª–∏–Ω–∏–Ω–≥—Ä–∞–¥) |
| PDF-–¥–æ–∫—É–º–µ–Ω—Ç—ã | `now_kgd()` –¥–ª—è –¥–∞—Ç—ã –¥–æ–∫—É–º–µ–Ω—Ç–∞ |
| iiko API timestamp | `now_kgd()` –¥–ª—è –∑–∞–ø—Ä–æ—Å–æ–≤ –æ—Å—Ç–∞—Ç–∫–æ–≤ |
| SyncLog | `started_at`, `finished_at` ‚Äî –∫–∞–ª–∏–Ω–∏–Ω–≥—Ä–∞–¥—Å–∫–æ–µ –≤—Ä–µ–º—è |

---

## ÔøΩ OCR-—Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏–µ –±—É—Ö–≥–∞–ª—Ç–µ—Ä—Å–∫–∏—Ö –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤ (Gemini Vision)

### –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ (FOOL-PROOF)

```
–§–æ—Ç–æ (1-14 —à—Ç—É–∫) ‚Üí Telegram album collector (4.0 —Å–µ–∫, buffer by user_id)
  ‚Üí preprocess (–∫–æ–Ω—Ç—Ä–∞—Å—Ç √ó1.5, —Ä–µ–∑–∫–æ—Å—Ç—å √ó2.0, RGB JPEG)
  ‚Üí –®–ê–ì 1: extract_document_metadata() ‚Äî –±—ã—Å—Ç—Ä—ã–π Gemini-–ø—Ä–æ–º–ø—Ç –¥–ª—è –ö–ê–ñ–î–û–ì–û —Ñ–æ—Ç–æ –ü–ê–†–ê–õ–õ–ï–õ–¨–ù–û
    (–Ω–æ–º–µ—Ä –¥–æ–∫—É–º–µ–Ω—Ç–∞, –¥–∞—Ç–∞, –ø–æ—Å—Ç–∞–≤—â–∏–∫/–ò–ù–ù, has_total, page_number)
  ‚Üí –®–ê–ì 2: group_photos_by_document() ‚Äî –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –≥—Ä—É–ø–ø–∏—Ä–æ–≤–∫–∞
    (–æ–¥–∏–Ω–∞–∫–æ–≤—ã–µ supplier+doc_number+date = –æ–¥–∏–Ω –¥–æ–∫—É–º–µ–Ω—Ç –Ω–∞ –Ω–µ—Å–∫–æ–ª—å–∫–∏—Ö –ª–∏—Å—Ç–∞—Ö)
  ‚Üí –®–ê–ì 3: –¥–ª—è –∫–∞–∂–¥–æ–π –≥—Ä—É–ø–ø—ã –æ—Ç–¥–µ–ª—å–Ω–æ:
    ‚îú‚îÄ 1 —Ñ–æ—Ç–æ ‚Üí recognize_document() (–æ–¥–Ω–æ—Å—Ç—Ä–∞–Ω–∏—á–Ω—ã–π)
    ‚îî‚îÄ N —Ñ–æ—Ç–æ ‚Üí recognize_multiple_pages() (–º–Ω–æ–≥–æ—Å—Ç—Ä–∞–Ω–∏—á–Ω—ã–π, –æ–±—ä–µ–¥–∏–Ω—è–µ—Ç items)
  ‚Üí –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –∫–∞—á–µ—Å—Ç–≤–∞ (70% –ø–æ—Ä–æ–≥)
  ‚Üí –∫–∞–∂–¥—ã–π –¥–æ–∫—É–º–µ–Ω—Ç ‚Üí –û–¢–î–ï–õ–¨–ù–û–ï —Å–æ–æ–±—â–µ–Ω–∏–µ –±—É—Ö–≥–∞–ª—Ç–µ—Ä—É
  ‚Üí –º–∞–ø–ø–∏–Ω–≥ —Ç–æ–≤–∞—Ä–æ–≤ + –ø–æ—Å—Ç–∞–≤—â–∏–∫–∞ (fuzzy match)
    ‚îú‚îÄ 1. ocr_item_mapping (–æ–±—É—á–µ–Ω–Ω—ã–µ) ‚Äî –ø–æ—Ä–æ–≥ 85%
    ‚îú‚îÄ 2. iiko_product (–Ω–æ–º–µ–Ω–∫–ª–∞—Ç—É—Ä–∞) ‚Äî –ø–æ—Ä–æ–≥ 80%
    ‚îú‚îÄ 3. GSheet ¬´OCR –ú–∞–ø–ø–∏–Ω–≥¬ª ‚Äî —Ä—É—á–Ω–æ–π –º–∞–ø–ø–∏–Ω–≥
    ‚îî‚îÄ –ê–≤—Ç–æ–æ–±—É—á–µ–Ω–∏–µ: –∫–∞–∂–¥—ã–π –º–∞–ø–ø–∏–Ω–≥ —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è –≤ –ë–î
  ‚Üí —Ç–æ–≤–∞—Ä: –±—É—Ö–≥–∞–ª—Ç–µ—Ä ‚Üí ‚úÖ –û—Ç–ø—Ä–∞–≤–∏—Ç—å –≤ iiko (–ø—Ä–∏—Ö–æ–¥–Ω–∞—è –Ω–∞–∫–ª–∞–¥–Ω–∞—è XML)
  ‚Üí —É—Å–ª—É–≥–∞: –±—É—Ö–≥–∞–ª—Ç–µ—Ä ‚Üí ‚úÖ –ü—Ä–∏–Ω—è—Ç–æ (—Ç–æ–ª—å–∫–æ –æ–∑–Ω–∞–∫–æ–º–ª–µ–Ω–∏–µ, –±–µ–∑ iiko)
```

**–ü—Ä–∏–º–µ—Ä—ã —Ä–∞–±–æ—Ç—ã:**
- 14 —Ä–∞–∑–Ω—ã—Ö —á–µ–∫–æ–≤ ‚Üí 14 –æ—Ç–¥–µ–ª—å–Ω—ã—Ö –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤ ‚Üí 14 —Å–æ–æ–±—â–µ–Ω–∏–π –±—É—Ö–≥–∞–ª—Ç–µ—Ä—É
- 1 –£–ü–î –Ω–∞ 3 –ª–∏—Å—Ç–∞—Ö (–æ–¥–∏–Ω–∞–∫–æ–≤—ã–π –ø–æ—Å—Ç–∞–≤—â–∏–∫ + –Ω–æ–º–µ—Ä + –¥–∞—Ç–∞) ‚Üí 1 –¥–æ–∫—É–º–µ–Ω—Ç
- 5 —á–µ–∫–æ–≤ + 1 –£–ü–î –Ω–∞ 2 –ª–∏—Å—Ç–∞—Ö ‚Üí 6 –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤ (5 + 1 –æ–±—ä–µ–¥–∏–Ω—ë–Ω–Ω—ã–π)

### ‚úÖ –†–µ—à—ë–Ω–Ω—ã–µ –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–Ω—ã–µ –ø—Ä–æ–±–ª–µ–º—ã

**–ú–Ω–æ–≥–æ—Å—Ç—Ä–∞–Ω–∏—á–Ω—ã–µ –¥–æ–∫—É–º–µ–Ω—Ç—ã** (–†–ï–®–ï–ù–û Feb 2026)
- –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –≥—Ä—É–ø–ø–∏—Ä–æ–≤–∫–∞ —á–µ—Ä–µ–∑ `extract_document_metadata()` + `group_photos_by_document()`
- –ö–ª—é—á –≥—Ä—É–ø–ø–∏—Ä–æ–≤–∫–∏: `(supplier_inn || supplier_name) + doc_number + date`
- –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø—Ä–æ—Å—Ç–æ –∫–∏–¥–∞–µ—Ç —Ñ–æ—Ç–æ ‚Äî —Å–∏—Å—Ç–µ–º–∞ —Å–∞–º–∞ —Ä–∞–∑–±–∏—Ä–∞–µ—Ç—Å—è

### ‚ö†Ô∏è –ò–∑–≤–µ—Å—Ç–Ω—ã–µ –ø—Ä–æ–±–ª–µ–º—ã

**–†—É–∫–æ–ø–∏—Å–Ω—ã–µ –¥–æ–∫—É–º–µ–Ω—Ç—ã**
- Handwritten receipts –ø–ª–æ—Ö–æ —Ä–∞—Å–ø–æ–∑–Ω–∞—é—Ç—Å—è Gemini Flash
- –°—Ç–∞—Ç—É—Å: ‚ö†Ô∏è low priority (—Ä–µ–¥–∫–∏–µ –¥–æ–∫—É–º–µ–Ω—Ç—ã)

### –ö–ª—é—á–µ–≤—ã–µ –º–æ–¥—É–ª–∏

| –ú–æ–¥—É–ª—å | –ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ | –ü–æ—Å–ª–µ–¥–Ω–∏–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è (Feb 2026) |
|--------|------------|-------------------------------|
| `adapters/gemini_vision.py` | Gemini Vision API: –ø—Ä–æ–º–ø—Ç, –ø–∞—Ä—Å–∏–Ω–≥ JSON | ‚úÖ `google-genai>=0.2.0` + `extract_document_metadata()` –¥–ª—è –≥—Ä—É–ø–ø–∏—Ä–æ–≤–∫–∏ |
| `use_cases/ocr_invoice.py` | OCR pipeline: —Ñ–æ—Ç–æ‚ÜíJSON‚Üí–≤–∞–ª–∏–¥–∞—Ü–∏—è‚Üí–ø—Ä–µ–≤—å—é, CRUD OcrDocument | ‚úÖ `group_photos_by_document()` + `process_photo_batch()` |
| `use_cases/ocr_mapping.py` | Fuzzy match —Ç–æ–≤–∞—Ä–æ–≤/–ø–æ—Å—Ç–∞–≤—â–∏–∫–æ–≤, –æ–±—É—á–µ–Ω–∏–µ, GSheet –º–∞–ø–ø–∏–Ω–≥ | ‚Äî |
| `use_cases/ocr_to_iiko.py` | –û—Ç–ø—Ä–∞–≤–∫–∞ –≤ iiko: resolve store, build items, XML import | ‚Äî |
| `bot/ocr_handlers.py` | Telegram-—Ö—ç–Ω–¥–ª–µ—Ä—ã OCR flow (FSM, album collection) | ‚úÖ Fool-proof `_run_ocr()` —Å auto-group, –ø—Ä–æ–≥—Ä–µ—Å—Å-–±–∞—Ä, batch-–æ—Ç–ø—Ä–∞–≤–∫–∞ |

### –õ–∏–º–∏—Ç—ã –∏ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è

| –ü–∞—Ä–∞–º–µ—Ç—Ä | –ó–Ω–∞—á–µ–Ω–∏–µ | –û–±–æ—Å–Ω–æ–≤–∞–Ω–∏–µ |
|----------|----------|-------------|
| `MAX_PHOTOS` | 14 —Ñ–æ—Ç–æ | Gemini Flash –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç ~16 –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π, –∏—Å–ø–æ–ª—å–∑—É–µ–º 14 –¥–ª—è –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏ |
| `ALBUM_WAIT_SEC` | 4.0 —Å–µ–∫ | Telegram —Ä–∞–∑–±–∏–≤–∞–µ—Ç >10 —Ñ–æ—Ç–æ –Ω–∞ —á–∞—Å—Ç–∏, –Ω—É–∂–Ω–æ –≤—Ä–µ–º—è —Å–æ–±—Ä–∞—Ç—å –≤—Å–µ (–±—ã–ª 2.0) |
| **Buffer strategy** | by `user_id` | Telegram –ø—Ä–∏—Å–≤–∞–∏–≤–∞–µ—Ç —Ä–∞–∑–Ω—ã–µ `media_group_id` —á–∞—Å—Ç—è–º –æ–¥–Ω–æ–≥–æ –∞–ª—å–±–æ–º–∞ (>10 —Ñ–æ—Ç–æ) |
| Quality threshold | 70% | –ú–∏–Ω–∏–º–∞–ª—å–Ω—ã–π confidence –¥–ª—è –∫–∞–∂–¥–æ–π –ø–æ–∑–∏—Ü–∏–∏ –¥–æ–∫—É–º–µ–Ω—Ç–∞ |
| Totals threshold | ¬±5‚ÇΩ | –î–æ–ø—É—Å—Ç–∏–º–æ–µ —Ä–∞—Å—Ö–æ–∂–¥–µ–Ω–∏–µ –º–µ–∂–¥—É —Å—É–º–º–∞–º–∏ —Å—Ç—Ä–æ–∫ –∏ –∏—Ç–æ–≥–æ–º –¥–æ–∫—É–º–µ–Ω—Ç–∞ |

### –ö–∞—Ç–µ–≥–æ—Ä–∏–∏ –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤ (goods / service)

| –ö–∞—Ç–µ–≥–æ—Ä–∏—è | –ü–æ—Ç–æ–∫ | –ö–Ω–æ–ø–∫–∏ –±—É—Ö–≥–∞–ª—Ç–µ—Ä–∞ |
|-----------|-------|--------------------|
| `goods` (—Ç–æ–≤–∞—Ä) | OCR ‚Üí –º–∞–ø–ø–∏–Ω–≥ ‚Üí –±—É—Ö–≥–∞–ª—Ç–µ—Ä ‚Üí iiko –ø—Ä–∏—Ö–æ–¥–Ω–∞—è | ‚úÖ –û—Ç–ø—Ä–∞–≤–∏—Ç—å –≤ iiko / üìã –≠—Ç–æ —É—Å–ª—É–≥–∞ / ‚ùå –û—Ç–∫–ª–æ–Ω–∏—Ç—å |
| `service` (—É—Å–ª—É–≥–∞) | OCR ‚Üí –±—É—Ö–≥–∞–ª—Ç–µ—Ä (–±–µ–∑ –º–∞–ø–ø–∏–Ω–≥–∞) | ‚úÖ –ü—Ä–∏–Ω—è—Ç–æ / ‚ùå –û—Ç–∫–ª–æ–Ω–∏—Ç—å |

**–°–∞–º–æ–æ–±—É—á–µ–Ω–∏–µ:** –±—É—Ö–≥–∞–ª—Ç–µ—Ä –Ω–∞–∂–∏–º–∞–µ—Ç ¬´üìã –≠—Ç–æ —É—Å–ª—É–≥–∞¬ª ‚Üí –ø–æ—Å—Ç–∞–≤—â–∏–∫ —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è –≤ `ocr_supplier_mapping` —Å `category="service"`. –ü—Ä–∏ —Å–ª–µ–¥—É—é—â–µ–º –¥–æ–∫—É–º–µ–Ω—Ç–µ –æ—Ç —ç—Ç–æ–≥–æ –ø–æ—Å—Ç–∞–≤—â–∏–∫–∞ —Å–∏—Å—Ç–µ–º–∞ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –æ–ø—Ä–µ–¥–µ–ª—è–µ—Ç –µ–≥–æ –∫–∞–∫ —É—Å–ª—É–≥—É.

### Media-group (–ø–∞—á–∫–∞ —Ñ–æ—Ç–æ) ‚Äî Album Collection Strategy

**–ü—Ä–æ–±–ª–µ–º–∞ Telegram:** –ü—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ >10 —Ñ–æ—Ç–æ –≤ –æ–¥–Ω–æ–º –∞–ª—å–±–æ–º–µ, Telegram **—Ä–∞–∑–±–∏–≤–∞–µ—Ç** –∏—Ö –Ω–∞ –Ω–µ—Å–∫–æ–ª—å–∫–æ –≥—Ä—É–ø–ø —Å **–†–ê–ó–ù–´–ú–ò** `media_group_id`:
- –ü–µ—Ä–≤—ã–µ 10 —Ñ–æ—Ç–æ ‚Üí `media_group_id_1`
- –°–ª–µ–¥—É—é—â–∏–µ 4 —Ñ–æ—Ç–æ ‚Üí `media_group_id_2`

**–†–µ—à–µ–Ω–∏–µ:** Buffer –ø–æ `user_id` –≤–º–µ—Å—Ç–æ `media_group_id`
```python
_album_buffer: dict[int, list[str]] = {}  # user_id ‚Üí [file_ids]
ALBUM_WAIT_SEC = 4.0  # –ñ–¥—ë–º 4 —Å–µ–∫—É–Ω–¥—ã –ø–æ—Å–ª–µ –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ —Ñ–æ—Ç–æ
```

**–ê–ª–≥–æ—Ä–∏—Ç–º:**
1. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø—Ä–∏—Å—ã–ª–∞–µ—Ç —Ñ–æ—Ç–æ ‚Üí –¥–æ–±–∞–≤–ª—è–µ–º `file_id` –≤ `_album_buffer[user_id]`
2. –ó–∞–ø—É—Å–∫–∞–µ–º/–ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞–µ–º —Ç–∞–π–º–µ—Ä –Ω–∞ 4 —Å–µ–∫—É–Ω–¥—ã
3. –ï—Å–ª–∏ –∑–∞ 4 —Å–µ–∫—É–Ω–¥—ã –Ω–æ–≤—ã—Ö —Ñ–æ—Ç–æ –Ω–µ—Ç ‚Üí –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –≤—Å–µ –Ω–∞–∫–æ–ø–ª–µ–Ω–Ω—ã–µ
4. –ï—Å–ª–∏ –ø—Ä–∏—à–ª–æ >14 —Ñ–æ—Ç–æ ‚Üí –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ + –æ–±—Ä–∞–±–æ—Ç–∫–∞ –ø–µ—Ä–≤—ã—Ö 14

**–û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è:**
- ‚úÖ –†–µ—à–∞–µ—Ç –ø—Ä–æ–±–ª–µ–º—É Telegram album splitting (10+4 —Ñ–æ—Ç–æ —Å–æ–±–∏—Ä–∞—é—Ç—Å—è –≤–º–µ—Å—Ç–µ)
- ‚ö†Ô∏è –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –º–æ–∂–µ—Ç –ø—Ä–∏—Å—ã–ª–∞—Ç—å 2 —Ä–∞–∑–Ω—ã—Ö –¥–æ–∫—É–º–µ–Ω—Ç–∞ –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–æ (–≤—Å–µ —Ñ–æ—Ç–æ –æ–±—ä–µ–¥–∏–Ω—è—Ç—Å—è)
- ‚ö†Ô∏è **–ö–†–ò–¢–ò–ß–ï–°–ö–ê–Ø –ü–†–û–ë–õ–ï–ú–ê:** –í—Å–µ —Ñ–æ—Ç–æ –º–µ—Ä–¥–∂–∞—Ç—Å—è –≤ –û–î–ò–ù –¥–æ–∫—É–º–µ–Ω—Ç (—Å–º. "–¢–µ–∫—É—â–∏–µ –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–Ω—ã–µ –ø—Ä–æ–±–ª–µ–º—ã" –≤—ã—à–µ)

### Fuzzy match (thefuzz)

| –ò—Å—Ç–æ—á–Ω–∏–∫ | –ü–æ—Ä–æ–≥ | –ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ |
|----------|-------|------------|
| `ocr_item_mapping` (–æ–±—É—á–µ–Ω–Ω—ã–µ) | 85% | –†–∞–Ω–µ–µ –∑–∞–º–∞–ø–ª–µ–Ω–Ω—ã–µ –Ω–∞–∑–≤–∞–Ω–∏—è —Ç–æ–≤–∞—Ä–æ–≤ |
| `iiko_product` (–Ω–æ–º–µ–Ω–∫–ª–∞—Ç—É—Ä–∞) | 80% | Fuzzy –ø–æ –≤—Å–µ–º GOODS+DISH –≤ iiko |
| `ocr_supplier_mapping` (–æ–±—É—á–µ–Ω–Ω—ã–µ) | 85% | –ü–æ—Å—Ç–∞–≤—â–∏–∫–∏ (–ø–æ –ò–ù–ù ‚Äî —Ç–æ—á–Ω–æ–µ, –ø–æ –∏–º–µ–Ω–∏ ‚Äî fuzzy) |
| `iiko_supplier` (—Å–ø—Ä–∞–≤–æ—á–Ω–∏–∫) | 85% | Fuzzy –ø–æ –ø–æ—Å—Ç–∞–≤—â–∏–∫–∞–º –≤ iiko |

### GSheet ¬´OCR –ú–∞–ø–ø–∏–Ω–≥¬ª

–õ–∏—Å—Ç —Å–æ–∑–¥–∞—ë—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø—Ä–∏ –ø–µ—Ä–≤–æ–º –Ω–µ–∑–∞–º–∞–ø–ª–µ–Ω–Ω–æ–º —Ç–æ–≤–∞—Ä–µ.

| –ö–æ–ª–æ–Ω–∫–∞ | –ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ |
|---------|------------|
| A | –ù–∞–∑–≤–∞–Ω–∏–µ (–∫–∞–∫ —Ä–∞—Å–ø–æ–∑–Ω–∞–ª LLM) |
| B | –ù–æ—Ä–º–∞–ª–∏–∑–æ–≤–∞–Ω–Ω–æ–µ –Ω–∞–∑–≤–∞–Ω–∏–µ |
| C | –¢–æ–≤–∞—Ä iiko (–≤—ã–ø–∞–¥–∞—é—â–∏–π —Å–ø–∏—Å–æ–∫ –∏–∑ `_OCR_Products`) |
| D | product_id (UUID) |
| E | –ü–æ—Å—Ç–∞–≤—â–∏–∫ (OCR) |
| F | –°—Ç–∞—Ç—É—Å (‚úÖ / ‚ùå) |

–í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—ã–π –ª–∏—Å—Ç `_OCR_Products` ‚Äî –∞–≤—Ç–æ–∑–∞–ø–æ–ª–Ω—è–µ—Ç—Å—è –Ω–æ–º–µ–Ω–∫–ª–∞—Ç—É—Ä–æ–π iiko (GOODS+DISH), –æ–±–µ—Å–ø–µ—á–∏–≤–∞–µ—Ç dropdown-—Å–ø–∏—Å–æ–∫ –≤ –∫–æ–ª–æ–Ω–∫–µ C.

### –ü—Ä–∏—Ö–æ–¥–Ω–∞—è –Ω–∞–∫–ª–∞–¥–Ω–∞—è –≤ iiko (XML)

```
POST /resto/api/documents/import/incomingInvoice?key=...
Content-Type: application/xml

<document>
  <documentNumber>...</documentNumber>
  <dateIncoming>YYYY-MM-DD HH:mm:ss</dateIncoming>
  <status>NEW</status>
  <defaultStore>{store_uuid}</defaultStore>
  <supplier>{supplier_uuid}</supplier>
  <items>
    <item>
      <product>{product_uuid}</product>
      <amount>qty</amount>
      <price>price</price>
      <sum>total</sum>
    </item>
  </items>
</document>
```

**–û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ —Å–∫–ª–∞–¥–∞ (store):**
1. `OCR_DEFAULT_STORE_ID` –∏–∑ env (–µ—Å–ª–∏ –∑–∞–¥–∞–Ω)
2. Fuzzy match `buyer_name` ‚Üí `iiko_store.name` (–ø–æ—Ä–æ–≥ 70%)
3. –ü–µ—Ä–≤—ã–π –Ω–µ-—É–¥–∞–ª—ë–Ω–Ω—ã–π —Å–∫–ª–∞–¥ (fallback)

### FSM-—Å–æ—Å—Ç–æ—è–Ω–∏—è OCR

| –°–æ—Å—Ç–æ—è–Ω–∏–µ | –û–ø–∏—Å–∞–Ω–∏–µ |
|-----------|----------|
| `OcrStates.waiting_photo` | –û–∂–∏–¥–∞–Ω–∏–µ —Ñ–æ—Ç–æ –¥–æ–∫—É–º–µ–Ω—Ç–∞ |
| `OcrStates.waiting_more_pages` | –û–∂–∏–¥–∞–Ω–∏–µ –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã—Ö —Å—Ç—Ä–∞–Ω–∏—Ü |
| `OcrStates.preview` | –ü—Ä–µ–≤—å—é —Å –∫–Ω–æ–ø–∫–∞–º–∏ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è |
| `OcrStates.waiting_mapping` | –û–∂–∏–¥–∞–Ω–∏–µ –º–∞–ø–ø–∏–Ω–≥–∞ –≤ GSheet |
| `OcrStates.waiting_accountant` | –û–∂–∏–¥–∞–Ω–∏–µ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è –±—É—Ö–≥–∞–ª—Ç–µ—Ä–∞ |

### –°—Ç–∞—Ç—É—Å—ã –¥–æ–∫—É–º–µ–Ω—Ç–∞ (ocr_document.status)

| –°—Ç–∞—Ç—É—Å | –ó–Ω–∞—á–µ–Ω–∏–µ |
|--------|----------|
| `recognized` | –†–∞—Å–ø–æ–∑–Ω–∞–Ω, –æ–∂–∏–¥–∞–µ—Ç –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è |
| `mapping` | –û–∂–∏–¥–∞–µ—Ç –º–∞–ø–ø–∏–Ω–≥–∞ —Ç–æ–≤–∞—Ä–æ–≤ |
| `pending_approval` | –û—Ç–ø—Ä–∞–≤–ª–µ–Ω –±—É—Ö–≥–∞–ª—Ç–µ—Ä—É |
| `sent_to_iiko` | –£—Å–ø–µ—à–Ω–æ –∑–∞–≥—Ä—É–∂–µ–Ω –≤ iiko |
| `acknowledged` | –£—Å–ª—É–≥–∞ ‚Äî –ø—Ä–∏–Ω—è—Ç–∞ –±—É—Ö–≥–∞–ª—Ç–µ—Ä–æ–º |
| `rejected` | –û—Ç–∫–ª–æ–Ω—ë–Ω –±—É—Ö–≥–∞–ª—Ç–µ—Ä–æ–º |
| `error` | –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –≤ iiko |

### –ó–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ OCR

| –ü–∞–∫–µ—Ç | –í–µ—Ä—Å–∏—è | –ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ | –ú–∏–≥—Ä–∞—Ü–∏–∏ |
|-------|--------|------------|----------|
| `google-genai` | >=0.2.0 | Gemini Vision API (–Ω–æ–≤—ã–π SDK) | ‚úÖ –ú–∏–≥—Ä–∏—Ä–æ–≤–∞–Ω–æ —Å `google-generativeai` (Feb 2026) |
| `thefuzz` | >=0.22.0 | Fuzzy matching (Levenshtein) | ‚Äî |
| `python-Levenshtein` | >=0.25.0 | C-–æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è –¥–ª—è thefuzz | ‚Äî |
| `Pillow` | >=10.0.0 | –ü—Ä–µ–¥–æ–±—Ä–∞–±–æ—Ç–∫–∞ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π | ‚Äî |

**‚ö†Ô∏è –í–ê–ñ–ù–û: –ú–∏–≥—Ä–∞—Ü–∏—è Google Gemini API**
–°—Ç–∞—Ä—ã–π –ø–∞–∫–µ—Ç `google-generativeai` deprecated —Å –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏—è–º–∏ FutureWarning.
–ù–æ–≤—ã–π API –∏—Å–ø–æ–ª—å–∑—É–µ—Ç **—Å–ª–æ–≤–∞—Ä–∏** –≤–º–µ—Å—Ç–æ `types.Part`:
```python
# –°–¢–ê–†–´–ô (deprecated)
from google.genai import types
contents = [types.Part.from_text(prompt), types.Part.from_bytes(...)]
config = types.GenerateContentConfig(temperature=0.1)

# –ù–û–í–´–ô (–∞–∫—Ç—É–∞–ª—å–Ω—ã–π)
contents = [
    {"text": prompt},
    {"inline_data": {"mime_type": "image/jpeg", "data": base64_data}}
]
config = {"temperature": 0.1}
```

---

## ÔøΩüîÆ –ü–ª–∞–Ω—ã / —Å–ª–µ–¥—É—é—â–∏–µ —à–∞–≥–∏

### OCR / Gemini Vision
- ‚úÖ ~~–ö–†–ò–¢–ò–ß–ù–û: –†–µ—à–∏—Ç—å –ø—Ä–æ–±–ª–µ–º—É –º–Ω–æ–≥–æ—Å—Ç—Ä–∞–Ω–∏—á–Ω—ã—Ö –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤~~ ‚Äî –í–´–ü–û–õ–ù–ï–ù–û (auto-group —á–µ—Ä–µ–∑ metadata extraction)
- ‚ö†Ô∏è –û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ —Ä—É–∫–æ–ø–∏—Å–Ω—ã—Ö –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤ ‚Üí –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (–Ω–∏–∑–∫–∏–π –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç)
- ‚úÖ ~~–ú–∏–≥—Ä–∞—Ü–∏—è –Ω–∞ –Ω–æ–≤—ã–π Google Gemini API (`google-genai`)~~ ‚Äî –í–´–ü–û–õ–ù–ï–ù–û
- ‚úÖ ~~–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –∫–∞—á–µ—Å—Ç–≤–∞ —Ñ–æ—Ç–æ~~ ‚Äî –í–´–ü–û–õ–ù–ï–ù–û
- ‚úÖ ~~–ü–æ–¥–¥–µ—Ä–∂–∫–∞ –∞–ª—å–±–æ–º–æ–≤ >10 —Ñ–æ—Ç–æ (Telegram splitting issue)~~ ‚Äî –í–´–ü–û–õ–ù–ï–ù–û
- ‚úÖ ~~–ü—Ä—è–º–∞—è –æ—Ç–ø—Ä–∞–≤–∫–∞ –±—É—Ö–≥–∞–ª—Ç–µ—Ä—É –±–µ–∑ –ø—Ä–æ–º–µ–∂—É—Ç–æ—á–Ω–æ–≥–æ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è~~ ‚Äî –í–´–ü–û–õ–ù–ï–ù–û

### –û–±—â–∏–µ –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏—è
- –≠—Ç–æ –±—É–¥–µ—Ç **–±–æ–ª—å—à–æ–π –ø—Ä–æ–µ–∫—Ç —Å —Ä–∞–∑–ª–∏—á–Ω—ã–º–∏ –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è–º–∏**
- –í–æ–∑–º–æ–∂–Ω—ã–µ –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏—è: –∞–Ω–∞–ª–∏—Ç–∏–∫–∞, –æ—Ç—á—ë—Ç—ã, –¥—Ä—É–≥–∏–µ API-–∏—Å—Ç–æ—á–Ω–∏–∫–∏
- –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ —É–∂–µ –≥–æ—Ç–æ–≤–∞ –∫ –º–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–∏—é: adapters/ –¥–ª—è –Ω–æ–≤—ã—Ö –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–π, use_cases/ –¥–ª—è –ª–æ–≥–∏–∫–∏
- ‚úÖ ~~FinTablo: scheduler –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–π –ø–µ—Ä–∏–æ–¥–∏—á–µ—Å–∫–æ–π —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏~~ ‚Äî —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ (APScheduler, 07:00 –ö–∞–ª–∏–Ω–∏–Ω–≥—Ä–∞–¥, –≤—Å–µ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏)
- –°–≤—è–∑–∫–∏ iiko ‚Üî FinTablo: –º–∞—Ç—á–∏–Ω–≥ –∫–æ–Ω—Ç—Ä–∞–≥–µ–Ω—Ç–æ–≤/—Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤ –º–µ–∂–¥—É —Å–∏—Å—Ç–µ–º–∞–º–∏

---

## üìã –ö–∞–∫ —Ä–∞–±–æ—Ç–∞—Ç—å —Å —ç—Ç–∏–º –ø—Ä–æ–µ–∫—Ç–æ–º (–¥–ª—è AI-–∞—Å—Å–∏—Å—Ç–µ–Ω—Ç–∞)

1. **–í—Å–µ–≥–¥–∞ —á–∏—Ç–∞–π —ç—Ç–æ—Ç —Ñ–∞–π–ª –ø–µ—Ä–≤—ã–º** –ø—Ä–∏ –Ω–∞—á–∞–ª–µ –Ω–æ–≤–æ–≥–æ –¥–∏–∞–ª–æ–≥–∞. –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ docs/ ‚Äî –ø–æ —Ç–∞–±–ª–∏—Ü–µ –Ω–∞–≤–∏–≥–∞—Ü–∏–∏ –≤—ã—à–µ.
2. –°–æ–±–ª—é–¥–∞–π –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–Ω—ã–µ –ø—Ä–∏–Ω—Ü–∏–ø—ã ‚Äî –Ω–µ –ª–µ–ø–∏ –ª–æ–≥–∏–∫—É –≤ handlers.
3. **–ü–æ—Ä—è–¥–æ–∫ –∏–∑–º–µ–Ω–µ–Ω–∏–π (—Å—Ç—Ä–æ–≥–æ):** –∞–Ω–∞–ª–∏–∑ —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–≥–æ –∫–æ–¥–∞ ‚Üí use_case (–±–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫–∞) ‚Üí handler (—Ç–æ–Ω–∫–∏–π) ‚Üí –æ–±–Ω–æ–≤–∏—Ç—å –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—é. –ù–∏–∫–æ–≥–¥–∞ –Ω–µ –Ω–∞—á–∏–Ω–∞–π —Å handler'–∞.
4. –ü—Ä–∏ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏: –ø–æ–º–Ω–∏ –ø—Ä–æ Railway latency ‚Äî –∫–∞–∂–¥—ã–π –ª–∏—à–Ω–∏–π round-trip = +400–º—Å.
5. **–õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ ‚Äî –û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–û –¥–ª—è –ª—é–±–æ–≥–æ –Ω–æ–≤–æ–≥–æ –∫–æ–¥–∞:**
   - –ö–∞–∂–¥—ã–π –Ω–æ–≤—ã–π handler **–û–ë–Ø–ó–ê–ù** –∏–º–µ—Ç—å `logger.info()`/`logger.debug()` –Ω–∞ –≤—Ö–æ–¥–µ
   - –§–æ—Ä–º–∞—Ç: `[module] –¥–µ–π—Å—Ç–≤–∏–µ tg:%d, params` ‚Äî –≥–¥–µ module –æ–¥–∏–Ω –∏–∑: `[auth]`, `[nav]`, `[sync]`, `[sync-ft]`, `[bg]`, `[writeoff]`, `[writeoff-edit]`, `[admin]`, `[invoice]`, `[perm]` (–∏–ª–∏ –Ω–æ–≤—ã–π –ø–æ –∞–Ω–∞–ª–æ–≥–∏–∏)
   - –ó–Ω–∞—á–∏–º—ã–µ –¥–µ–π—Å—Ç–≤–∏—è (–∫–Ω–æ–ø–∫–∏, –≤–≤–æ–¥, –≤—ã–±–æ—Ä) ‚Üí `logger.info`
   - –ü–∞–≥–∏–Ω–∞—Ü–∏—è, guard-—Ö—ç–Ω–¥–ª–µ—Ä—ã, noop ‚Üí `logger.debug`
   - –§–æ–Ω–æ–≤—ã–µ –∑–∞–¥–∞—á–∏: –ª–æ–≥ –Ω–∞ —Å—Ç–∞—Ä—Ç–µ –∏ –Ω–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∏–∏ (—Å —Ç–∞–π–º–∏–Ω–≥–æ–º)
   - –ë–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫–∞ –≤ use_cases: –ª–æ–≥ —Å —Ç–∞–π–º–∏–Ω–≥–æ–º (`time.monotonic()`)
   - –û—à–∏–±–∫–∏: `logger.warning`/`logger.exception` —Å –∫–æ–Ω—Ç–µ–∫—Å—Ç–æ–º (tg_id, doc_id –∏ —Ç.–¥.)
   - **–ù–∏–∫–æ–≥–¥–∞ –Ω–µ —Å–æ–∑–¥–∞–≤–∞–π handler –±–µ–∑ entry-–ª–æ–≥–∞** ‚Äî —ç—Ç–æ –≥–ª–∞–≤–Ω–æ–µ –ø—Ä–∞–≤–∏–ª–æ
6. **–ö–µ—à–∏—Ä–æ–≤–∞–Ω–∏–µ ‚Äî 4 —É—Ä–æ–≤–Ω—è:**
   - **In-memory dict** (user_context, admin_ids) ‚Äî –¥–ª—è –¥–∞–Ω–Ω—ã—Ö, –∫–æ—Ç–æ—Ä—ã–µ –∂–∏–≤—É—Ç –≤—Å—é —Å–µ—Å—Å–∏—é –±–æ—Ç–∞. –ò–Ω–≤–∞–ª–∏–¥–∞—Ü–∏—è —Ä—É—á–Ω–∞—è.
   - **TTL-–∫–µ—à** (writeoff_cache, permissions) ‚Äî –¥–ª—è –¥–∞–Ω–Ω—ã—Ö –∏–∑ –ë–î/GSheet, –∫–æ—Ç–æ—Ä—ã–µ –º–æ–≥—É—Ç —É—Å—Ç–∞—Ä–µ—Ç—å. TTL 5‚Äì30 –º–∏–Ω.
   - **FSM state.data** ‚Äî –¥–ª—è –¥–∞–Ω–Ω—ã—Ö –≤–Ω—É—Ç—Ä–∏ –æ–¥–Ω–æ–≥–æ FSM-—Ñ–ª–æ—É (`_stores_cache`, `_accounts_cache`). –ñ–∏–≤—ë—Ç –¥–æ `state.clear()`.
   - **GSheet ‚Üí in-memory** (permissions + roles) ‚Äî –º–∞—Ç—Ä–∏—Ü–∞ –ø—Ä–∞–≤ –∏ —Ä–æ–ª–µ–π (üëë –ê–¥–º–∏–Ω, üì¨ –ü–æ–ª—É—á–∞—Ç–µ–ª—å, üì¶ –û—Å—Ç–∞—Ç–∫–∏, üö´ –°—Ç–æ–ø-–ª–∏—Å—Ç) –∏–∑ Google –¢–∞–±–ª–∏—Ü—ã, –±–µ–∑ –ø—Ä–æ–º–µ–∂—É—Ç–æ—á–Ω–æ–π –ë–î. TTL 5 –º–∏–Ω + graceful degradation.
   - **GSheet ‚Üí in-memory** (cloud_org_mapping) ‚Äî –º–∞–ø–ø–∏–Ω–≥ department_id ‚Üí cloud_org_id –∏–∑ –ª–∏—Å—Ç–∞ ¬´–ù–∞—Å—Ç—Ä–æ–π–∫–∏¬ª. TTL 5 –º–∏–Ω. –ò–Ω–≤–∞–ª–∏–¥–∏—Ä—É–µ—Ç—Å—è –ø—Ä–∏ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏.
   - –ü–µ—Ä–µ–¥ —Å–æ–∑–¥–∞–Ω–∏–µ–º –Ω–æ–≤–æ–≥–æ –∫–µ—à–∞ ‚Äî –ø—Ä–æ–≤–µ—Ä—å, –ø–æ–¥—Ö–æ–¥–∏—Ç –ª–∏ –æ–¥–∏–Ω –∏–∑ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏—Ö.
7. **–ü–∞—Ä–∞–ª–ª–µ–ª–∏–∑–∞—Ü–∏—è ‚Äî –ø—Ä–∞–≤–∏–ª–æ, –∞ –Ω–µ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è:**
   - –ï—Å–ª–∏ 2+ –Ω–µ–∑–∞–≤–∏—Å–∏–º—ã—Ö async-–≤—ã–∑–æ–≤–∞ –∏–¥—É—Ç –ø–æ–¥—Ä—è–¥ ‚Üí `asyncio.gather()` —Å—Ä–∞–∑—É, –Ω–µ ¬´–ø–æ—Ç–æ–º –æ–ø—Ç–∏–º–∏–∑–∏—Ä—É–µ–º¬ª
   - –§–æ–Ω–æ–≤—ã–µ –∑–∞–¥–∞—á–∏: `asyncio.create_task()` + `try/except` + –ª–æ–≥. –ù–ò–ö–û–ì–î–ê –Ω–µ `await` –¥–ª—è —Ç–æ–≥–æ —á—Ç–æ –Ω–µ –¥–æ–ª–∂–Ω–æ –±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è.
8. **Fallback ‚Äî –≤—Å–µ–≥–¥–∞ graceful degradation:**
   - –ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –≤ –∫–µ—à–µ ‚Üí –∑–∞–ø—Ä–æ—Å –≤ –ë–î (–∞ –Ω–µ –æ—à–∏–±–∫–∞)
   - –ù–µ—Ç –∞–¥–º–∏–Ω–æ–≤ ‚Üí –ø—Ä—è–º–∞—è –æ—Ç–ø—Ä–∞–≤–∫–∞ (–∞ –Ω–µ ¬´–Ω–µ–≤–æ–∑–º–æ–∂–Ω–æ¬ª)
   - –ê–≤—Ç–æ-–≤—ã–±–æ—Ä –Ω–µ —Å—Ä–∞–±–æ—Ç–∞–ª ‚Üí —Ä—É—á–Ω–æ–π –≤—ã–±–æ—Ä (–∞ –Ω–µ —Å–±–æ–π)
   - –ù–µ—Ç unit_name ‚Üí ¬´—à—Ç¬ª (–∞ –Ω–µ –ø—É—Å—Ç–∞—è —Å—Ç—Ä–æ–∫–∞)
9. **Telegram UX ‚Äî —Å–∫–æ—Ä–æ—Å—Ç—å –∏ —á–∏—Å—Ç–æ—Ç–∞ —á–∞—Ç–∞ (–û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–û):**
   - `callback.answer()` ‚Äî **–ü–ï–†–í–ê–Ø —Å—Ç—Ä–æ–∫–∞** –≤ –∫–∞–∂–¥–æ–º callback-handler (—Å–Ω–∏–º–∞–µ—Ç —Å–ø–∏–Ω–Ω–µ—Ä). –ù–∏–∫–æ–≥–¥–∞ –Ω–µ —Å—Ç–∞–≤—å –ø–æ—Å–ª–µ DB/API –≤—ã–∑–æ–≤–æ–≤.
   - **–û–¥–Ω–æ –æ–∫–Ω–æ:** inline ‚Üí `edit_text()`, –ù–ò–ö–û–ì–î–ê `answer()`. Reply-–º–µ–Ω—é ‚Üí `delete old msg` ‚Üí `send new` (—á–µ—Ä–µ–∑ tracked `_menu_msg_id`).
   - **–¢–µ–∫—Å—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è ‚Üí —É–¥–∞–ª—è—Ç—å –í–°–ï–ì–î–ê** ‚Äî `try: await message.delete()` –ø–µ—Ä–≤–æ–π —Å—Ç—Ä–æ–∫–æ–π –≤ text-handler.
   - **–û—à–∏–±–∫–∏ –≤–∞–ª–∏–¥–∞—Ü–∏–∏ ‚Üí edit prompt** (–Ω–µ answer). 5 –æ—à–∏–±–æ–∫ –ø–æ–¥—Ä—è–¥ = 1 —Å–æ–æ–±—â–µ–Ω–∏–µ, –Ω–µ 5.
   - **Placeholder ‚Üí edit:** `"‚è≥ ..."` ‚Üí –¥–æ–ª–≥–∞—è –æ–ø–µ—Ä–∞—Ü–∏—è ‚Üí `edit_text("‚úÖ —Ä–µ–∑—É–ª—å—Ç–∞—Ç")`. –†–µ–∑—É–ª—å—Ç–∞—Ç –ù–ï –Ω–æ–≤—ã–º —Å–æ–æ–±—â–µ–Ω–∏–µ–º.
   - **ChatAction.typing** ‚Äî –≤ text-handler –ø–µ—Ä–µ–¥ –ª—é–±—ã–º DB/API –≤—ã–∑–æ–≤–æ–º (>0.5 —Å–µ–∫).
   - –≠–º–æ–¥–∑–∏ –≤ –Ω–∞—á–∞–ª–µ —Å–æ–æ–±—â–µ–Ω–∏–π (‚úÖ ‚ùå ‚è≥ ‚ö†Ô∏è üìÑ üè® üìÇ üîç üìè)
   - Guard-—Ö—ç–Ω–¥–ª–µ—Ä—ã: delete —Ç–µ–∫—Å—Ç + **edit prompt** —Å –ø–æ–¥—Å–∫–∞–∑–∫–æ–π (–Ω–µ answer)
   - –ü–∞–≥–∏–Ω–∞—Ü–∏—è: ‚óÄÔ∏è ‚ñ∂Ô∏è + —Å—á—ë—Ç—á–∏–∫ ¬´N/M¬ª, –≤—Å–µ–≥–¥–∞ `edit_text` (–Ω–µ –Ω–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ)
   - **–ü–æ–¥—Ä–æ–±–Ω—ã–µ –ø–∞—Ç—Ç–µ—Ä–Ω—ã —Å –∫–æ–¥–æ–º ‚Äî** `docs/UX_PATTERNS.md`
10. **–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏ ‚Äî –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–π —Ñ–∏–Ω–∞–ª—å–Ω—ã–π —à–∞–≥:**
    - –ü–æ—Å–ª–µ –ö–ê–ñ–î–û–ì–û –∏–∑–º–µ–Ω–µ–Ω–∏—è —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç–∏ ‚Äî –æ–±–Ω–æ–≤–∏ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–∏–µ —Å–µ–∫—Ü–∏–∏ –≤ docs/
    - –î–æ–±–∞–≤—å –∑–∞–ø–∏—Å—å –≤ `docs/CHANGELOG.md` (—Å–≤–µ—Ä—Ö—É, –Ω–æ–≤–æ–µ –ø–µ—Ä–≤—ã–º)
    - –ï—Å–ª–∏ –¥–æ–±–∞–≤–∏–ª –Ω–æ–≤—ã–π —Ñ–∞–π–ª ‚Äî –¥–æ–±–∞–≤—å –µ–≥–æ –≤ `docs/FILE_STRUCTURE.md`
    - –ï—Å–ª–∏ –∏–∑–º–µ–Ω–∏–ª —Å—Ö–µ–º—É –ë–î ‚Äî –æ–±–Ω–æ–≤–∏ `docs/DATABASE.md`
    - –ï—Å–ª–∏ –∏–∑–º–µ–Ω–∏–ª API/–æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏ ‚Äî –æ–±–Ω–æ–≤–∏ `docs/API_INTEGRATIONS.md`
11. **–§–∏–∫—Å–∞—Ü–∏—è –ø—Ä–æ–±–ª–µ–º ‚Äî –µ—Å–ª–∏ –ø–æ—Ç—Ä–∞—Ç–∏–ª >10 –º–∏–Ω –Ω–∞ –±–∞–≥, –∑–∞–ø–∏—à–∏ –≤ `docs/KNOWN_ISSUES.md`:**
    - –§–æ—Ä–º–∞—Ç: **–°–∏–º–ø—Ç–æ–º** ‚Üí **–ü—Ä–∏—á–∏–Ω–∞** ‚Üí **–†–µ—à–µ–Ω–∏–µ** ‚Üí **–ö–∞–∫ –∏–∑–±–µ–∂–∞—Ç—å**
    - –≠—Ç–æ –±–∞–∑–∞ –∑–Ω–∞–Ω–∏–π –ø—Ä–æ–µ–∫—Ç–∞ ‚Äî –ø–µ—Ä–µ–¥ –æ—Ç–ª–∞–¥–∫–æ–π —Å–Ω–∞—á–∞–ª–∞ –∑–∞–≥–ª—è–Ω–∏ —Ç—É–¥–∞
    - –ó–∞–ø–∏—Å—ã–≤–∞–π –¥–∞–∂–µ ¬´–≥–ª—É–ø—ã–µ¬ª –æ—à–∏–±–∫–∏ ‚Äî –æ–Ω–∏ –ø–æ–≤—Ç–æ—Ä—è—é—Ç—Å—è —á–∞—â–µ –≤—Å–µ–≥–æ
12. **–í–∞–ª–∏–¥–∞—Ü–∏—è callback_data ‚Äî –û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–ê –≤ –∫–∞–∂–¥–æ–º –Ω–æ–≤–æ–º handler:**
    - `callback.data.split(":", 1)[1]` ‚Üí —á–µ—Ä–µ–∑ `_parse_uuid()` / `_parse_int()` ‚Üí –ø—Ä–æ–≤–µ—Ä–∫–∞ None ‚Üí early return
    - –ù–µ–≤–∞–ª–∏–¥–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ ‚Üí `callback.answer("‚ö†Ô∏è –û—à–∏–±–∫–∞")` + `logger.warning` (–¥–µ—Ç–µ–∫—Ü–∏—è –∞—Ç–∞–∫)
    - –ü–∞—Ç—Ç–µ—Ä–Ω—ã –∏ —Ö–µ–ª–ø–µ—Ä—ã ‚Äî —Å–º. `docs/SECURITY_AND_RELIABILITY.md` ¬ß1
13. **–ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å ‚Äî –ø—Ä–∏ –ª—é–±–æ–º –Ω–æ–≤–æ–º handler/endpoint:**
    - –ü—Ä–æ–≤–µ—Ä—å –º–∞—Ç—Ä–∏—Ü—É –¥–æ—Å—Ç—É–ø–∞: –∫—Ç–æ –º–æ–∂–µ—Ç –≤—ã–∑–≤–∞—Ç—å? (–Ω–µ–∞–≤—Ç–æ—Ä–∏–∑. / –∞–≤—Ç–æ—Ä–∏–∑. / –ø–æ perm_key / –∞–¥–º–∏–Ω)
    - –î–æ—Ä–æ–≥–∏–µ –æ–ø–µ—Ä–∞—Ü–∏–∏ (sync, POST) = **admin-only** + rate limiting
    - –†–∞–∑–¥–µ–ª—ã –º–µ–Ω—é = `@permission_required("perm_key")` (–ø—Ä–∞–≤–∞ –∏–∑ Google –¢–∞–±–ª–∏—Ü—ã)
    - –ù–∏–∫–æ–≥–¥–∞ –Ω–µ –ª–æ–≥–∏—Ä—É–π URL —Å `key=` / `token=` / `Bearer` –Ω–∞ —É—Ä–æ–≤–Ω–µ –Ω–∏–∂–µ WARNING
    - –ü–æ–¥—Ä–æ–±–Ω—ã–µ –ø–∞—Ç—Ç–µ—Ä–Ω—ã ‚Äî —Å–º. `docs/SECURITY_AND_RELIABILITY.md` ¬ß2‚Äì¬ß5
14. **–ö–æ–Ω–∫—É—Ä–µ–Ω—Ç–Ω–æ—Å—Ç—å ‚Äî –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –¥–æ—Ä–æ–≥–æ–π async-–æ–ø–µ—Ä–∞—Ü–∏–∏:**
    - Sync-–æ–ø–µ—Ä–∞—Ü–∏–∏: —á–µ—Ä–µ–∑ sync-lock (`asyncio.Lock` per entity), –Ω–µ –¥–æ–ø—É—Å–∫–∞—Ç—å –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω—ã–π –∑–∞–ø—É—Å–∫
    - Background tasks: —Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å –≤ `_background_tasks` set –¥–ª—è graceful shutdown
    - –ü–∞—Ç—Ç–µ—Ä–Ω—ã ‚Äî —Å–º. `docs/SECURITY_AND_RELIABILITY.md` ¬ß7‚Äì¬ß8
15. **UX ‚Äî –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –ª—é–±–æ–≥–æ handler'a:**
    - Inline callback ‚Üí `edit_text`, –Ω–∏–∫–æ–≥–¥–∞ `answer` (–∫—Ä–æ–º–µ callback.answer)
    - –¢–µ–∫—Å—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è ‚Üí `message.delete()` –ø–µ—Ä–≤—ã–º –¥–µ–ª–æ–º
    - –û—à–∏–±–∫–∞ –≤–∞–ª–∏–¥–∞—Ü–∏–∏ ‚Üí edit prompt (–Ω–µ –Ω–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ)
    - –î–æ–ª–≥–∞—è –æ–ø–µ—Ä–∞—Ü–∏—è ‚Üí `"‚è≥"` placeholder ‚Üí edit —Å —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–º
    - –ü–æ–¥—Ä–æ–±–Ω—ã–µ –ø–∞—Ç—Ç–µ—Ä–Ω—ã –∏ –∫–æ–¥ ‚Äî `docs/UX_PATTERNS.md`
16. **Prefetch & cache warmup:**
    - –ü—Ä–∏ –≤—Ö–æ–¥–µ –≤ —Ä–∞–∑–¥–µ–ª ‚Üí `asyncio.create_task(preload_next_step_data())`
    - –ü—Ä–∏ —Å—Ç–∞—Ä—Ç–µ –±–æ—Ç–∞ ‚Üí `_warmup_caches()` (—Å–º. `docs/UX_PATTERNS.md` ¬ß6)
    - `user_context` = TTL 30 –º–∏–Ω, –Ω–µ –±–µ—Å–∫–æ–Ω–µ—á–Ω—ã–π
17. –ù–µ —Å–æ–∑–¥–∞–≤–∞–π –ª–∏—à–Ω–∏—Ö —Ñ–∞–π–ª–æ–≤ (markdown-–æ—Ç—á—ë—Ç—ã, —Å–∫—Ä–∏–ø—Ç—ã) ‚Äî —Ç–æ–ª—å–∫–æ —Ç–æ —á—Ç–æ –ø—Ä–æ—Å—è—Ç
18. –û–±—â–∞–π—Å—è –Ω–∞ —Ä—É—Å—Å–∫–æ–º, –∫—Ä–∞—Ç–∫–æ, –ø–æ —Å—É—â–µ—Å—Ç–≤—É

---

## ‚úÖ –ß–µ–∫–ª–∏—Å—Ç –¥–ª—è –Ω–æ–≤–æ–≥–æ –∫–æ–¥–∞ (–∫–æ–ø–∏—Ä—É–π –≤ –ø—Ä–æ–º–ø—Ç –ø—Ä–∏ –∑–∞–ø—Ä–æ—Å–µ —Ñ–∏—á–∏)

> **–ö–∞–∫ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å:** —Å–∫–æ–ø–∏—Ä—É–π –±–ª–æ–∫ –Ω–∏–∂–µ –≤ –Ω–∞—á–∞–ª–æ –ø—Ä–æ–º–ø—Ç–∞ –ø–µ—Ä–µ–¥ –æ–ø–∏—Å–∞–Ω–∏–µ–º –∑–∞–¥–∞—á–∏.
> –≠—Ç–æ –∑–∞—Å—Ç–∞–≤–∏—Ç AI –¥–µ—Ä–∂–∞—Ç—å –∫–∞–∂–¥—ã–π –ø—É–Ω–∫—Ç –≤ —Ñ–æ–∫—É—Å–µ –ø—Ä–∏ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –∫–æ–¥–∞, –∞ –Ω–µ ¬´–≥–¥–µ-—Ç–æ –≤ –¥–æ–∫—É–º–µ–Ω—Ç–µ –±—ã–ª–æ¬ª.

```
–ü—Ä–æ—á–∏—Ç–∞–π PROJECT_MAP.md. –ü—Ä–∏ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏ –û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–û —Å–æ–±–ª—é–¥–∞–π:

–ê–†–•–ò–¢–ï–ö–¢–£–†–ê:
- [ ] –¢–æ–Ω–∫–∏–π handler ‚Üí –±–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫–∞ –≤ use_cases/ ‚Üí –∞–¥–∞–ø—Ç–µ—Ä—ã –≤ adapters/
- [ ] –ü–æ—Ä—è–¥–æ–∫: –∞–Ω–∞–ª–∏–∑ ‚Üí use_case ‚Üí handler ‚Üí –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è

–í–ê–õ–ò–î–ê–¶–ò–Ø:
- [ ] callback_data ‚Äî try/except (ValueError, IndexError) –Ω–∞ –∫–∞–∂–¥—ã–π int()/UUID()
- [ ] –¢–µ–∫—Å—Ç–æ–≤—ã–π –≤–≤–æ–¥ ‚Äî –æ–≥—Ä–∞–Ω–∏—á–∏—Ç—å –¥–ª–∏–Ω—É
- [ ] FSM ‚Äî –ø—Ä–æ–≤–µ—Ä—è—Ç—å –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—é –Ω–∞ –ö–ê–ñ–î–û–ú —à–∞–≥–µ, –Ω–µ —Ç–æ–ª—å–∫–æ –Ω–∞ –≤—Ö–æ–¥–µ

–õ–û–ì–ò–†–û–í–ê–ù–ò–ï:
- [ ] logger.info —Å tg_id –≤ –ö–ê–ñ–î–û–ú —Ö—ç–Ω–¥–ª–µ—Ä–µ –Ω–∞ –≤—Ö–æ–¥–µ
- [ ] logger.warning/exception —Å –∫–æ–Ω—Ç–µ–∫—Å—Ç–æ–º –ø—Ä–∏ –æ—à–∏–±–∫–∞—Ö
- [ ] –ù–∏–∫–∞–∫–∏—Ö except Exception: pass –±–µ–∑ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è

TELEGRAM UX:
- [ ] callback.answer() ‚Äî –ü–ï–†–í–ê–Ø —Å—Ç—Ä–æ–∫–∞ callback-handler
- [ ] Inline ‚Üí edit_text(), –ù–ò–ö–û–ì–î–ê answer()
- [ ] –¢–µ–∫—Å—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è ‚Üí message.delete() –ø–µ—Ä–≤—ã–º –¥–µ–ª–æ–º
- [ ] –î–æ–ª–≥–∞—è –æ–ø–µ—Ä–∞—Ü–∏—è ‚Üí ‚è≥ placeholder ‚Üí edit —Å —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–º

–î–û–ö–£–ú–ï–ù–¢–ê–¶–ò–Ø (—Ñ–∏–Ω–∞–ª—å–Ω—ã–π —à–∞–≥):
- [ ] docs/FILE_STRUCTURE.md ‚Äî –Ω–æ–≤—ã–µ —Ñ–∞–π–ª—ã, FSM-—Å–æ—Å—Ç–æ—è–Ω–∏—è, –∫–Ω–æ–ø–∫–∏
- [ ] docs/DATABASE.md ‚Äî –Ω–æ–≤—ã–µ —Ç–∞–±–ª–∏—Ü—ã, —Å—á—ë—Ç—á–∏–∫–∏
- [ ] docs/CHANGELOG.md ‚Äî –∑–∞–ø–∏—Å—å —Å–≤–µ—Ä—Ö—É —Å –¥–∞—Ç–æ–π
- [ ] PROJECT_MAP.md ‚Äî –æ–±–Ω–æ–≤–∏—Ç—å –æ–ø–∏—Å–∞–Ω–∏–µ —Ñ–∞–∑—ã –∏ –Ω–∞–≤–∏–≥–∞—Ü–∏—é
```