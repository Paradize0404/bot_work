# üóÇ –ö–∞—Ä—Ç–∞ –ø—Ä–æ–µ–∫—Ç–∞ iiko + FinTablo Sync Bot

> –í–µ—Ä—Å–∏—è MAP: **2.0** | –û–±–Ω–æ–≤–ª–µ–Ω–æ: 2026-02-22  
> –Ø–∑—ã–∫: **—Ä—É—Å—Å–∫–∏–π** | Python 3.12 | asyncio + aiogram 3 + SQLAlchemy 2.0 + asyncpg + Redis  
> Deploy: Railway (PostgreSQL ~400ms RTT, Redis FSM)

---

## üéØ –ò–¥–µ–Ω—Ç–∏—á–Ω–æ—Å—Ç—å –ø—Ä–æ–µ–∫—Ç–∞

Telegram-–±–æ—Ç –¥–ª—è **PizzaYolo**: —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è iiko REST API + FinTablo REST API ‚Üí PostgreSQL,
—É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Å–∫–ª–∞–¥—Å–∫–∏–º–∏ –æ—Å—Ç–∞—Ç–∫–∞–º–∏, —Å–ø–∏—Å–∞–Ω–∏—è–º–∏, –∑–∞—è–≤–∫–∞–º–∏, OCR-–Ω–∞–∫–ª–∞–¥–Ω—ã–º–∏, –æ—Ç—á—ë—Ç–∞–º–∏.

**–¢—Ä–∏ —Å–ª–æ—è –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—ã:** `bot/handler` ‚Üê `use_cases/` ‚Üê `adapters/`  
**–ß–∞—Å–æ–≤–æ–π –ø–æ—è—Å:** Europe/Kaliningrad (UTC+2) ‚Äî `now_kgd()` –≤—Å–µ–≥–¥–∞, `datetime.now()` –∑–∞–ø—Ä–µ—â—ë–Ω.  
**–ê–≤—Ç–æ—Ä–∞—Å–ø–∏—Å–∞–Ω–∏–µ:** 07:00 full-sync | 22:00 —Å—Ç–æ–ø-–ª–∏—Å—Ç –æ—Ç—á—ë—Ç | 23:00 –∞–≤—Ç–æ-–ø–µ—Ä–µ–º–µ—â–µ–Ω–∏–µ —Ä–∞—Å—Ö–æ–¥–Ω–∏–∫–æ–≤.

---

## üìú –ö–æ–Ω—Ç—Ä–∞–∫—Ç—ã (K1‚ÄìK5)

> –ö–æ–Ω—Ç—Ä–∞–∫—Ç—ã ‚Äî —Ñ—É–Ω–¥–∞–º–µ–Ω—Ç–∞–ª—å–Ω—ã–µ –ø—Ä–∞–≤–∏–ª–∞, –Ω–∞—Ä—É—à–µ–Ω–∏–µ –∫–æ—Ç–æ—Ä—ã—Ö = —Ä–µ–≥—Ä–µ—Å—Å–∏—è.  
> –ö–∞–∂–¥—ã–π –∫–æ–Ω—Ç—Ä–∞–∫—Ç —Å–æ–¥–µ—Ä–∂–∏—Ç —Ç–µ—Å—Ç–∏—Ä—É–µ–º—ã–π –∫—Ä–∏—Ç–µ—Ä–∏–π.

### K1: –¢–æ–Ω–∫–∏–µ —Ö—ç–Ω–¥–ª–µ—Ä—ã
Handler –ø–æ–ª—É—á–∞–µ—Ç –≤–≤–æ–¥ ‚Üí –≤—ã–∑—ã–≤–∞–µ—Ç use_case ‚Üí –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –æ—Ç–≤–µ—Ç.  
**–¢–µ—Å—Ç:** –≤ `bot/*.py` –Ω–µ—Ç SQL-–∑–∞–ø—Ä–æ—Å–æ–≤, –Ω–µ—Ç `httpx`, –Ω–µ—Ç –±–∏–∑–Ω–µ—Å-–≤—ã—á–∏—Å–ª–µ–Ω–∏–π.

### K2: –ò–¥–µ–º–ø–æ—Ç–µ–Ω—Ç–Ω–æ—Å—Ç—å –∏ –∫–æ–Ω–∫—É—Ä–µ–Ω—Ç–Ω–æ—Å—Ç—å
- –í—Å–µ POST –≤ iiko ‚Äî —Å UUID (–ø–æ–≤—Ç–æ—Ä–Ω—ã–π –∫–ª–∏–∫ = —Ç–æ—Ç –∂–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç).
- Sync-lock: `asyncio.Lock` per entity, —á–µ—Ä–µ–∑ `acquire_nowait()` (**–Ω–µ** `locked()` ‚Äî TOCTOU).
- Mirror-delete: sanity ‚â§50%, –∏–Ω–∞—á–µ skip + warning.
- Double-click: `if user_id in _lock ‚Üí answer("‚è≥"); return`.

**–¢–µ—Å—Ç:** –¥–≤–∞ `asyncio.gather(sync(), sync())` –Ω–µ –¥–∞—é—Ç –¥—É–±–ª–µ–π –∏ –Ω–µ –ø–∞–¥–∞—é—Ç.

### K3: –ù–∞–±–ª—é–¥–∞–µ–º–æ—Å—Ç—å
- –ö–∞–∂–¥—ã–π handler: `logger.info("[module] action tg:%d ...")` –Ω–∞ –≤—Ö–æ–¥–µ.
- –ö–∞–∂–¥—ã–π use_case: —Ç–∞–π–º–∏–Ω–≥ `time.monotonic()` + –ª–æ–≥ –∏—Ç–æ–≥–æ–≤.
- –ö–∞–∂–¥–∞—è sync: –∑–∞–ø–∏—Å—å –≤ `iiko_sync_log`.
- –°–µ–∫—Ä–µ—Ç—ã: `mask_secrets()` –ø–µ—Ä–µ–¥ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ–º. httpx/httpcore loggers ‚â• WARNING.

**–¢–µ—Å—Ç:** grep –ø–æ handler'–∞–º ‚Äî –Ω–µ—Ç handler –±–µ–∑ `logger.info`/`logger.debug` –Ω–∞ –ø–µ—Ä–≤—ã—Ö 5 —Å—Ç—Ä–æ–∫–∞—Ö.

### K4: –í–∞–ª–∏–¥–∞—Ü–∏—è (Trust Nothing)
- `callback_data` ‚Üí `split(":", 1)[1]` ‚Üí `try UUID()/int() except ‚Üí answer("‚ö†Ô∏è"); return`.
- –¢–µ–∫—Å—Ç: –¥–ª–∏–Ω–∞ ‚â§ 100/500/2000. –ß–∏—Å–ª–∞: min/max.
- FSM: –ø—Ä–æ–≤–µ—Ä–∫–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ –Ω–∞ **–∫–∞–∂–¥–æ–º** —à–∞–≥–µ, –Ω–µ —Ç–æ–ª—å–∫–æ –Ω–∞ –≤—Ö–æ–¥–µ.

**–¢–µ—Å—Ç:** callback —Å –Ω–µ–≤–∞–ª–∏–¥–Ω—ã–º UUID ‚Üí –æ—Ç–≤–µ—Ç "‚ö†Ô∏è –û—à–∏–±–∫–∞", –Ω–µ 500.

### K5: UX ‚Äî –æ–¥–Ω–æ –æ–∫–Ω–æ, –Ω–µ—Ç –º—É—Å–æ—Ä–∞
- `callback.answer()` ‚Äî **–ø–µ—Ä–≤–∞—è —Å—Ç—Ä–æ–∫–∞** callback-handler (—Å–Ω–∏–º–∞–µ—Ç —Å–ø–∏–Ω–Ω–µ—Ä).
- Inline ‚Üí `edit_text()`, **–Ω–∏–∫–æ–≥–¥–∞** `answer()`. Reply ‚Üí delete old + send new.
- –¢–µ–∫—Å—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è ‚Üí `message.delete()` –≤—Å–µ–≥–¥–∞.
- –û–ø–µ—Ä–∞—Ü–∏—è >1—Å ‚Üí `"‚è≥ ..."` ‚Üí `edit_text("‚úÖ —Ä–µ–∑—É–ª—å—Ç–∞—Ç")`.

**–¢–µ—Å—Ç:** –±–æ—Ç –Ω–µ —Å–æ–∑–¥–∞—ë—Ç >1 —Å–æ–æ–±—â–µ–Ω–∏—è –Ω–∞ 1 –¥–µ–π—Å—Ç–≤–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (–∫—Ä–æ–º–µ –æ—à–∏–±–æ–∫ –≤–∞–ª–∏–¥–∞—Ü–∏–∏ ‚Üí edit).

---

## üó∫ –ù–∞–≤–∏–≥–∞—Ü–∏—è (dependency graph)

> –ß–∏—Ç–∞–π MAP –≤—Å–µ–≥–¥–∞. –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ —Ñ–∞–π–ª—ã ‚Äî –ø–æ –∑–∞–¥–∞—á–µ. –§–æ—Ä–º–∞—Ç: `—Ñ–∞–π–ª (~Nk —Ç–æ–∫–µ–Ω–æ–≤)`.

```
PROJECT_MAP.md (–≠–¢–û–¢ –§–ê–ô–õ, ~10k) ‚Äî –í–°–ï–ì–î–ê –∑–∞–≥—Ä—É–∂–∞—Ç—å
‚îÇ
‚îú‚îÄ docs/FILE_STRUCTURE.md (~19k) ‚Üê‚îÄ‚îÄ –Ω–æ–≤–∞—è —Ñ–∏—á–∞, –ø–æ–∏—Å–∫ –º–æ–¥—É–ª—è, FSM-–ø–æ—Ç–æ–∫–∏
‚îú‚îÄ docs/DATABASE.md (~17k)       ‚Üê‚îÄ‚îÄ –Ω–æ–≤–∞—è —Ç–∞–±–ª–∏—Ü–∞, –º–∏–≥—Ä–∞—Ü–∏—è, –¥–∞–Ω–Ω—ã–µ
‚îú‚îÄ docs/API_INTEGRATIONS.md (~8k) ‚Üê‚îÄ‚îÄ –≤–Ω–µ—à–Ω–∏–µ API, –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å, Railway
‚îú‚îÄ docs/UX_PATTERNS.md (~13k)    ‚Üê‚îÄ‚îÄ Telegram UX, –∫–Ω–æ–ø–∫–∏, –ø–∞–≥–∏–Ω–∞—Ü–∏—è, –∫–µ—à–∏—Ä–æ–≤–∞–Ω–∏–µ
‚îú‚îÄ docs/SECURITY.md (~6k)        ‚Üê‚îÄ‚îÄ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å, –≤–∞–ª–∏–¥–∞—Ü–∏—è, –∫–æ–Ω–∫—É—Ä–µ–Ω—Ç–Ω–æ—Å—Ç—å
‚îú‚îÄ docs/KNOWN_ISSUES.md (~6k)    ‚Üê‚îÄ‚îÄ –≥—Ä–∞–±–ª–∏, —Ä–µ—à—ë–Ω–Ω—ã–µ –±–∞–≥–∏
‚îÇ
‚îú‚îÄ‚îÄ‚îÄ –î–æ–º–µ–Ω—ã (–∑–∞–≥—Ä—É–∂–∞—Ç—å –ø–æ –∑–∞–¥–∞—á–µ, —Å–∞–º–æ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω—ã) ‚îÄ‚îÄ‚îÄ
‚îÇ
‚îú‚îÄ docs/SYNC.md (~5k)         ‚Üê‚îÄ‚îÄ scheduler, sync-–ø–∞—Ç—Ç–µ—Ä–Ω, mirror-delete
‚îú‚îÄ docs/WEBHOOKS.md (~5k)     ‚Üê‚îÄ‚îÄ iikoCloud hooks, —Å—Ç–æ–ø-–ª–∏—Å—Ç, –æ—Å—Ç–∞—Ç–∫–∏
‚îú‚îÄ docs/REQUESTS.md (~5k)     ‚Üê‚îÄ‚îÄ –∑–∞—è–≤–∫–∏, –∞–≤—Ç–æ-—Å–∫–ª–∞–¥—ã, –∞–≤—Ç–æ-–∫–æ–Ω—Ç—Ä–∞–≥–µ–Ω—Ç
‚îú‚îÄ docs/OCR.md (~6k)          ‚Üê‚îÄ‚îÄ OCR pipeline, –º–∞–ø–ø–∏–Ω–≥ GSheet, iiko XML
‚îú‚îÄ docs/WRITEOFFS.md (~4k)    ‚Üê‚îÄ‚îÄ –∞–∫—Ç—ã —Å–ø–∏—Å–∞–Ω–∏—è, pending, –∏—Å—Ç–æ—Ä–∏—è
‚îú‚îÄ docs/ENV_VARS.md (~3k)     ‚Üê‚îÄ‚îÄ –≤—Å–µ env vars, –¥–µ–ø–ª–æ–π-—á–µ–∫–ª–∏—Å—Ç
‚îÇ
‚îî‚îÄ‚îÄ‚îÄ –ê—Ä—Ö–∏–≤ / –ü–µ—Å–æ—á–Ω–∏—Ü–∞ ‚îÄ‚îÄ‚îÄ
   ‚îú‚îÄ docs/CHANGELOG.md (~10k) ‚Üê‚îÄ‚îÄ –ø–æ—Å–ª–µ–¥–Ω–∏–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è (2026)
   ‚îú‚îÄ docs/archive/             ‚Üê‚îÄ‚îÄ —Å—Ç–∞—Ä—ã–π changelog, deprecated —Ñ–∞–π–ª—ã
   ‚îî‚îÄ sandbox/                  ‚Üê‚îÄ‚îÄ –∏–∑–æ–ª–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ —ç–∫—Å–ø–µ—Ä–∏–º–µ–Ω—Ç—ã (.gitignored)
```

**–ü—Ä–∞–≤–∏–ª–æ –∑–∞–≥—Ä—É–∑–∫–∏:** MAP (~10k) + 1‚Äì2 –¥–æ–º–µ–Ω–∞ (~5‚Äì10k) = 15‚Äì25k ‚Üí –æ—Å—Ç–∞—ë—Ç—Å—è 100k+ –¥–ª—è –∫–æ–¥–∞.

---

## üèó –ö–æ–Ω–≤–µ–Ω—Ü–∏–∏ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏ (–∫–æ–º–ø–∞–∫—Ç–Ω—ã–µ)

| –ü—Ä–∞–≤–∏–ª–æ | –†–µ–∞–ª–∏–∑–∞—Ü–∏—è |
|---------|------------|
| Python 3.12 async | asyncio, asyncpg, httpx, aiogram 3 |
| SQLAlchemy 2.0 | Declarative, async session, `expire_on_commit=False` |
| –ß–∞—Å–æ–≤–æ–π –ø–æ—è—Å | `now_kgd()` –∏–∑ `_helpers`. `datetime.now()` = –ë–ê–ì |
| Shared helpers | `use_cases/_helpers.py`: `now_kgd`, `compute_hash`, `bfs_allowed_groups`, `load_stores_for_department`, `safe_uuid`, `mask_secrets` |
| UPSERT | INSERT ON CONFLICT DO UPDATE, batch=500 |
| Mirror-sync | –ü–æ—Å–ª–µ UPSERT ‚Üí DELETE –æ—Ç—Å—É—Ç—Å—Ç–≤—É—é—â–∏—Ö. –ë–î = –∑–µ—Ä–∫–∞–ª–æ API |
| raw_json | –ö–∞–∂–¥–∞—è —Ç–∞–±–ª–∏—Ü–∞ —Ö—Ä–∞–Ω–∏—Ç –ø–æ–ª–Ω—ã–π –æ—Ç–≤–µ—Ç API –∫–∞–∫ JSONB |
| DRY | `_run_sync()` + `_batch_upsert()` ‚Äî –æ–¥–∏–Ω generic, –Ω–µ –∫–æ–ø–∏–ø–∞—Å—Ç–∞ |
| Persistent HTTP | –û–¥–∏–Ω `httpx.AsyncClient` —Å pool, –Ω–µ per-request |
| –ú–∞–ª–µ–Ω—å–∫–∏–µ PR | –ò–Ω–∫—Ä–µ–º–µ–Ω—Ç–∞–ª—å–Ω—ã–µ –ø—Ä–∞–≤–∫–∏, –Ω–µ –ø–µ—Ä–µ–ø–∏—Å—ã–≤–∞—Ç—å –≤—Å—ë |
| –ü–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ—Å—Ç—å | `asyncio.gather` –¥–ª—è –Ω–µ–∑–∞–≤–∏—Å–∏–º—ã—Ö –≤—ã–∑–æ–≤–æ–≤ ‚Äî –ø—Ä–∞–≤–∏–ª–æ, –Ω–µ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è |

---

## üö´ –ê–Ω—Ç–∏–ø–∞—Ç—Ç–µ—Ä–Ω—ã (–∫–æ–º–ø–∞–∫—Ç–Ω—ã–µ)

| –ó–∞–ø—Ä–µ—â–µ–Ω–æ | –ü—Ä–∞–≤–∏–ª—å–Ω–æ |
|-----------|-----------|
| `asyncio.get_event_loop()` | `asyncio.run()` / `get_running_loop()` |
| `time.sleep`, `requests` | `asyncio.sleep`, `httpx.AsyncClient` |
| `print()` | `logging` (—á–µ—Ä–µ–∑ `logging_config.py`) |
| `Optional[X]` | `X \| None` |
| `except Exception: pass` | `logger.exception()` |
| `datetime.now()` / `utcnow()` | `now_kgd()` –∏–∑ `_helpers` |
| `_KGD_TZ = ZoneInfo(...)` –∑–∞–Ω–æ–≤–æ | `from use_cases._helpers import KGD_TZ` |
| `default=[]` / `default={}` –≤ Column | `default=list` / `default=dict` |
| `REAL` / `FLOAT` –¥–ª—è –¥–µ–Ω–µ–≥ | `Numeric(precision, scale)` |
| `JSON` –≤ PostgreSQL | `JSONB` |
| `lock.locked()` + `async with` | `lock.acquire_nowait()` |
| BFS / hash / stores –≤—Ä—É—á–Ω—É—é | `bfs_allowed_groups` / `compute_hash` / `load_stores_for_department` |

---

## üìê –®–∞–±–ª–æ–Ω—ã –º–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–∏—è

> –ù–æ–≤—ã–π –¥–æ–º–µ–Ω = –∫–æ–ø–∏—Ä—É–π –ø–∞—Ç—Ç–µ—Ä–Ω, –Ω–µ –∏–∑–æ–±—Ä–µ—Ç–∞–π.

### –®–∞–±–ª–æ–Ω 1: –ù–æ–≤—ã–π sync (—Å–∫–æ–ø–∏—Ä—É–π `use_cases/sync.py`)
```python
# 1. –í adapters/: fetch_new_entity() ‚Üí list[dict]
# 2. –í use_cases/: _run_sync("entity", fetch_fn, Model, mapping_fn, session)
# 3. –í bot/handlers.py: –∫–Ω–æ–ø–∫–∞ ‚Üí –≤—ã–∑–æ–≤ sync ‚Üí –ª–æ–≥ ‚Üí –æ—Ç–≤–µ—Ç
# 4. –ú–æ–¥–µ–ª—å: db/models.py ‚Äî new table —Å raw_json, synced_at
# 5. SyncLog –∑–∞–ø–∏—Å—ã–≤–∞–µ—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏
```
**–≠—Ç–∞–ª–æ–Ω:** `sync.py::sync_products()` ‚Äî UPSERT + mirror-delete + SyncLog.

### –®–∞–±–ª–æ–Ω 2: –ù–æ–≤—ã–π FSM-flow (—Å–∫–æ–ø–∏—Ä—É–π `bot/writeoff_handlers.py`)
```python
# 1. States: class NewFlowStates(StatesGroup): step1, step2, confirm
# 2. Entry: –∫–Ω–æ–ø–∫–∞ ‚Üí permission check ‚Üí prefetch ‚Üí set state
# 3. Steps: –∫–∞–∂–¥—ã–π —à–∞–≥ ‚Äî –≤–∞–ª–∏–¥–∞—Ü–∏—è + edit prompt (–Ω–µ –Ω–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ)
# 4. Confirm: use_case ‚Üí —Ä–µ–∑—É–ª—å—Ç–∞—Ç ‚Üí state.clear() ‚Üí restore_menu_kb()
# 5. Cancel: /cancel ‚Üí edit prompt ‚Üí state.clear() ‚Üí restore_menu_kb()
```
**–≠—Ç–∞–ª–æ–Ω:** `writeoff_handlers.py` ‚Äî –ø–æ–ª–Ω—ã–π —Ü–∏–∫–ª —Å cancel, guard, pagination.

### –®–∞–±–ª–æ–Ω 3: –ù–æ–≤—ã–π –¥–æ–º–µ–Ω-–¥–æ–∫—É–º–µ–Ω—Ç (—Å–∫–æ–ø–∏—Ä—É–π `docs/WRITEOFFS.md`)
```markdown
# –ó–∞–≥–æ–ª–æ–≤–æ–∫
> –ó–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏: ...
## –ö–æ–Ω—Ç—Ä–∞–∫—Ç—ã –¥–æ–º–µ–Ω–∞ (XX1‚ÄìXX4)
## –ü–æ—Ç–æ–∫ / –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞
## –ú–æ–¥—É–ª–∏ (—Ç–∞–±–ª–∏—Ü–∞)
## –¢–∞–±–ª–∏—Ü—ã –ë–î (–∫–æ–º–ø–∞–∫—Ç–Ω–∞—è —Ç–∞–±–ª–∏—Ü–∞)
## –ß–∞—Å—Ç—ã–µ –æ—à–∏–±–∫–∏
```

---

## üîÑ –ü—Ä–æ—Ç–æ–∫–æ–ª —ç–≤–æ–ª—é—Ü–∏–∏ –ø—Ä–∞–≤–∏–ª

> –ü—Ä–∞–≤–∏–ª–∞ —É—Å—Ç–∞—Ä–µ–≤–∞—é—Ç. –í–º–µ—Å—Ç–æ –º–æ–ª—á–∞–ª–∏–≤–æ–≥–æ –∏–≥–Ω–æ—Ä–∏—Ä–æ–≤–∞–Ω–∏—è ‚Äî —Ñ–æ—Ä–º–∞–ª—å–Ω—ã–π –ø—Ä–æ—Ü–µ—Å—Å.

### –ñ–∏–∑–Ω–µ–Ω–Ω—ã–π —Ü–∏–∫–ª –ø—Ä–∞–≤–∏–ª–∞

```
ACTIVE ‚Üí REVIEW ‚Üí MIGRATING ‚Üí DEPRECATED ‚Üí REMOVED
```

| –°—Ç–∞—Ç—É—Å | –ó–Ω–∞—á–µ–Ω–∏–µ |
|--------|----------|
| `ACTIVE` | –î–µ–π—Å—Ç–≤—É–µ—Ç, –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ –∫ —Å–æ–±–ª—é–¥–µ–Ω–∏—é |
| `REVIEW` | –ü–æ–¥ –≤–æ–ø—Ä–æ—Å–æ–º ‚Äî —Å–æ–±–∏—Ä–∞–µ–º –∞—Ä–≥—É–º–µ–Ω—Ç—ã –∑–∞/–ø—Ä–æ—Ç–∏–≤ |
| `MIGRATING` | –†–µ—à–µ–Ω–∏–µ –ø—Ä–∏–Ω—è—Ç–æ, –∏–¥—ë—Ç –ø–µ—Ä–µ—Ö–æ–¥ –Ω–∞ –Ω–æ–≤–æ–µ –ø—Ä–∞–≤–∏–ª–æ |
| `DEPRECATED` | –°—Ç–∞—Ä–æ–µ –ø—Ä–∞–≤–∏–ª–æ –µ—â—ë –≤ –∫–æ–¥–µ, –Ω–æ –Ω–æ–≤—ã–π –∫–æ–¥ –ø–∏—à–µ—Ç—Å—è –ø–æ-–Ω–æ–≤–æ–º—É |
| `REMOVED` | –ü–æ–ª–Ω–æ—Å—Ç—å—é —É–¥–∞–ª–µ–Ω–æ –∏–∑ –∫–æ–¥–∞ –∏ –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏ |

### –ö–ª–∞—Å—Å–∏—Ñ–∏–∫–∞—Ü–∏—è –ø–æ —É—Å—Ç–æ–π—á–∏–≤–æ—Å—Ç–∏

| –¢–∏–ø | –ü—Ä–∏–º–µ—Ä | –ö–æ–≥–¥–∞ –º–µ–Ω—è–µ—Ç—Å—è |
|-----|--------|----------------|
| üèõ –§—É–Ω–¥–∞–º–µ–Ω—Ç–∞–ª—å–Ω–æ–µ | K1 (—Ç–æ–Ω–∫–∏–µ —Ö—ç–Ω–¥–ª–µ—Ä—ã), K3 (–Ω–∞–±–ª—é–¥–∞–µ–º–æ—Å—Ç—å) | –ù–∏–∫–æ–≥–¥–∞ (—Å–º–µ–Ω–∞ = –Ω–æ–≤—ã–π –ø—Ä–æ–µ–∫—Ç) |
| üèó –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–Ω–æ–µ | UPSERT-–ø–∞—Ç—Ç–µ—Ä–Ω, mirror-sync | –ü—Ä–∏ –∫—Ä–∞—Ç–Ω–æ–º –º–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–∏–∏ |
| üîß –¢–µ—Ö–Ω–∏—á–µ—Å–∫–æ–µ | Python 3.12, httpx, aiogram 3 | –ü—Ä–∏ —Å–º–µ–Ω–µ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–∞ |
| üìè –°—Ç–∏–ª–∏—Å—Ç–∏—á–µ—Å–∫–æ–µ | `X \| None` –≤–º–µ—Å—Ç–æ `Optional[X]` | –ü—Ä–∏ —Å–º–µ–Ω–µ –∫–æ–Ω–≤–µ–Ω—Ü–∏–∏ |

### –ü—Ä–æ—Ü–µ–¥—É—Ä–∞ –∏–∑–º–µ–Ω–µ–Ω–∏—è –ø—Ä–∞–≤–∏–ª–∞

1. **–§–æ—Ä–º—É–ª–∏—Ä–æ–≤–∫–∞:** ¬´–ü—Ä–∞–≤–∏–ª–æ X —É—Å—Ç–∞—Ä–µ–ª–æ –ø–æ—Ç–æ–º—É —á—Ç–æ Y. –ê–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–∞: Z¬ª
2. **–î–æ–∫—É–º–µ–Ω—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ:** –≤ `docs/CHANGELOG.md` –∑–∞–ø–∏—Å—å `[RULE]` —Å –æ–±–æ—Å–Ω–æ–≤–∞–Ω–∏–µ–º
3. **–ú–∏–≥—Ä–∞—Ü–∏—è:** –ø–ª–∞–Ω –ø–µ—Ä–µ—Ö–æ–¥–∞ (–∫–∞–∫–∏–µ —Ñ–∞–π–ª—ã –∑–∞—Ç—Ä–æ–Ω—É—Ç—ã, –ø–æ—Ä—è–¥–æ–∫)
4. **–ü–µ—Ä–µ—Ö–æ–¥–Ω—ã–π –ø–µ—Ä–∏–æ–¥:** —Å—Ç–∞—Ä—ã–π –∏ –Ω–æ–≤—ã–π –ø–æ–¥—Ö–æ–¥ —Å–æ—Å—É—â–µ—Å—Ç–≤—É—é—Ç (DEPRECATED + ACTIVE)
5. **–û—á–∏—Å—Ç–∫–∞:** —É–¥–∞–ª–µ–Ω–∏–µ deprecated-–∫–æ–¥–∞, –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏

### –†–µ–µ—Å—Ç—Ä –ø—Ä–∞–≤–∏–ª (—Ç–µ–∫—É—â–µ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ)

| ID | –ü—Ä–∞–≤–∏–ª–æ | –¢–∏–ø | –°—Ç–∞—Ç—É—Å | –í–µ—Ä—Å–∏—è |
|----|---------|-----|--------|--------|
| K1 | –¢–æ–Ω–∫–∏–µ —Ö—ç–Ω–¥–ª–µ—Ä—ã | üèõ | ACTIVE | 1.0 |
| K2 | –ò–¥–µ–º–ø–æ—Ç–µ–Ω—Ç–Ω–æ—Å—Ç—å + –∫–æ–Ω–∫—É—Ä–µ–Ω—Ç–Ω–æ—Å—Ç—å | üèõ | ACTIVE | 1.0 |
| K3 | –ù–∞–±–ª—é–¥–∞–µ–º–æ—Å—Ç—å (–ª–æ–≥–∏ + SyncLog) | üèõ | ACTIVE | 1.0 |
| K4 | –í–∞–ª–∏–¥–∞—Ü–∏—è (Trust Nothing) | üèõ | ACTIVE | 1.0 |
| K5 | UX ‚Äî –æ–¥–Ω–æ –æ–∫–Ω–æ, –Ω–µ—Ç –º—É—Å–æ—Ä–∞ | üèó | ACTIVE | 1.0 |
| R1 | `now_kgd()` –≤–º–µ—Å—Ç–æ `datetime.now()` | üîß | ACTIVE | 1.0 |
| R2 | `X \| None` –≤–º–µ—Å—Ç–æ `Optional[X]` | üìè | ACTIVE | 1.0 |
| R3 | UPSERT batch=500 + mirror-delete | üèó | ACTIVE | 1.0 |
| R4 | Persistent httpx.AsyncClient | üèó | ACTIVE | 1.0 |
| R5 | –ú–∏–≥—Ä–∞—Ü–∏–∏ —á–µ—Ä–µ–∑ `_MIGRATIONS` + IF NOT EXISTS | üîß | ACTIVE | 1.0 |
| R6 | GSheet –∫–∞–∫ –∏—Å—Ç–æ—á–Ω–∏–∫ –ø—Ä–∞–≤ (–Ω–µ –ë–î) | üèó | ACTIVE | 1.0 |
| R7 | OCR: GPT-5.2 Vision (Yandex Vision / Gemini ‚Äî abandoned) | üîß | ACTIVE | 2.0 |

---

## ü§ù –ü—Ä–æ—Ç–æ–∫–æ–ª –µ–¥–∏–Ω—Å—Ç–≤–∞ (–¥–ª—è AI-–∞—Å—Å–∏—Å—Ç–µ–Ω—Ç–∞)

### –ü–æ—Ä—è–¥–æ–∫ —Ä–∞–±–æ—Ç—ã
1. **–ó–∞–≥—Ä—É–∑–∏ MAP** (—ç—Ç–æ—Ç —Ñ–∞–π–ª) ‚Äî –≤—Å–µ–≥–¥–∞.
2. **–û–ø—Ä–µ–¥–µ–ª–∏ –¥–æ–º–µ–Ω** –∑–∞–¥–∞—á–∏ ‚Üí –∑–∞–≥—Ä—É–∑–∏ 1‚Äì2 —Ñ–∞–π–ª–∞ –∏–∑ –≥—Ä–∞—Ñ–∞ –Ω–∞–≤–∏–≥–∞—Ü–∏–∏.
3. **–ê–Ω–∞–ª–∏–∑** —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–≥–æ –∫–æ–¥–∞ (grep/read) ‚Üí –ø–ª–∞–Ω.
4. **–†–µ–∞–ª–∏–∑–∞—Ü–∏—è:** use_case ‚Üí handler ‚Üí —Ç–µ—Å—Ç/–ø—Ä–æ–≤–µ—Ä–∫–∞.
5. **–î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è:** –æ–±–Ω–æ–≤–∏ docs/ + CHANGELOG.md.

### –ü—Ä–∞–≤–∏–ª–æ 99%+1%
–î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è –ø–æ–∫—Ä—ã–≤–∞–µ—Ç 99% –¥–µ–π—Å—Ç–≤–∏–π. –î–ª—è –æ—Å—Ç–∞–≤—à–µ–≥–æ—Å—è 1%:
- –û–ø—Ä–µ–¥–µ–ª–∏ –±–ª–∏–∂–∞–π—à–∏–π –¥–æ–º–µ–Ω-–¥–æ–∫—É–º–µ–Ω—Ç.
- –ù–∞–π–¥–∏ —à–∞–±–ª–æ–Ω –º–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–∏—è (¬ß –®–∞–±–ª–æ–Ω—ã –≤—ã—à–µ).
- –°–∫–æ–ø–∏—Ä—É–π –ø–∞—Ç—Ç–µ—Ä–Ω –∏–∑ —ç—Ç–∞–ª–æ–Ω–Ω–æ–≥–æ –º–æ–¥—É–ª—è.
- –ï—Å–ª–∏ –Ω–µ—Ç –ø–æ–¥—Ö–æ–¥—è—â–µ–≥–æ —à–∞–±–ª–æ–Ω–∞ ‚Äî —Å–æ–∑–¥–∞–π –Ω–æ–≤—ã–π –¥–æ–º–µ–Ω-–¥–æ–∫—É–º–µ–Ω—Ç –ø–æ –®–∞–±–ª–æ–Ω—É 3.

### –ü–µ—Å–æ—á–Ω–∏—Ü–∞ (sandbox/) ‚Äî –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π —Ä–µ–∂–∏–º

AI **—Å–∞–º** —Ä–µ—à–∞–µ—Ç –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å sandbox, –∫–æ–≥–¥–∞ –∑–∞–¥–∞—á–∞ = –Ω–æ–≤–∞—è —Ñ–∏—á–∞ / –ø–µ—Ä–µ—Ä–∞–±–æ—Ç–∫–∞ / –∏—Å—Å–ª–µ–¥–æ–≤–∞–Ω–∏–µ API / –∏–∑–æ–ª—è—Ü–∏—è –±–∞–≥–∞.
–ü—Ä–æ—Ç–æ–∫–æ–ª: `sandbox/<feature>_test.py` ‚Üí –∏—Ç–µ—Ä–∞—Ü–∏–∏ ‚Üí –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è –≤ –æ—Å–Ω–æ–≤–Ω–æ–π –ø—Ä–æ–µ–∫—Ç ‚Üí **–∑–∞—á–∏—Å—Ç–∫–∞ sandbox/**.
AI **–Ω–µ** –∏—Å–ø–æ–ª—å–∑—É–µ—Ç sandbox –¥–ª—è –ø—Ä–æ—Å—Ç—ã—Ö –ø—Ä–∞–≤–æ–∫, —à–∞–±–ª–æ–Ω–Ω—ã—Ö —Ö—ç–Ω–¥–ª–µ—Ä–æ–≤, –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏, –∞—É–¥–∏—Ç–∞.

–ü–∞–ø–∫–∞ –≤ `.gitignore` (–∫—Ä–æ–º–µ README). –ü–æ–ª–Ω–∞—è –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—è: `sandbox/README.md`.

### –ê—É–¥–∏—Ç –ø—Ä–æ–µ–∫—Ç–∞ (–ø–æ –∑–∞–ø—Ä–æ—Å—É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è)

–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∑–∞–ø—Ä–∞—à–∏–≤–∞–µ—Ç –∞—É–¥–∏—Ç —Ñ—Ä–∞–∑–æ–π –≤—Ä–æ–¥–µ ¬´–ø—Ä–æ–≤–µ–¥–∏ –∞—É–¥–∏—Ç –ø—Ä–æ–µ–∫—Ç–∞¬ª.
AI –≤—ã–ø–æ–ª–Ω—è–µ—Ç **–ø–æ–ª–Ω—ã–π** —á–µ–∫–ª–∏—Å—Ç –Ω–∏–∂–µ, –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ. –ß–µ–∫–ª–∏—Å—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Ä–∞—Å—à–∏—Ä—è–µ—Ç—Å—è –ø—Ä–∏ –ø–æ—è–≤–ª–µ–Ω–∏–∏ –Ω–æ–≤—ã—Ö –∫–æ–Ω—Ç—Ä–∞–∫—Ç–æ–≤, –ø—Ä–∞–≤–∏–ª, –º–æ–¥—É–ª–µ–π ‚Äî AI –≥–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç –ø—É–Ω–∫—Ç—ã **–¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏** –Ω–∞ –æ—Å–Ω–æ–≤–µ —Ç–µ–∫—É—â–µ–≥–æ —Å–æ—Å—Ç–æ—è–Ω–∏—è MAP.

#### –§–∞–∑–∞ 1: –ö–æ–Ω—Ç—Ä–∞–∫—Ç—ã (K1‚ÄìKn)
–î–ª—è **–∫–∞–∂–¥–æ–≥–æ** –∫–æ–Ω—Ç—Ä–∞–∫—Ç–∞ –∏–∑ —Ç–∞–±–ª–∏—Ü—ã ¬´–†–µ–µ—Å—Ç—Ä –ø—Ä–∞–≤–∏–ª¬ª —Å–æ —Å—Ç–∞—Ç—É—Å–æ–º ACTIVE:
- –í—ã–ø–æ–ª–Ω–∏—Ç—å —Ç–µ—Å—Ç –∏–∑ –æ–ø–∏—Å–∞–Ω–∏—è –∫–æ–Ω—Ç—Ä–∞–∫—Ç–∞
- –ó–∞—Ñ–∏–∫—Å–∏—Ä–æ–≤–∞—Ç—å –Ω–∞—Ä—É—à–µ–Ω–∏—è (—Ñ–∞–π–ª + —Å—Ç—Ä–æ–∫–∞ + —Å—É—Ç—å)

**–ü—Ä–∏–º–µ—Ä K1:** `grep` –ø–æ `bot/*.py` ‚Äî –Ω–∏ –æ–¥–Ω–æ–≥–æ SQL/httpx/–±–∏–∑–Ω–µ—Å-–≤—ã—á–∏—Å–ª–µ–Ω–∏—è.
**–ü—Ä–∏–º–µ—Ä K3:** `grep` –ø–æ handler'–∞–º ‚Äî –Ω–µ—Ç handler –±–µ–∑ `logger.info` –Ω–∞ –ø–µ—Ä–≤—ã—Ö 5 —Å—Ç—Ä–æ–∫–∞—Ö.
**–ü—Ä–∏–º–µ—Ä K4:** `grep` –ø–æ callback-handler'–∞–º ‚Äî –∫–∞–∂–¥—ã–π —Å–æ–¥–µ—Ä–∂–∏—Ç `try UUID()/int()`.

#### –§–∞–∑–∞ 2: –ü—Ä–∞–≤–∏–ª–∞ (R1‚ÄìRn)
–î–ª—è **–∫–∞–∂–¥–æ–≥–æ** –ø—Ä–∞–≤–∏–ª–∞ –∏–∑ —Ä–µ–µ—Å—Ç—Ä–∞ —Å–æ —Å—Ç–∞—Ç—É—Å–æ–º ACTIVE:
- –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å–æ–±–ª—é–¥–µ–Ω–∏–µ –≤ –∫–æ–¥–µ
- `R1`: –Ω–µ—Ç `datetime.now()` / `datetime.utcnow()` (–∫—Ä–æ–º–µ `_utcnow` –≤ models)
- `R3`: –≤—Å–µ sync-—Ñ—É–Ω–∫—Ü–∏–∏ –∏—Å–ø–æ–ª—å–∑—É—é—Ç `_run_sync` –∏–ª–∏ UPSERT-–ø–∞—Ç—Ç–µ—Ä–Ω
- –ù–æ–≤—ã–µ –ø—Ä–∞–≤–∏–ª–∞ ‚Äî AI —Ñ–æ—Ä–º—É–ª–∏—Ä—É–µ—Ç –ø—Ä–æ–≤–µ—Ä–∫—É –ø–æ –æ–ø–∏—Å–∞–Ω–∏—é

#### –§–∞–∑–∞ 3: –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è ‚Üî –ö–æ–¥
| –ü—Ä–æ–≤–µ—Ä–∫–∞ | –ö–∞–∫ |
|----------|-----|
| –¢–∞–±–ª–∏—Ü—ã –ë–î | –ö–æ–ª-–≤–æ –º–æ–¥–µ–ª–µ–π –≤ `db/models.py` + `db/ft_models.py` = –∫–æ–ª-–≤–æ –≤ `docs/DATABASE.md` |
| –ú–æ–¥—É–ª–∏ | –§–∞–π–ª—ã –≤ `use_cases/`, `adapters/`, `bot/` = –∑–∞–ø–∏—Å–∏ –≤ `docs/FILE_STRUCTURE.md` |
| Env vars | –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –≤ `config.py` = –∑–∞–ø–∏—Å–∏ –≤ `docs/ENV_VARS.md` |
| –ö–Ω–æ–ø–∫–∏ –±–æ—Ç–∞ | `NAV_BUTTONS` –≤ `global_commands.py` = –æ–ø–∏—Å–∞–Ω–∏–µ –≤ `docs/UX_PATTERNS.md` |
| –†–æ—É—Ç–µ—Ä—ã | `dp.include_router()` –≤ `main.py` = –æ–ø–∏—Å–∞–Ω–∏–µ –≤ `docs/FILE_STRUCTURE.md` |

#### –§–∞–∑–∞ 4: –†–∞—Å—Ö–æ–∂–¥–µ–Ω–∏—è
–î–ª—è –∫–∞–∂–¥–æ–≥–æ –Ω–∞–π–¥–µ–Ω–Ω–æ–≥–æ —Ä–∞—Å—Ö–æ–∂–¥–µ–Ω–∏—è:
1. –ö–ª–∞—Å—Å–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞—Ç—å: HIGH (–ø–æ–≤–µ–¥–µ–Ω–∏–µ) / MEDIUM (–¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è) / LOW (—Å—Ç–∏–ª—å)
2. –ò—Å–ø—Ä–∞–≤–∏—Ç—å –∫–æ–¥ –∏–ª–∏ –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—é
3. –ó–∞–ø–∏—Å–∞—Ç—å –≤ `docs/CHANGELOG.md` —Å —Ç–µ–≥–æ–º `[AUDIT]`

#### –§–∞–∑–∞ 5: –û—Ç—á—ë—Ç
–°–æ–æ–±—â–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é —Å–≤–æ–¥–∫—É:
```
–ê—É–¥–∏—Ç –∑–∞–≤–µ—Ä—à—ë–Ω. –ü—Ä–æ–≤–µ—Ä–µ–Ω–æ: N –∫–æ–Ω—Ç—Ä–∞–∫—Ç–æ–≤, M –ø—Ä–∞–≤–∏–ª, X –º–æ–¥—É–ª–µ–π.
–ù–∞–π–¥–µ–Ω–æ —Ä–∞—Å—Ö–æ–∂–¥–µ–Ω–∏–π: A HIGH, B MEDIUM, C LOW.
–ò—Å–ø—Ä–∞–≤–ª–µ–Ω–æ: ... –û—Å—Ç–∞–ª–æ—Å—å: ...
```

> **–†–∞—Å—à–∏—Ä—è–µ–º–æ—Å—Ç—å:** AI –Ω–µ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω —ç—Ç–∏–º —Å–ø–∏—Å–∫–æ–º. –ï—Å–ª–∏ –≤ —Ä–µ–µ—Å—Ç—Ä–µ –ø–æ—è–≤–∏–ª—Å—è –Ω–æ–≤—ã–π
> –∫–æ–Ω—Ç—Ä–∞–∫—Ç K6 –∏–ª–∏ –ø—Ä–∞–≤–∏–ª–æ R8 ‚Äî –∞—É–¥–∏—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –≤–∫–ª—é—á–∞–µ—Ç –∏—Ö –ø—Ä–æ–≤–µ—Ä–∫—É.
> –ï—Å–ª–∏ –ø–æ—è–≤–∏–ª—Å—è –Ω–æ–≤—ã–π –¥–æ–º–µ–Ω-–¥–æ–∫—É–º–µ–Ω—Ç ‚Äî AI –¥–æ–±–∞–≤–ª—è–µ—Ç –ø—Ä–æ–≤–µ—Ä–∫—É —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏—è.

### DoD (Definition of Done) –¥–ª—è –ª—é–±–æ–≥–æ –∏–∑–º–µ–Ω–µ–Ω–∏—è
- [ ] –ö–æ–Ω—Ç—Ä–∞–∫—Ç—ã K1‚ÄìK5 –Ω–µ –Ω–∞—Ä—É—à–µ–Ω—ã
- [ ] –õ–æ–≥–∏: entry-–ª–æ–≥ –≤ handler, —Ç–∞–π–º–∏–Ω–≥ –≤ use_case
- [ ] –í–∞–ª–∏–¥–∞—Ü–∏—è: callback_data, —Ç–µ–∫—Å—Ç, FSM-–∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è
- [ ] UX: edit (–Ω–µ answer), delete user text, placeholder –¥–ª—è >1—Å
- [ ] –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è –æ–±–Ω–æ–≤–ª–µ–Ω–∞ (docs/ + CHANGELOG)
- [ ] –ù–µ—Ç —É—Ç–µ—á–µ–∫ —Å–µ–∫—Ä–µ—Ç–æ–≤ –≤ –ª–æ–≥–∞—Ö
- [ ] –ù–µ—Ç –ª–∏—à–Ω–∏—Ö round-trips –∫ –ë–î (Railway latency!)

### –ö–µ—à–∏—Ä–æ–≤–∞–Ω–∏–µ ‚Äî 4 —É—Ä–æ–≤–Ω—è
| –£—Ä–æ–≤–µ–Ω—å | –ü—Ä–∏–º–µ—Ä | TTL |
|---------|--------|-----|
| In-memory dict | user_context, admin_ids | 30 –º–∏–Ω |
| TTL-–∫–µ—à | permissions, writeoff_cache | 5‚Äì30 –º–∏–Ω |
| FSM state.data | `_stores_cache` –≤ flow | –¥–æ `state.clear()` |
| GSheet ‚Üí memory | permissions, cloud_org_mapping | 5 –º–∏–Ω |

### Fallback ‚Äî –≤—Å–µ–≥–¥–∞ graceful
- –ù–µ—Ç –∫–µ—à–∞ ‚Üí –∑–∞–ø—Ä–æ—Å –ë–î (–Ω–µ –æ—à–∏–±–∫–∞)
- –ù–µ—Ç –∞–¥–º–∏–Ω–æ–≤ ‚Üí –æ—Ç–ø—Ä–∞–≤–∫–∞ –≤—Å–µ–º (–Ω–µ ¬´–Ω–µ–≤–æ–∑–º–æ–∂–Ω–æ¬ª)
- –ê–≤—Ç–æ-–≤—ã–±–æ—Ä –Ω–µ —Å—Ä–∞–±–æ—Ç–∞–ª ‚Üí —Ä—É—á–Ω–æ–π (–Ω–µ —Å–±–æ–π)
- –ù–µ—Ç unit_name ‚Üí ¬´—à—Ç¬ª (–Ω–µ –ø—É—Å—Ç–∞—è —Å—Ç—Ä–æ–∫–∞)

---

## ‚úÖ –ë—ã—Å—Ç—Ä—ã–π —á–µ–∫–ª–∏—Å—Ç (–∫–æ–ø–∏—Ä—É–π –≤ –ø—Ä–æ–º–ø—Ç)

```
–ü—Ä–æ—á–∏—Ç–∞–π PROJECT_MAP.md. –°–æ–±–ª—é–¥–∞–π –∫–æ–Ω—Ç—Ä–∞–∫—Ç—ã K1‚ÄìK5:

- [ ] handler —Ç–æ–Ω–∫–∏–π ‚Üí –ª–æ–≥–∏–∫–∞ –≤ use_cases/ ‚Üí –∞–¥–∞–ø—Ç–µ—Ä—ã –≤ adapters/
- [ ] callback_data: try UUID()/int() except ‚Üí answer("‚ö†Ô∏è"); return
- [ ] logger.info("[module] action tg:%d") –≤ –∫–∞–∂–¥–æ–º handler
- [ ] callback.answer() ‚Äî –ø–µ—Ä–≤–∞—è —Å—Ç—Ä–æ–∫–∞ callback-handler
- [ ] inline ‚Üí edit_text(), —Ç–µ–∫—Å—Ç ‚Üí message.delete()
- [ ] >1—Å ‚Üí ‚è≥ placeholder ‚Üí edit —Ä–µ–∑—É–ª—å—Ç–∞—Ç
- [ ] docs/ –æ–±–Ω–æ–≤–ª–µ–Ω—ã + –∑–∞–ø–∏—Å—å –≤ CHANGELOG.md
```
