#!/bin/sh
# Pre-commit hook: проверяет, что ни один staged .py-файл
# не содержит символа U+FFFD (признак повреждённой кодировки).
#
# Установка (из корня репозитория):
#   Linux / macOS / Git Bash:
#     cp hooks/pre-commit .git/hooks/pre-commit && chmod +x .git/hooks/pre-commit
#   PowerShell:
#     Copy-Item hooks/pre-commit .git/hooks/pre-commit

# Ищем рабочий Python (проверяем реальный запуск, а не только наличие в PATH —
# на Windows command -v python находит заглушку Microsoft Store, которая не работает)
PY=""
for candidate in python3 python; do
    if command -v "$candidate" > /dev/null 2>&1; then
        if "$candidate" -c "pass" > /dev/null 2>&1; then
            PY="$candidate"
            break
        fi
    fi
done

if [ -z "$PY" ]; then
    echo "Warning: Python not found or not functional -- UTF-8 pre-commit check skipped."
    exit 0
fi

$PY - << 'PYEOF'
import subprocess, sys

result = subprocess.run(
    ["git", "diff", "--cached", "--name-only", "--diff-filter=ACMR"],
    capture_output=True, text=True, encoding="utf-8",
)
staged = [f for f in result.stdout.splitlines() if f.endswith(".py")]

bad = []
for path in staged:
    try:
        if "\ufffd" in open(path, encoding="utf-8", errors="replace").read():
            bad.append(path)
    except OSError:
        pass

if bad:
    print("COMMIT BLOCKED: corrupted encoding (U+FFFD) in:")
    for f in bad:
        print(f"  {f}")
    print()
    print("Fix: VS Code -> bottom status bar -> click encoding")
    print("     -> 'Reopen with Encoding' -> UTF-8")
    sys.exit(1)
PYEOF
