# OCR Pipeline ‚Äî –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è –∏ –æ—Ç—á—ë—Ç –æ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–µ

**–î–∞—Ç–∞ —Å–æ–∑–¥–∞–Ω–∏—è:** 2026-02-18  
**–°—Ç–∞—Ç—É—Å:** MVP –≥–æ—Ç–æ–≤–æ –∫ –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏  
**–°–ª–µ–¥—É—é—â–∏–π —à–∞–≥:** –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å Telegram –±–æ—Ç–æ–º

---

## üìã –ß—Ç–æ –±—ã–ª–æ —Å–¥–µ–ª–∞–Ω–æ

### 1. –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ —Å–∏—Å—Ç–µ–º—ã

**–ì–∏–±—Ä–∏–¥–Ω–æ–µ —Ä–µ—à–µ–Ω–∏–µ:**
- ‚ùå Yandex OCR ‚Äî **–ù–ï –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è** (DNS –±–ª–æ–∫–∏—Ä–æ–≤–∫–∞ `api.yandex.cloud`)
- ‚úÖ GPT-5.2 Vision ‚Äî **–æ—Å–Ω–æ–≤–Ω–æ–π –¥–≤–∏–∂–æ–∫** (—Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏–µ + –∏–∑–≤–ª–µ—á–µ–Ω–∏–µ –ø–æ–ª–µ–π)

**Pipeline –æ–±—Ä–∞–±–æ—Ç–∫–∏:**
```
–§–æ—Ç–æ ‚Üí –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–∞—á–µ—Å—Ç–≤–∞ ‚Üí GPT-5.2 ‚Üí –ü—Ä–æ–≤–µ—Ä–∫–∞ QR ‚Üí –ì—Ä—É–ø–ø–∏—Ä–æ–≤–∫–∞ ‚Üí –û–±—ä–µ–¥–∏–Ω–µ–Ω–∏–µ ‚Üí JSON
```

---

### 2. –°–æ–∑–¥–∞–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã

| –§–∞–π–ª | –ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ | –°—Ç–∞—Ç—É—Å |
|------|------------|--------|
| `adapters/gpt5_vision_ocr.py` | GPT-5.2 OCR –∞–¥–∞–ø—Ç–µ—Ä | ‚úÖ –ì–æ—Ç–æ–≤–æ |
| `utils/photo_validator.py` | –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–∞—á–µ—Å—Ç–≤–∞ —Ñ–æ—Ç–æ | ‚úÖ –ì–æ—Ç–æ–≤–æ |
| `utils/qr_detector.py` | –î–µ—Ç–µ–∫—Ü–∏—è QR-–∫–æ–¥–æ–≤ | ‚úÖ –ì–æ—Ç–æ–≤–æ |
| `use_cases/ocr_pipeline.py` | –û—Å–Ω–æ–≤–Ω–æ–π pipeline | ‚úÖ –ì–æ—Ç–æ–≤–æ |
| `models/ocr.py` | SQLAlchemy –º–æ–¥–µ–ª–∏ –ë–î | ‚úÖ –ì–æ—Ç–æ–≤–æ |
| `test_ocr_full.py` | –¢–µ—Å—Ç –Ω–∞ —Ä–µ–∞–ª—å–Ω—ã—Ö —Ñ–æ—Ç–æ | ‚úÖ –†–∞–±–æ—Ç–∞–µ—Ç |
| `test_ocr_mock.py` | –¢–µ—Å—Ç —Å –º–æ–∫-–¥–∞–Ω–Ω—ã–º–∏ | ‚úÖ –í—Å–µ —Ç–µ—Å—Ç—ã –ø—Ä–æ—à–ª–∏ |
| `ocr_results.json` | –†–∞—Å–ø–æ–∑–Ω–∞–Ω–Ω—ã–µ —Ñ–æ—Ç–æ (17) | ‚úÖ –°–æ–∑–¥–∞–Ω |
| `ocr_results_merged.json` | –û–±—ä–µ–¥–∏–Ω—ë–Ω–Ω—ã–µ –¥–æ–∫—É–º–µ–Ω—Ç—ã (10) | ‚úÖ –°–æ–∑–¥–∞–Ω |

---

### 3. –ö–ª—é—á–µ–≤—ã–µ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏

#### ‚úÖ –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–∞—á–µ—Å—Ç–≤–∞ —Ñ–æ—Ç–æ
- –†–∞–∑–º—ã—Ç–æ—Å—Ç—å (Laplacian variance ‚â• 80)
- –û—Å–≤–µ—â—ë–Ω–Ω–æ—Å—Ç—å (—è—Ä–∫–æ—Å—Ç—å 50-240)
- –†–∞–∑—Ä–µ—à–µ–Ω–∏–µ (–º–∏–Ω–∏–º—É–º 300x300)
- –û—Ä–∏–µ–Ω—Ç–∞—Ü–∏—è (–≤–µ—Ä—Ç–∏–∫–∞–ª—å–Ω—ã–µ **–¥–æ–ø—É—Å—Ç–∏–º—ã**)

#### ‚úÖ –î–µ—Ç–µ–∫—Ü–∏—è QR-–∫–æ–¥–æ–≤
- OpenCV QRCodeDetector
- pyzbar (–æ—Å–Ω–æ–≤–Ω–æ–π –º–µ—Ç–æ–¥)
- –ê–¥–∞–ø—Ç–∏–≤–Ω–∞—è –±–∏–Ω–∞—Ä–∏–∑–∞—Ü–∏—è –¥–ª—è –ø–ª–æ—Ö–∏—Ö —Å–∫–∞–Ω–æ–≤
- **–õ–æ–≥–∏–∫–∞:** –æ—Ç–∫–ª–æ–Ω—è–µ–º –¢–û–õ–¨–ö–û —á–µ–∫–∏ —Å QR

#### ‚úÖ –ì—Ä—É–ø–ø–∏—Ä–æ–≤–∫–∞ –º–Ω–æ–≥–æ—Å—Ç—Ä–∞–Ω–∏—á–Ω—ã—Ö –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤
- `group_key = "{supplier_inn}_{doc_number}_{date}"`
- –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –æ–±—ä–µ–¥–∏–Ω–µ–Ω–∏–µ —Ç–æ–≤–∞—Ä–æ–≤ –∏–∑ –≤—Å–µ—Ö —Å—Ç—Ä–∞–Ω–∏—Ü
- –ü—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ –µ—Å–ª–∏ –Ω–µ —Ö–≤–∞—Ç–∞–µ—Ç —Å—Ç—Ä–∞–Ω–∏—Ü

#### ‚úÖ –ò–∑–≤–ª–µ—á–µ–Ω–∏–µ –ø–æ–ª–µ–π
- **–ü–æ—Å—Ç–∞–≤—â–∏–∫:** name + inn
- **–ü–æ–∫—É–ø–∞—Ç–µ–ª—å:** name + inn (–µ—Å–ª–∏ –µ—Å—Ç—å)
- **–¢–æ–≤–∞—Ä—ã:** name, unit, qty, price, sum, vat_rate
- **–°—É–º–º—ã:** –∞–≤—Ç–æ–ø–µ—Ä–µ—Å—á—ë—Ç –ø—Ä–∏ –æ–±—ä–µ–¥–∏–Ω–µ–Ω–∏–∏

---

## üìä –†–µ–∑—É–ª—å—Ç–∞—Ç—ã —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è

### –¢–µ—Å—Ç –Ω–∞ 17 —Ñ–æ—Ç–æ –∏–∑ `photo_test/`

| –¢–∏–ø –¥–æ–∫—É–º–µ–Ω—Ç–∞ | –í—Å–µ–≥–æ | –†–∞—Å–ø–æ–∑–Ω–∞–Ω–æ | –û—Ç–∫–ª–æ–Ω–µ–Ω–æ (QR) |
|--------------|-------|------------|----------------|
| –£–ü–î (1-2 —Å—Ç—Ä.) | 11 | 11 | 0 |
| –ß–µ–∫–∏ | 4 | 0 | 4 |
| –†–ö–û | 1 | 1 | 0 |
| –ê–∫—Ç | 1 | 1 | 0 |
| **–ò—Ç–æ–≥–æ** | **17** | **13 (76%)** | **4 (24%)** |

### –ú–Ω–æ–≥–æ—Å—Ç—Ä–∞–Ω–∏—á–Ω—ã–µ –¥–æ–∫—É–º–µ–Ω—Ç—ã

| group_key | doc_number | –°—Ç—Ä–∞–Ω–∏—Ü | –°—Ç–∞—Ç—É—Å |
|-----------|------------|---------|--------|
| 422373281150_–£–¢-41076_2025-11-28 | –£–¢-41076 | 2/2 | ‚úÖ –û–±—ä–µ–¥–∏–Ω—ë–Ω |
| 3906963687_–£–¢-21660_2025-11-28 | –£–¢-21660 | 1/2 | ‚ö†Ô∏è –ù–µ–ø–æ–ª–Ω—ã–π |
| 3906963687_–£–¢-21661_2025-11-28 | –£–¢-21661 | 2/2 | ‚úÖ –û–±—ä–µ–¥–∏–Ω—ë–Ω |
| 3900040690_5881_2025-11-28 | 5881 | 2/2 | ‚úÖ –û–±—ä–µ–¥–∏–Ω—ë–Ω |

---

## ‚ö†Ô∏è –û—à–∏–±–∫–∏ –∏ —Å–ª–æ–∂–Ω–æ—Å—Ç–∏

### 1. Yandex Cloud API –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω

**–ü—Ä–æ–±–ª–µ–º–∞:**
```
[Errno 11001] getaddrinfo failed
```
- `api.yandex.cloud` –Ω–µ —Ä–µ–∑–æ–ª–≤–∏—Ç—Å—è —á–µ—Ä–µ–∑ DNS
- `vision.api.yandexcloud.net` ‚Äî —Ç–∞ –∂–µ –ø—Ä–æ–±–ª–µ–º–∞

**–ü—Ä–∏—á–∏–Ω–∞:** –ë–ª–æ–∫–∏—Ä–æ–≤–∫–∞ –Ω–∞ —É—Ä–æ–≤–Ω–µ –ø—Ä–æ–≤–∞–π–¥–µ—Ä–∞/–∫–æ—Ä–ø–æ—Ä–∞—Ç–∏–≤–Ω–æ–≥–æ firewall

**–†–µ—à–µ–Ω–∏–µ:** –ü–æ–ª–Ω—ã–π –ø–µ—Ä–µ—Ö–æ–¥ –Ω–∞ GPT-5.2 Vision

---

### 2. GPT-5.2 API –ø–∞—Ä–∞–º–µ—Ç—Ä—ã

**–ü—Ä–æ–±–ª–µ–º–∞ 1:** `max_tokens` –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è
```
Error: 'max_tokens' is not supported with this model. Use 'max_completion_tokens' instead.
```

**–†–µ—à–µ–Ω–∏–µ:** –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å `max_completion_tokens=4096`

---

**–ü—Ä–æ–±–ª–µ–º–∞ 2:** `temperature` –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è
```
Error: 'temperature' does not support 0.05 with this model. Only the default (1) is supported.
```

**–†–µ—à–µ–Ω–∏–µ:** –£–¥–∞–ª–∏—Ç—å –ø–∞—Ä–∞–º–µ—Ç—Ä temperature (–∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è 1 –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é)

---

### 3. –î–µ—Ç–µ–∫—Ü–∏—è QR-–∫–æ–¥–æ–≤

**–ü—Ä–æ–±–ª–µ–º–∞:** pyzbar/OpenCV –Ω–µ –≤–∏–¥—è—Ç QR –Ω–∞ –Ω–µ–∫–æ—Ç–æ—Ä—ã—Ö —á–µ–∫–∞—Ö

**–ü—Ä–∏—á–∏–Ω–∞:**
- QR-–∫–æ–¥ –≤ –Ω–∏–∂–Ω–µ–π —á–∞—Å—Ç–∏ —á–µ–∫–∞ (–æ–±—Ä–µ–∑–∞–Ω)
- –ù–∏–∑–∫–∏–π –∫–æ–Ω—Ç—Ä–∞—Å—Ç
- –ú–∞–ª–µ–Ω—å–∫–∏–π —Ä–∞–∑–º–µ—Ä

**–†–µ—à–µ–Ω–∏–µ:**
- –ú–Ω–æ–≥–æ—Å—Ç—É–ø–µ–Ω—á–∞—Ç–∞—è –¥–µ—Ç–µ–∫—Ü–∏—è (–æ—Ä–∏–≥–∏–Ω–∞–ª ‚Üí –Ω–∏–∂–Ω—è—è –ø–æ–ª–æ–≤–∏–Ω–∞ ‚Üí –±–∏–Ω–∞—Ä–∏–∑–∞—Ü–∏—è ‚Üí —É–≤–µ–ª–∏—á–µ–Ω–∏–µ)
- **–í–∞–∂–Ω–µ–µ:** GPT-5.2 —Å–∞–º –æ–ø—Ä–µ–¥–µ–ª—è–µ—Ç `has_qr: true/false` –≤ –ø—Ä–æ–º–ø—Ç–µ

---

### 4. –û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –º–Ω–æ–≥–æ—Å—Ç—Ä–∞–Ω–∏—á–Ω–æ—Å—Ç–∏

**–ü—Ä–æ–±–ª–µ–º–∞:** GPT –Ω–µ –≤—Å–µ–≥–¥–∞ –≤–∏–¥–∏—Ç "–õ–∏—Å—Ç 1 –∏–∑ 2" –Ω–∞ –ø–µ—Ä–≤–æ–π —Å—Ç—Ä–∞–Ω–∏—Ü–µ

**–ü—Ä–∏—á–∏–Ω–∞:** –ù–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–µ 1 –Ω–µ—Ç —è–≤–Ω–æ–≥–æ —É–∫–∞–∑–∞–Ω–∏—è –Ω–∞ –º–Ω–æ–≥–æ—Å—Ç—Ä–∞–Ω–∏—á–Ω–æ—Å—Ç—å (—Ç–æ–ª—å–∫–æ –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–µ 2)

**–†–µ—à–µ–Ω–∏–µ:**
- –ì—Ä—É–ø–ø–∏—Ä–æ–≤–∫–∞ –ø–æ `group_key` –≤ –ø—Ä–æ–¥–∞–∫—à–µ–Ω–µ
- –ï—Å–ª–∏ `total_pages > len(–∑–∞–≥—Ä—É–∂–µ–Ω–Ω—ã—Ö —Å—Ç—Ä–∞–Ω–∏—Ü)` ‚Üí –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ

---

### 5. –ö–æ–¥–∏—Ä–æ–≤–∫–∞ Windows (cp1251)

**–ü—Ä–æ–±–ª–µ–º–∞:**
```
UnicodeEncodeError: 'charmap' codec can't encode character '\u2705'
```

**–ü—Ä–∏—á–∏–Ω–∞:** –≠–º–æ–¥–∑–∏ –≤ print() –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞—é—Ç—Å—è –≤ Windows console

**–†–µ—à–µ–Ω–∏–µ:** –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å ASCII —Å–∏–º–≤–æ–ª—ã –≤ —Ç–µ—Å—Ç–∞—Ö (`[OK]` –≤–º–µ—Å—Ç–æ `‚úÖ`)

---

### 6. SQLAlchemy –º–æ–¥–µ–ª–∏

**–ü—Ä–æ–±–ª–µ–º–∞ 1:** `Real` –≤–º–µ—Å—Ç–æ `REAL`
```
NameError: name 'Real' is not defined. Did you mean: 'REAL'?
```

**–†–µ—à–µ–Ω–∏–µ:** –ò–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å `REAL` –∏–∑ sqlalchemy

---

**–ü—Ä–æ–±–ª–µ–º–∞ 2:** `dict` —Ç–∏–ø –¥–ª—è JSON –ø–æ–ª–µ–π
```
ArgumentError: Could not locate SQLAlchemy Core type for Python type <class 'dict'>
```

**–†–µ—à–µ–Ω–∏–µ:** –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å `JSON` —Ç–∏–ø:
```python
from sqlalchemy import JSON
raw_json: Mapped[dict | None] = mapped_column(JSON, nullable=True)
```

---

**–ü—Ä–æ–±–ª–µ–º–∞ 3:** –ò–º–ø–æ—Ä—Ç `Base` –∏–∑ `db.engine`
```
ImportError: cannot import name 'Base' from 'db.engine'
```

**–†–µ—à–µ–Ω–∏–µ:** –°–æ–∑–¥–∞—Ç—å —Å–≤–æ–π `Base = declarative_base()` –≤ `models/ocr.py`

---

## üîë –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è (.env)

```bash
# OpenAI (–û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–û)
OPENAI_API_KEY=sk-svcacct-...

# Yandex Cloud (–ù–ï –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è, –Ω–æ –º–æ–∂–Ω–æ –æ—Å—Ç–∞–≤–∏—Ç—å)
YANDEX_IAM_TOKEN=t1....
YANDEX_FOLDER_ID=b1g...

# S3 (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ, –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è —Ñ–æ—Ç–æ)
S3_ENDPOINT=https://storage.yandexcloud.net
S3_ACCESS_KEY=ajeq...
S3_SECRET_KEY=AQVN...
S3_BUCKET=ocr-gpt

# Telegram (—É–∂–µ –µ—Å—Ç—å)
TELEGRAM_BOT_TOKEN=...

# Database (—É–∂–µ –µ—Å—Ç—å)
DATABASE_URL=postgresql+asyncpg://...
```

---

## üìÅ –°—Ç—Ä—É–∫—Ç—É—Ä–∞ JSON —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤

### –†–∞—Å–ø–æ–∑–Ω–∞–Ω–Ω—ã–µ —Ñ–æ—Ç–æ (`ocr_results.json`)

```json
{
  "photo": "photo_...11.jpg",
  "status": "success",
  "doc_type": "upd",
  "doc_number": "–£–¢-41076",
  "date": "2025-11-28",
  "supplier": {"name": "...", "inn": "..."},
  "buyer": {"name": "...", "inn": "..."},
  "items": [
    {"name": "...", "unit": "–∫–≥", "qty": 2.0, "price": 404.55, "sum": 809.09}
  ],
  "total_amount": 980.91,
  "page_number": 1,
  "total_pages": 2,
  "group_key": "422373281150_–£–¢-41076_2025-11-28"
}
```

### –û–±—ä–µ–¥–∏–Ω—ë–Ω–Ω—ã–µ –¥–æ–∫—É–º–µ–Ω—Ç—ã (`ocr_results_merged.json`)

```json
{
  "group_key": "422373281150_–£–¢-41076_2025-11-28",
  "doc_type": "upd",
  "doc_number": "–£–¢-41076",
  "items": [
    // –¢–æ–≤–∞—Ä—ã –∏–∑ –í–°–ï–• —Å—Ç—Ä–∞–Ω–∏—Ü
  ],
  "total_amount": 2125.37,
  "page_count": 2,
  "total_pages": 2,
  "is_complete": true,
  "source_photos": ["...11.jpg", "...12.jpg"]
}
```

---

## üöÄ –°–ª–µ–¥—É—é—â–∏–µ —à–∞–≥–∏ (–¥–ª—è –ø—Ä–æ–¥–æ–ª–∂–µ–Ω–∏—è)

### 1. Telegram –±–æ—Ç —Ö—ç–Ω–¥–ª–µ—Ä—ã

**–§–∞–π–ª:** `bot/document_handlers.py`

**–§—É–Ω–∫—Ü–∏–æ–Ω–∞–ª:**
- –ü—Ä–∏—ë–º —Ñ–æ—Ç–æ (–ø–æ –æ–¥–Ω–æ–º—É –∏ –ø–∞—á–∫–æ–π –¥–æ 10 —à—Ç)
- –í—ã–∑–æ–≤ `process_photo_batch()` –∏–∑ `use_cases/ocr_pipeline.py`
- –û—Ç–ø—Ä–∞–≤–∫–∞ JSON –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é –Ω–∞ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ
- –ö–Ω–æ–ø–∫–∏: `[‚úÖ –ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å] [‚úèÔ∏è –ò—Å–ø—Ä–∞–≤–∏—Ç—å] [‚ùå –û—Ç–º–µ–Ω–∞]`

---

### 2. –ú–µ—Ö–∞–Ω–∏–∫–∞ –æ–∂–∏–¥–∞–Ω–∏—è —Å—Ç—Ä–∞–Ω–∏—Ü

**–§–∞–π–ª:** `use_cases/ocr_pending.py`

**–õ–æ–≥–∏–∫–∞:**
- –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –Ω–µ–ø–æ–ª–Ω—ã—Ö –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤ –≤ –ë–î/Redis
- –¢–∞–π–º–∞—É—Ç 24 —á–∞—Å–∞
- –£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ: "–î–æ—Å—ã–ª–∞–π—Ç–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã"

---

### 3. –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å iiko

**–§–∞–π–ª:** `adapters/iiko_ocr_import.py`

**–§—É–Ω–∫—Ü–∏–æ–Ω–∞–ª:**
- –ö–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏—è JSON ‚Üí XML –¥–ª—è iiko
- POST `/resto/api/documents/import/incomingInvoice`
- –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫ –∏–º–ø–æ—Ä—Ç–∞

---

### 4. –ú–∞–ø–ø–∏–Ω–≥ —Ç–æ–≤–∞—Ä–æ–≤

**–§–∞–π–ª:** `use_cases/ocr_mapping.py`

**–õ–æ–≥–∏–∫–∞:**
- Fuzzy match –ø–æ `ocr_mapping` —Ç–∞–±–ª–∏—Ü–µ (‚â•85%)
- GSheet –¥–ª—è —Ä—É—á–Ω–æ–≥–æ –º–∞–ø–ø–∏–Ω–≥–∞
- –ê–≤—Ç–æ–æ–±—É—á–µ–Ω–∏–µ –ø–æ—Å–ª–µ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è

---

## üìù –ü—Ä–æ–º–ø—Ç –¥–ª—è GPT-5.2 (–∞–∫—Ç—É–∞–ª—å–Ω–∞—è –≤–µ—Ä—Å–∏—è)

**–§–∞–π–ª:** `adapters/gpt5_vision_ocr.py`

**–ö–ª—é—á–µ–≤—ã–µ –±–ª–æ–∫–∏:**
1. –¢–∏–ø—ã –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤ (upd/receipt/act/cash_order)
2. QR-–∫–æ–¥ (–≤–∞–∂–Ω–æ –¥–ª—è —á–µ–∫–æ–≤)
3. –ú–Ω–æ–≥–æ—Å—Ç—Ä–∞–Ω–∏—á–Ω–æ—Å—Ç—å (–õ–∏—Å—Ç X –∏–∑ Y)
4. group_key –¥–ª—è –≥—Ä—É–ø–ø–∏—Ä–æ–≤–∫–∏
5. –§–æ—Ä–º–∞—Ç JSON (—Å—Ç—Ä–æ–≥–æ –±–µ–∑ markdown)

**–ú–æ–¥–µ–ª—å:** `gpt-5.2-chat-latest`  
**–ü–∞—Ä–∞–º–µ—Ç—Ä—ã:** `max_completion_tokens=4096`

---

## üß™ –¢–µ—Å—Ç—ã

### –ó–∞–ø—É—Å—Ç–∏—Ç—å mock —Ç–µ—Å—Ç—ã:
```bash
python test_ocr_mock.py
```

**–û–∂–∏–¥–∞–µ–º—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç:**
```
ALL TESTS PASSED!
```

### –ó–∞–ø—É—Å—Ç–∏—Ç—å —Ç–µ—Å—Ç –Ω–∞ —Ä–µ–∞–ª—å–Ω—ã—Ö —Ñ–æ—Ç–æ:
```bash
python test_ocr_full.py
```

**–¢—Ä–µ–±—É–µ—Ç:** `OPENAI_API_KEY` –≤ `.env`

---

## üìä –ú–µ—Ç—Ä–∏–∫–∏ –∫–∞—á–µ—Å—Ç–≤–∞

| –ú–µ—Ç—Ä–∏–∫–∞ | –ó–Ω–∞—á–µ–Ω–∏–µ | –¶–µ–ª—å |
|---------|----------|------|
| % —Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏—è | 76% | >90% |
| % –∞–≤—Ç–æ-–º–∞–ø–ø–∏–Ω–≥–∞ | 0% (–ø–æ–∫–∞ –Ω–µ —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ) | >85% |
| –°—Ä–µ–¥–Ω–∏–π confidence | 90% | >85% |
| –í—Ä–µ–º—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ (1 —Ñ–æ—Ç–æ) | ~5 —Å–µ–∫ | <10 —Å–µ–∫ |

---

## üí∞ –°—Ç–æ–∏–º–æ—Å—Ç—å (GPT-5.2)

| –û–±—ä—ë–º | –¶–µ–Ω–∞/–¥–æ–∫—É–º–µ–Ω—Ç | –í –º–µ—Å—è—Ü |
|-------|---------------|---------|
| 100 –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤ | ~$0.04 | ~$4 |
| 1000 –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤ | ~$0.04 | ~$40 |
| 10 000 –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤ | ~$0.04 | ~$400 |

**–†–∞—Å—á—ë—Ç:** ~15K —Ç–æ–∫–µ–Ω–æ–≤ –Ω–∞ –¥–æ–∫—É–º–µ–Ω—Ç (2092 prompt + 500-1000 completion)

---

## üõ† –ó–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏

```txt
openai>=1.51.0
Pillow>=10.0.0
opencv-python>=4.0.0
opencv-contrib-python>=4.13.0  # –¥–ª—è WeChat QR detector
pyzbar>=0.1.9
boto3>=1.26.0  # –¥–ª—è S3
sqlalchemy>=2.0.0
asyncpg>=0.29.0
```

---

## üìû –ö–æ–Ω—Ç–∞–∫—Ç—ã –¥–ª—è –≤–æ–ø—Ä–æ—Å–æ–≤

**–†–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫:** [–¢–≤–æ—ë –∏–º—è]  
**Telegram:** [–¢–≤–æ–π –Ω–∏–∫]  
**–î–∞—Ç–∞ –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è:** 2026-02-18

---

## üìå –ó–∞–º–µ—Ç–∫–∏ –¥–ª—è —Å–ª–µ–¥—É—é—â–µ–π —Å–µ—Å—Å–∏–∏

1. **–ù–∞—á–∞—Ç—å —Å:** `bot/document_handlers.py`
2. **–ü—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å:** –ó–∞–≥—Ä—É–∑–∫—É 1-10 —Ñ–æ—Ç–æ –≤ Telegram
3. **–ü—Ä–æ–≤–µ—Ä–∏—Ç—å:** –ì—Ä—É–ø–ø–∏—Ä–æ–≤–∫—É –ø–æ `group_key`
4. **–†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å:** –ö–Ω–æ–ø–∫–∏ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è/–∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è
5. **–ò–Ω—Ç–µ–≥—Ä–∏—Ä–æ–≤–∞—Ç—å:** –° iiko API –¥–ª—è –∏–º–ø–æ—Ä—Ç–∞ –Ω–∞–∫–ª–∞–¥–Ω—ã—Ö

---

**–ö–æ–Ω–µ—Ü –¥–æ–∫—É–º–µ–Ω—Ç–∞.**
