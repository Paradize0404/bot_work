# üìù –°–ø–∏—Å–∞–Ω–∏—è (Writeoffs)

> **–ó–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏:** PROJECT_MAP.md (–ø—Ä–æ—á–∏—Ç–∞–Ω).  
> –ï—Å–ª–∏ –∑–∞–¥–µ–≤–∞–µ—à—å –ë–î ‚Üí –∑–∞–≥—Ä—É–∑–∏ —Å–µ–∫—Ü–∏–∏ `pending_writeoff`, `writeoff_history` –∏–∑ DATABASE.md.  
> –ï—Å–ª–∏ –Ω–æ–≤—ã–π handler ‚Üí –∑–∞–≥—Ä—É–∑–∏ UX_PATTERNS.md.

---

## –ö–æ–Ω—Ç—Ä–∞–∫—Ç—ã –¥–æ–º–µ–Ω–∞

- **WO1:** Pending writeoffs ‚Üí PostgreSQL (–ø–µ—Ä–µ–∂–∏–≤–∞—é—Ç —Ä–µ—Å—Ç–∞—Ä—Ç). In-memory —Ö—Ä–∞–Ω–µ–Ω–∏–µ –∑–∞–ø—Ä–µ—â–µ–Ω–æ.
- **WO2:** –ê–≤—Ç–æ-–≤—ã–±–æ—Ä —Å–∫–ª–∞–¥–∞ –ø–æ –¥–æ–ª–∂–Ω–æ—Å—Ç–∏ (–ë–∞—Ä/–ö—É—Ö–Ω—è). –ê–¥–º–∏–Ω ‚Üí —Ä—É—á–Ω–æ–π –≤—ã–±–æ—Ä.
- **WO3:** –ù–æ–º–µ–Ω–∫–ª–∞—Ç—É—Ä–∞ —Ñ–∏–ª—å—Ç—Ä—É–µ—Ç—Å—è –ø–æ —Ä–∞–∑—Ä–µ—à—ë–Ω–Ω—ã–º –ø–∞–ø–∫–∞–º: GOODS+DISH –∏–∑ `gsheet_export_group` (–æ–±—ã—á–Ω—ã–µ —Ç–æ—á–∫–∏) / `writeoff_request_store_group` (—Ç–æ—á–∫–∞-–ø–æ–ª—É—á–∞—Ç–µ–ª—å). PREPARED ‚Äî –±–µ–∑ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–π.
- **WO4:** –ò–¥–µ–º–ø–æ—Ç–µ–Ω—Ç–Ω—ã–π POST: UUID –≥–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç—Å—è –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏, –ø–æ–≤—Ç–æ—Ä–Ω—ã–π POST = –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ (–Ω–µ –¥—É–±–ª–∏–∫–∞—Ç).

---

## –ü–æ—Ç–æ–∫ —Å–æ–∑–¥–∞–Ω–∏—è –∞–∫—Ç–∞ (FSM)

```
üìù –°–ø–∏—Å–∞–Ω–∏—è ‚Üí [–∞–≤—Ç–æ-–≤—ã–±–æ—Ä —Å–∫–ª–∞–¥–∞] ‚Üí [–≤—ã–±–æ—Ä —Å—á—ë—Ç–∞] ‚Üí –ø–æ–∏—Å–∫ —Ç–æ–≤–∞—Ä–æ–≤ ‚Üí –≤–≤–æ–¥ –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ ‚Üí –ø—Ä–∏—á–∏–Ω–∞
  ‚îú‚îÄ –ë–µ–∑ –∞–¥–º–∏–Ω–æ–≤: –æ—Ç–ø—Ä–∞–≤–∫–∞ –≤ iiko —Å—Ä–∞–∑—É + save_to_history
  ‚îî‚îÄ –° –∞–¥–º–∏–Ω–∞–º–∏: pending_writeoff ‚Üí –∫–Ω–æ–ø–∫–∏ –æ–¥–æ–±—Ä–µ–Ω–∏—è ‚Üí iiko + save_to_history
```

**FSM-—Å–æ—Å—Ç–æ—è–Ω–∏—è:** `WriteoffStates`: `store ‚Üí account ‚Üí search_product ‚Üí enter_qty ‚Üí reason ‚Üí confirm`

## –ê–≤—Ç–æ-–≤—ã–±–æ—Ä —Å–∫–ª–∞–¥–∞

| –î–æ–ª–∂–Ω–æ—Å—Ç—å | –î–µ–π—Å—Ç–≤–∏–µ |
|-----------|----------|
| –ë–æ—Ç-–∞–¥–º–∏–Ω | –†—É—á–Ω–æ–π –≤—ã–±–æ—Ä –∏–∑ —Å–ø–∏—Å–∫–∞ |
| ¬´*–±–∞—Ä*¬ª | –ê–≤—Ç–æ ‚Üí —Å–∫–ª–∞–¥ —Ç–∏–ø–∞ ¬´–ë–∞—Ä¬ª |
| ¬´*–∫—É—Ö–Ω—è*¬ª / ¬´*–ø–æ–≤–∞—Ä*¬ª | –ê–≤—Ç–æ ‚Üí —Å–∫–ª–∞–¥ —Ç–∏–ø–∞ ¬´–ö—É—Ö–Ω—è¬ª |
| Unknown | –†—É—á–Ω–æ–π –≤—ã–±–æ—Ä |

---

## Pending writeoffs (PostgreSQL)

- –¢–∞–±–ª–∏—Ü–∞ `pending_writeoff`: `doc_id`, `author_chat_id`, `store_id`, `account_id`, `items` (JSONB), `admin_msg_ids` (JSONB), `is_locked` (–∞—Ç–æ–º–∞—Ä–Ω—ã–π –ª–æ–∫)
- TTL 24—á ‚Äî –∞–≤—Ç–æ–æ—á–∏—Å—Ç–∫–∞ expired
- –ö–æ–Ω–∫—É—Ä–µ–Ω—Ç–Ω–æ—Å—Ç—å: `UPDATE ... WHERE is_locked = false`
- –ü—Ä–∏ —Ä–µ—Å—Ç–∞—Ä—Ç–µ –±–æ—Ç–∞ ‚Äî –≤—Å–µ pending —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã, –∞–¥–º–∏–Ω –º–æ–∂–µ—Ç –æ–¥–æ–±—Ä–∏—Ç—å/–æ—Ç–∫–ª–æ–Ω–∏—Ç—å

## –ò—Å—Ç–æ—Ä–∏—è —Å–ø–∏—Å–∞–Ω–∏–π

- –¢–∞–±–ª–∏—Ü–∞ `writeoff_history`: JSONB items, `store_type` –¥–ª—è —Ä–æ–ª–µ–≤–æ–π —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏
- –ê–≤—Ç–æ–æ—á–∏—Å—Ç–∫–∞: >200 –∑–∞–ø–∏—Å–µ–π –Ω–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
- –§–∏–ª—å—Ç—Ä–∞—Ü–∏—è: –±–∞—Ä ‚Üí —Ç–æ–ª—å–∫–æ –±–∞—Ä, –∫—É—Ö–Ω—è ‚Üí —Ç–æ–ª—å–∫–æ –∫—É—Ö–Ω—è, admin ‚Üí –≤—Å–µ
- –î—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏–µ: ¬´üîÑ –ü–æ–≤—Ç–æ—Ä–∏—Ç—å¬ª ‚Üí –Ω–æ–≤—ã–π –∞–∫—Ç —Å –ø–æ–∑–∏—Ü–∏—è–º–∏ –∏–∑ –∏—Å—Ç–æ—Ä–∏–∏

---

## –ú–æ–¥—É–ª–∏

| –ú–æ–¥—É–ª—å | –†–æ–ª—å |
|--------|------|
| `bot/writeoff_handlers.py` | FSM: —Å–æ–∑–¥–∞–Ω–∏–µ, –æ–¥–æ–±—Ä–µ–Ω–∏–µ, –∏—Å—Ç–æ—Ä–∏—è, —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ |
| `use_cases/writeoff.py` | –ë–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫–∞: preload_products, build_writeoff_xml, search_products |
| `use_cases/pending_writeoffs.py` | CRUD pending –≤ PostgreSQL |
| `use_cases/writeoff_history.py` | save/get/build_summary |
| `use_cases/writeoff_cache.py` | TTL-–∫–µ—à: stores, accounts, products |

## –¢–∞–±–ª–∏—Ü—ã

| –¢–∞–±–ª–∏—Ü–∞ | –ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ | –ö–ª—é—á–µ–≤—ã–µ –ø–æ–ª—è |
|---------|-----------|---------------|
| `pending_writeoff` | –û–∂–∏–¥–∞—é—â–∏–µ –æ–¥–æ–±—Ä–µ–Ω–∏—è | doc_id, is_locked, items (JSONB) |
| `writeoff_history` | –ê—Ä—Ö–∏–≤ —Å–ø–∏—Å–∞–Ω–∏–π | telegram_id, department_id, store_type |

## –ß–∞—Å—Ç—ã–µ –æ—à–∏–±–∫–∏

1. **In-memory pending:** –ó–∞–ø—Ä–µ—â–µ–Ω–æ (WO1) ‚Äî –∏—Å–ø–æ–ª—å–∑—É–π PostgreSQL —Ç–∞–±–ª–∏—Ü—É
2. **UUID –Ω–µ –≥–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç—Å—è:** –ö–∞–∂–¥—ã–π –¥–æ–∫—É–º–µ–Ω—Ç = `uuid4()` –¥–ª—è –∏–¥–µ–º–ø–æ—Ç–µ–Ω—Ç–Ω–æ—Å—Ç–∏
3. **is_locked –≥–æ–Ω–∫–∞:** –¢–æ–ª—å–∫–æ `UPDATE ... WHERE is_locked = false` (–∞—Ç–æ–º–∞—Ä–Ω—ã–π)
4. **–ö–µ—à –ø—Ä–æ–¥—É–∫—Ç–æ–≤:** ~400 –ö–ë RAM, TTL 10 –º–∏–Ω, –ø—Ä–æ–≥—Ä–µ–≤ –ø—Ä–∏ –≤—Ö–æ–¥–µ –≤ ¬´–î–æ–∫—É–º–µ–Ω—Ç—ã¬ª
