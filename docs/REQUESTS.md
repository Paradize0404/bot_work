# üì¶ –ó–∞—è–≤–∫–∏ –Ω–∞ —Ç–æ–≤–∞—Ä—ã

> **–ó–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏:** PROJECT_MAP.md (–ø—Ä–æ—á–∏—Ç–∞–Ω).  
> –ï—Å–ª–∏ –∑–∞–¥–µ–≤–∞–µ—à—å –ë–î ‚Üí –∑–∞–≥—Ä—É–∑–∏ —Å–µ–∫—Ü–∏–∏ `product_request`, `request_receiver`, `price_product` –∏–∑ DATABASE.md.  
> –ï—Å–ª–∏ –Ω–æ–≤—ã–π handler ‚Üí –∑–∞–≥—Ä—É–∑–∏ UX_PATTERNS.md.

---

## –ö–æ–Ω—Ç—Ä–∞–∫—Ç—ã –¥–æ–º–µ–Ω–∞

- **Q1:** –°–∫–ª–∞–¥ –æ–ø—Ä–µ–¥–µ–ª—è–µ—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∏–∑ –ø—Ä–∞–π—Å-–ª–∏—Å—Ç–∞ ‚Äî –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ù–ï –≤—ã–±–∏—Ä–∞–µ—Ç —Å–∫–ª–∞–¥. –ü–µ—Ä–µ—Å–º–æ—Ç—Ä–µ—Ç—å –∫–æ–≥–¥–∞: —Ç–æ–≤–∞—Ä—ã –±–µ–∑ –ø—Ä–∏–≤—è–∑–∫–∏ –∫ —Å–∫–ª–∞–¥—É.
- **Q2:** –ö–æ–Ω—Ç—Ä–∞–≥–µ–Ω—Ç –æ–ø—Ä–µ–¥–µ–ª—è–µ—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø–æ –∏–º–µ–Ω–∏ target-—Å–∫–ª–∞–¥–∞. –ü–µ—Ä–µ—Å–º–æ—Ç—Ä–µ—Ç—å –∫–æ–≥–¥–∞: –Ω–µ—Å–∫–æ–ª—å–∫–æ –∫–æ–Ω—Ç—Ä–∞–≥–µ–Ω—Ç–æ–≤ –Ω–∞ –æ–¥–∏–Ω —Å–∫–ª–∞–¥.
- **Q3:** –ó–∞—è–≤–∫–∞ —Å —Ç–æ–≤–∞—Ä–∞–º–∏ –∏–∑ —Ä–∞–∑–Ω—ã—Ö —Å–∫–ª–∞–¥–æ–≤ ‚Üí N –æ—Ç–¥–µ–ª—å–Ω—ã—Ö –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤ –≤ iiko (–ø–æ –æ–¥–Ω–æ–º—É –Ω–∞ —Å–∫–ª–∞–¥).
- **Q4:** –ë–ª–æ–∫–∏—Ä–æ–≤–∫–∏: –≥–æ—Å—Ç—å (–Ω–µ—Ç dept) ‚Üí —Å—Ç–æ–ø; dept == ¬´–ó–∞–≤–µ–¥–µ–Ω–∏–µ –¥–ª—è –∑–∞—è–≤–æ–∫¬ª ‚Üí —Å—Ç–æ–ø

---

## –ü–æ—Ç–æ–∫ —Å–æ–∑–¥–∞–Ω–∏—è –∑–∞—è–≤–∫–∏ (FSM)

```
üìã –ó–∞—è–≤–∫–∏ ‚Üí [–±–ª–æ–∫–∏—Ä–æ–≤–∫–∏] ‚Üí –ø–æ–∏—Å–∫ —Ç–æ–≤–∞—Ä–æ–≤ ‚Üí –≤–≤–æ–¥ –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ ‚Üí –ø—Ä–µ–≤—å—é ‚Üí –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ
  ‚îî‚îÄ –ë–ª–æ–∫–∏—Ä–æ–≤–∫–∏:
  ‚îÇ   ‚îú‚îÄ –ì–æ—Å—Ç—å (–Ω–µ—Ç department) ‚Üí ¬´–°–≤—è–∂–∏—Ç–µ—Å—å —Å –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–º¬ª
  ‚îÇ   ‚îî‚îÄ department == ¬´–ó–∞–≤–µ–¥–µ–Ω–∏–µ –¥–ª—è –∑–∞—è–≤–æ–∫¬ª ‚Üí ¬´–°–º–µ–Ω–∏—Ç–µ –ø–æ–¥—Ä–∞–∑–¥–µ–ª–µ–Ω–∏–µ¬ª
  ‚îî‚îÄ –ê–≤—Ç–æ-—Å–æ–ø–æ—Å—Ç–∞–≤–ª–µ–Ω–∏–µ —Å–∫–ª–∞–¥–æ–≤:
  ‚îÇ   ‚îú‚îÄ source store = PriceProduct.store_name (–∏–∑ –ø—Ä–∞–π—Å-–ª–∏—Å—Ç–∞)
  ‚îÇ   ‚îú‚îÄ target store = —Å–∫–ª–∞–¥ —Ç–æ–≥–æ –∂–µ —Ç–∏–ø–∞ –≤ –ø–æ–¥—Ä–∞–∑–¥–µ–ª–µ–Ω–∏–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
  ‚îÇ   ‚îî‚îÄ —Ç–∏–ø –∏–∑–≤–ª–µ–∫–∞–µ—Ç—Å—è: ¬´PizzaYolo: –ö—É—Ö–Ω—è (–ú–æ—Å–∫–æ–≤—Å–∫–∏–π)¬ª ‚Üí ¬´–∫—É—Ö–Ω—è¬ª
  ‚îî‚îÄ –ê–≤—Ç–æ-–æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –∫–æ–Ω—Ç—Ä–∞–≥–µ–Ω—Ç–∞:
      ‚îî‚îÄ iiko_supplier –ø–æ –∏–º–µ–Ω–∏ target-—Å–∫–ª–∞–¥–∞ (exact ‚Üí partial)
```

**FSM-—Å–æ—Å—Ç–æ—è–Ω–∏—è:** `CreateRequestStates`: `add_items ‚Üí enter_item_qty ‚Üí confirm`

---

## –ê–≤—Ç–æ-—Å–æ–ø–æ—Å—Ç–∞–≤–ª–µ–Ω–∏–µ —Å–∫–ª–∞–¥–æ–≤ (store type matching)

1. –ò–∑ –∏–º–µ–Ω–∏ source-—Å–∫–ª–∞–¥–∞ –∏–∑–≤–ª–µ–∫–∞–µ—Ç—Å—è **—Ç–∏–ø** (`extract_store_type`): —É–±–∏—Ä–∞–µ—Ç—Å—è –±—Ä–µ–Ω–¥ –¥–æ `:` –∏ —Å—É—Ñ—Ñ–∏–∫—Å –≤ —Å–∫–æ–±–∫–∞—Ö ‚Üí `"–∫—É—Ö–Ω—è"`, `"–±–∞—Ä"`, `"—Ç–º—Ü"`
2. –í –ø–æ–¥—Ä–∞–∑–¥–µ–ª–µ–Ω–∏–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏—â–µ—Ç—Å—è —Å–∫–ª–∞–¥ —Ç–æ–≥–æ –∂–µ —Ç–∏–ø–∞ (`build_store_type_map` ‚Üí `resolve_target_store`)
3. –ì—Ä—É–ø–ø–∏—Ä–æ–≤–∫–∞ –∏ –æ—Ç–ø—Ä–∞–≤–∫–∞ –ø–æ **target-—Å–∫–ª–∞–¥–∞–º** (–Ω–µ source)
4. –ï—Å–ª–∏ —Å–æ–ø–æ—Å—Ç–∞–≤–ª–µ–Ω–∏–µ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ ‚Üí source-—Å–∫–ª–∞–¥ –∫–∞–∫ fallback

## –ê–≤—Ç–æ-–æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –∫–æ–Ω—Ç—Ä–∞–≥–µ–Ω—Ç–∞

1. `find_counteragent_for_store(target_store_name)` ‚Äî `iiko_supplier` exact ‚Üí `ILIKE %name%`
2. Fallback: `find_counteragent_for_store(source_store_name)`
3. –ö–æ–Ω—Ç—Ä–∞–≥–µ–Ω—Ç –æ–ø—Ä–µ–¥–µ–ª—è–µ—Ç—Å—è **per group** (—Ä–∞–∑–Ω—ã–µ —Å–∫–ª–∞–¥—ã ‚Üí —Ä–∞–∑–Ω—ã–µ –∫–æ–Ω—Ç—Ä–∞–≥–µ–Ω—Ç—ã)

---

## GSheet ¬´–ü—Ä–∞–π—Å-–ª–∏—Å—Ç¬ª ‚Äî —Å—Ç—Ä—É–∫—Ç—É—Ä–∞

| –ö–æ–ª–æ–Ω–∫–∞ | –°–æ–¥–µ—Ä–∂–∞–Ω–∏–µ |
|---------|------------|
| A | –ù–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ —Ç–æ–≤–∞—Ä–∞ |
| B | product_id (UUID, —Å–∫—Ä—ã—Ç—ã–π) |
| C | **–°–∫–ª–∞–¥** (dropdown –∏–∑ —Å–∫–ª–∞–¥–æ–≤ ¬´–ó–∞–≤–µ–¥–µ–Ω–∏—è –¥–ª—è –∑–∞—è–≤–æ–∫¬ª) |
| D | –°—Ç–æ–∏–º–æ—Å—Ç—å |
| E..N | –ü–æ—Å—Ç–∞–≤—â–∏–∫–∏ (–¥–æ 10 –∫–æ–ª–æ–Ω–æ–∫) |

`num_fixed = 4` (A‚ÄìD —Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ, –¥–∞–ª–µ–µ –ø–æ—Å—Ç–∞–≤—â–∏–∫–∏)

## GSheet ¬´–ù–∞—Å—Ç—Ä–æ–π–∫–∏¬ª ‚Äî –∑–∞–≤–µ–¥–µ–Ω–∏–µ –¥–ª—è –∑–∞—è–≤–æ–∫

- A = label, C = dropdown –ø–æ–¥—Ä–∞–∑–¥–µ–ª–µ–Ω–∏–π, D = VLOOKUP ‚Üí UUID
- E:F = —Å–∫—Ä—ã—Ç—ã–π —Å–ø—Ä–∞–≤–æ—á–Ω–∏–∫ (name ‚Üí uuid)
- –ü—Ä–∏ —Å–º–µ–Ω–µ dropdown ‚Üí UUID –æ–±–Ω–æ–≤–ª—è–µ—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏

---

## –°–µ–±–µ—Å—Ç–æ–∏–º–æ—Å—Ç—å DISH (—Ç–µ—Ö–∫–∞—Ä—Ç—ã)

–ò—Ç–µ—Ä–∞—Ç–∏–≤–Ω—ã–π —Ä–∞—Å—á—ë—Ç: GOODS ‚Üí PREPARED ‚Üí DISH
- –°–¶–° —Å —Ñ–∏–ª—å—Ç—Ä–æ–º –ø–æ —Å–∫–ª–∞–¥–∞–º –ø–æ–¥—Ä–∞–∑–¥–µ–ª–µ–Ω–∏—è + –¥–≤—É—Ö—É—Ä–æ–≤–Ω–µ–≤—ã–π fallback (dept ‚Üí all-stores ‚Üí –Ω–∞–∫–ª–∞–¥–Ω—ã–µ)
- –î–µ–ª–µ–Ω–∏–µ –Ω–∞ `assembledAmount` (–∫–æ–ª-–≤–æ –µ–¥–∏–Ω–∏—Ü –±–ª—é–¥–∞ –∑–∞ —Ä–µ—Ü–µ–ø—Ç)
- –ü—Ä–∞–≤–∏–ª—å–Ω–æ–µ –ø–æ–ª–µ `amountOut` (–Ω–µ `amount`)

---

## –ú–æ–¥—É–ª–∏

| –ú–æ–¥—É–ª—å | –†–æ–ª—å |
|--------|------|
| `bot/request_handlers.py` | FSM: –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏, –ø–æ–∏—Å–∫, –≥—Ä—É–ø–ø–∏—Ä–æ–≤–∫–∞ –ø–æ target-—Å–∫–ª–∞–¥–∞–º, –∞–≤—Ç–æ-–∫–æ–Ω—Ç—Ä–∞–≥–µ–Ω—Ç |
| `use_cases/product_request.py` | `create_request`, `extract_store_type`, `build_store_type_map`, `resolve_target_store`, `find_counteragent_for_store` |
| `use_cases/outgoing_invoice.py` | `search_price_products`, `get_product_store_map`, `calculate_*_cost_prices`, `sync_price_sheet` |
| `use_cases/invoice_cache.py` | TTL-–∫–µ—à: suppliers, accounts, stores, products_tree |
| `use_cases/pdf_invoice.py` | PDF —Å 2 –∫–æ–ø–∏—è–º–∏ (–∞–¥–∞–ø—Ç–∏–≤–Ω—ã–π —Ä–∞–∑–º–µ—Ä, –∫–∏—Ä–∏–ª–ª–∏—Ü–∞) |
| `adapters/google_sheets.py` | `sync_invoice_prices_to_sheet`, `read_invoice_prices`, `read_request_stores` |

## –¢–∞–±–ª–∏—Ü—ã (–∫–æ–º–ø–∞–∫—Ç–Ω–æ)

| –¢–∞–±–ª–∏—Ü–∞ | –ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ | –ö–ª—é—á–µ–≤—ã–µ –ø–æ–ª—è |
|---------|-----------|---------------|
| `product_request` | –ó–∞—è–≤–∫–∏ | status, requester_tg, department_id, items (JSONB) |
| `request_receiver` | –ü–æ–ª—É—á–∞—Ç–µ–ª–∏ | telegram_id (unique) |
| `price_product` | –ü—Ä–∞–π—Å-–ª–∏—Å—Ç | product_id, store_id, store_name |
| `price_supplier_column` | –ü–æ—Å—Ç–∞–≤—â–∏–∫–∏ –ø—Ä–∞–π—Å-–ª–∏—Å—Ç–∞ | sheet_col, supplier_name |
| `price_supplier_price` | –¶–µ–Ω—ã –ø–æ—Å—Ç–∞–≤—â–∏–∫–æ–≤ | product_id, supplier_col_id, price |
| `invoice_template` | –®–∞–±–ª–æ–Ω—ã –Ω–∞–∫–ª–∞–¥–Ω—ã—Ö | department_id, items (JSONB) |

## –ß–∞—Å—Ç—ã–µ –æ—à–∏–±–∫–∏

1. **Store type –Ω–µ –Ω–∞–π–¥–µ–Ω:** `_STORE_TYPE_ALIASES` –Ω–µ —Å–æ–¥–µ—Ä–∂–∏—Ç alias ‚Üí –¥–æ–±–∞–≤–∏—Ç—å –≤ `product_request.py`
2. **–ö–æ–Ω—Ç—Ä–∞–≥–µ–Ω—Ç –Ω–µ –Ω–∞–π–¥–µ–Ω:** –ò–º—è —Å–∫–ª–∞–¥–∞ –Ω–µ —Å–æ–≤–ø–∞–¥–∞–µ—Ç —Å `iiko_supplier.name` ‚Üí –ø—Ä–æ–≤–µ—Ä–∏—Ç—å –º–∞–ø–ø–∏–Ω–≥
3. **–¶–µ–Ω–∞ 0 —É DISH:** –ù–µ –¥–µ–ª–∏–ª–æ—Å—å –Ω–∞ `assembledAmount` (–∏—Å–ø—Ä–∞–≤–ª–µ–Ω–æ 2026-02-20)
4. **–ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω–æ–µ –ø–æ–ª–µ amount:** –î–ª—è —Ç–µ—Ö–∫–∞—Ä—Ç –ø—Ä–∞–≤–∏–ª—å–Ω–æ–µ –ø–æ–ª–µ = `amountOut` (–Ω–µ `amount`)
