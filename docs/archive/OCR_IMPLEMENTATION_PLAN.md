# üì∏ –ü–ª–∞–Ω —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏ OCR: –ì–∏–±—Ä–∏–¥–Ω–æ–µ —Ä–µ—à–µ–Ω–∏–µ (Yandex + GPT-5.2)

> –í–µ—Ä—Å–∏—è: 1.0  
> –î–∞—Ç–∞: 2026-02-18  
> –°—Ç–∞—Ç—É—Å: **–ù–∞ —Å–æ–≥–ª–∞—Å–æ–≤–∞–Ω–∏–∏**

---

## üéØ –¶–µ–ª—å

–°–æ–∑–¥–∞—Ç—å **–Ω–∞–¥—ë–∂–Ω—É—é —Å–∏—Å—Ç–µ–º—É —Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏—è –±—É—Ö–≥–∞–ª—Ç–µ—Ä—Å–∫–∏—Ö –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤** —Å –º–∏–Ω–∏–º–∞–ª—å–Ω—ã–º —É—á–∞—Å—Ç–∏–µ–º —á–µ–ª–æ–≤–µ–∫–∞ –∏ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–º –æ–±—É—á–µ–Ω–∏–µ–º.

**–ü—Ä–∏–Ω—Ü–∏–ø:** –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø—Ä–æ—Å—Ç–æ –∫–∏–¥–∞–µ—Ç —Ñ–æ—Ç–æ ‚Üí —Å–∏—Å—Ç–µ–º–∞ —Å–∞–º–∞ —Ä–∞–∑–±–∏—Ä–∞–µ—Ç—Å—è.

---

## üèó –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ (–ì–∏–±—Ä–∏–¥ Yandex + GPT-5.2)

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ –§–æ—Ç–æ –æ—Ç —é–∑–µ—Ä–∞   ‚îÇ
‚îÇ (Telegram)      ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
         ‚îÇ
         ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  1. –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–∞—á–µ—Å—Ç–≤–∞           ‚îÇ
‚îÇ     ‚Ä¢ –†–∞–∑–º—ã—Ç–æ—Å—Ç—å (OpenCV)       ‚îÇ
‚îÇ     ‚Ä¢ –û—Å–≤–µ—â–µ–Ω–∏–µ (OpenCV)        ‚îÇ
‚îÇ     ‚Ä¢ –û—Ä–∏–µ–Ω—Ç–∞—Ü–∏—è (OpenCV)       ‚îÇ
‚îÇ     ‚Ä¢ QR-–∫–æ–¥ (OpenCV/pyzbar)    ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
         ‚îÇ
         ‚îú‚îÄ‚ùå –ü–ª–æ—Ö–æ–µ –∫–∞—á–µ—Å—Ç–≤–æ ‚Üí –í–µ—Ä–Ω—É—Ç—å —Ñ–æ—Ç–æ —Å –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–µ–π
         ‚îú‚îÄ‚ùå QR-–∫–æ–¥ –æ–±–Ω–∞—Ä—É–∂–µ–Ω ‚Üí –ò–Ω—Å—Ç—Ä—É–∫—Ü–∏—è –ø—Ä–æ –§–ù–°
         ‚îÇ
         ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  2. –ö–ª–∞—Å—Å–∏—Ñ–∏–∫–∞—Ü–∏—è –¥–æ–∫—É–º–µ–Ω—Ç–∞     ‚îÇ
‚îÇ     GPT-5.2 (–±—ã—Å—Ç—Ä—ã–π –ø—Ä–æ–º–ø—Ç)    ‚îÇ
‚îÇ     –¢–∏–ø: –£–ü–î / —á–µ–∫ / –∞–∫—Ç / –æ—Ä–¥–µ—Ä‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
         ‚îÇ
         ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  3. Yandex Vision OCR           ‚îÇ
‚îÇ     –†–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏–µ —Ç–µ–∫—Å—Ç–∞        ‚îÇ
‚îÇ     (~‚ÇΩ0.03/—Å—Ç—Ä–∞–Ω–∏—Ü–∞)           ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
         ‚îÇ
         ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  4. GPT-5.2                     ‚îÇ
‚îÇ     –ò–∑–≤–ª–µ—á–µ–Ω–∏–µ –ø–æ–ª–µ–π –∏–∑ —Ç–µ–∫—Å—Ç–∞  ‚îÇ
‚îÇ     (~$0.002/–¥–æ–∫—É–º–µ–Ω—Ç)          ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
         ‚îÇ
         ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  5. –í–∞–ª–∏–¥–∞—Ü–∏—è                   ‚îÇ
‚îÇ     ‚Ä¢ qty √ó price = sum         ‚îÇ
‚îÇ     ‚Ä¢ total = sum(items)        ‚îÇ
‚îÇ     ‚Ä¢ –î–∞—Ç–∞ –Ω–µ –≤ –±—É–¥—É—â–µ–º         ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
         ‚îÇ
         ‚îú‚îÄ‚ùå –û—à–∏–±–∫–∏ ‚Üí –ü–æ–≤—Ç–æ—Ä–Ω—ã–π –ø—Ä–æ–≥–æ–Ω GPT
         ‚îÇ
         ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  6. –ê–≤—Ç–æ-–º–∞–ø–ø–∏–Ω–≥                ‚îÇ
‚îÇ     ‚Ä¢ ocr_mapping (‚â•85%) ‚Üí –∞–≤—Ç–æ ‚îÇ
‚îÇ     ‚Ä¢ iiko_product (‚â•85%) ‚Üí –∞–≤—Ç–æ‚îÇ
‚îÇ     ‚Ä¢ GSheet ‚Üí —Ä—É—á–Ω–æ–π           ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
         ‚îÇ
         ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  7. –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –≤ –ë–î             ‚îÇ
‚îÇ     ‚Ä¢ ocr_document              ‚îÇ
‚îÇ     ‚Ä¢ ocr_item                  ‚îÇ
‚îÇ     ‚Ä¢ ocr_mapping (–æ–±—É—á–µ–Ω–∏–µ)    ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
         ‚îÇ
         ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  8. –û—Ç–ø—Ä–∞–≤–∫–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é       ‚îÇ
‚îÇ     JSON + –∫–Ω–æ–ø–∫–∏               ‚îÇ
‚îÇ     [‚úÖ] [‚úèÔ∏è] [‚ùå]              ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

---

## üí∞ –°—Ç–æ–∏–º–æ—Å—Ç—å (–≥–∏–±—Ä–∏–¥ vs —á–∏—Å—Ç—ã–π GPT)

| –û–±—ä—ë–º | –ß–∏—Å—Ç—ã–π GPT-5.2 | –ì–∏–±—Ä–∏–¥ Yandex+GPT | –≠–∫–æ–Ω–æ–º–∏—è |
|-------|----------------|-------------------|----------|
| 100 –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤ | ~$2.60 | ~$0.80 | **69%** |
| 1000 –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤ | ~$26 | ~$8 | **69%** |
| 10 000 –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤ | ~$260 | ~$80 | **69%** |

**–†–∞—Å—á—ë—Ç –Ω–∞ 1 –¥–æ–∫—É–º–µ–Ω—Ç (~1 —Å—Ç—Ä–∞–Ω–∏—Ü–∞):**
- Yandex OCR: ~‚ÇΩ0.03 ‚âà $0.0003
- GPT-5.2 (—Ç–µ–∫—Å—Ç ~3K —Ç–æ–∫–µ–Ω–æ–≤): ~$0.005
- **–ò—Ç–æ–≥–æ:** ~$0.0053 vs $0.026 (—á–∏—Å—Ç—ã–π GPT)

---

## üìÅ –°—Ç—Ä—É–∫—Ç—É—Ä–∞ —Ñ–∞–π–ª–æ–≤

```
test/
‚îú‚îÄ‚îÄ adapters/
‚îÇ   ‚îú‚îÄ‚îÄ yandex_ocr.py              # Yandex Vision OCR (—Ç–µ–∫—Å—Ç)
‚îÇ   ‚îî‚îÄ‚îÄ gpt5_extractor.py          # GPT-5.2 (–∏–∑–≤–ª–µ—á–µ–Ω–∏–µ –ø–æ–ª–µ–π)
‚îÇ
‚îú‚îÄ‚îÄ utils/
‚îÇ   ‚îú‚îÄ‚îÄ photo_validator.py         # –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–∞—á–µ—Å—Ç–≤–∞ —Ñ–æ—Ç–æ
‚îÇ   ‚îú‚îÄ‚îÄ qr_detector.py             # –î–µ—Ç–µ–∫—Ü–∏—è QR-–∫–æ–¥–æ–≤
‚îÇ   ‚îú‚îÄ‚îÄ document_classifier.py     # –¢–∏–ø –¥–æ–∫—É–º–µ–Ω—Ç–∞ (GPT-5.2)
‚îÇ   ‚îî‚îÄ‚îÄ multistage_detector.py     # –ú–Ω–æ–≥–æ—Å—Ç—Ä–∞–Ω–∏—á–Ω–æ—Å—Ç—å
‚îÇ
‚îú‚îÄ‚îÄ models/
‚îÇ   ‚îî‚îÄ‚îÄ ocr.py                     # SQLAlchemy –º–æ–¥–µ–ª–∏
‚îÇ       ‚Ä¢ OcrDocument              # ocr_document
‚îÇ       ‚Ä¢ OcrItem                  # ocr_item
‚îÇ       ‚Ä¢ OcrMapping               # ocr_mapping (–∞–≤—Ç–æ–æ–±—É—á–µ–Ω–∏–µ)
‚îÇ       ‚Ä¢ OcrSupplierMapping       # ocr_supplier_mapping
‚îÇ       ‚Ä¢ OcrCorrectionLog         # ocr_correction_log
‚îÇ       ‚Ä¢ OcrConfidenceStats       # ocr_confidence_stats
‚îÇ
‚îú‚îÄ‚îÄ use_cases/
‚îÇ   ‚îú‚îÄ‚îÄ ocr_processing.py          # –û—Å–Ω–æ–≤–Ω–æ–π pipeline
‚îÇ   ‚îú‚îÄ‚îÄ ocr_auto_mapping.py        # –ê–≤—Ç–æ-–º–∞–ø–ø–∏–Ω–≥ —Å –æ–±—É—á–µ–Ω–∏–µ–º
‚îÇ   ‚îú‚îÄ‚îÄ ocr_validation.py          # –í–∞–ª–∏–¥–∞—Ü–∏—è —Å—É–º–º, –¥–∞—Ç
‚îÇ   ‚îú‚îÄ‚îÄ ocr_statistics.py          # –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∏ –º–µ—Ç—Ä–∏–∫–∏
‚îÇ   ‚îú‚îÄ‚îÄ ocr_to_iiko.py             # –û—Ç–ø—Ä–∞–≤–∫–∞ –≤ iiko (XML)
‚îÇ   ‚îî‚îÄ‚îÄ ocr_gsheet_mapping.py      # GSheet –º–∞–ø–ø–∏–Ω–≥ (–Ω–æ–≤—ã–µ —Ç–æ–≤–∞—Ä—ã)
‚îÇ
‚îú‚îÄ‚îÄ bot/
‚îÇ   ‚îú‚îÄ‚îÄ document_handlers.py       # –ü—Ä–∏—ë–º —Ñ–æ—Ç–æ ‚Üí OCR ‚Üí –ø—Ä–µ–≤—å—é
‚îÇ   ‚îî‚îÄ‚îÄ ocr_review.py              # –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ, –ø–æ–≤—Ç–æ—Ä, –∏—Å—Ç–æ—Ä–∏—è
‚îÇ
‚îú‚îÄ‚îÄ db/
‚îÇ   ‚îî‚îÄ‚îÄ migrations_ocr.py          # –ú–∏–≥—Ä–∞—Ü–∏–∏ –ë–î
‚îÇ
‚îú‚îÄ‚îÄ tests/
‚îÇ   ‚îî‚îÄ‚îÄ test_ocr.py                # –¢–µ—Å—Ç –Ω–∞ photo_test
‚îÇ
‚îî‚îÄ‚îÄ docs/
    ‚îî‚îÄ‚îÄ OCR.md                     # –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è —Å–∏—Å—Ç–µ–º—ã
```

---

## üóÑ –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö

### –¢–∞–±–ª–∏—Ü—ã (6 –Ω–æ–≤—ã—Ö)

| ‚Ññ | –¢–∞–±–ª–∏—Ü–∞ | –ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ | –ò–Ω–¥–µ–∫—Å—ã |
|---|---------|------------|---------|
| **1** | `ocr_document` | –†–∞—Å–ø–æ–∑–Ω–∞–Ω–Ω—ã–µ –¥–æ–∫—É–º–µ–Ω—Ç—ã | `ix_ocr_document_tg`, `ix_ocr_document_status` |
| **2** | `ocr_item` | –¢–æ–≤–∞—Ä—ã –∏–∑ –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤ | `ix_ocr_item_doc_id` |
| **3** | `ocr_mapping` | **–ê–≤—Ç–æ–æ–±—É—á–µ–Ω–∏–µ**: raw_name ‚Üí iiko_id (—Ç–æ–≤–∞—Ä—ã) | `ix_ocr_mapping_raw_trgm` (GIN trigram) |
| **4** | `ocr_supplier_mapping` | **–ê–≤—Ç–æ–æ–±—É—á–µ–Ω–∏–µ**: raw_name ‚Üí iiko_id (–ø–æ—Å—Ç–∞–≤—â–∏–∫–∏) | `ix_ocr_supplier_mapping_raw_trgm` |
| **5** | `ocr_correction_log` | –ò—Å—Ç–æ—Ä–∏—è –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–π | `ix_ocr_correction_doc_id` |
| **6** | `ocr_confidence_stats` | –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ confidence | `ix_ocr_stats_date` |

### SQL –º–∏–≥—Ä–∞—Ü–∏–∏

```sql
-- 1. ocr_document
CREATE TABLE IF NOT EXISTS ocr_document (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    telegram_id BIGINT NOT NULL,
    user_id UUID,
    doc_type VARCHAR(20) NOT NULL,  -- 'upd', 'receipt', 'act', 'cash_order'
    doc_number VARCHAR(100),
    doc_date DATE,
    supplier_name TEXT,
    supplier_inn VARCHAR(20),
    supplier_id UUID,  -- —Å—Å—ã–ª–∫–∞ –Ω–∞ iiko_supplier
    buyer_name TEXT,
    buyer_inn VARCHAR(20),
    total_amount DECIMAL(15,2),
    total_vat DECIMAL(15,2),
    currency VARCHAR(3) DEFAULT 'RUB',
    status VARCHAR(30) NOT NULL DEFAULT 'recognized',
    category VARCHAR(20) DEFAULT 'goods',  -- 'goods' –∏–ª–∏ 'service'
    raw_json JSONB NOT NULL,  -- —Å—ã—Ä–æ–π –æ—Ç–≤–µ—Ç GPT
    validated_json JSONB,  -- –ø–æ—Å–ª–µ –≤–∞–ª–∏–¥–∞—Ü–∏–∏
    confidence_score REAL,  -- 0-100
    page_count INT DEFAULT 1,
    is_multistage BOOLEAN DEFAULT FALSE,
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    updated_at TIMESTAMP WITH TIME ZONE,
    sent_to_iiko_at TIMESTAMP WITH TIME ZONE,
    iiko_document_id UUID,
    _metadata JSONB  -- —Å–ª—É–∂–µ–±–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ
);

CREATE INDEX IF NOT EXISTS ix_ocr_document_tg ON ocr_document (telegram_id);
CREATE INDEX IF NOT EXISTS ix_ocr_document_status ON ocr_document (status);
CREATE INDEX IF NOT EXISTS ix_ocr_document_created ON ocr_document (created_at);

-- 2. ocr_item
CREATE TABLE IF NOT EXISTS ocr_item (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    document_id UUID NOT NULL REFERENCES ocr_document(id) ON DELETE CASCADE,
    num INT,
    raw_name TEXT NOT NULL,  -- –∫–∞–∫ —Ä–∞—Å–ø–æ–∑–Ω–∞–Ω–æ
    name_normalized TEXT,  -- –Ω–æ—Ä–º–∞–ª–∏–∑–æ–≤–∞–Ω–Ω–æ–µ
    product_id UUID,  -- —Å—Å—ã–ª–∫–∞ –Ω–∞ iiko_product
    unit VARCHAR(20),  -- –∫–≥, —à—Ç, –ª
    qty DECIMAL(15,3),
    price DECIMAL(15,2),
    sum DECIMAL(15,2),
    vat_rate VARCHAR(10),  -- '10%', '20%', '–±–µ–∑ –ù–î–°'
    confidence_score REAL,
    is_auto_corrected BOOLEAN DEFAULT FALSE,
    mapping_status VARCHAR(20) DEFAULT 'pending',  -- 'auto', 'manual', 'pending'
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

CREATE INDEX IF NOT EXISTS ix_ocr_item_doc_id ON ocr_item (document_id);
CREATE INDEX IF NOT EXISTS ix_ocr_item_raw_name ON ocr_item USING gin (raw_name gin_trgm_ops);

-- 3. ocr_mapping (–∞–≤—Ç–æ–æ–±—É—á–µ–Ω–∏–µ —Ç–æ–≤–∞—Ä—ã)
CREATE TABLE IF NOT EXISTS ocr_mapping (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    raw_name TEXT NOT NULL UNIQUE,  -- "–ü–æ–º–∏–¥–æ—Ä —Å–≤–µ–∂."
    corrected_name TEXT NOT NULL,  -- "–ü–æ–º–∏–¥–æ—Ä—ã —Å–≤–µ–∂–∏–µ"
    iiko_id UUID NOT NULL,
    iiko_type VARCHAR(20) NOT NULL,  -- 'product' | 'supplier'
    iiko_name TEXT NOT NULL,  -- –Ω–∞–∑–≤–∞–Ω–∏–µ –≤ iiko
    confidence REAL NOT NULL,  -- 0.85-1.0
    source VARCHAR(20) DEFAULT 'auto',  -- 'auto' | 'manual' | 'gsheet'
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    last_used_at TIMESTAMP WITH TIME ZONE,
    use_count INT DEFAULT 1
);

CREATE INDEX IF NOT EXISTS ix_ocr_mapping_raw_trgm ON ocr_mapping USING gin (raw_name gin_trgm_ops);
CREATE INDEX IF NOT EXISTS ix_ocr_mapping_iiko_id ON ocr_mapping (iiko_id);

-- 4. ocr_supplier_mapping (–∞–≤—Ç–æ–æ–±—É—á–µ–Ω–∏–µ –ø–æ—Å—Ç–∞–≤—â–∏–∫–∏)
CREATE TABLE IF NOT EXISTS ocr_supplier_mapping (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    raw_name TEXT NOT NULL UNIQUE,
    corrected_name TEXT NOT NULL,
    iiko_id UUID NOT NULL,
    inn VARCHAR(20),  -- –¥–ª—è —Ç–æ—á–Ω–æ–≥–æÂåπÈÖç –ø–æ –ò–ù–ù
    confidence REAL NOT NULL,
    source VARCHAR(20) DEFAULT 'auto',
    category VARCHAR(20) DEFAULT 'goods',  -- 'goods' | 'service'
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    last_used_at TIMESTAMP WITH TIME ZONE,
    use_count INT DEFAULT 1
);

CREATE INDEX IF NOT EXISTS ix_ocr_supplier_mapping_raw_trgm ON ocr_supplier_mapping USING gin (raw_name gin_trgm_ops);
CREATE INDEX IF NOT EXISTS ix_ocr_supplier_mapping_inn ON ocr_supplier_mapping (inn);

-- 5. ocr_correction_log (–∏—Å—Ç–æ—Ä–∏—è –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–π)
CREATE TABLE IF NOT EXISTS ocr_correction_log (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    document_id UUID NOT NULL REFERENCES ocr_document(id),
    item_id UUID REFERENCES ocr_item(id),
    field_name VARCHAR(50) NOT NULL,  -- 'name', 'qty', 'price', 'sum'
    old_value TEXT,
    new_value TEXT,
    corrected_by BIGINT,  -- telegram_id
    corrected_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    reason VARCHAR(100)  -- 'auto_correct', 'manual', 'gpt_reread'
);

CREATE INDEX IF NOT EXISTS ix_ocr_correction_doc_id ON ocr_correction_log (document_id);
CREATE INDEX IF NOT EXISTS ix_ocr_correction_field ON ocr_correction_log (field_name);

-- 6. ocr_confidence_stats (—Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞)
CREATE TABLE IF NOT EXISTS ocr_confidence_stats (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    date DATE NOT NULL,
    doc_type VARCHAR(20),
    total_documents INT NOT NULL,
    avg_confidence REAL NOT NULL,
    auto_mapped_items INT DEFAULT 0,
    manual_mapped_items INT DEFAULT 0,
    auto_mapping_pct REAL DEFAULT 0,
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

CREATE INDEX IF NOT EXISTS ix_ocr_stats_date ON ocr_confidence_stats (date);
CREATE UNIQUE INDEX IF NOT EXISTS uq_ocr_stats_date_type ON ocr_confidence_stats (date, doc_type);
```

---

## üîë –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è (.env)

### –û–±—è–∑–∞—Ç–µ–ª—å–Ω–æ:

```bash
# OpenAI API (GPT-5.2)
OPENAI_API_KEY=sk-...
OPENAI_OCR_MODEL=gpt-5.2-chat-latest

# Yandex Cloud (OCR)
YANDEX_CLOUD_ID=...
YANDEX_FOLDER_ID=...
YANDEX_SERVICE_ACCOUNT_ID=...
YANDEX_API_KEY=...

# Telegram Bot (—É–∂–µ –µ—Å—Ç—å)
TELEGRAM_BOT_TOKEN=...

# Database (—É–∂–µ –µ—Å—Ç—å)
DATABASE_URL=postgresql+asyncpg://...

# Google Sheets (–º–∞–ø–ø–∏–Ω–≥)
GOOGLE_SHEETS_CREDENTIALS=...
OCR_MAPPING_SHEET_ID=...  # –æ—Ç–¥–µ–ª—å–Ω–∞—è —Ç–∞–±–ª–∏—Ü–∞ –¥–ª—è OCR –º–∞–ø–ø–∏–Ω–≥–∞
```

### –û–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ:

```bash
# Object Storage (—Ö—Ä–∞–Ω–µ–Ω–∏–µ –æ—Ä–∏–≥–∏–Ω–∞–ª–æ–≤)
S3_ENDPOINT=https://storage.yandexcloud.net
S3_ACCESS_KEY=...
S3_SECRET_KEY=...
S3_BUCKET=ocr-documents

# –ù–∞—Å—Ç—Ä–æ–π–∫–∏
OCR_AUTO_APPROVE_THRESHOLD=90  # ‚â•90% confidence ‚Üí –∞–≤—Ç–æ
OCR_MAX_RETRIES=2  # –º–∞–∫—Å. –ø–æ–ø—ã—Ç–æ–∫ —Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏—è
OCR_DEFAULT_STORE_ID=...  # —Å–∫–ª–∞–¥ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
OCR_ENABLE_QR_REJECT=true  # –æ—Ç–∫–ª–æ–Ω—è—Ç—å —á–µ–∫–∏ —Å QR
```

---

## üìä Flow —Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏—è

### 1. –ü—Ä–∏—ë–º —Ñ–æ—Ç–æ

```python
# bot/document_handlers.py

async def handle_photo(message: Message, state: FSMContext):
    # 1. –°–æ—Ö—Ä–∞–Ω—è–µ–º file_id
    # 2. –°–∫–∞—á–∏–≤–∞–µ–º —Ñ–æ—Ç–æ
    # 3. –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –Ω–∞ –≤–∞–ª–∏–¥–∞—Ü–∏—é
    quality = await validate_photo(image_bytes)
    
    if not quality.is_good:
        await message.answer(f"‚ùå {quality.message}")
        return
    
    # 4. –î–µ—Ç–µ–∫—Ü–∏—è QR
    has_qr = await detect_qr(image_bytes)
    if has_qr:
        await message.answer("üì± –û–±–Ω–∞—Ä—É–∂–µ–Ω QR-–∫–æ–¥. –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –§–ù–°...")
        return
    
    # 5. OCR pipeline
    await process_ocr(message, image_bytes, state)
```

---

### 2. –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–∞—á–µ—Å—Ç–≤–∞

```python
# utils/photo_validator.py

async def validate_photo(image_bytes: bytes) -> QualityResult:
    img = cv2.imdecode(np.frombuffer(image_bytes, np.uint8), cv2.IMREAD_GRAYSCALE)
    
    # 1. –†–∞–∑–º—ã—Ç–æ—Å—Ç—å (Laplacian variance)
    blur_score = cv2.Laplacian(img, cv2.CV_64F).var()
    if blur_score < 80:
        return QualityResult(
            is_good=False,
            issue=f"–§–æ—Ç–æ —Ä–∞–∑–º—ã—Ç–æ–µ (—Ä–µ–∑–∫–æ—Å—Ç—å {blur_score:.0f}, –Ω—É–∂–Ω–æ >80)"
        )
    
    # 2. –û—Å–≤–µ—â—ë–Ω–Ω–æ—Å—Ç—å
    brightness = np.mean(img)
    if brightness < 60:
        return QualityResult(
            is_good=False,
            issue=f"–§–æ—Ç–æ —Å–ª–∏—à–∫–æ–º —Ç—ë–º–Ω–æ–µ (—è—Ä–∫–æ—Å—Ç—å {brightness:.0f})"
        )
    if brightness > 220:
        return QualityResult(
            is_good=False,
            issue=f"–§–æ—Ç–æ —Å–ª–∏—à–∫–æ–º —Å–≤–µ—Ç–ª–æ–µ (—è—Ä–∫–æ—Å—Ç—å {brightness:.0f})"
        )
    
    # 3. –û—Ä–∏–µ–Ω—Ç–∞—Ü–∏—è
    height, width = img.shape
    if height > width:
        return QualityResult(
            is_good=False,
            issue="–§–æ—Ç–æ –ø–æ–≤—ë—Ä–Ω—É—Ç–æ –≤–µ—Ä—Ç–∏–∫–∞–ª—å–Ω–æ ‚Äî —Å–¥–µ–ª–∞–π—Ç–µ –≥–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª—å–Ω—ã–π —Å–Ω–∏–º–æ–∫"
        )
    
    # 4. –†–∞–∑—Ä–µ—à–µ–Ω–∏–µ
    if width < 800 or height < 600:
        return QualityResult(
            is_good=False,
            issue=f"–ù–∏–∑–∫–æ–µ —Ä–∞–∑—Ä–µ—à–µ–Ω–∏–µ ({width}x{height}, –Ω—É–∂–Ω–æ –º–∏–Ω–∏–º—É–º 800x600)"
        )
    
    return QualityResult(is_good=True)
```

---

### 3. –ö–ª–∞—Å—Å–∏—Ñ–∏–∫–∞—Ü–∏—è –¥–æ–∫—É–º–µ–Ω—Ç–∞

```python
# utils/document_classifier.py

async def classify_document(image_bytes: bytes) -> str:
    """
    –ë—ã—Å—Ç—Ä–∞—è –∫–ª–∞—Å—Å–∏—Ñ–∏–∫–∞—Ü–∏—è —Ç–∏–ø–∞ –¥–æ–∫—É–º–µ–Ω—Ç–∞ —á–µ—Ä–µ–∑ GPT-5.2.
    –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç: 'upd', 'receipt', 'act', 'cash_order', 'unknown'
    """
    client = AsyncOpenAI(api_key=OPENAI_API_KEY)
    
    prompt = """
–ö–ª–∞—Å—Å–∏—Ñ–∏—Ü–∏—Ä—É–π —Ç–∏–ø –¥–æ–∫—É–º–µ–Ω—Ç–∞.
–í–∞—Ä–∏–∞–Ω—Ç—ã: upd, receipt, act, cash_order, unknown.
–í–µ—Ä–Ω–∏ –¢–û–õ–¨–ö–û –æ–¥–Ω–æ —Å–ª–æ–≤–æ.
"""
    
    response = await client.chat.completions.create(
        model="gpt-5.2-chat-latest",
        messages=[
            {"role": "user", "content": [
                {"type": "text", "text": prompt},
                {"type": "image_url", "image_url": {"url": f"data:image/jpeg;base64,{base64_image}"}}
            ]}
        ],
        max_tokens=10
    )
    
    return response.choices[0].message.content.strip().lower()
```

---

### 4. Yandex OCR

```python
# adapters/yandex_ocr.py

async def recognize_text(image_bytes: bytes) -> str:
    """
    –†–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏–µ —Ç–µ–∫—Å—Ç–∞ —á–µ—Ä–µ–∑ Yandex Vision OCR.
    –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç –ø–æ–ª–Ω—ã–π —Ç–µ–∫—Å—Ç –¥–æ–∫—É–º–µ–Ω—Ç–∞.
    """
    session = yandexcloud.Session(api_key=YANDEX_API_KEY)
    client = VisionAsyncClient(session)
    
    result = await client.document_text_detection(
        DocumentTextDetectionRequest(
            folder_id=YANDEX_FOLDER_ID,
            model="document-text-detection",
            pages=[
                DocumentPage(
                    uri=f"data:image/jpeg;base64,{base64.b64encode(image_bytes).decode()}"
                )
            ]
        )
    )
    
    # –°–æ–±–∏—Ä–∞–µ–º —Ç–µ–∫—Å—Ç –∏–∑ –≤—Å–µ—Ö —Å—Ç—Ä–æ–∫
    text = "\n".join(
        page.text
        for page in result.pages
    )
    
    return text
```

---

### 5. GPT-5.2 –∏–∑–≤–ª–µ—á–µ–Ω–∏–µ –ø–æ–ª–µ–π

```python
# adapters/gpt5_extractor.py

async def extract_fields(text: str, doc_type: str) -> dict:
    """
    –ò–∑–≤–ª–µ—á–µ–Ω–∏–µ –ø–æ–ª–µ–π –∏–∑ —Ç–µ–∫—Å—Ç–∞ —á–µ—Ä–µ–∑ GPT-5.2.
    """
    client = AsyncOpenAI(api_key=OPENAI_API_KEY)
    
    prompt = f"""
–ò–∑–≤–ª–µ–∫–∏ –ø–æ–ª—è –∏–∑ –¥–æ–∫—É–º–µ–Ω—Ç–∞ —Ç–∏–ø–∞ {doc_type}.

–í–µ—Ä–Ω–∏ JSON:
{{
  "doc_type": "{doc_type}",
  "supplier": {{"name": "...", "inn": "..."}},
  "buyer": {{"name": "...", "inn": "..."}},
  "date": "YYYY-MM-DD",
  "doc_number": "...",
  "items": [
    {{
      "name": "...",
      "unit": "–∫–≥|—à—Ç|–ª",
      "qty": 0.0,
      "price": 0.0,
      "sum": 0.0,
      "vat_rate": "10%|20%|–±–µ–∑ –ù–î–°"
    }}
  ],
  "total_amount": 0.0,
  "total_vat": 0.0,
  "currency": "RUB",
  "quality_check": {{
    "confidence_score": 0-100,
    "warnings": ["..."]
  }}
}}
"""
    
    response = await client.chat.completions.create(
        model="gpt-5.2-chat-latest",
        messages=[
            {"role": "system", "content": "–¢—ã —ç–∫—Å–ø–µ—Ä—Ç –ø–æ —Ä–æ—Å—Å–∏–π—Å–∫–∏–º –±—É—Ö–≥–∞–ª—Ç–µ—Ä—Å–∫–∏–º –¥–æ–∫—É–º–µ–Ω—Ç–∞–º."},
            {"role": "user", "content": prompt + "\n\n–¢–µ–∫—Å—Ç –¥–æ–∫—É–º–µ–Ω—Ç–∞:\n" + text}
        ],
        max_tokens=4096,
        temperature=0.1
    )
    
    return json.loads(response.choices[0].message.content)
```

---

### 6. –í–∞–ª–∏–¥–∞—Ü–∏—è

```python
# use_cases/ocr_validation.py

async def validate_document(doc: dict) -> ValidationResult:
    errors = []
    warnings = []
    auto_corrected = []
    
    # 1. –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–∞—Ç
    if doc.get('date'):
        try:
            doc_date = datetime.strptime(doc['date'], '%Y-%m-%d').date()
            if doc_date > date.today():
                errors.append(f"–î–∞—Ç–∞ –≤ –±—É–¥—É—â–µ–º: {doc_date}")
        except ValueError:
            errors.append(f"–ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω–∞—è –¥–∞—Ç–∞: {doc['date']}")
    
    # 2. –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—É–º–º
    for i, item in enumerate(doc.get('items', [])):
        expected_sum = round(item['qty'] * item['price'], 2)
        if abs(item['sum'] - expected_sum) > 0.5:
            auto_corrected.append({
                'field': f'items[{i}].sum',
                'old': item['sum'],
                'new': expected_sum
            })
            item['sum'] = expected_sum
            item['_auto_corrected'] = True
    
    # 3. –ü—Ä–æ–≤–µ—Ä–∫–∞ total
    calculated_total = sum(item['sum'] for item in doc.get('items', []))
    if abs(doc.get('total_amount', 0) - calculated_total) > 5:
        warnings.append(f"total_amount –Ω–µ —Å—Ö–æ–¥–∏—Ç—Å—è: {doc['total_amount']} vs {calculated_total}")
    
    # 4. –ü—Ä–æ–≤–µ—Ä–∫–∞ confidence
    confidence = doc.get('quality_check', {}).get('confidence_score', 0)
    if confidence < 70:
        errors.append(f"–ù–∏–∑–∫–∞—è —É–≤–µ—Ä–µ–Ω–Ω–æ—Å—Ç—å: {confidence}%")
    
    return ValidationResult(
        is_valid=len(errors) == 0,
        errors=errors,
        warnings=warnings,
        auto_corrected=auto_corrected
    )
```

---

### 7. –ê–≤—Ç–æ-–º–∞–ø–ø–∏–Ω–≥

```python
# use_cases/ocr_auto_mapping.py

async def find_mapping(raw_name: str, iiko_type: str) -> MappingResult | None:
    """
    –ü–æ–∏—Å–∫ –º–∞–ø–ø–∏–Ω–≥–∞:
    1. ocr_mapping (–æ–±—É—á–µ–Ω–Ω—ã–µ) ‚â•85%
    2. iiko_product/supplier (fuzzy) ‚â•85%
    3. None (–Ω—É–∂–µ–Ω —Ä—É—á–Ω–æ–π –º–∞–ø–ø–∏–Ω–≥)
    """
    # 1. –ü—Ä–æ–≤–µ—Ä–∫–∞ ocr_mapping
    async with session() as db:
        mapping = await db.execute(
            select(OcrMapping).where(
                OcrMapping.iiko_type == iiko_type
            )
        )
        
        best_match = fuzzy_match(raw_name, [m.raw_name for m in mapping])
        if best_match and best_match.confidence >= 0.85:
            # –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É
            best_match.last_used_at = now()
            best_match.use_count += 1
            await db.commit()
            
            return MappingResult(
                iiko_id=best_match.iiko_id,
                iiko_name=best_match.iiko_name,
                confidence=best_match.confidence,
                source='auto'
            )
    
    # 2. Fuzzy –ø–æ iiko —Å–ø—Ä–∞–≤–æ—á–Ω–∏–∫—É
    if iiko_type == 'product':
        iiko_items = await fetch_all_products()  # GOODS+DISH
    else:
        iiko_items = await fetch_all_suppliers()
    
    best_match = fuzzy_match(raw_name, [i.name for i in iiko_items])
    if best_match and best_match.confidence >= 0.85:
        # –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ ocr_mapping (–æ–±—É—á–µ–Ω–∏–µ)
        new_mapping = OcrMapping(
            raw_name=raw_name,
            corrected_name=best_match.name,
            iiko_id=best_match.id,
            iiko_type=iiko_type,
            iiko_name=best_match.name,
            confidence=best_match.confidence,
            source='auto'
        )
        async with session() as db:
            db.add(new_mapping)
            await db.commit()
        
        return MappingResult(
            iiko_id=best_match.id,
            iiko_name=best_match.name,
            confidence=best_match.confidence,
            source='auto'
        )
    
    # 3. –ù–µ –Ω–∞–π–¥–µ–Ω–æ ‚Üí —Ä—É—á–Ω–æ–π –º–∞–ø–ø–∏–Ω–≥
    return None
```

---

## üìà –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∏ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥

### –ú–µ—Ç—Ä–∏–∫–∏

| –ú–µ—Ç—Ä–∏–∫–∞ | –§–æ—Ä–º—É–ª–∞ | –¶–µ–ª—å |
|---------|---------|------|
| **% –∞–≤—Ç–æ-–º–∞–ø–ø–∏–Ω–≥–∞** | `auto_mapped / total_items √ó 100` | >90% |
| **–°—Ä–µ–¥–Ω–∏–π confidence** | `avg(confidence_score)` | >85% |
| **–ö–æ–ª-–≤–æ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–π** | `count(correction_log)` | <10% –æ—Ç –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤ |
| **–í—Ä–µ–º—è –æ–±—Ä–∞–±–æ—Ç–∫–∏** | `finished_at - started_at` | <30 —Å–µ–∫ |
| **–¢–æ–ø –æ—à–∏–±–æ–∫** | `GROUP BY field_name ORDER BY count` | ‚Äî |

### –î–∞—à–±–æ—Ä–¥ (–±—É–¥—É—â–µ–µ)

```
üìä OCR –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ (–∑–∞ 30 –¥–Ω–µ–π)

–†–∞—Å–ø–æ–∑–Ω–∞–Ω–æ –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤: 1 247
‚îú‚îÄ –£–ü–î: 856
‚îú‚îÄ –ß–µ–∫–∏: 234
‚îú‚îÄ –ê–∫—Ç—ã: 89
‚îî‚îÄ –û—Ä–¥–µ—Ä–∞: 68

–ê–≤—Ç–æ-–º–∞–ø–ø–∏–Ω–≥: 94.2% ‚úÖ
–°—Ä–µ–¥–Ω–∏–π confidence: 87.3% ‚úÖ
–ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–π: 7.1% ‚úÖ
–°—Ä–µ–¥–Ω–µ–µ –≤—Ä–µ–º—è: 18 —Å–µ–∫ ‚úÖ

–¢–æ–ø –æ—à–∏–±–æ–∫:
1. sum (–∞–≤—Ç–æ–ø–µ—Ä–µ—Å—á—ë—Ç) ‚Äî 34
2. qty (—Ä–∞–∑–º—ã—Ç–æ) ‚Äî 12
3. name (–Ω–µ –Ω–∞–π–¥–µ–Ω) ‚Äî 8
```

---

## üß™ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

### –¢–µ—Å—Ç–æ–≤—ã–µ –¥–∞–Ω–Ω—ã–µ

| –§–∞–π–ª | –¢–∏–ø | –°—Ç—Ä–∞–Ω–∏—Ü | –û–∂–∏–¥–∞–µ–º—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç |
|------|-----|---------|---------------------|
| `photo_2026-02-18_07-20-11.jpg` | –£–ü–î | 1 | –†–∞—Å–ø–æ–∑–Ω–∞—Ç—å, –Ω–∞–π—Ç–∏ —Ç–æ–≤–∞—Ä—ã |
| `photo_2026-02-18_07-20-12.jpg` | –£–ü–î (–ª–∏—Å—Ç 2) | 1 | –°–≥—Ä—É–ø–ø–∏—Ä–æ–≤–∞—Ç—å —Å –ø—Ä–µ–¥—ã–¥—É—â–∏–º |
| `photo_2026-02-18_07-20-28.jpg` | –ß–µ–∫ | 1 | –†–∞—Å–ø–æ–∑–Ω–∞—Ç—å (–±–µ–∑ QR) |
| `photo_2026-02-18_07-20-33.jpg` | –†–ö–û | 1 | –†–∞—Å–ø–æ–∑–Ω–∞—Ç—å —Ä—É–∫–æ–ø–∏—Å–Ω—ã–π |
| `photo_2026-02-18_07-20-34.jpg` | –ê–∫—Ç | 1 | –†–∞—Å–ø–æ–∑–Ω–∞—Ç—å —É—Å–ª—É–≥—É |

### –ö—Ä–∏—Ç–µ—Ä–∏–∏ –ø—Ä–∏—ë–º–∫–∏

- [ ] –í—Å–µ 17 —Ñ–æ—Ç–æ –∏–∑ `photo_test` —Ä–∞—Å–ø–æ–∑–Ω–∞—é—Ç—Å—è
- [ ] –ß–µ–∫–∏ —Å QR –æ—Ç–∫–ª–æ–Ω—è—é—Ç—Å—è —Å –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–µ–π
- [ ] –£–ü–î –Ω–∞ 2 —Å—Ç—Ä–∞–Ω–∏—Ü–∞—Ö –≥—Ä—É–ø–ø–∏—Ä—É—é—Ç—Å—è
- [ ] –°—É–º–º—ã –∞–≤—Ç–æ–ø–µ—Ä–µ—Å—á–∏—Ç—ã–≤–∞—é—Ç—Å—è –ø—Ä–∏ –Ω–µ—Å–æ–≤–ø–∞–¥–µ–Ω–∏–∏
- [ ] –ù–æ–≤—ã–µ —Ç–æ–≤–∞—Ä—ã –ø–æ–ø–∞–¥–∞—é—Ç –≤ GSheet
- [ ] –ü–æ–≤—Ç–æ—Ä–Ω—ã–π —Ç–æ–≤–∞—Ä –º–∞–ø–ø–∏—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏

---

## üìÖ –ü–ª–∞–Ω —Ä–∞–±–æ—Ç (–≤–¥–≤–æ—ë–º, –∏–Ω—Ç–µ–Ω—Å–∏–≤–Ω–æ)

| –≠—Ç–∞–ø | –ó–∞–¥–∞—á–∞ | –ö—Ç–æ | –í—Ä–µ–º—è |
|------|--------|-----|-------|
| **1** | –ö–ª—é—á–∏ + –º–∏–≥—Ä–∞—Ü–∏–∏ –ë–î | –¢—ã: –∫–ª—é—á–∏, –Ø: –∫–æ–¥ | 1-2 —á–∞—Å–∞ |
| **2** | –Ø–¥—Ä–æ OCR (`adapters/*` + `utils/*`) | –Ø: –∫–æ–¥, –¢—ã: —Ç–µ—Å—Ç—ã | 3-4 —á–∞—Å–∞ |
| **3** | –ë–î + –ú–∞–ø–ø–∏–Ω–≥ (`models/` + `use_cases/ocr_auto_mapping.py`) | –Ø: –∫–æ–¥, –¢—ã: GSheet | 2-3 —á–∞—Å–∞ |
| **4** | Pipeline + –í–∞–ª–∏–¥–∞—Ü–∏—è | –Ø: –∫–æ–¥, –¢—ã: —Ç–µ—Å—Ç—ã | 3-4 —á–∞—Å–∞ |
| **5** | –ë–æ—Ç (`bot/document_handlers.py` + `ocr_review.py`) | –Ø: –∫–æ–¥, –¢—ã: —Ç–µ—Å—Ç—ã –≤ TG | 3-4 —á–∞—Å–∞ |
| **6** | –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ + –§–∏–Ω–∞–ª | –Ø: –∫–æ–¥, –¢—ã: —Ç–µ—Å—Ç—ã –≤—Å–µ—Ö 17 —Ñ–æ—Ç–æ | 2-3 —á–∞—Å–∞ |

**–ò—Ç–æ–≥–æ: 1-2 –¥–Ω—è** (–Ω–µ 10 –¥–Ω–µ–π!)

---

### üéØ –†–µ–∞–ª–∏—Å—Ç–∏—á–Ω—ã–π –≥—Ä–∞—Ñ–∏–∫

**–î–µ–Ω—å 1 (6-9 —á–∞—Å–æ–≤):**
- [ ] –ö–ª—é—á–∏ –ø–æ–ª—É—á–µ–Ω—ã
- [ ] –ú–∏–≥—Ä–∞—Ü–∏–∏ –ë–î —Å–æ–∑–¥–∞–Ω—ã
- [ ] –Ø–¥—Ä–æ OCR —Ä–∞–±–æ—Ç–∞–µ—Ç (—Ç–µ–∫—Å—Ç ‚Üí JSON)
- [ ] –ê–≤—Ç–æ-–º–∞–ø–ø–∏–Ω–≥ —Ä–∞–±–æ—Ç–∞–µ—Ç

**–î–µ–Ω—å 2 (8-11 —á–∞—Å–æ–≤):**
- [ ] Pipeline –ø–æ–ª–Ω—ã–π —Ä–∞–±–æ—Ç–∞–µ—Ç
- [ ] –ë–æ—Ç –ø—Ä–∏–Ω–∏–º–∞–µ—Ç —Ñ–æ—Ç–æ ‚Üí –≤—ã–¥–∞—ë—Ç JSON
- [ ] –í—Å–µ 17 —Ñ–æ—Ç–æ –∏–∑ photo_test —Ä–∞—Å–ø–æ–∑–Ω–∞–Ω—ã
- [ ] –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–∏—à–µ—Ç—Å—è

---

## ‚úÖ –ß–µ–∫–ª–∏—Å—Ç –ø–µ—Ä–µ–¥ —Å—Ç–∞—Ä—Ç–æ–º

- [ ] **OpenAI API Key** –ø–æ–ª—É—á–µ–Ω –∏ –¥–æ–±–∞–≤–ª–µ–Ω –≤ `.env`
- [ ] **Yandex Cloud –∞–∫–∫–∞—É–Ω—Ç** —Å–æ–∑–¥–∞–Ω
- [ ] **Yandex Service Account** —Å–æ–∑–¥–∞–Ω —Å —Ä–æ–ª—è–º–∏ `vision.editor`
- [ ] **Yandex API Key** –ø–æ–ª—É—á–µ–Ω
- [ ] **GSheet credentials** –µ—Å—Ç—å
- [ ] **Database** –ø–æ–¥–∫–ª—é—á–µ–Ω–∞
- [ ] **Telegram bot** —Ä–∞–±–æ—Ç–∞–µ—Ç
- [ ] **photo_test** –ø–∞–ø–∫–∞ —Å –ø—Ä–∏–º–µ—Ä–∞–º–∏
- [ ] **S3 –±–∞–∫–µ—Ç** —Å–æ–∑–¥–∞–Ω (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)

---

## üîó –ü–æ–ª–µ–∑–Ω—ã–µ —Å—Å—ã–ª–∫–∏

- [Yandex Vision OCR Docs](https://cloud.yandex.ru/docs/vision/concepts/document-text-detection)
- [OpenAI GPT-5.2 Docs](https://platform.openai.com/docs/models/gpt-5-2)
- [Telegram Bot API](https://core.telegram.org/bots/api)
- [aiogram 3.x Docs](https://docs.aiogram.dev/)
- [SQLAlchemy 2.0](https://docs.sqlalchemy.org/)

---

## üìù –ó–∞–º–µ—Ç–∫–∏ –¥–ª—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è

**–û—Ç—Ä–µ–¥–∞–∫—Ç–∏—Ä—É–π —Å–ª–µ–¥—É—é—â–∏–µ —Å–µ–∫—Ü–∏–∏ –ø–µ—Ä–µ–¥ —Å—Ç–∞—Ä—Ç–æ–º:**

1. **–ú–æ–¥–µ–ª—å GPT:** `gpt-5.2-chat-latest` ‚Üí –¥—Ä—É–≥–∞—è –µ—Å–ª–∏ –Ω—É–∂–Ω–æ
2. **–ü–æ—Ä–æ–≥–∏ –º–∞–ø–ø–∏–Ω–≥–∞:** `85%` ‚Üí –¥—Ä—É–≥–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ
3. **–õ–∏–º–∏—Ç—ã:** `MAX_RETRIES=2` ‚Üí –¥—Ä—É–≥–æ–µ
4. **GSheet ID:** `OCR_MAPPING_SHEET_ID` ‚Üí —Å–≤–æ–π
5. **–°—Ç–æ–∏–º–æ—Å—Ç—å:** –ø–µ—Ä–µ—Å—á–∏—Ç–∞–π –ø–æ–¥ —Å–≤–æ–∏ –æ–±—ä—ë–º—ã

---

**–ì–æ—Ç–æ–≤ –Ω–∞—á–∞—Ç—å? –û—Ç–º–µ—Ç—å —á–µ–∫–ª–∏—Å—Ç –∏ –¥–∞–π –∫–ª—é—á–∏!**
