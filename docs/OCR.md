# üì∏ OCR –Ω–∞–∫–ª–∞–¥–Ω—ã—Ö

> **–ó–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏:** PROJECT_MAP.md (–ø—Ä–æ—á–∏—Ç–∞–Ω).  
> –ï—Å–ª–∏ –∑–∞–¥–µ–≤–∞–µ—à—å –ë–î ‚Üí –∑–∞–≥—Ä—É–∑–∏ —Å–µ–∫—Ü–∏–∏ `ocr_document`, `ocr_item` –∏–∑ DATABASE.md.  
> –ï—Å–ª–∏ –º–∞–ø–ø–∏–Ω–≥ ‚Üí –∑–∞–≥—Ä—É–∑–∏ –æ–ø–∏—Å–∞–Ω–∏–µ GSheet ¬´–ú–∞–ø–ø–∏–Ω–≥¬ª / ¬´–ú–∞–ø–ø–∏–Ω–≥ –ò–º–ø–æ—Ä—Ç¬ª –Ω–∏–∂–µ.  
> –û–±—ä–µ–¥–∏–Ω—è–µ—Ç –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –∏–∑ –±—ã–≤—à–∏—Ö OCR_IMPLEMENTATION_PLAN.md –∏ OCR_REPORT.md.

---

## –ö–æ–Ω—Ç—Ä–∞–∫—Ç—ã –¥–æ–º–µ–Ω–∞

- **O1:** –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø—Ä–æ—Å—Ç–æ –∫–∏–¥–∞–µ—Ç —Ñ–æ—Ç–æ ‚Üí —Å–∏—Å—Ç–µ–º–∞ —Å–∞–º–∞ —Ä–∞–∑–±–∏—Ä–∞–µ—Ç—Å—è (fool-proof). –ü–µ—Ä–µ—Å–º–æ—Ç—Ä–µ—Ç—å –∫–æ–≥–¥–∞: –ø–æ—è–≤—è—Ç—Å—è —Ñ–æ—Ç–æ, –∫–æ—Ç–æ—Ä—ã–µ —Å–∏—Å—Ç–µ–º–∞ –Ω–µ –º–æ–∂–µ—Ç –∫–ª–∞—Å—Å–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞—Ç—å.
- **O2:** –î–≤—É—Ö—Ç–∞–±–ª–∏—á–Ω—ã–π –º–∞–ø–ø–∏–Ω–≥: ¬´–ú–∞–ø–ø–∏–Ω–≥¬ª (–±–∞–∑–∞, –ø–æ—Å—Ç–æ—è–Ω–Ω–∞—è) + ¬´–ú–∞–ø–ø–∏–Ω–≥ –ò–º–ø–æ—Ä—Ç¬ª (—Ç—Ä–∞–Ω—Å—Ñ–µ—Ä, –æ—á–∏—â–∞–µ—Ç—Å—è). –ü–µ—Ä–µ—Å–º–æ—Ç—Ä–µ—Ç—å –∫–æ–≥–¥–∞: >1000 –ø–æ–∑–∏—Ü–∏–π –º–∞–ø–ø–∏–Ω–≥–∞.
- **O3:** –û–¥–∏–Ω OcrDocument ‚Üí N iiko-–Ω–∞–∫–ª–∞–¥–Ω—ã—Ö (–ø–æ store_type). –ü–µ—Ä–µ—Å–º–æ—Ç—Ä–µ—Ç—å –∫–æ–≥–¥–∞: –Ω—É–∂–Ω–∞ –Ω–∞–∫–ª–∞–¥–Ω–∞—è –±–µ–∑ —Ä–∞–∑–±–∏–≤–∫–∏.
- **O4:** GPT-5.2 Vision ‚Äî –µ–¥–∏–Ω—Å—Ç–≤–µ–Ω–Ω—ã–π OCR-–¥–≤–∏–∂–æ–∫ (Yandex OCR –∑–∞–±—Ä–æ—à–µ–Ω –∏–∑-–∑–∞ DNS-–±–ª–æ–∫–∏—Ä–æ–≤–∫–∏).

---

## –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ (–∞–∫—Ç—É–∞–ª—å–Ω–∞—è)

```
–§–æ—Ç–æ –æ—Ç —é–∑–µ—Ä–∞ (Telegram) ‚Äî 1-10 —à—Ç, –∞–ª—å–±–æ–º –∏–ª–∏ –ø–æ –æ–¥–Ω–æ–º—É
  ‚îÇ
  ‚îú‚îÄ Debounce 1.5 —Å–µ–∫ –ø–æ—Å–ª–µ –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ —Ñ–æ—Ç–æ
  ‚îÇ
  ‚ñº
process_photo_batch() ‚Üí –¥–ª—è –∫–∞–∂–¥–æ–≥–æ —Ñ–æ—Ç–æ:
  ‚îú‚îÄ –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–∞—á–µ—Å—Ç–≤–∞ (OpenCV: —Ä–∞–∑–º—ã—Ç–æ—Å—Ç—å, –æ—Å–≤–µ—â–µ–Ω–∏–µ, —Ä–∞–∑—Ä–µ—à–µ–Ω–∏–µ)
  ‚îú‚îÄ GPT-5.2 Vision ‚Üí JSON (doc_type, supplier, items, totals)
  ‚îú‚îÄ –î–µ—Ç–µ–∫—Ü–∏—è QR (OpenCV + pyzbar) ‚Üí rejected_qr –µ—Å–ª–∏ —á–µ–∫
  ‚îú‚îÄ VAT-–∫–æ—Ä—Ä–µ–∫—Ü–∏—è (_VAT_RATE_MAP)
  ‚îú‚îÄ –ì—Ä—É–ø–ø–∏—Ä–æ–≤–∫–∞ –ø–æ group_key (supplier_inn + doc_number + date)
  ‚îÇ   ‚îú‚îÄ –ü—Ä–æ—Ö–æ–¥ 1: —Å—Ç—Ä–∞–Ω–∏—Ü—ã —Å —è–≤–Ω—ã–º group_key
  ‚îÇ   ‚îî‚îÄ –ü—Ä–æ—Ö–æ–¥ 2: ¬´–æ—Å–∏—Ä–æ—Ç–µ–≤—à–∏–µ¬ª —Å—Ç—Ä. 2+ ‚Üí —Å–æ–ø–æ—Å—Ç–∞–≤–ª–µ–Ω–∏–µ –ø–æ supplier_inn + date
  ‚îî‚îÄ –û–±—ä–µ–¥–∏–Ω–µ–Ω–∏–µ —Ç–æ–≤–∞—Ä–æ–≤ –∏–∑ –≤—Å–µ—Ö —Å—Ç—Ä–∞–Ω–∏—Ü
  ‚îÇ
  ‚ñº
–ö–ª–∞—Å—Å–∏—Ñ–∏–∫–∞—Ü–∏—è —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤:
  ‚îú‚îÄ rejected_qr ‚Üí –ø—Ä–æ–ø—É—Å–∫
  ‚îú‚îÄ error ‚Üí —Å–ø–∏—Å–æ–∫ –æ—à–∏–±–æ–∫
  ‚îú‚îÄ cash_order / act –±–µ–∑ —Å—É–º–º—ã ‚Üí —É—Å–ª—É–≥–∞ ‚Üí notify_accountants (üìë –ë—É—Ö–≥–∞–ª—Ç–µ—Ä)
  ‚îî‚îÄ upd / act —Å —Å—É–º–º–æ–π ‚Üí –Ω–∞–∫–ª–∞–¥–Ω–∞—è:
      ‚îú‚îÄ apply_mapping() ‚Üí –æ–±–æ–≥–∞—â–µ–Ω–∏–µ iiko_name/iiko_id –∏–∑ –±–∞–∑—ã –º–∞–ø–ø–∏–Ω–≥–∞
      ‚îú‚îÄ –ï—Å–ª–∏ –µ—Å—Ç—å –Ω–µ–∑–∞–º–∞–ø–ª–µ–Ω–Ω—ã–µ ‚Üí write_transfer() ‚Üí ¬´–ú–∞–ø–ø–∏–Ω–≥ –ò–º–ø–æ—Ä—Ç¬ª
      ‚îú‚îÄ –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –≤ –ë–î (ocr_document + ocr_item)
      ‚îî‚îÄ Summary: –Ω–∞–∫–ª–∞–¥–Ω—ã–µ / —É—Å–ª—É–≥–∏ / QR / –æ—à–∏–±–∫–∏
```

## –ö–Ω–æ–ø–∫–∞ ¬´‚úÖ –ú–∞–ø–ø–∏–Ω–≥ –≥–æ—Ç–æ–≤¬ª

```
‚úÖ –ú–∞–ø–ø–∏–Ω–≥ –≥–æ—Ç–æ–≤
  ‚îî‚îÄ check_transfer_ready() ‚Üí –≤—Å–µ —Å—Ç—Ä–æ–∫–∏ –∑–∞–ø–æ–ª–Ω–µ–Ω—ã –≤ ¬´–ú–∞–ø–ø–∏–Ω–≥ –ò–º–ø–æ—Ä—Ç¬ª?
      ‚îú‚îÄ –ù–µ –≥–æ—Ç–æ–≤–æ ‚Üí —Å–ø–∏—Å–æ–∫ –Ω–µ–∑–∞–ø–æ–ª–Ω–µ–Ω–Ω—ã—Ö + –∫–Ω–æ–ø–∫–∞ –ø–æ–≤—Ç–æ—Ä–∞
      ‚îî‚îÄ –ì–æ—Ç–æ–≤–æ ‚Üí finalize_transfer()
          ‚îú‚îÄ –ß–∏—Ç–∞–µ–º ¬´–ú–∞–ø–ø–∏–Ω–≥ –ò–º–ø–æ—Ä—Ç¬ª
          ‚îú‚îÄ –û–±–æ–≥–∞—â–∞–µ–º iiko_id (reverse-–∞–ª–∏–∞—Å—ã display‚Üíreal)
          ‚îú‚îÄ UPSERT –≤ ¬´–ú–∞–ø–ø–∏–Ω–≥¬ª (–±–∞–∑–∞)
          ‚îú‚îÄ –û—á–∏—â–∞–µ–º ¬´–ú–∞–ø–ø–∏–Ω–≥ –ò–º–ø–æ—Ä—Ç¬ª
          ‚îî‚îÄ build_iiko_invoices(doc_ids —Ç–µ–∫—É—â–µ–π —Å–µ—Å—Å–∏–∏)
              ‚îú‚îÄ [üì§ –û—Ç–ø—Ä–∞–≤–∏—Ç—å –≤ iiko] ‚Üí POST XML ‚Üí mark_imported
              ‚îî‚îÄ [‚ùå –û—Ç–º–µ–Ω–∏—Ç—å] ‚Üí mark_cancelled
```

---

## GSheet –º–∞–ø–ø–∏–Ω–≥

| –õ–∏—Å—Ç | –ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ | –°—Ç—Ä—É–∫—Ç—É—Ä–∞ |
|------|-----------|-----------|
| ¬´–ú–∞–ø–ø–∏–Ω–≥¬ª | –ë–∞–∑–∞ (–ø–æ—Å—Ç–æ—è–Ω–Ω–∞—è) | A: —Ç–∏–ø, B: OCR-–∏–º—è, C: iiko-–∏–º—è, D: iiko-id |
| ¬´–ú–∞–ø–ø–∏–Ω–≥ –ò–º–ø–æ—Ä—Ç¬ª | –¢—Ä–∞–Ω—Å—Ñ–µ—Ä (–æ—á–∏—â–∞–µ—Ç—Å—è) | A: —Ç–∏–ø, B: OCR-–∏–º—è, C: iiko-–∏–º—è (dropdown) |
| ¬´–ú–∞–ø–ø–∏–Ω–≥ –°–ø—Ä–∞–≤–æ—á–Ω–∏–∫¬ª | –°–∫—Ä—ã—Ç—ã–π ref –¥–ª—è dropdown | A: display_name GOODS (–±–µ–∑ —Ç–µ—Ö–ø—Ä–µ—Ñ–∏–∫—Å–æ–≤) |

- Dropdown –≤ –∫–æ–ª–æ–Ω–∫–µ C: `ONE_OF_RANGE` ‚Üí `='–ú–∞–ø–ø–∏–Ω–≥ –°–ø—Ä–∞–≤–æ—á–Ω–∏–∫'!$A$1:$A$N`
- Display_name: `—Ç_–±—É—Ç—ã–ª–∫–∞ 2–ª` ‚Üí `–±—É—Ç—ã–ª–∫–∞ 2–ª` (–ø–æ–∏—Å–∫ ¬´–±—É—Ç¬ª –Ω–∞—Ö–æ–¥–∏—Ç –≤—Å–µ)
- Reverse-–∞–ª–∏–∞—Å –ø—Ä–∏ —Ñ–∏–Ω–∞–ª–∏–∑–∞—Ü–∏–∏: `–±—É—Ç—ã–ª–∫–∞ 2–ª` ‚Üí `—Ç_–±—É—Ç—ã–ª–∫–∞ 2–ª` –¥–ª—è iiko_id
- Ref-–ª–∏—Å—Ç –æ–±–Ω–æ–≤–ª—è–µ—Ç—Å—è –µ–∂–µ–¥–Ω–µ–≤–Ω–æ –≤ 07:00 + –ø–æ –∫–Ω–æ–ø–∫–µ ¬´üîÑ –û–±–Ω–æ–≤–∏—Ç—å —Å–ø–∏—Å–æ–∫ —Ç–æ–≤–∞—Ä–æ–≤¬ª

---

## –ú–æ–¥—É–ª–∏

| –ú–æ–¥—É–ª—å | –†–æ–ª—å |
|--------|------|
| `bot/document_handlers.py` | FSM: btn_ocr_start, handle_ocr_photo, btn_mapping_done, cb_iiko_invoice_send/cancel |
| `use_cases/ocr_pipeline.py` | process_photo_batch ‚Äî OCR + VAT-–∫–æ—Ä—Ä–µ–∫—Ü–∏—è + –≥—Ä—É–ø–ø–∏—Ä–æ–≤–∫–∞ |
| `use_cases/ocr_mapping.py` | apply_mapping, write_transfer, finalize_transfer, notify_accountants, refresh_ref_sheet |
| `use_cases/incoming_invoice.py` | build_iiko_invoices, send_invoices_to_iiko, mark_imported/cancelled |
| `adapters/gpt5_vision_ocr.py` | GPT-5.2 Vision: —Ñ–æ—Ç–æ ‚Üí JSON |
| `adapters/google_sheets.py` | read/write –º–∞–ø–ø–∏–Ω–≥–æ–≤—ã—Ö –ª–∏—Å—Ç–æ–≤ |
| `models/ocr.py` | OcrDocument, OcrItem (+ iiko_id, iiko_name) |
| `utils/photo_validator.py` | –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–∞—á–µ—Å—Ç–≤–∞ (Laplacian, brightness) |
| `utils/qr_detector.py` | QR-–¥–µ—Ç–µ–∫—Ü–∏—è (pyzbar + OpenCV) |

## –¢–∞–±–ª–∏—Ü—ã (–∫–æ–º–ø–∞–∫—Ç–Ω–æ)

| –¢–∞–±–ª–∏—Ü–∞ | –ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ | –ö–ª—é—á–µ–≤—ã–µ –ø–æ–ª—è |
|---------|-----------|---------------|
| `ocr_document` | –†–∞—Å–ø–æ–∑–Ω–∞–Ω–Ω—ã–µ –¥–æ–∫—É–º–µ–Ω—Ç—ã | telegram_id, doc_type, status, supplier_id |
| `ocr_item` | –¢–æ–≤–∞—Ä—ã –∏–∑ –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤ | document_id (FK), raw_name, iiko_id, iiko_name |

---

## –°—Ç–æ–∏–º–æ—Å—Ç—å (GPT-5.2 Vision)

| –û–±—ä—ë–º | –¶–µ–Ω–∞/–¥–æ–∫—É–º–µ–Ω—Ç | –í –º–µ—Å—è—Ü |
|-------|--------------|---------|
| 100 –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤ | ~$0.04 | ~$4 |
| 1000 –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤ | ~$0.04 | ~$40 |

~15K —Ç–æ–∫–µ–Ω–æ–≤ –Ω–∞ –¥–æ–∫—É–º–µ–Ω—Ç (prompt + completion).

## –ú–µ—Ç—Ä–∏–∫–∏ –∫–∞—á–µ—Å—Ç–≤–∞ (MVP —Ç–µ—Å—Ç –Ω–∞ 17 —Ñ–æ—Ç–æ)

| –¢–∏–ø | –í—Å–µ–≥–æ | –†–∞—Å–ø–æ–∑–Ω–∞–Ω–æ | –û—Ç–∫–ª–æ–Ω–µ–Ω–æ (QR) |
|-----|-------|------------|----------------|
| –£–ü–î | 11 | 11 | 0 |
| –ß–µ–∫–∏ | 4 | 0 | 4 |
| –†–ö–û/–ê–∫—Ç | 2 | 2 | 0 |

---

## –ß–∞—Å—Ç—ã–µ –æ—à–∏–±–∫–∏

1. **VAT 22% –Ω–µ —Ä–∞—Å–ø–æ–∑–Ω–∞–Ω:** –¥–æ–±–∞–≤–∏—Ç—å –≤ `_VAT_RATE_MAP` –≤ `ocr_pipeline.py`
2. **–°—Ç—Ä–∞–Ω–∏—Ü–∞ 2 –Ω–µ –æ–±—ä–µ–¥–∏–Ω—è–µ—Ç—Å—è:** –¥–≤—É—Ö–ø—Ä–æ—Ö–æ–¥–Ω–∞—è –≥—Ä—É–ø–ø–∏—Ä–æ–≤–∫–∞ (supplier_inn + date)
3. **–ü—É—Å—Ç–æ–π choices –≤ GPT:** –ø—Ä–æ–≤–µ—Ä—è—Ç—å `if not response.choices` (S6)
4. **REAL –¥–ª—è –¥–µ–Ω–µ–≥:** –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å `Numeric(12, 4)` (K4)
5. **–î—É–±–ª–∏ OcrDocument:** `_save_ocr_document` —É–¥–∞–ª—è–µ—Ç —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ recognized/pending —Å —Ç–µ–º –∂–µ doc_number
6. **Yandex Cloud:** DNS-–±–ª–æ–∫–∏—Ä–æ–≤–∫–∞ ‚Äî –Ω–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è, —Ç–æ–ª—å–∫–æ GPT-5.2

---

## –°—Ç–∞—Ç—É—Å —É—Å—Ç–∞—Ä–µ–≤—à–∏—Ö —Ä–µ—à–µ–Ω–∏–π

| –†–µ—à–µ–Ω–∏–µ | –°—Ç–∞—Ç—É—Å | –ó–∞–º–µ–Ω–∞ |
|---------|--------|--------|
| Yandex Vision OCR | üóë removed | GPT-5.2 Vision |
| `OPENAI_API_KEY` –≤ config.py | üóë removed | –ß–∏—Ç–∞–µ—Ç—Å—è –≤ –∞–¥–∞–ø—Ç–µ—Ä–µ –Ω–∞–ø—Ä—è–º—É—é |
| `OCR_DEFAULT_STORE_ID` | üóë removed | –ê–≤—Ç–æ-–æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ —á–µ—Ä–µ–∑ store_type |
| ocr_mapping —Ç–∞–±–ª–∏—Ü–∞ –≤ –ë–î | üóë removed | GSheet ¬´–ú–∞–ø–ø–∏–Ω–≥¬ª |
| ocr_supplier_mapping | üóë removed | GSheet ¬´–ú–∞–ø–ø–∏–Ω–≥¬ª |
