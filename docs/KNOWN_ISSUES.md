# üß† –†–µ—à—ë–Ω–Ω—ã–µ –ø—Ä–æ–±–ª–µ–º—ã –∏ –Ω–∞–∫–æ–ø–ª–µ–Ω–Ω—ã–π –æ–ø—ã—Ç

> –°—é–¥–∞ –∑–∞–ø–∏—Å—ã–≤–∞–µ–º –ø—Ä–æ–±–ª–µ–º—ã, –Ω–∞ –∫–æ—Ç–æ—Ä—ã–µ –ø–æ—Ç—Ä–∞—Ç–∏–ª–∏ –º–Ω–æ–≥–æ –≤—Ä–µ–º–µ–Ω–∏, —á—Ç–æ–±—ã –Ω–µ –ø–æ–≤—Ç–æ—Ä—è—Ç—å –æ—à–∏–±–∫–∏.
> –§–æ—Ä–º–∞—Ç: **–°–∏–º–ø—Ç–æ–º** ‚Üí **–ü—Ä–∏—á–∏–Ω–∞** ‚Üí **–†–µ—à–µ–Ω–∏–µ** ‚Üí **–ö–∞–∫ –∏–∑–±–µ–∂–∞—Ç—å**.
> AI-–∞—Å—Å–∏—Å—Ç–µ–Ω—Ç: —á–∏—Ç–∞–π —ç—Ç–æ—Ç —Ñ–∞–π–ª –ø—Ä–∏ –æ—Ç–ª–∞–¥–∫–µ –∏–ª–∏ –µ—Å–ª–∏ –∑–∞–¥–∞—á–∞ ¬´–Ω–µ –∏–¥—ë—Ç¬ª.

---

### iiko API: timestamp –±–µ–∑ –≤—Ä–µ–º–µ–Ω–∏ ‚Üí —É—Å—Ç–∞—Ä–µ–≤—à–∏–µ –æ—Å—Ç–∞—Ç–∫–∏
- **–°–∏–º–ø—Ç–æ–º:** –û—Å—Ç–∞—Ç–∫–∏ –≤ –±–æ—Ç–µ –Ω–µ —Å–æ–≤–ø–∞–¥–∞—é—Ç —Å UI iiko
- **–ü—Ä–∏—á–∏–Ω–∞:** `date.today().isoformat()` ‚Üí `"2026-02-09"` (–Ω–∞—á–∞–ª–æ –¥–Ω—è), iiko –Ω–µ —É—á–∏—Ç—ã–≤–∞–µ—Ç —Å–µ–≥–æ–¥–Ω—è—à–Ω–∏–µ –ø—Ä–æ–≤–æ–¥–∫–∏
- **–†–µ—à–µ–Ω–∏–µ:** `datetime.now().strftime("%Y-%m-%dT%H:%M:%S")`
- **–ö–∞–∫ –∏–∑–±–µ–∂–∞—Ç—å:** –í—Å–µ–≥–¥–∞ –ø–µ—Ä–µ–¥–∞–≤–∞—Ç—å –ø–æ–ª–Ω—ã–π datetime –≤ iiko API, –Ω–∏–∫–æ–≥–¥–∞ —Ç–æ–ª—å–∫–æ –¥–∞—Ç—É

---

### iiko XML: –≤–ª–æ–∂–µ–Ω–Ω—ã–µ –æ–¥–Ω–æ–∏–º—ë–Ω–Ω—ã–µ —Ç–µ–≥–∏ ‚Üí –º—É—Å–æ—Ä–Ω—ã–µ –∑–∞–ø–∏—Å–∏
- **–°–∏–º–ø—Ç–æ–º:** –ü–æ–ª–æ–≤–∏–Ω–∞ –∑–∞–ø–∏—Å–µ–π ¬´–Ω–µ–≤–∞–ª–∏–¥–Ω—ã–π UUID¬ª, –º—É—Å–æ—Ä–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –ø–æ—Å–ª–µ –ø–∞—Ä—Å–∏–Ω–≥–∞
- **–ü—Ä–∏—á–∏–Ω–∞:** `iter("employee")` –Ω–∞—Ö–æ–¥–∏—Ç –≤–ª–æ–∂–µ–Ω–Ω—ã–π `<employee>true</employee>` (boolean-—Ñ–ª–∞–≥) –≤–Ω—É—Ç—Ä–∏ `<employee>` (–æ–±—ä–µ–∫—Ç)
- **–†–µ—à–µ–Ω–∏–µ:** `findall("employee")` ‚Äî —Ç–æ–ª—å–∫–æ –ø—Ä—è–º—ã–µ –¥–æ—á–µ—Ä–Ω–∏–µ —ç–ª–µ–º–µ–Ω—Ç—ã
- **–ö–∞–∫ –∏–∑–±–µ–∂–∞—Ç—å:** –í iiko XML **–Ω–∏–∫–æ–≥–¥–∞** –Ω–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å `iter()`, —Ç–æ–ª—å–∫–æ `findall()`

---

### Railway PostgreSQL: –∫–∞–∂–¥—ã–π –∑–∞–ø—Ä–æ—Å = +400–º—Å
- **–°–∏–º–ø—Ç–æ–º:** –ë–æ—Ç –æ—Ç–≤–µ—á–∞–µ—Ç –º–µ–¥–ª–µ–Ω–Ω–æ, –∫–Ω–æ–ø–∫–∏ ¬´–∑–∞–≤–∏—Å–∞—é—Ç¬ª
- **–ü—Ä–∏—á–∏–Ω–∞:** Railway PostgreSQL ‚Äî —É–¥–∞–ª—ë–Ω–Ω–∞—è –ë–î, ~400–º—Å –Ω–∞ –∫–∞–∂–¥—ã–π round-trip
- **–†–µ—à–µ–Ω–∏–µ:** Batch INSERT (500 —Å—Ç—Ä–æ–∫), asyncio.gather, JOIN –≤–º–µ—Å—Ç–æ N+1, in-memory –∫–µ—à
- **–ö–∞–∫ –∏–∑–±–µ–∂–∞—Ç—å:** –ü–µ—Ä–µ–¥ –∫–∞–∂–¥—ã–º –Ω–æ–≤—ã–º DB-–∑–∞–ø—Ä–æ—Å–æ–º —Å–ø—Ä–∞—à–∏–≤–∞–π: ¬´–∞ –º–æ–∂–Ω–æ –ª–∏ —ç—Ç–æ –æ–±—ä–µ–¥–∏–Ω–∏—Ç—å —Å –¥—Ä—É–≥–∏–º –∑–∞–ø—Ä–æ—Å–æ–º –∏–ª–∏ –∑–∞–∫–µ—à–∏—Ä–æ–≤–∞—Ç—å?¬ª

---

### FinTablo 429 Too Many Requests
- **–°–∏–º–ø—Ç–æ–º:** –ß–∞—Å—Ç—å sync-–∑–∞–¥–∞—á –ø–∞–¥–∞–µ—Ç —Å 429
- **–ü—Ä–∏—á–∏–Ω–∞:** 13 –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω—ã—Ö –∑–∞–¥–∞—á –±–µ–∑ –ª–∏–º–∏—Ç–∞ ‚Üí 500+ req/min, –ª–∏–º–∏—Ç FinTablo = 300 req/min
- **–†–µ—à–µ–Ω–∏–µ:** `asyncio.Semaphore(4)` + retry —Å exponential backoff (2—Å ‚Üí 4—Å ‚Üí 8—Å ‚Üí 16—Å ‚Üí 32—Å)
- **–ö–∞–∫ –∏–∑–±–µ–∂–∞—Ç—å:** –õ—é–±–æ–π –≤–Ω–µ—à–Ω–∏–π API —Å rate limit ‚Üí —Å–µ–º–∞—Ñ–æ—Ä + retry —Å backoff —Å –ø–µ—Ä–≤–æ–≥–æ –¥–Ω—è

---

### httpx: `Server disconnected without sending a response`
- **–°–∏–º–ø—Ç–æ–º:** –°–ª—É—á–∞–π–Ω—ã–µ –ø–∞–¥–µ–Ω–∏—è sync (–æ—Å–æ–±–µ–Ω–Ω–æ stores), –æ—à–∏–±–∫–∞ `RemoteProtocolError`
- **–ü—Ä–∏—á–∏–Ω–∞:** –¢—Ä–∞–Ω–∑–∏–µ–Ω—Ç–Ω—ã–µ —Å–µ—Ç–µ–≤—ã–µ –æ—à–∏–±–∫–∏ iiko —Å–µ—Ä–≤–µ—Ä–∞ (TCP reset, timeout)
- **–†–µ—à–µ–Ω–∏–µ:** `_get_with_retry()` ‚Äî 3 –ø–æ–ø—ã—Ç–∫–∏, backoff 1‚Üí3‚Üí7 —Å–µ–∫
- **–ö–∞–∫ –∏–∑–±–µ–∂–∞—Ç—å:** –í—Å–µ GET-–∑–∞–ø—Ä–æ—Å—ã –∫ –≤–Ω–µ—à–Ω–∏–º API ‚Äî —á–µ—Ä–µ–∑ retry-–æ–±—ë—Ä—Ç–∫—É. POST ‚Äî –±–µ–∑ retry (–∏–¥–µ–º–ø–æ—Ç–µ–Ω—Ç–Ω–æ—Å—Ç—å)

---

### –ú–µ–¥–ª–µ–Ω–Ω—ã–π —Å—Ç–∞—Ä—Ç –±–æ—Ç–∞ (13 —Å–µ–∫)
- **–°–∏–º–ø—Ç–æ–º:** –ë–æ—Ç –∑–∞–ø—É—Å–∫–∞–µ—Ç—Å—è 13 —Å–µ–∫—É–Ω–¥
- **–ü—Ä–∏—á–∏–Ω–∞:** `create_all()` –ø—Ä–∏ –∫–∞–∂–¥–æ–º –∑–∞–ø—É—Å–∫–µ ‚Üí DDL-–∑–∞–ø—Ä–æ—Å—ã –ø–æ —É–¥–∞–ª—ë–Ω–Ω–æ–π –ë–î (~400–º—Å √ó N —Ç–∞–±–ª–∏—Ü)
- **–†–µ—à–µ–Ω–∏–µ:** `SELECT 1` health check –≤–º–µ—Å—Ç–æ `create_all`
- **–ö–∞–∫ –∏–∑–±–µ–∂–∞—Ç—å:** `create_all` —Ç–æ–ª—å–∫–æ –ø—Ä–∏ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ (`python -m db.init_db`), –Ω–µ –ø—Ä–∏ –∫–∞–∂–¥–æ–º –∑–∞–ø—É—Å–∫–µ

---

### Google Sheets: —Å–∫—Ä—ã—Ç–∏–µ —Å—Ç—Ä–æ–∫/—Å—Ç–æ–ª–±—Ü–æ–≤ –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç
- **–°–∏–º–ø—Ç–æ–º:** –ú–µ—Ç–∞-—Å—Ç—Ä–æ–∫–∞ –∏ —Å—Ç–æ–ª–±–µ—Ü ID –≤–∏–¥–Ω—ã –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é, –æ—à–∏–±–∫–∏ ¬´–ø—Ä–æ–≥–ª–∞—Ç—ã–≤–∞—é—Ç—Å—è¬ª –≤ –ª–æ–≥–∞—Ö
- **–ü—Ä–∏—á–∏–Ω–∞:** batch_update –æ—à–∏–±–∫–∏ –ª–æ–≤–∏–ª–∏—Å—å —á–µ—Ä–µ–∑ `logger.debug` (–Ω–µ–≤–∏–¥–∏–º–æ –ø—Ä–∏ LOG_LEVEL=INFO)
- **–†–µ—à–µ–Ω–∏–µ:** –û—Ç–¥–µ–ª—å–Ω—ã–π try/except —Å `logger.warning`, —Ä–∞–∑–¥–µ–ª–µ–Ω–∏–µ batch_update –Ω–∞ —á–∞—Å—Ç–∏
- **–ö–∞–∫ –∏–∑–±–µ–∂–∞—Ç—å:** –û—à–∏–±–∫–∏ Google Sheets API ‚Üí `logger.warning`, –Ω–∏–∫–æ–≥–¥–∞ –Ω–µ `logger.debug`

---

### writeoff_handlers: double-click –Ω–µ –±–ª–æ–∫–∏—Ä–æ–≤–∞–ª—Å—è
- **–°–∏–º–ø—Ç–æ–º:** –ü—Ä–∏ –±—ã—Å—Ç—Ä–æ–º –¥–≤–æ–π–Ω–æ–º –Ω–∞–∂–∞—Ç–∏–∏ ¬´–û—Ç–ø—Ä–∞–≤–∏—Ç—å¬ª –¥–æ–∫—É–º–µ–Ω—Ç —Å–æ–∑–¥–∞–≤–∞–ª—Å—è –¥–≤–∞–∂–¥—ã
- **–ü—Ä–∏—á–∏–Ω–∞:** `_sending_lock` –ø—Ä–æ–≤–µ—Ä—è–ª—Å—è (`if user_id in _sending_lock`), –Ω–æ –Ω–∏–∫–æ–≥–¥–∞ –Ω–µ —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–ª—Å—è (`_sending_lock.add(user_id)` –æ—Ç—Å—É—Ç—Å—Ç–≤–æ–≤–∞–ª)
- **–†–µ—à–µ–Ω–∏–µ:** –î–æ–±–∞–≤–ª–µ–Ω `_sending_lock.add(user_id)` + `finally: _sending_lock.discard(user_id)`
- **–ö–∞–∫ –∏–∑–±–µ–∂–∞—Ç—å:** Lock = 3 —Å—Ç—Ä–æ–∫–∏: check ‚Üí set ‚Üí finally discard. –ï—Å–ª–∏ –≤–∏–¥–∏—à—å —Ç–æ–ª—å–∫–æ check ‚Äî –±–∞–≥.

---

### sync_products –Ω–µ –≤—ã–∑—ã–≤–∞–ª—Å—è –ø–µ—Ä–µ–¥ –ø—Ä–æ–≤–µ—Ä–∫–æ–π –º–∏–Ω. –æ—Å—Ç–∞—Ç–∫–æ–≤
- **–°–∏–º–ø—Ç–æ–º:** –ë–æ—Ç –≥–æ–≤–æ—Ä–∏—Ç ¬´–≤—Å–µ –≤ –Ω–æ—Ä–º–µ¬ª, —Ö–æ—Ç—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Ç–æ–ª—å–∫–æ —á—Ç–æ —É—Å—Ç–∞–Ω–æ–≤–∏–ª –º–∏–Ω. —É—Ä–æ–≤–µ–Ω—å –≤ iiko
- **–ü—Ä–∏—á–∏–Ω–∞:** `btn_check_min_stock` —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞–ª –æ—Å—Ç–∞—Ç–∫–∏, –Ω–æ –Ω–µ –Ω–æ–º–µ–Ω–∫–ª–∞—Ç—É—Ä—É. –ú–∏–Ω. —É—Ä–æ–≤–Ω–∏ –≤ `raw_json` —É—Å—Ç–∞—Ä–µ–≤—à–∏–µ.
- **–†–µ—à–µ–Ω–∏–µ:** –î–æ–±–∞–≤–ª–µ–Ω `sync_products()` –ø–µ—Ä–µ–¥ `sync_stock_balances()`
- **–ö–∞–∫ –∏–∑–±–µ–∂–∞—Ç—å:** –ï—Å–ª–∏ –¥–∞–Ω–Ω—ã–µ —á–∏—Ç–∞—é—Ç—Å—è –∏–∑ `raw_json` ‚Äî —É–±–µ–¥–∏—Å—å, —á—Ç–æ –æ–±—ä–µ–∫—Ç —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞–Ω –ø–µ—Ä–µ–¥ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º
