# ‚úÖ –ò—Å—Ç–æ—Ä–∏—è –∏–∑–º–µ–Ω–µ–Ω–∏–π (Changelog)

> –ß–∏—Ç–∞–π —ç—Ç–æ—Ç —Ñ–∞–π–ª –ø—Ä–∏: –ø–æ–Ω–∏–º–∞–Ω–∏–µ –∏—Å—Ç–æ—Ä–∏–∏ —Ä–µ—à–µ–Ω–∏–π, –ø—Ä–æ–≤–µ—Ä–∫–∞ —á—Ç–æ —É–∂–µ –±—ã–ª–æ —Å–¥–µ–ª–∞–Ω–æ, –∫–æ–Ω—Ç–µ–∫—Å—Ç –ø—Ä–æ—à–ª—ã—Ö –±–∞–≥–æ–≤.

---

### 2026-02-12 ‚Äî –ü—Ä–∞–π—Å-–ª–∏—Å—Ç –Ω–∞–∫–ª–∞–¥–Ω—ã—Ö + —Å–µ–±–µ—Å—Ç–æ–∏–º–æ—Å—Ç—å –∏–∑ iiko

**–¶–µ–ª—å:** Google –¢–∞–±–ª–∏—Ü–∞ —Å —Ç–æ–≤–∞—Ä–∞–º–∏ –¥–ª—è —Ä–∞—Å—Ö–æ–¥–Ω—ã—Ö –Ω–∞–∫–ª–∞–¥–Ω—ã—Ö, –∞–≤—Ç–æ-—Ä–∞—Å—á—ë—Ç —Å–µ–±–µ—Å—Ç–æ–∏–º–æ—Å—Ç–∏.

**1. iiko API ‚Äî –¥–≤–∞ –Ω–æ–≤—ã—Ö —ç–Ω–¥–ø–æ–∏–Ω—Ç–∞** (`adapters/iiko_api.py`)
- `fetch_incoming_invoices(date_from, date_to)` ‚Äî GET `/resto/api/documents/export/incomingInvoice` (XML ‚Üí list[dict])
- `fetch_assembly_charts(date_from, date_to)` ‚Äî GET `/resto/api/v2/assemblyCharts/getAll` (JSON, includePreparedCharts)

**2. –†–∞—Å—á—ë—Ç —Å–µ–±–µ—Å—Ç–æ–∏–º–æ—Å—Ç–∏** (`use_cases/outgoing_invoice.py`)
- `calculate_goods_cost_prices(days_back=90)` ‚Äî —Ü–µ–Ω–∞ GOODS –ø–æ –ø–æ—Å–ª–µ–¥–Ω–µ–º—É –ø—Ä–∏—Ö–æ–¥—É (–ø—Ä–∏—Ö–æ–¥–Ω—ã–µ –Ω–∞–∫–ª–∞–¥–Ω—ã–µ –∑–∞ N –¥–Ω–µ–π)
- `calculate_dish_cost_prices(goods_costs)` ‚Äî —Å–µ–±–µ—Å—Ç–æ–∏–º–æ—Å—Ç—å DISH: sum(ingredient.amountOut √ó ingredient_cost) –ø–æ —Ç–µ—Ö–∫–∞—Ä—Ç–∞–º
- `sync_price_sheet()` ‚Äî –ø–æ–ª–Ω—ã–π –ø–∞–π–ø–ª–∞–π–Ω: –¥–µ—Ä–µ–≤–æ —Ç–æ–≤–∞—Ä–æ–≤ ‚Üí GOODS cost ‚Üí DISH cost ‚Üí Google Sheet

**3. Google Sheet ¬´–ü—Ä–∞–π—Å-–ª–∏—Å—Ç¬ª** (`adapters/google_sheets.py`)
- `sync_invoice_prices_to_sheet(products, cost_prices)` ‚Äî –∑–∞–ø–∏—Å—å —Å —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ–º —Ä—É—á–Ω—ã—Ö —Ü–µ–Ω (D —Å—Ç–æ–ª–±–µ—Ü)
- `read_invoice_prices()` ‚Äî —á—Ç–µ–Ω–∏–µ –ø—Ä–∞–π—Å-–ª–∏—Å—Ç–∞
- –°—Ç–æ–ª–±—Ü—ã: A=–¢–æ–≤–∞—Ä, B=ID (—Å–∫—Ä—ã—Ç—ã–π), C=–°–µ–±–µ—Å—Ç–æ–∏–º–æ—Å—Ç—å (–∞–≤—Ç–æ), D=–¶–µ–Ω–∞ –æ—Ç–≥—Ä—É–∑–∫–∏ (—Ä—É—á–Ω–∞—è)
- –ü–∞—Ç—Ç–µ—Ä–Ω stable-rows: –ø—Ä–∏–≤—è–∑–∫–∞ –ø–æ product_id, –Ω–æ–≤—ã–µ –ø–æ–∑–∏—Ü–∏–∏ –Ω–µ —Å–¥–≤–∏–≥–∞—é—Ç —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ

**4. –ö–Ω–æ–ø–∫–∞ –±–æ—Ç–∞** (`bot/handlers.py`)
- ¬´üí∞ –ü—Ä–∞–π—Å-–ª–∏—Å—Ç ‚Üí GSheet¬ª –≤ –ø–æ–¥–º–µ–Ω—é ¬´–ö–æ–º–∞–Ω–¥—ã¬ª (admin_required)
- –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è: INVOICE_PRICE_SHEET_ID (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é = MIN_STOCK_SHEET_ID)

---

### 2026-02-12 ‚Äî –†–∞—Å—Ö–æ–¥–Ω–∞—è –Ω–∞–∫–ª–∞–¥–Ω–∞—è: —à–∞–±–ª–æ–Ω—ã (Phase 1)

**–¶–µ–ª—å:** –°–æ–∑–¥–∞–Ω–∏–µ —à–∞–±–ª–æ–Ω–æ–≤ —Ä–∞—Å—Ö–æ–¥–Ω—ã—Ö –Ω–∞–∫–ª–∞–¥–Ω—ã—Ö –¥–ª—è –±—ã—Å—Ç—Ä–æ–≥–æ –ø–æ–≤—Ç–æ—Ä–Ω–æ–≥–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è.

**1. –ú–æ–¥–µ–ª—å `InvoiceTemplate`** (`db/models.py`)
- –¢–∞–±–ª–∏—Ü–∞ ‚Ññ16 iiko/bot (‚Ññ29 –æ–±—â–∞—è), JSONB-–ø–æ–ª–µ items [{product_id, name, unit_name}]
- –î–µ–Ω–æ—Ä–º–∞–ª–∏–∑–æ–≤–∞–Ω–Ω—ã–µ –ø–æ–ª—è: counteragent_name, account_name, store_name
- –ò–Ω–¥–µ–∫—Å—ã: created_by, department_id

**2. –ö–µ—à `use_cases/invoice_cache.py`**
- TTL 600—Å: suppliers, revenue_account, stores (–ø–æ dept), products_tree
- –ü–∞—Ç—Ç–µ—Ä–Ω writeoff_cache: in-memory dict {key: (data, timestamp)}

**3. –ë–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫–∞ `use_cases/outgoing_invoice.py`**
- `load_all_suppliers()` + `search_suppliers(query)` ‚Äî –ø–æ–∏—Å–∫ –∫–æ–Ω—Ç—Ä–∞–≥–µ–Ω—Ç–æ–≤
- `get_revenue_account()` ‚Äî –∞–≤—Ç–æ-–ø–æ–∏—Å–∫ —Å—á—ë—Ç–∞ ¬´—Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è –Ω–∞ —Ç–æ—á–∫–∏¬ª
- `get_stores_for_department()` ‚Äî —Ç–æ–ª—å–∫–æ –±–∞—Ä/–∫—É—Ö–Ω—è
- `preload_products_tree()` ‚Äî BFS –ø–æ gsheet_export_group ‚Üí —Ñ–∏–ª—å—Ç—Ä GOODS+DISH
- `save_template()`, `get_templates_for_department()`, `delete_template()`

**4. –•—ç–Ω–¥–ª–µ—Ä—ã `bot/invoice_handlers.py`**
- FSM: store ‚Üí supplier_search ‚Üí supplier_choose ‚Üí add_items ‚Üí template_name
- Summary+prompt –ø–∞—Ç—Ç–µ—Ä–Ω, guard-—Ö—ç–Ω–¥–ª–µ—Ä—ã, inline-–∫–Ω–æ–ø–∫–∏
- –ö–Ω–æ–ø–∫–∞ ¬´üìã –°–æ–∑–¥–∞—Ç—å —à–∞–±–ª–æ–Ω –Ω–∞–∫–ª–∞–¥–Ω–æ–π¬ª –≤ –º–µ–Ω—é ¬´–î–æ–∫—É–º–µ–Ω—Ç—ã¬ª

---

### 2026-02-12 ‚Äî –ö–µ—à –Ω–æ–º–µ–Ω–∫–ª–∞—Ç—É—Ä—ã –¥–ª—è –º–≥–Ω–æ–≤–µ–Ω–Ω–æ–≥–æ –ø–æ–∏—Å–∫–∞ —Ç–æ–≤–∞—Ä–æ–≤

**–ü—Ä–æ–±–ª–µ–º–∞:** –ü–æ–∏—Å–∫ —Ç–æ–≤–∞—Ä–æ–≤ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ —Å–ø–∏—Å–∞–Ω–∏—è = ~2.3 —Å–µ–∫ (DB round-trip Railway).
**–†–µ—à–µ–Ω–∏–µ:** In-memory –∫–µ—à –≤—Å–µ—Ö GOODS/PREPARED —Ç–æ–≤–∞—Ä–æ–≤ —Å –ø—Ä–µ–¥—Ä–µ–∑–æ–ª–≤–ª–µ–Ω–Ω—ã–º–∏ –µ–¥–∏–Ω–∏—Ü–∞–º–∏ –∏–∑–º–µ—Ä–µ–Ω–∏—è.
- `preload_products()` –≤ `writeoff.py` ‚Äî –∑–∞–≥—Ä—É–∂–∞–µ—Ç –≤—Å–µ 1942 —Ç–æ–≤–∞—Ä–∞ + –±–∞—Ç—á-—Ä–µ–∑–æ–ª–≤ units ‚Üí –∫–µ—à (~400 –ö–ë RAM)
- `search_products()` ‚Äî —Å–Ω–∞—á–∞–ª–∞ –∏—â–µ—Ç –≤ –∫–µ—à–µ (0 –º—Å), fallback –Ω–∞ –ë–î –µ—Å–ª–∏ –∫–µ—à –ø—É—Å—Ç
- –ü—Ä–æ–≥—Ä–µ–≤ –ø—Ä–∏ –≤—Ö–æ–¥–µ –≤ ¬´–î–æ–∫—É–º–µ–Ω—Ç—ã¬ª –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ —Å–æ —Å–∫–ª–∞–¥–∞–º–∏/—Å—á–µ—Ç–∞–º–∏/admin_ids
- TTL 10 –º–∏–Ω (–∫–∞–∫ —Å–∫–ª–∞–¥—ã/—Å—á–µ—Ç–∞)
- `get_products()` / `set_products()` –≤ `writeoff_cache.py`

---

### 2026-02-12 ‚Äî –ò—Å—Ç–æ—Ä–∏—è —Å–ø–∏—Å–∞–Ω–∏–π (writeoff_history)

**1. –ù–æ–≤–∞—è —Ç–∞–±–ª–∏—Ü–∞ `writeoff_history`**
- –ú–æ–¥–µ–ª—å `WriteoffHistory` –≤ `db/models.py` (—Ç–∞–±–ª–∏—Ü–∞ ‚Ññ15 iiko/bot, ‚Ññ28 –æ–±—â–∞—è)
- JSONB-–ø–æ–ª–µ `items` –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è –ø–æ–∑–∏—Ü–∏–π —Å–ø–∏—Å–∞–Ω–∏—è
- `store_type` (bar/kitchen/NULL) –¥–ª—è —Ä–æ–ª–µ–≤–æ–π —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏
- –ò–Ω–¥–µ–∫—Å—ã: telegram_id, department_id, store_type, created_at
- –ú–∏–≥—Ä–∞—Ü–∏—è: 4 CREATE INDEX IF NOT EXISTS –≤ `db/init_db.py`

**2. –ë–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫–∞ `use_cases/writeoff_history.py`**
- `save_to_history()` ‚Äî —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –æ–¥–æ–±—Ä–µ–Ω–Ω–æ–≥–æ —Å–ø–∏—Å–∞–Ω–∏—è + –∞–≤—Ç–æ-–æ—á–∏—Å—Ç–∫–∞ (>200 –∑–∞–ø–∏—Å–µ–π –Ω–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è)
- `get_history(telegram_id, department_id, role_type, page)` ‚Äî —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏—è: –±–∞—Ä ‚Üí —Ç–æ–ª—å–∫–æ –±–∞—Ä, –∫—É—Ö–Ω—è ‚Üí —Ç–æ–ª—å–∫–æ –∫—É—Ö–Ω—è, admin/unknown ‚Üí –≤—Å–µ
- `get_history_entry(pk)`, `build_history_summary()` ‚Äî –¥–µ—Ç–∞–ª–∏ –∑–∞–ø–∏—Å–∏
- `_detect_store_type()` ‚Äî –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ —Ç–∏–ø–∞ —Å–∫–ª–∞–¥–∞ (–±–∞—Ä/–∫—É—Ö–Ω—è) –ø–æ –∏–º–µ–Ω–∏
- MAX_HISTORY_PER_USER=200, HISTORY_PAGE_SIZE=10

**3. Telegram-—Ö—ç–Ω–¥–ª–µ—Ä—ã (bot/writeoff_handlers.py)**
- FSM `HistoryStates`: browsing ‚Üí viewing ‚Üí editing_reason / editing_items / editing_quantity
- –ü—Ä–æ—Å–º–æ—Ç—Ä: —Å–ø–∏—Å–æ–∫ —Å –ø–∞–≥–∏–Ω–∞—Ü–∏–µ–π, –¥–µ—Ç–∞–ª–∏ –∑–∞–ø–∏—Å–∏, –∫–Ω–æ–ø–∫–∏ ¬´–ø–æ–≤—Ç–æ—Ä–∏—Ç—å –∫–∞–∫ –µ—Å—Ç—å¬ª / ¬´—Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –∏ –æ—Ç–ø—Ä–∞–≤–∏—Ç—å¬ª
- –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –ø–µ—Ä–µ–¥ –ø–æ–≤—Ç–æ—Ä–æ–º: –ø—Ä–∏—á–∏–Ω–∞, –ø–æ–∑–∏—Ü–∏–∏ (–∫–æ–ª–∏—á–µ—Å—Ç–≤–æ, —É–¥–∞–ª–µ–Ω–∏–µ, –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ –Ω–æ–≤–æ–≥–æ —Ç–æ–≤–∞—Ä–∞)
- Callback-–ø—Ä–µ—Ñ–∏–∫—Å—ã: `woh_` (history browse), `wohe_` (history edit)
- –í–∞–ª–∏–¥–∞—Ü–∏—è callback_data: –≤—Å–µ int-–ø–∞—Ä—Å–∏–Ω–≥–∏ –æ–±—ë—Ä–Ω—É—Ç—ã –≤ try/except (ValueError, IndexError)
- –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ: tg_id + –¥–µ–π—Å—Ç–≤–∏–µ –≤–æ –≤—Å–µ—Ö —Ö—ç–Ω–¥–ª–µ—Ä–∞—Ö

**4. –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è save_to_history**
- `admin_approve` ‚Äî –ø–æ—Å–ª–µ —É—Å–ø–µ—à–Ω–æ–π –æ—Ç–ø—Ä–∞–≤–∫–∏ –≤ iiko
- `finalize_writeoff` (no-admin) ‚Äî –ø–æ—Å–ª–µ –ø—Ä—è–º–æ–π –æ—Ç–ø—Ä–∞–≤–∫–∏
- `hist_reuse` (no-admin) ‚Äî –ø–æ–≤—Ç–æ—Ä –∏–∑ –∏—Å—Ç–æ—Ä–∏–∏
- `hist_edit_send` (no-admin) ‚Äî –ø–æ–≤—Ç–æ—Ä —Å –∏–∑–º–µ–Ω–µ–Ω–∏—è–º–∏

**5. UI**
- –ö–Ω–æ–ø–∫–∞ ¬´üìã –ò—Å—Ç–æ—Ä–∏—è —Å–ø–∏—Å–∞–Ω–∏–π¬ª –≤ –ø–æ–¥–º–µ–Ω—é ¬´–î–æ–∫—É–º–µ–Ω—Ç—ã¬ª (`bot/handlers.py`)

**6. –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è**
- `docs/DATABASE.md`: —Ç–∞–±–ª–∏—Ü–∞ ‚Ññ28, —Å—á—ë—Ç—á–∏–∫–∏ 27‚Üí28, 14‚Üí15
- `docs/FILE_STRUCTURE.md`: writeoff_history.py, HistoryStates, –∫–Ω–æ–ø–∫–∞ ¬´üìã –ò—Å—Ç–æ—Ä–∏—è¬ª
- `PROJECT_MAP.md`: –æ–ø–∏—Å–∞–Ω–∏–µ —Ñ–∞–∑—ã, –Ω–∞–≤–∏–≥–∞—Ü–∏–æ–Ω–Ω–∞—è —Ç–∞–±–ª–∏—Ü–∞ 27‚Üí28 —Å—Ö–µ–º

---

### 2026-02-11 ‚Äî –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ GSheet + –º–∏–≥—Ä–∞—Ü–∏—è –º–∏–Ω/–º–∞–∫—Å –∏–∑ storeBalanceLevels + –æ—á–∏—Å—Ç–∫–∞

**1. –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ Google –¢–∞–±–ª–∏—Ü—ã**
- –ó–∞–≥–æ–ª–æ–≤–∫–∏ –ø–æ–¥—Ä–∞–∑–¥–µ–ª–µ–Ω–∏–π: merge_cells –∏—Å–ø—Ä–∞–≤–ª–µ–Ω (A1-notation –≤–º–µ—Å—Ç–æ keyword args)
- –°—É–±–∑–∞–≥–æ–ª–æ–≤–∫–∏ –ú–ò–ù/–ú–ê–ö–°: —Ü–µ–Ω—Ç—Ä–∏—Ä–æ–≤–∞–Ω–∏–µ (`horizontalAlignment: "CENTER"`)
- –®–∏—Ä–∏–Ω–∞ –ú–ò–ù/–ú–ê–ö–°: 60px (–±—ã–ª–æ 75px)

**2. –û–¥–Ω–æ—Ä–∞–∑–æ–≤–∞—è –º–∏–≥—Ä–∞—Ü–∏—è –º–∏–Ω/–º–∞–∫—Å –∏–∑ iiko**
- –ò–∑–≤–ª–µ—á–µ–Ω—ã `storeBalanceLevels` –∏–∑ `iiko_product.raw_json` ‚Üí 70 –∑–∞–ø–∏—Å–µ–π (product√ódept)
- –ú–∞–ø–ø–∏–Ω–≥: `store.parent_id ‚Üí dept_id`, –∞–≥—Ä–µ–≥–∞—Ü–∏—è `MAX(min, max)` –ø–æ —Å–∫–ª–∞–¥–∞–º
- –î–∞–Ω–Ω—ã–µ –∑–∞–ø–∏—Å–∞–Ω—ã –≤ GSheet ‚Üí —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞–Ω—ã –≤ `min_stock_level` (70 –∑–∞–ø–∏—Å–µ–π)

**3. –û—á–∏—Å—Ç–∫–∞ –æ–¥–Ω–æ—Ä–∞–∑–æ–≤–æ–≥–æ –∫–æ–¥–∞**
- –£–¥–∞–ª—ë–Ω –ø–∞—Ä–∞–º–µ—Ç—Ä `db_levels` –∏–∑ `sync_products_to_sheet()` (–æ–¥–Ω–æ—Ä–∞–∑–æ–≤—ã–π pre-fill –≤—ã–ø–æ–ª–Ω–µ–Ω)
- –£–¥–∞–ª—ë–Ω –±–ª–æ–∫ –∏–∑–≤–ª–µ—á–µ–Ω–∏—è storeBalanceLevels –∏–∑ `sync_nomenclature_to_gsheet()`
- –£–¥–∞–ª—ë–Ω –∏–º–ø–æ—Ä—Ç `Store` –∏–∑ `sync_min_stock.py`
- –ò—Å—Ç–æ—á–Ω–∏–∫ –º–∏–Ω/–º–∞–∫—Å —Ç–µ–ø–µ—Ä—å: —Ç–æ–ª—å–∫–æ —Ä—É—á–Ω–æ–π –≤–≤–æ–¥ –≤ GSheet –∏–ª–∏ —á–µ—Ä–µ–∑ Telegram-–±–æ—Ç

---

### 2026-02-11 ‚Äî Retry-–ª–æ–≥–∏–∫–∞ –¥–ª—è iiko API + ProductGroup + GSheet —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ + –≥—Ä—É–ø–ø–∏—Ä–æ–≤–∫–∞ –ø–æ –¥–µ—Ä–µ–≤—É

**1. Retry-–ª–æ–≥–∏–∫–∞ –¥–ª—è iiko API GET-–∑–∞–ø—Ä–æ—Å–æ–≤**

–ü—Ä–æ–±–ª–µ–º–∞: Store sync –≤—ã–ø–∞–¥–∞–ª —Å `Server disconnected without sending a response`.
–†–µ—à–µ–Ω–∏–µ: `_get_with_retry()` ‚Äî 3 –ø–æ–ø—ã—Ç–∫–∏, backoff 1‚Üí3‚Üí7 —Å–µ–∫. POST –±–µ–∑ retry.
–ò–∑–º–µ–Ω–µ–Ω–æ: `adapters/iiko_api.py` ‚Äî –≤—Å–µ 11 GET fetch-—Ñ—É–Ω–∫—Ü–∏–π.

**2. –ù–æ–º–µ–Ω–∫–ª–∞—Ç—É—Ä–Ω—ã–µ –≥—Ä—É–ø–ø—ã (ProductGroup)**

–ü—Ä–æ–±–ª–µ–º–∞: `sync_product_groups` —É–ø–æ–º–∏–Ω–∞–ª–∞—Å—å, –Ω–æ –Ω–µ —Å—É—â–µ—Å—Ç–≤–æ–≤–∞–ª–∞.
–†–µ—à–µ–Ω–∏–µ: –ü–æ–ª–Ω–æ—Ü–µ–Ω–Ω–∞—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è –Ω–æ–º–µ–Ω–∫–ª–∞—Ç—É—Ä–Ω—ã—Ö –≥—Ä—É–ø–ø.
–ò–∑–º–µ–Ω–µ–Ω–æ: `db/models.py` (ProductGroup), `adapters/iiko_api.py` (fetch_product_groups), `use_cases/sync.py` (sync_product_groups), `bot/handlers.py`.

**3. –§–∏–ª—å—Ç—Ä–∞—Ü–∏—è —Ç–æ–≤–∞—Ä–æ–≤ –ø–æ –¥–µ—Ä–µ–≤—É –≥—Ä—É–ø–ø –∏–∑ –ë–î**

–ü—Ä–æ–±–ª–µ–º–∞: –í GSheet –≤—ã–≥—Ä—É–∂–∞–ª–∏—Å—å –≤—Å–µ —Ç–æ–≤–∞—Ä—ã (GOODS), –∞ –Ω—É–∂–Ω–æ —Ç–æ–ª—å–∫–æ –∏–∑ –ø–∞–ø–∫–∏ ¬´–¢–æ–≤–∞—Ä—ã¬ª.
–†–µ—à–µ–Ω–∏–µ: –¢–∞–±–ª–∏—Ü–∞ `gsheet_export_group` + BFS-–æ–±—Ö–æ–¥ –¥–µ—Ä–µ–≤–∞ `iiko_product_group`.
–ò–∑–º–µ–Ω–µ–Ω–æ: `db/models.py` (GSheetExportGroup), `use_cases/sync_min_stock.py`.

**4. Google Sheets ‚Äî –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Å–∫—Ä—ã—Ç–∏—è —Å—Ç—Ä–æ–∫/—Å—Ç–æ–ª–±—Ü–æ–≤ + —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ**

–ü—Ä–æ–±–ª–µ–º–∞: Row 1 –∏ column B –Ω–µ —Å–∫—Ä—ã–≤–∞–ª–∏—Å—å.
–†–µ—à–µ–Ω–∏–µ: –†–∞–∑–¥–µ–ª–µ–Ω–∏–µ batch_update, SOLID_MEDIUM –≥—Ä–∞–Ω–∏—Ü—ã, 75px‚Üí60px.
–ò–∑–º–µ–Ω–µ–Ω–æ: `adapters/google_sheets.py`.

**5. –†–µ–æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏—è –∫–Ω–æ–ø–æ–∫ –±–æ—Ç–∞ + –∞—É–¥–∏—Ç**

–£–¥–∞–ª–µ–Ω—ã —Ç–µ—Å—Ç–æ–≤—ã–µ —Ñ–∞–π–ª—ã. –ü—Ä–æ–≤–µ—Ä–µ–Ω–æ: 0 stale-—Å—Å—ã–ª–æ–∫, 0 syntax errors.

---

### 2026-02-11 ‚Äî –ü–µ—Ä–µ–ø–∏—Å–∞–Ω–∞ —Å–∏—Å—Ç–µ–º–∞ –º–∏–Ω–∏–º–∞–ª—å–Ω—ã—Ö/–º–∞–∫—Å–∏–º–∞–ª—å–Ω—ã—Ö –æ—Å—Ç–∞—Ç–∫–æ–≤ (Google –¢–∞–±–ª–∏—Ü–∞)

**–ó–∞–¥–∞—á–∞:** –ü–µ—Ä–µ–ø–∏—Å–∞—Ç—å —Å–∏—Å—Ç–µ–º—É –º–∏–Ω/–º–∞–∫—Å –æ—Å—Ç–∞—Ç–∫–æ–≤. –ò—Å—Ç–æ—á–Ω–∏–∫ –∏—Å—Ç–∏–Ω—ã ‚Äî Google –¢–∞–±–ª–∏—Ü–∞ —Å–æ —Å—Ç–æ–ª–±—Ü–∞–º–∏ –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –ø–æ–¥—Ä–∞–∑–¥–µ–ª–µ–Ω–∏—è.

**–ù–æ–≤–∞—è –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞:**
- Google –¢–∞–±–ª–∏—Ü–∞ ‚Äî –µ–¥–∏–Ω—ã–π –∏—Å—Ç–æ—á–Ω–∏–∫ –º–∏–Ω/–º–∞–∫—Å —É—Ä–æ–≤–Ω–µ–π
- –§–æ—Ä–º–∞—Ç: —Å—Ç—Ä–æ–∫–∞ 1 = dept UUID (–º–µ—Ç–∞), —Å—Ç—Ä–æ–∫–∞ 2 = –∑–∞–≥–æ–ª–æ–≤–∫–∏, —Å—Ç—Ä–æ–∫–∞ 3+ = —Ç–æ–≤–∞—Ä—ã
- –ö–∞–∂–¥—ã–π department = 2 —Å—Ç–æ–ª–±—Ü–∞ (–º–∏–Ω, –º–∞–∫—Å)
- –ë–î (min_stock_level) = –∑–µ—Ä–∫–∞–ª–æ Google –¢–∞–±–ª–∏—Ü—ã

**–£–¥–∞–ª–µ–Ω–æ:** `update_product()` –∏–∑ iiko_api.py, `check_tomato.py`, `test_iiko_update.py`, –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç—å –æ—Ç storeBalanceLevels.

**–ò–∑–º–µ–Ω–µ–Ω–æ:** `adapters/google_sheets.py`, `use_cases/sync_min_stock.py`, `use_cases/edit_min_stock.py`, `use_cases/check_min_stock.py`, `bot/handlers.py`, `bot/min_stock_handlers.py`, `config.py`.

---

### 2026-02-10 ‚Äî –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –º–∏–Ω–∏–º–∞–ª—å–Ω—ã—Ö –æ—Å—Ç–∞—Ç–∫–æ–≤ —á–µ—Ä–µ–∑ –±–æ—Ç–∞

**–§–ª–æ—É:** –û—Ç—á—ë—Ç—ã ‚Üí ‚úèÔ∏è –ò–∑–º–µ–Ω–∏—Ç—å ‚Üí –ø–æ–∏—Å–∫ —Ç–æ–≤–∞—Ä–∞ ‚Üí –≤—ã–±–æ—Ä ‚Üí –≤—ã–±–æ—Ä —Å–∫–ª–∞–¥–∞ ‚Üí –≤–≤–æ–¥ –Ω–æ–≤–æ–≥–æ –º–∏–Ω ‚Üí iiko API + –ë–î.

**–ù–æ–≤—ã–µ —Ñ–∞–π–ª—ã:** `use_cases/edit_min_stock.py`, `bot/min_stock_handlers.py`.
**–ò–∑–º–µ–Ω–µ–Ω–æ:** `adapters/iiko_api.py` (update_product), `bot/handlers.py`, `main.py`.

---

### 2026-02-10 ‚Äî –ü—Ä–æ–≤–µ—Ä–∫–∞ –º–∏–Ω–∏–º–∞–ª—å–Ω—ã—Ö –æ—Å—Ç–∞—Ç–∫–æ–≤ –ø–æ –ø–æ–¥—Ä–∞–∑–¥–µ–ª–µ–Ω–∏—è–º

**–ó–∞–¥–∞—á–∞:** –°–æ–æ–±—â–µ–Ω–∏–µ –æ —Ç–æ–≤–∞—Ä–∞—Ö –Ω–∏–∂–µ –º–∏–Ω. –æ—Å—Ç–∞—Ç–∫–æ–≤ –¥–ª—è —Ä–µ—Å—Ç–æ—Ä–∞–Ω–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è.

**–†–µ—à–µ–Ω–∏–µ (v2):** storeBalanceLevels –∏–∑ raw_json, —Å—É–º–º–∏—Ä–æ–≤–∞–Ω–∏–µ –ø–æ –≤—Å–µ–º —Å–∫–ª–∞–¥–∞–º dept, MAX(min) –ø—Ä–∏ –¥–µ–¥—É–ø–ª–∏–∫–∞—Ü–∏–∏.

**–ù–æ–≤—ã–π —Ñ–∞–π–ª:** `use_cases/check_min_stock.py`.
**–ò–∑–º–µ–Ω–µ–Ω–æ:** `bot/handlers.py` (btn_check_min_stock).

---

### 2026-02-10 ‚Äî –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ: –º–∏–Ω. –æ—Å—Ç–∞—Ç–∫–∏ –Ω–µ –Ω–∞—Ö–æ–¥–∏–ª–∏—Å—å –¥–ª—è –Ω–æ–≤–æ–≥–æ —Ä–µ—Å—Ç–æ—Ä–∞–Ω–∞

**–ü—Ä–æ–±–ª–µ–º–∞:** `btn_check_min_stock` –Ω–µ –≤—ã–∑—ã–≤–∞–ª `sync_products()` ‚Äî storeBalanceLevels –≤ raw_json —É—Å—Ç–∞—Ä–µ–≤—à–∏–µ.
**–†–µ—à–µ–Ω–∏–µ:** –î–æ–±–∞–≤–ª–µ–Ω `sync_products()` –ø–µ—Ä–µ–¥ `sync_stock_balances()`.

---

### 2026-02-10 ‚Äî –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è –æ—Å—Ç–∞—Ç–∫–æ–≤ –ø–æ —Å–∫–ª–∞–¥–∞–º (sync_stock_balances)

**–ü–∞—Ç—Ç–µ—Ä–Ω:** Full-replace (DELETE + batch INSERT) –≤ –æ–¥–Ω–æ–π —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏.
**–ù–æ–≤—ã–π —Ñ–∞–π–ª:** `use_cases/sync_stock_balances.py`.
**–ò–∑–º–µ–Ω–µ–Ω–æ:** `adapters/iiko_api.py` (fetch_stock_balances), `db/models.py` (StockBalance).

---

### 2026-02-09 ‚Äî –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Ç–æ—á–Ω–æ—Å—Ç–∏ sync_stock_balances (timestamp)

**–ü—Ä–æ–±–ª–µ–º–∞:** timestamp –±–µ–∑ –≤—Ä–µ–º–µ–Ω–∏ ‚Üí iiko –æ—Ç–¥–∞–≤–∞–ª –æ—Å—Ç–∞—Ç–∫–∏ –Ω–∞ –Ω–∞—á–∞–ª–æ –¥–Ω—è.
**–†–µ—à–µ–Ω–∏–µ:** `datetime.now().strftime("%Y-%m-%dT%H:%M:%S")` –≤–º–µ—Å—Ç–æ `date.today().isoformat()`.
**–ò–∑–º–µ–Ω–µ–Ω–æ:** `adapters/iiko_api.py`, `use_cases/sync_stock_balances.py`.

---

### 2026-02-09 ‚Äî –ü–æ–ª–Ω–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –≤—Å–µ—Ö –¥–µ–π—Å—Ç–≤–∏–π

**–ü—Ä–æ–±–ª–µ–º–∞:** 94% —Ö—ç–Ω–¥–ª–µ—Ä–æ–≤ (62 –∏–∑ 68) –Ω–µ –∏–º–µ–ª–∏ entry-–ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è.
**–†–µ—à–µ–Ω–∏–µ:** –ï–¥–∏–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç `[module] –¥–µ–π—Å—Ç–≤–∏–µ tg:USER_ID, params`.
**–ò–∑–º–µ–Ω–µ–Ω–æ:** `handlers.py` (+25 –ª–æ–≥–æ–≤), `writeoff_handlers.py` (+23), `admin_handlers.py` (+10).

---

### 2026-02-09 ‚Äî –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è —Å–∫–æ—Ä–æ—Å—Ç–∏ —Å–æ–∑–¥–∞–Ω–∏—è –∞–∫—Ç–∞ —Å–ø–∏—Å–∞–Ω–∏—è

**–†–µ—à–µ–Ω–∏–µ:** asyncio.gather –¥–ª—è start_writeoff, batch-resolve –µ–¥–∏–Ω–∏—Ü, pre-warm admin_ids.
**–ò–∑–º–µ–Ω–µ–Ω–æ:** `writeoff.py`, `writeoff_handlers.py`.

---

### 2026-02-09 ‚Äî –ö–æ–º–ø–ª–µ–∫—Å–Ω–∞—è –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏

**–û–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏:** user_context 1 JOIN (‚àí800–º—Å), btn_check_min_stock asyncio.gather (‚àí3-5 —Å–µ–∫), check_min_stock asyncio.gather (‚àí400–º—Å), sync_stock_balances –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω—ã–π API+DB (‚àí300-500–º—Å).

---

### 2026-02-09 ‚Äî –§–æ–Ω–æ–≤–∞—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è –ø—Ä–∏ –æ—Ç–∫—Ä—ã—Ç–∏–∏ ¬´–î–æ–∫—É–º–µ–Ω—Ç—ã¬ª

**–†–µ—à–µ–Ω–∏–µ:** `asyncio.create_task` + `asyncio.gather(sync_products, sync_all_entities)` ‚Äî –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –∂–¥—ë—Ç.
**–ò–∑–º–µ–Ω–µ–Ω–æ:** `handlers.py` (btn_documents_menu, _bg_sync_for_documents).

---

### 2026-02-09 ‚Äî –ê–≤—Ç–æ-–≤—ã–±–æ—Ä —Å–∫–ª–∞–¥–∞ –ø–æ –¥–æ–ª–∂–Ω–æ—Å—Ç–∏ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –∞–∫—Ç–∞ —Å–ø–∏—Å–∞–Ω–∏—è

**–õ–æ–≥–∏–∫–∞:** –ë–æ—Ç-–∞–¥–º–∏–Ω ‚Üí —Ä—É—á–Ω–æ–π, –ë–∞—Ä ‚Üí –∞–≤—Ç–æ-–±–∞—Ä, –ö—É—Ö–Ω—è ‚Üí –∞–≤—Ç–æ-–∫—É—Ö–Ω—è, –ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ ‚Üí —Ä—É—á–Ω–æ–π.
**–ò–∑–º–µ–Ω–µ–Ω–æ:** `user_context.py` (role_name), `auth.py`, `writeoff.py`, `writeoff_handlers.py`.

---

### 2026-02-09 ‚Äî –ê—É–¥–∏—Ç –∏ —á–∏—Å—Ç–∫–∞ –∫–æ–¥–æ–≤–æ–π –±–∞–∑—ã

–£–¥–∞–ª–µ–Ω—ã: `f.json`, `FinTablo-v1-swagger (1).yaml`, `__pycache__/`.
–û—á–∏—â–µ–Ω—ã –Ω–µ–∏—Å–ø–æ–ª—å–∑—É–µ–º—ã–µ –∏–º–ø–æ—Ä—Ç—ã (9 —Ñ–∞–π–ª–æ–≤).
–ò—Å–ø—Ä–∞–≤–ª–µ–Ω—ã: writeoff_handlers.py _sending_lock, iiko_auth.py unreachable raise.

---

### 2026-02-08 ‚Äî Mirror-sync (–∑–µ—Ä–∫–∞–ª—å–Ω–∞—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è)

**–ü—Ä–æ–±–ª–µ–º–∞:** –£–¥–∞–ª—ë–Ω–Ω—ã–µ –≤ iiko/FinTablo –æ–±—ä–µ–∫—Ç—ã –æ—Å—Ç–∞–≤–∞–ª–∏—Å—å –≤ –ë–î.
**–†–µ—à–µ–Ω–∏–µ:** `_mirror_delete()` –ø–æ—Å–ª–µ –∫–∞–∂–¥–æ–≥–æ UPSERT. –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å: 0 –∑–∞–ø–∏—Å–µ–π ‚Üí skip.
**–ò–∑–º–µ–Ω–µ–Ω–æ:** `sync.py`, `sync_fintablo.py`. –ó–∞—Ç—Ä–æ–Ω—É—Ç—ã –≤—Å–µ 22 —Ç–∞–±–ª–∏—Ü—ã.

---

### 2026-02-08 ‚Äî –†–µ—Å—Ç—Ä—É–∫—Ç—É—Ä–∏–∑–∞—Ü–∏—è –º–µ–Ω—é –±–æ—Ç–∞

–ì–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é: üè† –°–º–µ–Ω–∏—Ç—å —Ä–µ—Å—Ç–æ—Ä–∞–Ω | üìÇ –ö–æ–º–∞–Ω–¥—ã | üìä –û—Ç—á—ë—Ç—ã | üìÑ –î–æ–∫—É–º–µ–Ω—Ç—ã.
**–ò–∑–º–µ–Ω–µ–Ω–æ:** `handlers.py`.

---

### 2026-02-08 ‚Äî In-memory –∫–µ—à –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (UserContext)

**–ü—Ä–æ–±–ª–µ–º–∞:** +400–º—Å –Ω–∞ –∫–∞–∂–¥—ã–π –∑–∞–ø—Ä–æ—Å department_id.
**–†–µ—à–µ–Ω–∏–µ:** dict –≤ RAM, –ª–µ–Ω–∏–≤–∞—è –∑–∞–≥—Ä—É–∑–∫–∞, –∏–Ω–≤–∞–ª–∏–¥–∞—Ü–∏—è –ø—Ä–∏ —Å–º–µ–Ω–µ —Ä–µ—Å—Ç–æ—Ä–∞–Ω–∞.
**–ù–æ–≤—ã–π —Ñ–∞–π–ª:** `use_cases/user_context.py`.
**–ò–∑–º–µ–Ω–µ–Ω–æ:** `handlers.py`, `auth.py`.
