# ‚úÖ –ò—Å—Ç–æ—Ä–∏—è –∏–∑–º–µ–Ω–µ–Ω–∏–π (Changelog)

> –ß–∏—Ç–∞–π —ç—Ç–æ—Ç —Ñ–∞–π–ª –ø—Ä–∏: –ø–æ–Ω–∏–º–∞–Ω–∏–µ –∏—Å—Ç–æ—Ä–∏–∏ —Ä–µ—à–µ–Ω–∏–π, –ø—Ä–æ–≤–µ—Ä–∫–∞ —á—Ç–æ —É–∂–µ –±—ã–ª–æ —Å–¥–µ–ª–∞–Ω–æ, –∫–æ–Ω—Ç–µ–∫—Å—Ç –ø—Ä–æ—à–ª—ã—Ö –±–∞–≥–æ–≤.

---

### 2026-02-14 ‚Äî –°—Ç–æ–ø-–ª–∏—Å—Ç iikoCloud + –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ ORG_ID

**–¶–µ–ª—å:** –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å—Ç–æ–ø-–ª–∏—Å—Ç–∞ –∏–∑ iikoCloud ‚Äî –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ —Ç–æ–≤–∞—Ä–æ–≤ –≤ —Å—Ç–æ–ø–µ, –∑–∞–∫—Ä–µ–ø–ª—ë–Ω–Ω—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è, –µ–∂–µ–≤–µ—á–µ—Ä–Ω–∏–π –æ—Ç—á—ë—Ç, –≤–µ–±—Ö—É–∫-–æ–±—Ä–∞–±–æ—Ç–∫–∞. –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –±–∞–≥–∞ —Å –ø—É—Å—Ç—ã–º —Å—Ç–æ–ø-–ª–∏—Å—Ç–æ–º.

**1. –°—Ç–æ–ø-–ª–∏—Å—Ç: –±–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫–∞**
- –ù–æ–≤—ã–π —Ñ–∞–π–ª: `use_cases/stoplist.py`
  - `fetch_stoplist_items()` ‚Äî –∑–∞–ø—Ä–æ—Å —Å—Ç–æ–ø-–ª–∏—Å—Ç–∞ –∏–∑ iikoCloud (terminal groups ‚Üí stop_lists)
  - `diff_and_update(items)` ‚Äî —Å—Ä–∞–≤–Ω–µ–Ω–∏–µ —Å –ë–î (active_stoplist), –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ, –∑–∞–ø–∏—Å—å –∏—Å—Ç–æ—Ä–∏–∏
  - `_enrich_names(items)` ‚Äî –ø–æ–¥—Ç—è–≥–∏–≤–∞–Ω–∏–µ –Ω–∞–∑–≤–∞–Ω–∏–π –∏–∑ `iiko_product`
  - StoplistHistory: –∑–∞–ø–∏—Å—å started_at/ended_at –ø—Ä–∏ –≤—Ö–æ–¥–µ/–≤—ã—Ö–æ–¥–µ —Ç–æ–≤–∞—Ä–∞ –∏–∑ —Å—Ç–æ–ø–∞

**2. –ó–∞–∫—Ä–µ–ø–ª—ë–Ω–Ω—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è**
- –ù–æ–≤—ã–π —Ñ–∞–π–ª: `use_cases/pinned_stoplist_message.py`
  - `send_stoplist_for_user(bot, chat_id)` ‚Äî —Å–æ–∑–¥–∞–Ω–∏–µ/–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ pinned msg —Å–æ —Å—Ç–æ–ø-–ª–∏—Å—Ç–æ–º
  - `update_all_stoplist_messages(bot)` ‚Äî –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ —É –≤—Å–µ—Ö –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
  - snapshot_hash –¥–ª—è –¥–µ–¥—É–ø–ª–∏–∫–∞—Ü–∏–∏ (–Ω–µ –æ–±–Ω–æ–≤–ª—è—Ç—å –µ—Å–ª–∏ –¥–∞–Ω–Ω—ã–µ –Ω–µ –∏–∑–º–µ–Ω–∏–ª–∏—Å—å)

**3. –ï–∂–µ–≤–µ—á–µ—Ä–Ω–∏–π –æ—Ç—á—ë—Ç**
- –ù–æ–≤—ã–π —Ñ–∞–π–ª: `use_cases/stoplist_report.py`
  - `send_daily_stoplist_report(bot)` ‚Äî –æ—Ç—á—ë—Ç –∑–∞ –¥–µ–Ω—å (22:00) –≤—Å–µ–º –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω–Ω—ã–º
  - –°—É–º–º–∞—Ä–Ω–æ–µ –≤—Ä–µ–º—è –≤ —Å—Ç–æ–ø–µ –ø–æ –∫–∞–∂–¥–æ–º—É —Ç–æ–≤–∞—Ä—É –∑–∞ –¥–µ–Ω—å

**4. –í–µ–±—Ö—É–∫ StopListUpdate**
- `use_cases/iiko_webhook_handler.py`: –æ–±—Ä–∞–±–æ—Ç–∫–∞ —Å–æ–±—ã—Ç–∏—è StopListUpdate
- `adapters/iiko_cloud_api.py`: –¥–æ–±–∞–≤–ª–µ–Ω —Ñ–∏–ª—å—Ç—Ä `stopListUpdateFilter` –ø—Ä–∏ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ –≤–µ–±—Ö—É–∫–∞
- `adapters/iiko_cloud_api.py`: `fetch_terminal_groups()`, `fetch_stop_lists()` ‚Äî –Ω–æ–≤—ã–µ –º–µ—Ç–æ–¥—ã

**5. –ü–ª–∞–Ω–∏—Ä–æ–≤—â–∏–∫**
- `use_cases/scheduler.py`: –¥–æ–±–∞–≤–ª–µ–Ω–∞ –∑–∞–¥–∞—á–∞ `_daily_stoplist_report` –Ω–∞ 22:00

**6. –ë–î (3 –Ω–æ–≤—ã–µ —Ç–∞–±–ª–∏—Ü—ã)**
- `active_stoplist` ‚Äî —Ç–µ–∫—É—â–∏–π —Å—Ç–æ–ø-–ª–∏—Å—Ç (–∑–µ—Ä–∫–∞–ª–æ iikoCloud)
- `stoplist_message` ‚Äî –∑–∞–∫—Ä–µ–ø–ª—ë–Ω–Ω—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è (chat_id, message_id, snapshot_hash)
- `stoplist_history` ‚Äî –∏—Å—Ç–æ—Ä–∏—è –≤—Ö–æ–¥–∞/–≤—ã—Ö–æ–¥–∞ –∏–∑ —Å—Ç–æ–ø–∞ (–¥–ª—è –µ–∂–µ–≤–µ—á–µ—Ä–Ω–µ–≥–æ –æ—Ç—á—ë—Ç–∞)
- `db/init_db.py`: 9 –Ω–æ–≤—ã—Ö –∏–Ω–¥–µ–∫—Å–æ–≤

**7. –ë–∞–≥—Ñ–∏–∫—Å: —Å—Ç–æ–ø-–ª–∏—Å—Ç –ø—É—Å—Ç (ORG_ID)**
- **–°–∏–º–ø—Ç–æ–º:** ¬´–°—Ç–æ–ø-–ª–∏—Å—Ç –ø—É—Å—Ç¬ª –Ω–µ—Å–º–æ—Ç—Ä—è –Ω–∞ –Ω–∞–ª–∏—á–∏–µ –ø–æ–∑–∏—Ü–∏–π –≤ iiko
- **–ü—Ä–∏—á–∏–Ω–∞:** Railway env —Å–æ–¥–µ—Ä–∂–∏—Ç `ORG_ID` (–∏–∑ —Å—Ç–∞—Ä–æ–≥–æ —Å–∫—Ä–∏–ø—Ç–∞), –Ω–æ –±–æ—Ç —á–∏—Ç–∞–ª `IIKO_CLOUD_ORG_ID`
- **–†–µ—à–µ–Ω–∏–µ:** `config.py` ‚Äî fallback: `os.getenv("IIKO_CLOUD_ORG_ID") or os.getenv("ORG_ID")`

**8. –û—á–∏—Å—Ç–∫–∞**
- –£–¥–∞–ª–µ–Ω—ã —É—Å—Ç–∞—Ä–µ–≤—à–∏–µ —Ñ–∞–π–ª—ã: `main-stoplist.py`, `daily_report-stoplist.py` (—Å—Ç–∞—Ä—ã–µ standalone-—Å–∫—Ä–∏–ø—Ç—ã)
- –£–¥–∞–ª–µ–Ω–∞ –≤—Ä–µ–º–µ–Ω–Ω–∞—è –¥–∏–∞–≥–Ω–æ—Å—Ç–∏—á–µ—Å–∫–∞—è –∫–Ω–æ–ø–∫–∞ ¬´üîç –¢–µ—Å—Ç —Å—Ç–æ–ø-–ª–∏—Å—Ç–∞¬ª

---

### 2026-02-14 ‚Äî iikoCloud –≤–µ–±—Ö—É–∫–∏ + –∞–≤—Ç–æ–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –æ—Å—Ç–∞—Ç–∫–æ–≤

**–¶–µ–ª—å:** –û–ø–µ—Ä–∞—Ç–∏–≤–Ω–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –æ—Å—Ç–∞—Ç–∫–æ–≤ –Ω–∏–∂–µ –º–∏–Ω–∏–º—É–º–∞ ‚Äî –Ω–µ –ø–æ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏—é, –∞ –ø–æ —Å–æ–±—ã—Ç–∏—è–º (–∑–∞–∫—Ä—ã—Ç–∏–µ –∑–∞–∫–∞–∑–æ–≤ –≤ iiko). –ó–∞–∫—Ä–µ–ø–ª—ë–Ω–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ —Å –æ—Å—Ç–∞—Ç–∫–∞–º–∏ –≤ –ª–∏—á–∫–µ –∫–∞–∂–¥–æ–≥–æ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω–Ω–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è.

**1. –ê–¥–∞–ø—Ç–µ—Ä iikoCloud API**
- –ù–æ–≤—ã–π —Ñ–∞–π–ª: `adapters/iiko_cloud_api.py`
  - –¢–æ–∫–µ–Ω —á–∏—Ç–∞–µ—Ç—Å—è –∏–∑ —Ç–∞–±–ª–∏—Ü—ã `iiko_access_tokens` (–≤–Ω–µ—à–Ω–∏–π cron –æ–±–Ω–æ–≤–ª—è–µ—Ç –∫–∞–∂–¥—ã–µ 5 –º–∏–Ω)
  - `get_organizations()` ‚Äî –ø–æ–ª—É—á–∏—Ç—å Organization ID
  - `register_webhook()` ‚Äî —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –≤–µ–±—Ö—É–∫–∞ —Å —Ñ–∏–ª—å—Ç—Ä–æ–º –Ω–∞ Closed –∑–∞–∫–∞–∑—ã (delivery + table)
  - `get_webhook_settings()` ‚Äî —Ç–µ–∫—É—â–∏–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –≤–µ–±—Ö—É–∫–∞
  - `verify_webhook_auth()` ‚Äî –≤–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏—è –≤—Ö–æ–¥—è—â–∏—Ö –≤–µ–±—Ö—É–∫–æ–≤

**2. –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –≤–µ–±—Ö—É–∫–æ–≤**
- –ù–æ–≤—ã–π —Ñ–∞–π–ª: `use_cases/iiko_webhook_handler.py`
  - In-memory —Å—á—ë—Ç—á–∏–∫ –∑–∞–∫—Ä—ã—Ç—ã—Ö –∑–∞–∫–∞–∑–æ–≤
  - –ö–∞–∂–¥—ã–µ N –∑–∞–∫–∞–∑–æ–≤ (env: `STOCK_CHECK_ORDER_INTERVAL`, –¥–µ—Ñ–æ–ª—Ç 5):
    - `sync_stock_balances()` ‚Üí `check_min_stock_levels()` ‚Üí –¥–µ–ª—å—Ç–∞-—Å—Ä–∞–≤–Ω–µ–Ω–∏–µ
    - –ï—Å–ª–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–µ > –ø–æ—Ä–æ–≥–∞ (env: `STOCK_CHANGE_THRESHOLD_PCT`, –¥–µ—Ñ–æ–ª—Ç 5%) ‚Üí –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å–æ–æ–±—â–µ–Ω–∏–π
  - `force_stock_check()` ‚Äî –ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ (–∏–≥–Ω–æ—Ä–∏—Ä—É–µ—Ç —Å—á—ë—Ç—á–∏–∫ –∏ –ø–æ—Ä–æ–≥)

**3. –ó–∞–∫—Ä–µ–ø–ª—ë–Ω–Ω—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è —Å –æ—Å—Ç–∞—Ç–∫–∞–º–∏**
- –ù–æ–≤—ã–π —Ñ–∞–π–ª: `use_cases/pinned_stock_message.py`
  - –î–ª—è –∫–∞–∂–¥–æ–≥–æ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω–Ω–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è ‚Äî –æ–¥–Ω–æ —Å–æ–æ–±—â–µ–Ω–∏–µ –≤ –ª–∏—á–∫–µ
  - edit_message_text –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ (–Ω–µ –Ω–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ)
  - pin_chat_message –ø—Ä–∏ –ø–µ—Ä–≤–æ–º —Å–æ–∑–¥–∞–Ω–∏–∏
  - snapshot_hash –¥–ª—è –¥–µ–¥—É–ø–ª–∏–∫–∞—Ü–∏–∏ (–Ω–µ –æ–±–Ω–æ–≤–ª—è—Ç—å –µ—Å–ª–∏ –Ω–∏—á–µ–≥–æ –Ω–µ –∏–∑–º–µ–Ω–∏–ª–æ—Å—å)

**4. HTTP-—ç–Ω–¥–ø–æ–∏–Ω—Ç `/iiko-webhook`**
- `main.py`: –¥–æ–±–∞–≤–ª–µ–Ω POST `/iiko-webhook` (aiohttp, —Ç–æ–ª—å–∫–æ –≤ webhook-—Ä–µ–∂–∏–º–µ)
  - –í–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏—è authToken
  - –ë—ã—Å—Ç—Ä—ã–π 200 –æ—Ç–≤–µ—Ç + —Ñ–æ–Ω–æ–≤–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ —á–µ—Ä–µ–∑ asyncio.create_task

**5. –ê–¥–º–∏–Ω-–∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å**
- `bot/handlers.py`: –Ω–æ–≤–æ–µ –ø–æ–¥–º–µ–Ω—é ¬´‚òÅÔ∏è iikoCloud –≤–µ–±—Ö—É–∫¬ª –≤ –ù–∞—Å—Ç—Ä–æ–π–∫–∞—Ö
  - üìã –ü–æ–ª—É—á–∏—Ç—å –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏–∏ ‚Äî –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å Organization ID
  - üîó –ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å –≤–µ–±—Ö—É–∫ ‚Äî –æ—Ç–ø—Ä–∞–≤–∏—Ç—å –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –≤ iikoCloud
  - ‚ÑπÔ∏è –°—Ç–∞—Ç—É—Å –≤–µ–±—Ö—É–∫–∞ ‚Äî —Ç–µ–∫—É—â–∏–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏
  - üîÑ –û–±–Ω–æ–≤–∏—Ç—å –æ—Å—Ç–∞—Ç–∫–∏ —Å–µ–π—á–∞—Å ‚Äî –ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ + —Ä–∞—Å—Å—ã–ª–∫–∞

**6. –ë–î**
- –ù–æ–≤–∞—è —Ç–∞–±–ª–∏—Ü–∞: `stock_alert_message` (chat_id, message_id, snapshot_hash, updated_at)
- –ú–∏–≥—Ä–∞—Ü–∏—è –≤ `init_db.py`: –∏–Ω–¥–µ–∫—Å –Ω–∞ chat_id

**7. –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è (–Ω–æ–≤—ã–µ env)**
- `IIKO_CLOUD_ORG_ID` ‚Äî UUID –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏–∏ –≤ iikoCloud
- `IIKO_CLOUD_BASE_URL` ‚Äî –±–∞–∑–æ–≤—ã–π URL (–¥–µ—Ñ–æ–ª—Ç `https://api-ru.iiko.services`)
- `STOCK_CHECK_ORDER_INTERVAL` ‚Äî –∫–∞–∂–¥—ã–µ N –∑–∞–∫–∞–∑–æ–≤ –ø—Ä–æ–≤–µ—Ä—è—Ç—å (–¥–µ—Ñ–æ–ª—Ç 5)
- `STOCK_CHANGE_THRESHOLD_PCT` ‚Äî –ø–æ—Ä–æ–≥ –∏–∑–º–µ–Ω–µ–Ω–∏—è –≤ % (–¥–µ—Ñ–æ–ª—Ç 5.0)
- `IIKO_CLOUD_WEBHOOK_SECRET` ‚Äî authToken –¥–ª—è –≤–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏–∏ –≤—Ö–æ–¥—è—â–∏—Ö –≤–µ–±—Ö—É–∫–æ–≤

---

### 2026-02-13 ‚Äî –ö–∞–ª–∏–Ω–∏–Ω–≥—Ä–∞–¥—Å–∫–æ–µ –≤—Ä–µ–º—è + –ï–∂–µ–¥–Ω–µ–≤–Ω–∞—è –∞–≤—Ç–æ—Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è

**–¶–µ–ª—å:** –í—Å–µ –¥–∞—Ç—ã –∏ –≤—Ä–µ–º—è –≤ –ø—Ä–æ–µ–∫—Ç–µ ‚Äî –ø–æ –ö–∞–ª–∏–Ω–∏–Ω–≥—Ä–∞–¥—É (Europe/Kaliningrad, UTC+2). –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –ø–æ–ª–Ω–∞—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è –∫–∞–∂–¥—ã–π –¥–µ–Ω—å –≤ 07:00.

**1. –ß–∞—Å–æ–≤–æ–π –ø–æ—è—Å Europe/Kaliningrad (UTC+2)**
- `use_cases/_helpers.py`: –¥–æ–±–∞–≤–ª–µ–Ω `now_kgd()` ‚Äî –µ–¥–∏–Ω—ã–π —Ö–µ–ª–ø–µ—Ä, –≤–æ–∑–≤—Ä–∞—â–∞—é—â–∏–π naive datetime –ø–æ –ö–∞–ª–∏–Ω–∏–Ω–≥—Ä–∞–¥—É. `utcnow()` –æ—Å—Ç–∞–≤–ª–µ–Ω –∫–∞–∫ deprecated alias.
- `db/models.py`, `db/ft_models.py`: `_utcnow()` —Ç–µ–ø–µ—Ä—å –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç –∫–∞–ª–∏–Ω–∏–Ω–≥—Ä–∞–¥—Å–∫–æ–µ –≤—Ä–µ–º—è (—á–µ—Ä–µ–∑ `ZoneInfo`).
- `config.py`: –¥–æ–±–∞–≤–ª–µ–Ω–∞ –∫–æ–Ω—Å—Ç–∞–Ω—Ç–∞ `TIMEZONE = "Europe/Kaliningrad"`.
- –ó–∞–º–µ–Ω–µ–Ω—ã –≤—Å–µ `datetime.utcnow()` –∏ `datetime.now()` –Ω–∞ `now_kgd()` –≤:
  - `use_cases/sync_fintablo.py` (started/finished_at, mapping)
  - `use_cases/writeoff.py` (dateIncoming –≤ iiko)
  - `use_cases/pdf_invoice.py` (–¥–∞—Ç–∞ –¥–æ–∫—É–º–µ–Ω—Ç–∞, –∏–º—è —Ñ–∞–π–ª–∞)
  - `use_cases/product_request.py` (approve/cancel timestamps)
  - `use_cases/outgoing_invoice.py` (dateIncoming, —Ä–∞—Å—á—ë—Ç —Å–µ–±–µ—Å—Ç–æ–∏–º–æ—Å—Ç–∏, —Ç–µ—Ö–∫–∞—Ä—Ç—ã)
  - `adapters/iiko_api.py` (timestamp –¥–ª—è –æ—Å—Ç–∞—Ç–∫–æ–≤)
- –í—Å–µ –∑–∞–ø–∏—Å–∏ –≤ –ë–î (SyncLog, synced_at, created_at –∏ —Ç.–¥.) —Ç–µ–ø–µ—Ä—å –≤ –∫–∞–ª–∏–Ω–∏–Ω–≥—Ä–∞–¥—Å–∫–æ–º –≤—Ä–µ–º–µ–Ω–∏.
- PDF-–¥–æ–∫—É–º–µ–Ω—Ç—ã (–Ω–∞–∫–ª–∞–¥–Ω—ã–µ, –∑–∞—è–≤–∫–∏) ‚Äî –¥–∞—Ç–∞ –ø–æ –ö–∞–ª–∏–Ω–∏–Ω–≥—Ä–∞–¥—É.
- iiko API –∑–∞–ø—Ä–æ—Å—ã (–æ—Å—Ç–∞—Ç–∫–∏, —Å–ø–∏—Å–∞–Ω–∏—è, –Ω–∞–∫–ª–∞–¥–Ω—ã–µ) ‚Äî –∫–∞–ª–∏–Ω–∏–Ω–≥—Ä–∞–¥—Å–∫–∏–π timestamp.

**2. –ï–∂–µ–¥–Ω–µ–≤–Ω–∞—è –∞–≤—Ç–æ—Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è (APScheduler)**
- –ù–æ–≤—ã–π —Ñ–∞–π–ª: `use_cases/scheduler.py`
  - `_daily_full_sync()`: iiko + FinTablo + –æ—Å—Ç–∞—Ç–∫–∏ + min/max –∏–∑ GSheet ‚Äî –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ.
  - `start_scheduler(bot)` / `stop_scheduler()` ‚Äî —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∂–∏–∑–Ω–µ–Ω–Ω—ã–º —Ü–∏–∫–ª–æ–º.
  - CronTrigger: 07:00 Europe/Kaliningrad, misfire_grace_time=3600—Å.
  - –ü–æ—Å–ª–µ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏ ‚Äî —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –≤—Å–µ—Ö –∞–¥–º–∏–Ω–æ–≤ –≤ Telegram —Å –æ—Ç—á—ë—Ç–æ–º.
- `main.py`: scheduler –∑–∞–ø—É—Å–∫–∞–µ—Ç—Å—è –≤ –æ–±–æ–∏—Ö —Ä–µ–∂–∏–º–∞—Ö (webhook + polling), –æ—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç—Å—è –ø—Ä–∏ shutdown.
- `requirements.txt`: –¥–æ–±–∞–≤–ª–µ–Ω `apscheduler>=3.10.0`.

**–ó–∞—Ç—Ä–æ–Ω—É—Ç—ã–µ —Ñ–∞–π–ª—ã:**
- `config.py`, `use_cases/_helpers.py`, `db/models.py`, `db/ft_models.py`
- `use_cases/sync_fintablo.py`, `use_cases/writeoff.py`, `use_cases/pdf_invoice.py`
- `use_cases/product_request.py`, `use_cases/outgoing_invoice.py`
- `adapters/iiko_api.py`, `main.py`, `requirements.txt`
- –ù–æ–≤—ã–π: `use_cases/scheduler.py`
- –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è: `PROJECT_MAP.md`, `docs/FILE_STRUCTURE.md`, `docs/CHANGELOG.md`

---

### 2026-02-15 ‚Äî Security Hardening: –∞—É–¥–∏—Ç –∏ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —É—è–∑–≤–∏–º–æ—Å—Ç–µ–π

**–¶–µ–ª—å:** –ü–æ–ª–Ω—ã–π –∞—É–¥–∏—Ç –ø—Ä–æ–µ–∫—Ç–∞ –ø–æ PROJECT_MAP.md (—Ä–∞–∑–¥–µ–ª 7‚Äì8: –í–∞–ª–∏–¥–∞—Ü–∏—è –≤—Ö–æ–¥–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö, –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å).
–ù–∞–π–¥–µ–Ω—ã –∏ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω—ã —É—è–∑–≤–∏–º–æ—Å—Ç–∏ –≤–æ –≤—Å–µ—Ö handler-—Ñ–∞–π–ª–∞—Ö.

**1. –í–∞–ª–∏–¥–∞—Ü–∏—è callback_data** (`bot/writeoff_handlers.py`, `bot/handlers.py`, `bot/min_stock_handlers.py`)
- –î–æ–±–∞–≤–ª–µ–Ω—ã —É—Ç–∏–ª–∏—Ç—ã –≤ `bot/middleware.py`: `extract_callback_value()`, `validate_callback_uuid()`, `validate_callback_int()`, `truncate_input()`, –∫–æ–Ω—Å—Ç–∞–Ω—Ç—ã `MAX_TEXT_SEARCH=200`, `MAX_TEXT_REASON=500`, `MAX_TEXT_GENERAL=2000`, `MAX_TEXT_NAME=100`
- **writeoff_handlers.py**: 12+ callback_data UUID/int —Ç–µ–ø–µ—Ä—å –≤–∞–ª–∏–¥–∏—Ä—É—é—Ç—Å—è —á–µ—Ä–µ–∑ `validate_callback_uuid()`/`validate_callback_int()` (store_id, account_id, product_id, page, item_idx –∏ –¥—Ä.)
- **handlers.py**: UUID-–≤–∞–ª–∏–¥–∞—Ü–∏—è –¥–ª—è auth-–∫–æ–ª–±—ç–∫–æ–≤ (`process_choose_employee`, `process_choose_department`, `process_change_department`)
- **min_stock_handlers.py**: UUID-–≤–∞–ª–∏–¥–∞—Ü–∏—è –¥–ª—è `select_product`

**2. –ö–†–ò–¢–ò–ß–ï–°–ö–ò–ï —Ñ–∏–∫—Å—ã: admin permission checks** (`bot/writeoff_handlers.py`)
- `admin_approve`, `admin_reject`, `admin_edit_start` ‚Äî **—Ä–∞–Ω–µ–µ –Ω–µ –ø—Ä–æ–≤–µ—Ä—è–ª–∏ admin-–ø—Ä–∞–≤–∞!** –õ—é–±–æ–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –º–æ–≥ –æ–¥–æ–±—Ä–∏—Ç—å/–æ—Ç–∫–ª–æ–Ω–∏—Ç—å —Å–ø–∏—Å–∞–Ω–∏–µ, –∑–Ω–∞—è callback_data. –î–æ–±–∞–≤–ª–µ–Ω–∞ –ø—Ä–æ–≤–µ—Ä–∫–∞ `admin_uc.is_admin()`.

**3. Sync-–±–ª–æ–∫–∏—Ä–æ–≤–∫–∏ –∫–æ–Ω–∫—É—Ä–µ–Ω—Ç–Ω–æ—Å—Ç–∏** (`bot/handlers.py`)
- –í—Å–µ 14 sync-–æ–±—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤ —Ç–µ–ø–µ—Ä—å –∏—Å–ø–æ–ª—å–∑—É—é—Ç `asyncio.Lock` per entity type —á–µ—Ä–µ–∑ `get_sync_lock()` –≤ `sync_with_progress()`
- –ê–≥—Ä–µ–≥–∞—Ç–æ—Ä—ã (`sync_entities`, `sync_all_iiko`, `ft_sync_all`, `sync_everything`) –ø—Ä–æ–≤–µ—Ä—è—é—Ç `.locked()` –ø–µ—Ä–µ–¥ –∑–∞–ø—É—Å–∫–æ–º

**4. –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ –¥–ª–∏–Ω—ã —Ç–µ–∫—Å—Ç–æ–≤–æ–≥–æ –≤–≤–æ–¥–∞**
- `writeoff_handlers.py`: search_product, admin_search_new_product, hist_edit_add_item_search ‚Üí `truncate_input(query, MAX_TEXT_SEARCH)`
- `handlers.py`: process_last_name ‚Üí `truncate_input(text, MAX_TEXT_NAME)`
- `min_stock_handlers.py`: search_product ‚Üí `truncate_input(query, MAX_TEXT_SEARCH)`
- `invoice_handlers.py`: enter_quantities ‚Üí `raw[:2000]`

**5. logging_config.py** ‚Äî –ò—Å–ø—Ä–∞–≤–ª–µ–Ω FileHandler(mode="w") ‚Üí `RotatingFileHandler(maxBytes=5MB, backupCount=3)` (–∫–∞–∫ –∑–∞—è–≤–ª–µ–Ω–æ –≤ docstring)

**6. SSL-–≤–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏—è iiko** ‚Äî –í–≤–µ–¥–µ–Ω–∞ –ø–µ—Ä–µ–º–µ–Ω–Ω–∞—è `IIKO_VERIFY_SSL` –≤ `config.py`:
- `adapters/iiko_api.py` –∏ `iiko_auth.py` —Ç–µ–ø–µ—Ä—å –∏—Å–ø–æ–ª—å–∑—É—é—Ç –Ω–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º—ã–π –ø–∞—Ä–∞–º–µ—Ç—Ä –≤–º–µ—Å—Ç–æ —Ö–∞—Ä–¥–∫–æ–¥ `verify=False`
- –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é `false` (–æ–±—Ä–∞—Ç–Ω–∞—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å —Å self-signed —Å–µ—Ä—Ç–∞–º–∏ iiko on-premise)
- –ú–æ–∂–Ω–æ –∑–∞–¥–∞—Ç—å `true` –∏–ª–∏ –ø—É—Ç—å –∫ CA-bundle

---

### 2026-02-14 ‚Äî –°–∫—Ä—ã—Ç–∏–µ Reply-–∫–ª–∞–≤–∏–∞—Ç—É—Ä—ã –≤–æ –≤—Ä–µ–º—è dialog-flow'–æ–≤

**–¶–µ–ª—å:** –ü—Ä–∏ –∑–∞–ø–æ–ª–Ω–µ–Ω–∏–∏ –¥–æ–∫—É–º–µ–Ω—Ç–∞ (—Å–ø–∏—Å–∞–Ω–∏–µ, –Ω–∞–∫–ª–∞–¥–Ω–∞—è, –∑–∞—è–≤–∫–∞, —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –º–∏–Ω. –æ—Å—Ç–∞—Ç–∫–∞) Reply-–∫–ª–∞–≤–∏–∞—Ç—É—Ä–∞ –ø–æ–¥–º–µ–Ω—é –¥–æ–ª–∂–Ω–∞ —Å–∫—Ä—ã–≤–∞—Ç—å—Å—è, —á—Ç–æ–±—ã –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –º–æ–≥ —Å–ª—É—á–∞–π–Ω–æ –Ω–∞–∂–∞—Ç—å –Ω–∞–≤–∏–≥–∞—Ü–∏–æ–Ω–Ω—ã–µ –∫–Ω–æ–ø–∫–∏. –í–º–µ—Å—Ç–æ –Ω–µ—ë –æ—Ç–æ–±—Ä–∞–∂–∞–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ –∫–Ω–æ–ø–∫–∞ ¬´‚ùå –û—Ç–º–µ–Ω–∞¬ª.

**1. –•–µ–ª–ø–µ—Ä—ã** (`bot/middleware.py`)
- `CANCEL_KB` ‚Äî `ReplyKeyboardMarkup` —Å –æ–¥–Ω–æ–π –∫–Ω–æ–ø–∫–æ–π ¬´‚ùå –û—Ç–º–µ–Ω–∞¬ª
- `set_cancel_kb(bot, chat_id, state)` ‚Äî –ø—Ä–∏ –í–•–û–î–ï –≤ flow: —É–¥–∞–ª—è–µ—Ç —Å—Ç–∞—Ä–æ–µ Reply-—Å–æ–æ–±—â–µ–Ω–∏–µ –ø–æ–¥–º–µ–Ω—é (`_menu_msg_id`), –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –≤—Ä–µ–º–µ–Ω–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ —Å `CANCEL_KB` (–∏ —É–¥–∞–ª—è–µ—Ç –µ–≥–æ), —á—Ç–æ –º–µ–Ω—è–µ—Ç Reply-–∫–ª–∞–≤–∏–∞—Ç—É—Ä—É –Ω–∞ cancel-only
- `restore_menu_kb(bot, chat_id, state, menu_text, kb)` ‚Äî –ø—Ä–∏ –í–´–•–û–î–ï –∏–∑ flow: –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –Ω–æ–≤–æ–µ Reply-—Å–æ–æ–±—â–µ–Ω–∏–µ —Å –∫–ª–∞–≤–∏–∞—Ç—É—Ä–æ–π –ø–æ–¥–º–µ–Ω—é, —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç `_menu_msg_id`

**2. Keyboard-—Ñ—É–Ω–∫—Ü–∏–∏ –≤—ã–Ω–µ—Å–µ–Ω—ã –≤ `bot/_utils.py`**
- `writeoffs_keyboard()`, `invoices_keyboard()`, `requests_keyboard()`, `reports_keyboard()`
- –ò—Å–ø–æ–ª—å–∑—É—é—Ç—Å—è —Å–æ–≤–º–µ—Å—Ç–Ω–æ –∏–∑ `handlers.py` –∏ –≤—Å–µ—Ö handler-—Ñ–∞–π–ª–æ–≤

**3. ¬´‚ùå –û—Ç–º–µ–Ω–∞¬ª –¥–æ–±–∞–≤–ª–µ–Ω–∞ –≤ `NAV_BUTTONS`** (`bot/global_commands.py`)
- `NavResetMiddleware` –ø–µ—Ä–µ—Ö–≤–∞—Ç—ã–≤–∞–µ—Ç –Ω–∞–∂–∞—Ç–∏–µ –∫–Ω–æ–ø–∫–∏ ¬´‚ùå –û—Ç–º–µ–Ω–∞¬ª –∏ —Å–±—Ä–∞—Å—ã–≤–∞–µ—Ç FSM

**4. `set_cancel_kb` –¥–æ–±–∞–≤–ª–µ–Ω –Ω–∞ —Å—Ç–∞—Ä—Ç –≤—Å–µ—Ö 7 flow'–æ–≤:**
- `start_writeoff`, `start_history` (writeoff_handlers)
- `start_template`, `start_from_template` (invoice_handlers)
- `start_create_request`, `start_duplicate_request` (request_handlers)
- `btn_edit_min_stock` (min_stock_handlers)

**5. `restore_menu_kb` –¥–æ–±–∞–≤–ª–µ–Ω –Ω–∞ –í–°–ï —Ç–æ—á–∫–∏ –≤—ã—Ö–æ–¥–∞:**
- **writeoff** (3): finalize no-admin, finalize admin, cancel_writeoff
- **writeoff history** (5): hist_close, hist_reuse √ó2 (admin/no-admin), hist_edit_send √ó2
- **invoice** (3): save_template, confirm_send, cancel_template
- **request** (5): cancel_request, confirm_send √ó2 (no-receiver/normal), confirm_dup_send √ó2
- **min_stock** (2): enter_min_level, cancel_edit

---

### 2026-02-13 ‚Äî –ì–ª–æ–±–∞–ª—å–Ω–∞—è –æ—Ç–º–µ–Ω–∞, –∑–∞—â–∏—Ç–∞ –æ—Ç –∑–∞–≤–∏—Å–∞–Ω–∏—è FSM, edit-first –ø–∞—Ç—Ç–µ—Ä–Ω

**–¶–µ–ª—å:** –ë–æ—Ç –º–æ–≥ "–∑–∞–≤–∏—Å–Ω—É—Ç—å" –≤ —Å–æ—Å—Ç–æ—è–Ω–∏–∏ –≤–≤–æ–¥–∞ (–ø–æ–∏—Å–∫ —Ç–æ–≤–∞—Ä–∞), –≥–¥–µ Reply-–∫–Ω–æ–ø–∫–∏ –Ω–∞–≤–∏–≥–∞—Ü–∏–∏ –ø–µ—Ä–µ—Ö–≤–∞—Ç—ã–≤–∞–ª–∏—Å—å –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–æ–º –ø–æ–∏—Å–∫–∞, —É–¥–∞–ª—è–ª–∏—Å—å, –∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –º–æ–≥ –≤—ã–π—Ç–∏.

**1. –ì–ª–æ–±–∞–ª—å–Ω–∞—è –∫–æ–º–∞–Ω–¥–∞ `/cancel`** (`bot/global_commands.py` ‚Äî –ù–û–í–´–ô –§–ê–ô–õ)
- –†–∞–±–æ—Ç–∞–µ—Ç –∏–∑ –õ–Æ–ë–û–ì–û FSM-—Å–æ—Å—Ç–æ—è–Ω–∏—è (–∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è, —Å–ø–∏—Å–∞–Ω–∏—è, –Ω–∞–∫–ª–∞–¥–Ω—ã–µ, –∑–∞—è–≤–∫–∏, –º–∏–Ω. –æ—Å—Ç–∞—Ç–∫–∏, —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ)
- –†–µ–¥–∞–∫—Ç–∏—Ä—É–µ—Ç prompt-—Å–æ–æ–±—â–µ–Ω–∏–µ —Å —Ç–µ–∫—Å—Ç–æ–º –æ—Ç–º–µ–Ω—ã (edit-first, fallback –Ω–∞ answer)
- –£–¥–∞–ª—è–µ—Ç –æ—Å—Ç–∞–ª—å–Ω—ã–µ –±–æ—Ç-—Å–æ–æ–±—â–µ–Ω–∏—è (header, selection –∏ —Ç.–¥.)
- –û—á–∏—â–∞–µ—Ç FSM-—Å–æ—Å—Ç–æ—è–Ω–∏–µ
- –†–æ—É—Ç–µ—Ä –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω –ü–ï–†–í–´–ú –≤ `main.py`

**2. `NavResetMiddleware`** (`bot/global_commands.py`)
- Outer-middleware –Ω–∞ `dp.message` ‚Äî –ø–µ—Ä–µ—Ö–≤–∞—Ç—ã–≤–∞–µ—Ç –í–°–ï Reply-–∫–Ω–æ–ø–∫–∏ –Ω–∞–≤–∏–≥–∞—Ü–∏–∏
- –ï—Å–ª–∏ —É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∞–∫—Ç–∏–≤–Ω–æ–µ FSM-—Å–æ—Å—Ç–æ—è–Ω–∏–µ –∏ –Ω–∞–∂–∞—Ç–∞ –Ω–∞–≤–∏–≥–∞—Ü–∏–æ–Ω–Ω–∞—è –∫–Ω–æ–ø–∫–∞ ‚Üí —Å–±—Ä–æ—Å FSM + cleanup
- State-filtered –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ (search_product, enter_quantity) –ù–ï –º–∞—Ç—á–∞—Ç—Å—è ‚Üí –∫–Ω–æ–ø–∫–∞ –ø—Ä–æ—Ö–æ–¥–∏—Ç –∫ —à—Ç–∞—Ç–Ω–æ–º—É —Ö—ç–Ω–¥–ª–µ—Ä—É
- `NAV_BUTTONS` ‚Äî frozenset –∏–∑ 55+ —Ç–µ–∫—Å—Ç–æ–≤ –≤—Å–µ—Ö Reply-–∫–Ω–æ–ø–æ–∫ –∏–∑ –≤—Å–µ—Ö –º–µ–Ω—é

**3. Guard-—Ö—ç–Ω–¥–ª–µ—Ä—ã –¥–ª—è 10 inline-only —Å–æ—Å—Ç–æ—è–Ω–∏–π**
- `writeoff_handlers.py`: `AdminEditStates` (5 —Å–æ—Å—Ç–æ—è–Ω–∏–π), `HistoryStates.browsing/viewing` (2 —Å–æ—Å—Ç–æ—è–Ω–∏—è)
- `request_handlers.py`: `ReceiverMgmtStates` (3 —Å–æ—Å—Ç–æ—è–Ω–∏—è)
- –í—Å–µ —É–¥–∞–ª—è—é—Ç —Å–ª—É—á–∞–π–Ω—ã–π —Ç–µ–∫—Å—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ —Å–æ—Å—Ç–æ—è–Ω–∏—è—Ö, –≥–¥–µ –æ–∂–∏–¥–∞–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ inline-–≤–≤–æ–¥

**4. Edit-first –≤ `/cancel`**
- –í–º–µ—Å—Ç–æ —É–¥–∞–ª–µ–Ω–∏—è –≤—Å–µ—Ö —Å–æ–æ–±—â–µ–Ω–∏–π + –æ—Ç–ø—Ä–∞–≤–∫–∏ –Ω–æ–≤–æ–≥–æ ‚Üí —Ä–µ–¥–∞–∫—Ç–∏—Ä—É–µ—Ç prompt-—Å–æ–æ–±—â–µ–Ω–∏–µ —Å ¬´‚úÖ –î–µ–π—Å—Ç–≤–∏–µ –æ—Ç–º–µ–Ω–µ–Ω–æ¬ª
- –£–¥–∞–ª—è–µ—Ç —Ç–æ–ª—å–∫–æ –ø—Ä–æ—á–∏–µ –±–æ—Ç-—Å–æ–æ–±—â–µ–Ω–∏—è (header, selection)

**5. –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ `save_quantity` –≤ writeoff**
- –£–±—Ä–∞–Ω–æ –ª–∏—à–Ω–µ–µ —É–¥–∞–ª–µ–Ω–∏–µ `quantity_prompt_id` (—Å–æ–≤–ø–∞–¥–∞–ª —Å `prompt_msg_id`)
- –¢–µ–ø–µ—Ä—å `_send_prompt` —É—Å–ø–µ—à–Ω–æ —Ä–µ–¥–∞–∫—Ç–∏—Ä—É–µ—Ç —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –≤–º–µ—Å—Ç–æ fallback –Ω–∞ send

**6. –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –≤ `main.py`**
- `dp.message.outer_middleware(NavResetMiddleware())` ‚Äî –ø–µ—Ä–µ–¥ –≤—Å–µ–º–∏ —Ä–æ—É—Ç–µ—Ä–∞–º–∏
- `dp.include_router(global_router)` ‚Äî –ø–µ—Ä–≤—ã–π —Ä–æ—É—Ç–µ—Ä

---

### 2026-02-13 ‚Äî PDF-–¥–æ–∫—É–º–µ–Ω—Ç—ã —Ä–∞—Å—Ö–æ–¥–Ω—ã—Ö –Ω–∞–∫–ª–∞–¥–Ω—ã—Ö –∏ –∑–∞—è–≤–æ–∫

**–¶–µ–ª—å:** –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ —Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏–µ PDF –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ —Ä–∞—Å—Ö–æ–¥–Ω–æ–π –Ω–∞–∫–ª–∞–¥–Ω–æ–π (–ø–æ —à–∞–±–ª–æ–Ω—É) –∏ –ø—Ä–∏ –æ–¥–æ–±—Ä–µ–Ω–∏–∏/—Å–æ–∑–¥–∞–Ω–∏–∏ –∑–∞—è–≤–∫–∏. –î–æ–∫—É–º–µ–Ω—Ç —Å–æ–¥–µ—Ä–∂–∏—Ç 2 –∫–æ–ø–∏–∏ (–¥–ª—è –æ—Ç–ø—Ä–∞–≤–∏—Ç–µ–ª—è –∏ –ø–æ–ª—É—á–∞—Ç–µ–ª—è).

**1. Use-case** (`use_cases/pdf_invoice.py`)
- `generate_invoice_pdf()` ‚Äî —Ñ–æ—Ä–º–∏—Ä—É–µ—Ç PDF —Å –¥–≤—É–º—è –∫–æ–ø–∏—è–º–∏ –¥–æ–∫—É–º–µ–Ω—Ç–∞ (–Ω–æ–∂–Ω–∏—Ü—ã-—Ä–∞–∑–¥–µ–ª–∏—Ç–µ–ª—å)
- –ê–¥–∞–ø—Ç–∏–≤–Ω—ã–π —Ä–∞–∑–º–µ—Ä —à—Ä–∏—Ñ—Ç–∞ –∏ –≤—ã—Å–æ—Ç—ã —Å—Ç—Ä–æ–∫: ‚â§10 –ø–æ–∑. ‚Üí 9pt, ‚â§20 ‚Üí 8pt, ‚â§35 ‚Üí 7pt, ‚â§50 ‚Üí 6.5pt, >50 ‚Üí 6pt
- –°–æ–¥–µ—Ä–∂–∏–º–æ–µ: –∑–∞–≥–æ–ª–æ–≤–æ–∫, –¥–∞—Ç–∞, –ø–æ–¥—Ä–∞–∑–¥–µ–ª–µ–Ω–∏–µ, —Å–∫–ª–∞–¥ (–æ—Ç–∫—É–¥–∞), –∫–æ–Ω—Ç—Ä–∞–≥–µ–Ω—Ç (–∫—É–¥–∞), —Å—á—ë—Ç, –∞–≤—Ç–æ—Ä, –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π
- –¢–∞–±–ª–∏—Ü–∞: ‚Ññ, –ù–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ, –ï–¥., –ö–æ–ª-–≤–æ, –¶–µ–Ω–∞, –°—É–º–º–∞ + –∏—Ç–æ–≥–æ
- –ü–æ–¥–ø–∏—Å–∏: ¬´–û—Ç–ø—É—Å—Ç–∏–ª / –ü–æ–ª—É—á–∏–ª¬ª
- `generate_invoice_filename()` ‚Äî —Ç—Ä–∞–Ω—Å–ª–∏—Ç–µ—Ä–∏—Ä–æ–≤–∞–Ω–Ω–æ–µ –∏–º—è —Ñ–∞–π–ª–∞ –¥–ª—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏
- `_download_fonts()` ‚Äî –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ —Å–∫–∞—á–∏–≤–∞–Ω–∏–µ DejaVu Sans –ø—Ä–∏ –æ—Ç—Å—É—Ç—Å—Ç–≤–∏–∏ (Railway)

**2. –®—Ä–∏—Ñ—Ç—ã** (`fonts/`)
- DejaVu Sans + DejaVu Sans Bold ‚Äî –≤—Å—Ç—Ä–æ–µ–Ω—ã –≤ –ø—Ä–æ–µ–∫—Ç (Git)
- –ö–∏—Ä–∏–ª–ª–∏—Ü–∞ —Ä–∞–±–æ—Ç–∞–µ—Ç –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ –±–µ–∑ —É—Å—Ç–∞–Ω–æ–≤–∫–∏ —Å–∏—Å—Ç–µ–º–Ω—ã—Ö —à—Ä–∏—Ñ—Ç–æ–≤
- –ê–≤—Ç–æ—Å–∫–∞—á–∏–≤–∞–Ω–∏–µ –∏–∑ GitHub releases –µ—Å–ª–∏ —Ñ–∞–π–ª—ã –æ—Ç—Å—É—Ç—Å—Ç–≤—É—é—Ç

**3. –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è ‚Äî –Ω–∞–∫–ª–∞–¥–Ω—ã–µ –ø–æ —à–∞–±–ª–æ–Ω—É** (`bot/invoice_handlers.py`)
- –ü–æ—Å–ª–µ —É—Å–ø–µ—à–Ω–æ–π –æ—Ç–ø—Ä–∞–≤–∫–∏ –≤ iiko ‚Üí –≥–µ–Ω–µ—Ä–∞—Ü–∏—è PDF ‚Üí –æ—Ç–ø—Ä–∞–≤–∫–∞ –¥–æ–∫—É–º–µ–Ω—Ç–æ–º –≤ —á–∞—Ç
- `BufferedInputFile` ‚Äî PDF –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è –∫–∞–∫ Telegram-–¥–æ–∫—É–º–µ–Ω—Ç

**4. –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è ‚Äî –∑–∞—è–≤–∫–∏** (`bot/request_handlers.py`)
- –ü—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –∑–∞—è–≤–∫–∏: PDF –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è –≤–º–µ—Å—Ç–µ —Å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ–º –∫–∞–∂–¥–æ–º—É –ø–æ–ª—É—á–∞—Ç–µ–ª—é
- –ü—Ä–∏ –æ–¥–æ–±—Ä–µ–Ω–∏–∏ –∑–∞—è–≤–∫–∏: PDF –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è –æ–¥–æ–±—Ä–∏–≤—à–µ–º—É + —Å–æ–∑–¥–∞—Ç–µ–ª—é –∑–∞—è–≤–∫–∏

**5. –ó–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏**
- –î–æ–±–∞–≤–ª–µ–Ω–∞ `reportlab>=4.0.0` –≤ `requirements.txt`

---

### 2026-02-13 ‚Äî –ì—Ä–∞–Ω—É–ª—è—Ä–Ω—ã–µ –ø—Ä–∞–≤–∞ –¥–æ—Å—Ç—É–ø–∞ —á–µ—Ä–µ–∑ Google –¢–∞–±–ª–∏—Ü—É

**–¶–µ–ª—å:** –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø—Ä–∞–≤–∞–º–∏ –¥–æ—Å—Ç—É–ø–∞ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤ –∫ —Ä–∞–∑–¥–µ–ª–∞–º –±–æ—Ç–∞ —á–µ—Ä–µ–∑ Google –¢–∞–±–ª–∏—Ü—É (–±–µ–∑ –¥–µ–ø–ª–æ—è –∏ –∫–æ–¥–∞).

**1. Use-case** (`use_cases/permissions.py`)
- In-memory –∫–µ—à –ø—Ä–∞–≤ —Å TTL 5 –º–∏–Ω (graceful degradation ‚Äî –µ—Å–ª–∏ GSheet –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω, –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è —Å—Ç–∞—Ä—ã–π –∫–µ—à)
- `has_permission(telegram_id, perm_key)` ‚Äî –ø—Ä–æ–≤–µ—Ä–∫–∞ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–≥–æ –ø—Ä–∞–≤–∞; –∞–¥–º–∏–Ω—ã –∏–º–µ—é—Ç bypass (–≤—Å—ë —Ä–∞–∑—Ä–µ—à–µ–Ω–æ)
- `get_allowed_keys(telegram_id)` ‚Äî –º–Ω–æ–∂–µ—Å—Ç–≤–æ —Ä–∞–∑—Ä–µ—à—ë–Ω–Ω—ã—Ö –∫–ª—é—á–µ–π (–¥–ª—è —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏ –∫–ª–∞–≤–∏–∞—Ç—É—Ä—ã)
- `sync_permissions_to_gsheet()` ‚Äî –≤—ã–≥—Ä—É–∑–∫–∞ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω–Ω—ã—Ö —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤ + —Å—Ç–æ–ª–±—Ü–æ–≤ –ø—Ä–∞–≤
  - –î–æ–±–∞–≤–ª—è–µ—Ç –Ω–æ–≤—ã—Ö —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤ —Å –ø—É—Å—Ç—ã–º–∏ –ø—Ä–∞–≤–∞–º–∏
  - –î–æ–±–∞–≤–ª—è–µ—Ç –Ω–æ–≤—ã–µ —Å—Ç–æ–ª–±—Ü—ã –µ—Å–ª–∏ PERMISSION_KEYS —Ä–∞—Å—à–∏—Ä–∏–ª—Å—è
  - –ù–ï —É–¥–∞–ª—è–µ—Ç —Å—Ç—Ä–æ–∫–∏ —É–≤–æ–ª–µ–Ω–Ω—ã—Ö, –ù–ï —Å—Ç–∏—Ä–∞–µ—Ç —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ ‚úÖ/‚ùå
- `PERMISSION_KEYS` = [üìù –°–ø–∏—Å–∞–Ω–∏—è, üì¶ –ù–∞–∫–ª–∞–¥–Ω—ã–µ, üìã –ó–∞—è–≤–∫–∏, üìä –û—Ç—á—ë—Ç—ã, ‚öôÔ∏è –ù–∞—Å—Ç—Ä–æ–π–∫–∏]

**2. GSheet –∞–¥–∞–ø—Ç–µ—Ä** (`adapters/google_sheets.py`)
- –ù–æ–≤—ã–π –ª–∏—Å—Ç ¬´–ü—Ä–∞–≤–∞ –¥–æ—Å—Ç—É–ø–∞¬ª –≤ —Ç–æ–π –∂–µ —Ç–∞–±–ª–∏—Ü–µ
- `read_permissions_sheet()` ‚Äî —á—Ç–µ–Ω–∏–µ –º–∞—Ç—Ä–∏—Ü—ã –ø—Ä–∞–≤ ‚Üí [{telegram_id, perms: {key: bool}}]
- `sync_permissions_to_sheet(employees, permission_keys)` ‚Äî –∑–∞–ø–∏—Å—å —Å –∑–∞—â–∏—Ç–æ–π –æ—Ç –ø–æ—Ç–µ—Ä–∏ –¥–∞–Ω–Ω—ã—Ö
- –§–æ—Ä–º–∞—Ç: —Å—Ç—Ä–æ–∫–∞ 1=–º–µ—Ç–∞, —Å—Ç—Ä–æ–∫–∞ 2=–∑–∞–≥–æ–ª–æ–≤–∫–∏, —Å—Ç—Ä–æ–∫–∞ 3+=—Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∏ —Å ‚úÖ/–ø—É—Å—Ç–æ
- Data validation (dropdown ‚úÖ/–ø—É—Å—Ç–æ) –¥–ª—è —Å—Ç–æ–ª–±—Ü–æ–≤ –ø—Ä–∞–≤
- –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ: —Å–∫—Ä—ã—Ç–∞—è –º–µ—Ç–∞-—Å—Ç—Ä–æ–∫–∞, –∑–∞–º–æ—Ä–æ–∑–∫–∞ 2 —Å—Ç—Ä–æ–∫ + 1 —Å—Ç–æ–ª–±—Ü–∞

**3. Middleware** (`bot/middleware.py`)
- –ù–æ–≤—ã–π –¥–µ–∫–æ—Ä–∞—Ç–æ—Ä `permission_required(perm_key)` ‚Äî –ø—Ä–æ–≤–µ—Ä—è–µ—Ç –ø—Ä–∞–≤–æ —á–µ—Ä–µ–∑ `perm_uc.has_permission()`
- –ü—Ä–∏–º–µ–Ω—ë–Ω –Ω–∞ –≤—Å–µ —Ä–∞–∑–¥–µ–ª—ã –≥–ª–∞–≤–Ω–æ–≥–æ –º–µ–Ω—é: –°–ø–∏—Å–∞–Ω–∏—è, –ù–∞–∫–ª–∞–¥–Ω—ã–µ, –ó–∞—è–≤–∫–∏, –û—Ç—á—ë—Ç—ã, –ù–∞—Å—Ç—Ä–æ–π–∫–∏

**4. –ö–ª–∞–≤–∏–∞—Ç—É—Ä–∞** (`bot/handlers.py`)
- `_main_keyboard(allowed)` ‚Äî –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∞—è —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏—è –∫–Ω–æ–ø–æ–∫ –ø–æ –º–Ω–æ–∂–µ—Å—Ç–≤—É —Ä–∞–∑—Ä–µ—à—ë–Ω–Ω—ã—Ö –ø—Ä–∞–≤
- `_get_main_kb(tg_id)` ‚Äî async-–æ–±—ë—Ä—Ç–∫–∞, –ø–æ–¥–≥—Ä—É–∂–∞–µ—Ç –ø—Ä–∞–≤–∞ –∏ —Å—Ç—Ä–æ–∏—Ç –∫–ª–∞–≤–∏–∞—Ç—É—Ä—É
- ¬´üè† –°–º–µ–Ω–∏—Ç—å —Ä–µ—Å—Ç–æ—Ä–∞–Ω¬ª ‚Äî –≤—Å–µ–≥–¥–∞ –≤–∏–¥–Ω–∞ (–Ω–µ –∫–æ–Ω—Ç—Ä–æ–ª–∏—Ä—É–µ—Ç—Å—è –ø—Ä–∞–≤–∞–º–∏)
- –ù–æ–≤–∞—è –∫–Ω–æ–ø–∫–∞ –≤ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞—Ö: ¬´üîë –ü—Ä–∞–≤–∞ –¥–æ—Å—Ç—É–ø–∞ ‚Üí GSheet¬ª

**–ü—Ä–∏–Ω—Ü–∏–ø —Ä–∞–±–æ—Ç—ã:**
- –ö–∞–∂–¥—ã–π –∑–∞–ø—Ä–æ—Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è ‚Üí –ø—Ä–æ–≤–µ—Ä–∫–∞ –ø—Ä–∞–≤ –∏–∑ in-memory –∫–µ—à–∞ (TTL 5 –º–∏–Ω)
- –ü—Ä–∏ –ø—Ä–æ–º–∞—Ö–µ –∫–µ—à–∞ ‚Üí —á—Ç–µ–Ω–∏–µ –ª–∏—Å—Ç–∞ –∏–∑ Google –¢–∞–±–ª–∏—Ü—ã ~1-2 —Å–µ–∫
- –ö–Ω–æ–ø–∫–∞ ¬´üîë –ü—Ä–∞–≤–∞ –¥–æ—Å—Ç—É–ø–∞ ‚Üí GSheet¬ª ‚Äî —Ç–æ–ª—å–∫–æ –¥–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –Ω–æ–≤—ã—Ö —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤/—Å—Ç–æ–ª–±—Ü–æ–≤
- –ê–¥–º–∏–Ω –ø—Ä–∞–≤–∏—Ç ‚úÖ/‚ùå –ø—Ä—è–º–æ –≤ —Ç–∞–±–ª–∏—Ü–µ ‚Üí —á–µ—Ä–µ–∑ 5 –º–∏–Ω (–∏–ª–∏ –ø–æ—Å–ª–µ –∏–Ω–≤–∞–ª–∏–¥–∞—Ü–∏–∏) –∏–∑–º–µ–Ω–µ–Ω–∏—è –≤—Å—Ç—É–ø–∞—é—Ç –≤ —Å–∏–ª—É

---

### 2026-02-12 ‚Äî –°–∏—Å—Ç–µ–º–∞ –∑–∞—è–≤–æ–∫ –Ω–∞ —Ç–æ–≤–∞—Ä—ã + –∏—Å—Ç–æ—Ä–∏—è —Å –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏–µ–º

**–¶–µ–ª—å:** –¢–æ—á–∫–∏ —Å–æ–∑–¥–∞—é—Ç –∑–∞—è–≤–∫–∏ –Ω–∞ —Ç–æ–≤–∞—Ä—ã ‚Üí –ø–æ–ª—É—á–∞—Ç–µ–ª–∏ –æ–¥–æ–±—Ä—è—é—Ç/—Ä–µ–¥–∞–∫—Ç–∏—Ä—É—é—Ç ‚Üí —Ä–∞—Å—Ö–æ–¥–Ω–∞—è –Ω–∞–∫–ª–∞–¥–Ω–∞—è –≤ iiko. –ü–æ–≤—Ç–æ—Ä–Ω–∞—è –æ—Ç–ø—Ä–∞–≤–∫–∞ –∏–∑ –∏—Å—Ç–æ—Ä–∏–∏.

**1. –ú–æ–¥–µ–ª–∏ –ë–î** (`db/models.py`)
- `RequestReceiver` ‚Äî —Ç–∞–±–ª–∏—Ü–∞ `request_receiver`: telegram_id (unique+indexed), employee_id, employee_name, added_at, added_by
- `ProductRequest` ‚Äî —Ç–∞–±–ª–∏—Ü–∞ `product_request`: pk, status (pending/approved/cancelled), requester_tg (indexed), department_id (indexed), store_id, counteragent_id, account_id, items (JSONB), total_sum, comment, approved_by, created_at, approved_at
- –ò–Ω–¥–µ–∫—Å—ã: `ix_request_receiver_telegram_id`, `ix_product_request_requester`, `ix_product_request_dept`, `ix_product_request_status`

**2. –ë–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫–∞** (`use_cases/product_request.py`)
- –ö–µ—à –ø–æ–ª—É—á–∞—Ç–µ–ª–µ–π: `_receiver_ids_cache` (in-memory, –∫–∞–∫ admin_ids)
- CRUD –ø–æ–ª—É—á–∞—Ç–µ–ª–µ–π: `add_receiver()`, `remove_receiver()`, `list_receivers()`, `is_receiver()`, `get_available_for_receiver()`
- –ó–∞—è–≤–∫–∏: `create_request()`, `get_request_by_pk()`, `get_pending_requests()`, `approve_request()`, `cancel_request()`
- –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ: `update_request_items()` ‚Äî –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø–æ–∑–∏—Ü–∏–π –∏ —Å—É–º–º—ã –ø–æ–ª—É—á–∞—Ç–µ–ª–µ–º
- –ò—Å—Ç–æ—Ä–∏—è: `get_user_requests(telegram_id, limit)` ‚Äî –ø–æ—Å–ª–µ–¥–Ω–∏–µ –∑–∞—è–≤–∫–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
- –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ: `format_request_text()`, `format_receiver_list()`

**3. –•—ç–Ω–¥–ª–µ—Ä—ã** (`bot/request_handlers.py`)
- **A) –°–æ–∑–¥–∞–Ω–∏–µ –∑–∞—è–≤–∫–∏** ‚Äî `CreateRequestStates`: store ‚Üí supplier_choose ‚Üí add_items ‚Üí enter_item_qty ‚Üí confirm
  - –ü–æ–∏—Å–∫ —Ç–æ–≤–∞—Ä–æ–≤ –ø–æ –Ω–∞–∑–≤–∞–Ω–∏—é (`search_price_products()`), –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ –ø–æ –æ–¥–Ω–æ–º—É —Å –≤–≤–æ–¥–æ–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞
  - –ö–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏—è –µ–¥–∏–Ω–∏—Ü (–≥‚Üí–∫–≥, –º–ª‚Üí–ª), –∞–∫—Ç—É–∞–ª—å–Ω—ã–µ —Ü–µ–Ω—ã –∏–∑ –ø—Ä–∞–π—Å-–ª–∏—Å—Ç–∞
  - –ö–Ω–æ–ø–∫–∏: ¬´‚úÖ –û—Ç–ø—Ä–∞–≤–∏—Ç—å –∑–∞—è–≤–∫—É (N –ø–æ–∑.)¬ª, ¬´üóë –£–¥–∞–ª–∏—Ç—å –ø–æ—Å–ª–µ–¥–Ω–∏–π¬ª, ¬´‚ùå –û—Ç–º–µ–Ω–∞¬ª
  - –ü—Ä–∏ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–∏: —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –≤ –ë–î ‚Üí —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –≤—Å–µ—Ö –ø–æ–ª—É—á–∞—Ç–µ–ª–µ–π
- **B) –û–¥–æ–±—Ä–µ–Ω–∏–µ/—Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ** ‚Äî –ø–æ–ª—É—á–∞—Ç–µ–ª–∏:
  - ¬´‚úÖ –û—Ç–ø—Ä–∞–≤–∏—Ç—å¬ª ‚Üí `build_outgoing_invoice_document()` + `send_outgoing_invoice_document()` ‚Üí iiko (XML-–∏–º–ø–æ—Ä—Ç, —Å—Ç–∞—Ç—É—Å PROCESSED)
  - ¬´‚úèÔ∏è –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞¬ª ‚Üí `EditRequestStates.enter_quantities` ‚Üí –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –≤ –ë–î ‚Üí –ø–æ–≤—Ç–æ—Ä–Ω—ã–π –ø–æ–∫–∞–∑ —Å –∫–Ω–æ–ø–∫–∞–º–∏
  - ¬´‚ùå –û—Ç–º–µ–Ω–∏—Ç—å¬ª ‚Üí cancelled + —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ —Å–æ–∑–¥–∞—Ç–µ–ª—è
- **C) –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø–æ–ª—É—á–∞—Ç–µ–ª—è–º–∏** ‚Äî `ReceiverMgmtStates`: menu ‚Üí choosing_employee ‚Üí confirm_remove (—Ç–æ–ª—å–∫–æ –∞–¥–º–∏–Ω—ã)
- **D) –ò—Å—Ç–æ—Ä–∏—è –∑–∞—è–≤–æ–∫ + –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏–µ** ‚Äî `DuplicateRequestStates`: enter_quantities ‚Üí confirm
  - ¬´üìã –ò—Å—Ç–æ—Ä–∏—è –∑–∞—è–≤–æ–∫¬ª ‚Äî –ø–æ—Å–ª–µ–¥–Ω–∏–µ 10 –∑–∞—è–≤–æ–∫ —Å –∫–Ω–æ–ø–∫–∞–º–∏ –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ –∏ üîÑ (–ø–æ–≤—Ç–æ—Ä–∏—Ç—å)
  - –î—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏–µ: –ø–æ–∫–∞–∑ –ø–æ–∑–∏—Ü–∏–π —Å—Ç–∞—Ä–æ–π –∑–∞—è–≤–∫–∏ ‚Üí –≤–≤–æ–¥ –Ω–æ–≤—ã—Ö –∫–æ–ª–∏—á–µ—Å—Ç–≤ ‚Üí –ø—Ä–µ–≤—å—é ‚Üí –æ—Ç–ø—Ä–∞–≤–∫–∞ –ø–æ–ª—É—á–∞—Ç–µ–ª—è–º
  - –¶–µ–Ω—ã –æ–±–Ω–æ–≤–ª—è—é—Ç—Å—è –∏–∑ –∞–∫—Ç—É–∞–ª—å–Ω–æ–≥–æ –ø—Ä–∞–π—Å-–ª–∏—Å—Ç–∞ –ø—Ä–∏ –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏–∏

**4. –ö–Ω–æ–ø–∫–∏ –º–µ–Ω—é** (`bot/handlers.py`)
- –ü–æ–¥–º–µ–Ω—é ¬´–î–æ–∫—É–º–µ–Ω—Ç—ã¬ª: –¥–æ–±–∞–≤–ª–µ–Ω—ã ¬´üìù –°–æ–∑–¥–∞—Ç—å –∑–∞—è–≤–∫—É¬ª, ¬´üìã –ò—Å—Ç–æ—Ä–∏—è –∑–∞—è–≤–æ–∫¬ª, ¬´üì¨ –í—Ö–æ–¥—è—â–∏–µ –∑–∞—è–≤–∫–∏¬ª
- –ü–æ–¥–º–µ–Ω—é ¬´–°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è¬ª: ¬´üì¨ –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø–æ–ª—É—á–∞—Ç–µ–ª—è–º–∏¬ª (admin-only)

**5. –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è —Ä–∞—Å—Ö–æ–¥–Ω—ã—Ö –Ω–∞–∫–ª–∞–¥–Ω—ã—Ö** (`use_cases/outgoing_invoice.py`, `adapters/iiko_api.py`)
- ContainerId: —Ä–µ–∞–ª—å–Ω—ã–π ID –∏–∑ `iiko_product.raw_json -> containers[0].id` (–Ω–µ null UUID)
- XML-–≤–∞–ª–∏–¥–∞—Ü–∏—è: –ø–∞—Ä—Å–∏–Ω–≥ `<valid>false</valid>` –∏–∑ –æ—Ç–≤–µ—Ç–∞ iiko (HTTP 200 –¥–∞–∂–µ –ø—Ä–∏ –æ—à–∏–±–∫–µ)
- –°—Ç–∞—Ç—É—Å: `"status": "PROCESSED"` –≤–º–µ—Å—Ç–æ `"NEW"`

---

### 2026-02-12 ‚Äî –ü—Ä–∞–π—Å-–ª–∏—Å—Ç –Ω–∞–∫–ª–∞–¥–Ω—ã—Ö + —Å–µ–±–µ—Å—Ç–æ–∏–º–æ—Å—Ç—å –∏–∑ iiko

**–¶–µ–ª—å:** Google –¢–∞–±–ª–∏—Ü–∞ —Å —Ç–æ–≤–∞—Ä–∞–º–∏ –¥–ª—è —Ä–∞—Å—Ö–æ–¥–Ω—ã—Ö –Ω–∞–∫–ª–∞–¥–Ω—ã—Ö, –∞–≤—Ç–æ-—Ä–∞—Å—á—ë—Ç —Å–µ–±–µ—Å—Ç–æ–∏–º–æ—Å—Ç–∏.

**1. iiko API ‚Äî –¥–≤–∞ –Ω–æ–≤—ã—Ö —ç–Ω–¥–ø–æ–∏–Ω—Ç–∞** (`adapters/iiko_api.py`)
- `fetch_incoming_invoices(date_from, date_to)` ‚Äî GET `/resto/api/documents/export/incomingInvoice` (XML ‚Üí list[dict])
- `fetch_assembly_charts(date_from, date_to)` ‚Äî GET `/resto/api/v2/assemblyCharts/getAll` (JSON, includePreparedCharts)

**2. –†–∞—Å—á—ë—Ç —Å–µ–±–µ—Å—Ç–æ–∏–º–æ—Å—Ç–∏** (`use_cases/outgoing_invoice.py`)
- `calculate_goods_cost_prices(days_back=90)` ‚Äî —Ü–µ–Ω–∞ GOODS –ø–æ –ø–æ—Å–ª–µ–¥–Ω–µ–º—É –ø—Ä–∏—Ö–æ–¥—É (–ø—Ä–∏—Ö–æ–¥–Ω—ã–µ –Ω–∞–∫–ª–∞–¥–Ω—ã–µ –∑–∞ N –¥–Ω–µ–π)
- `calculate_dish_cost_prices(goods_costs)` ‚Äî —Å–µ–±–µ—Å—Ç–æ–∏–º–æ—Å—Ç—å DISH: sum(ingredient.amountOut √ó ingredient_cost) –ø–æ —Ç–µ—Ö–∫–∞—Ä—Ç–∞–º
- `sync_price_sheet()` ‚Äî –ø–æ–ª–Ω—ã–π –ø–∞–π–ø–ª–∞–π–Ω: –¥–µ—Ä–µ–≤–æ —Ç–æ–≤–∞—Ä–æ–≤ ‚Üí GOODS cost ‚Üí DISH cost ‚Üí Google Sheet

**3. Google Sheet ¬´–ü—Ä–∞–π—Å-–ª–∏—Å—Ç¬ª** (`adapters/google_sheets.py`)
- `sync_invoice_prices_to_sheet(products, cost_prices)` ‚Äî –∑–∞–ø–∏—Å—å —Å —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ–º —Ä—É—á–Ω—ã—Ö —Ü–µ–Ω (D —Å—Ç–æ–ª–±–µ—Ü)
- `read_invoice_prices()` ‚Äî —á—Ç–µ–Ω–∏–µ –ø—Ä–∞–π—Å-–ª–∏—Å—Ç–∞
- –°—Ç–æ–ª–±—Ü—ã: A=–¢–æ–≤–∞—Ä, B=ID (—Å–∫—Ä—ã—Ç—ã–π), C=–°–µ–±–µ—Å—Ç–æ–∏–º–æ—Å—Ç—å (–∞–≤—Ç–æ), D=–¶–µ–Ω–∞ –æ—Ç–≥—Ä—É–∑–∫–∏ (—Ä—É—á–Ω–∞—è)
- –ü–∞—Ç—Ç–µ—Ä–Ω stable-rows: –ø—Ä–∏–≤—è–∑–∫–∞ –ø–æ product_id, –Ω–æ–≤—ã–µ –ø–æ–∑–∏—Ü–∏–∏ –Ω–µ —Å–¥–≤–∏–≥–∞—é—Ç —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ

**4. –ö–Ω–æ–ø–∫–∞ –±–æ—Ç–∞** (`bot/handlers.py`)
- ¬´üí∞ –ü—Ä–∞–π—Å-–ª–∏—Å—Ç ‚Üí GSheet¬ª –≤ –ø–æ–¥–º–µ–Ω—é ¬´–ö–æ–º–∞–Ω–¥—ã¬ª (admin_required)
- –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è: INVOICE_PRICE_SHEET_ID (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é = MIN_STOCK_SHEET_ID)

---

### 2026-02-12 ‚Äî –†–∞—Å—Ö–æ–¥–Ω–∞—è –Ω–∞–∫–ª–∞–¥–Ω–∞—è: —à–∞–±–ª–æ–Ω—ã (Phase 1)

**–¶–µ–ª—å:** –°–æ–∑–¥–∞–Ω–∏–µ —à–∞–±–ª–æ–Ω–æ–≤ —Ä–∞—Å—Ö–æ–¥–Ω—ã—Ö –Ω–∞–∫–ª–∞–¥–Ω—ã—Ö –¥–ª—è –±—ã—Å—Ç—Ä–æ–≥–æ –ø–æ–≤—Ç–æ—Ä–Ω–æ–≥–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è.

**1. –ú–æ–¥–µ–ª—å `InvoiceTemplate`** (`db/models.py`)
- –¢–∞–±–ª–∏—Ü–∞ ‚Ññ16 iiko/bot (‚Ññ29 –æ–±—â–∞—è), JSONB-–ø–æ–ª–µ items [{product_id, name, unit_name}]
- –î–µ–Ω–æ—Ä–º–∞–ª–∏–∑–æ–≤–∞–Ω–Ω—ã–µ –ø–æ–ª—è: counteragent_name, account_name, store_name
- –ò–Ω–¥–µ–∫—Å—ã: created_by, department_id

**2. –ö–µ—à `use_cases/invoice_cache.py`**
- TTL 600—Å: suppliers, revenue_account, stores (–ø–æ dept), products_tree
- –ü–∞—Ç—Ç–µ—Ä–Ω writeoff_cache: in-memory dict {key: (data, timestamp)}

**3. –ë–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫–∞ `use_cases/outgoing_invoice.py`**
- `load_all_suppliers()` + `search_suppliers(query)` ‚Äî –ø–æ–∏—Å–∫ –∫–æ–Ω—Ç—Ä–∞–≥–µ–Ω—Ç–æ–≤
- `get_revenue_account()` ‚Äî –∞–≤—Ç–æ-–ø–æ–∏—Å–∫ —Å—á—ë—Ç–∞ ¬´—Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è –Ω–∞ —Ç–æ—á–∫–∏¬ª
- `get_stores_for_department()` ‚Äî —Ç–æ–ª—å–∫–æ –±–∞—Ä/–∫—É—Ö–Ω—è
- `preload_products_tree()` ‚Äî BFS –ø–æ gsheet_export_group ‚Üí —Ñ–∏–ª—å—Ç—Ä GOODS+DISH
- `save_template()`, `get_templates_for_department()`, `delete_template()`

**4. –•—ç–Ω–¥–ª–µ—Ä—ã `bot/invoice_handlers.py`**
- FSM: store ‚Üí supplier_search ‚Üí supplier_choose ‚Üí add_items ‚Üí template_name
- Summary+prompt –ø–∞—Ç—Ç–µ—Ä–Ω, guard-—Ö—ç–Ω–¥–ª–µ—Ä—ã, inline-–∫–Ω–æ–ø–∫–∏
- –ö–Ω–æ–ø–∫–∞ ¬´üìã –°–æ–∑–¥–∞—Ç—å —à–∞–±–ª–æ–Ω –Ω–∞–∫–ª–∞–¥–Ω–æ–π¬ª –≤ –º–µ–Ω—é ¬´–î–æ–∫—É–º–µ–Ω—Ç—ã¬ª

---

### 2026-02-12 ‚Äî –ö–µ—à –Ω–æ–º–µ–Ω–∫–ª–∞—Ç—É—Ä—ã –¥–ª—è –º–≥–Ω–æ–≤–µ–Ω–Ω–æ–≥–æ –ø–æ–∏—Å–∫–∞ —Ç–æ–≤–∞—Ä–æ–≤

**–ü—Ä–æ–±–ª–µ–º–∞:** –ü–æ–∏—Å–∫ —Ç–æ–≤–∞—Ä–æ–≤ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ —Å–ø–∏—Å–∞–Ω–∏—è = ~2.3 —Å–µ–∫ (DB round-trip Railway).
**–†–µ—à–µ–Ω–∏–µ:** In-memory –∫–µ—à –≤—Å–µ—Ö GOODS/PREPARED —Ç–æ–≤–∞—Ä–æ–≤ —Å –ø—Ä–µ–¥—Ä–µ–∑–æ–ª–≤–ª–µ–Ω–Ω—ã–º–∏ –µ–¥–∏–Ω–∏—Ü–∞–º–∏ –∏–∑–º–µ—Ä–µ–Ω–∏—è.
- `preload_products()` –≤ `writeoff.py` ‚Äî –∑–∞–≥—Ä—É–∂–∞–µ—Ç –≤—Å–µ 1942 —Ç–æ–≤–∞—Ä–∞ + –±–∞—Ç—á-—Ä–µ–∑–æ–ª–≤ units ‚Üí –∫–µ—à (~400 –ö–ë RAM)
- `search_products()` ‚Äî —Å–Ω–∞—á–∞–ª–∞ –∏—â–µ—Ç –≤ –∫–µ—à–µ (0 –º—Å), fallback –Ω–∞ –ë–î –µ—Å–ª–∏ –∫–µ—à –ø—É—Å—Ç
- –ü—Ä–æ–≥—Ä–µ–≤ –ø—Ä–∏ –≤—Ö–æ–¥–µ –≤ ¬´–î–æ–∫—É–º–µ–Ω—Ç—ã¬ª –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ —Å–æ —Å–∫–ª–∞–¥–∞–º–∏/—Å—á–µ—Ç–∞–º–∏/admin_ids
- TTL 10 –º–∏–Ω (–∫–∞–∫ —Å–∫–ª–∞–¥—ã/—Å—á–µ—Ç–∞)
- `get_products()` / `set_products()` –≤ `writeoff_cache.py`

---

### 2026-02-12 ‚Äî –ò—Å—Ç–æ—Ä–∏—è —Å–ø–∏—Å–∞–Ω–∏–π (writeoff_history)

**1. –ù–æ–≤–∞—è —Ç–∞–±–ª–∏—Ü–∞ `writeoff_history`**
- –ú–æ–¥–µ–ª—å `WriteoffHistory` –≤ `db/models.py` (—Ç–∞–±–ª–∏—Ü–∞ ‚Ññ15 iiko/bot, ‚Ññ28 –æ–±—â–∞—è)
- JSONB-–ø–æ–ª–µ `items` –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è –ø–æ–∑–∏—Ü–∏–π —Å–ø–∏—Å–∞–Ω–∏—è
- `store_type` (bar/kitchen/NULL) –¥–ª—è —Ä–æ–ª–µ–≤–æ–π —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏
- –ò–Ω–¥–µ–∫—Å—ã: telegram_id, department_id, store_type, created_at
- –ú–∏–≥—Ä–∞—Ü–∏—è: 4 CREATE INDEX IF NOT EXISTS –≤ `db/init_db.py`

**2. –ë–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫–∞ `use_cases/writeoff_history.py`**
- `save_to_history()` ‚Äî —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –æ–¥–æ–±—Ä–µ–Ω–Ω–æ–≥–æ —Å–ø–∏—Å–∞–Ω–∏—è + –∞–≤—Ç–æ-–æ—á–∏—Å—Ç–∫–∞ (>200 –∑–∞–ø–∏—Å–µ–π –Ω–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è)
- `get_history(telegram_id, department_id, role_type, page)` ‚Äî —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏—è: –±–∞—Ä ‚Üí —Ç–æ–ª—å–∫–æ –±–∞—Ä, –∫—É—Ö–Ω—è ‚Üí —Ç–æ–ª—å–∫–æ –∫—É—Ö–Ω—è, admin/unknown ‚Üí –≤—Å–µ
- `get_history_entry(pk)`, `build_history_summary()` ‚Äî –¥–µ—Ç–∞–ª–∏ –∑–∞–ø–∏—Å–∏
- `_detect_store_type()` ‚Äî –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ —Ç–∏–ø–∞ —Å–∫–ª–∞–¥–∞ (–±–∞—Ä/–∫—É—Ö–Ω—è) –ø–æ –∏–º–µ–Ω–∏
- MAX_HISTORY_PER_USER=200, HISTORY_PAGE_SIZE=10

**3. Telegram-—Ö—ç–Ω–¥–ª–µ—Ä—ã (bot/writeoff_handlers.py)**
- FSM `HistoryStates`: browsing ‚Üí viewing ‚Üí editing_reason / editing_items / editing_quantity
- –ü—Ä–æ—Å–º–æ—Ç—Ä: —Å–ø–∏—Å–æ–∫ —Å –ø–∞–≥–∏–Ω–∞—Ü–∏–µ–π, –¥–µ—Ç–∞–ª–∏ –∑–∞–ø–∏—Å–∏, –∫–Ω–æ–ø–∫–∏ ¬´–ø–æ–≤—Ç–æ—Ä–∏—Ç—å –∫–∞–∫ –µ—Å—Ç—å¬ª / ¬´—Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –∏ –æ—Ç–ø—Ä–∞–≤–∏—Ç—å¬ª
- –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –ø–µ—Ä–µ–¥ –ø–æ–≤—Ç–æ—Ä–æ–º: –ø—Ä–∏—á–∏–Ω–∞, –ø–æ–∑–∏—Ü–∏–∏ (–∫–æ–ª–∏—á–µ—Å—Ç–≤–æ, —É–¥–∞–ª–µ–Ω–∏–µ, –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ –Ω–æ–≤–æ–≥–æ —Ç–æ–≤–∞—Ä–∞)
- Callback-–ø—Ä–µ—Ñ–∏–∫—Å—ã: `woh_` (history browse), `wohe_` (history edit)
- –í–∞–ª–∏–¥–∞—Ü–∏—è callback_data: –≤—Å–µ int-–ø–∞—Ä—Å–∏–Ω–≥–∏ –æ–±—ë—Ä–Ω—É—Ç—ã –≤ try/except (ValueError, IndexError)
- –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ: tg_id + –¥–µ–π—Å—Ç–≤–∏–µ –≤–æ –≤—Å–µ—Ö —Ö—ç–Ω–¥–ª–µ—Ä–∞—Ö

**4. –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è save_to_history**
- `admin_approve` ‚Äî –ø–æ—Å–ª–µ —É—Å–ø–µ—à–Ω–æ–π –æ—Ç–ø—Ä–∞–≤–∫–∏ –≤ iiko
- `finalize_writeoff` (no-admin) ‚Äî –ø–æ—Å–ª–µ –ø—Ä—è–º–æ–π –æ—Ç–ø—Ä–∞–≤–∫–∏
- `hist_reuse` (no-admin) ‚Äî –ø–æ–≤—Ç–æ—Ä –∏–∑ –∏—Å—Ç–æ—Ä–∏–∏
- `hist_edit_send` (no-admin) ‚Äî –ø–æ–≤—Ç–æ—Ä —Å –∏–∑–º–µ–Ω–µ–Ω–∏—è–º–∏

**5. UI**
- –ö–Ω–æ–ø–∫–∞ ¬´üìã –ò—Å—Ç–æ—Ä–∏—è —Å–ø–∏—Å–∞–Ω–∏–π¬ª –≤ –ø–æ–¥–º–µ–Ω—é ¬´–î–æ–∫—É–º–µ–Ω—Ç—ã¬ª (`bot/handlers.py`)

**6. –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è**
- `docs/DATABASE.md`: —Ç–∞–±–ª–∏—Ü–∞ ‚Ññ28, —Å—á—ë—Ç—á–∏–∫–∏ 27‚Üí28, 14‚Üí15
- `docs/FILE_STRUCTURE.md`: writeoff_history.py, HistoryStates, –∫–Ω–æ–ø–∫–∞ ¬´üìã –ò—Å—Ç–æ—Ä–∏—è¬ª
- `PROJECT_MAP.md`: –æ–ø–∏—Å–∞–Ω–∏–µ —Ñ–∞–∑—ã, –Ω–∞–≤–∏–≥–∞—Ü–∏–æ–Ω–Ω–∞—è —Ç–∞–±–ª–∏—Ü–∞ 27‚Üí28 —Å—Ö–µ–º

---

### 2026-02-11 ‚Äî –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ GSheet + –º–∏–≥—Ä–∞—Ü–∏—è –º–∏–Ω/–º–∞–∫—Å –∏–∑ storeBalanceLevels + –æ—á–∏—Å—Ç–∫–∞

**1. –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ Google –¢–∞–±–ª–∏—Ü—ã**
- –ó–∞–≥–æ–ª–æ–≤–∫–∏ –ø–æ–¥—Ä–∞–∑–¥–µ–ª–µ–Ω–∏–π: merge_cells –∏—Å–ø—Ä–∞–≤–ª–µ–Ω (A1-notation –≤–º–µ—Å—Ç–æ keyword args)
- –°—É–±–∑–∞–≥–æ–ª–æ–≤–∫–∏ –ú–ò–ù/–ú–ê–ö–°: —Ü–µ–Ω—Ç—Ä–∏—Ä–æ–≤–∞–Ω–∏–µ (`horizontalAlignment: "CENTER"`)
- –®–∏—Ä–∏–Ω–∞ –ú–ò–ù/–ú–ê–ö–°: 60px (–±—ã–ª–æ 75px)

**2. –û–¥–Ω–æ—Ä–∞–∑–æ–≤–∞—è –º–∏–≥—Ä–∞—Ü–∏—è –º–∏–Ω/–º–∞–∫—Å –∏–∑ iiko**
- –ò–∑–≤–ª–µ—á–µ–Ω—ã `storeBalanceLevels` –∏–∑ `iiko_product.raw_json` ‚Üí 70 –∑–∞–ø–∏—Å–µ–π (product√ódept)
- –ú–∞–ø–ø–∏–Ω–≥: `store.parent_id ‚Üí dept_id`, –∞–≥—Ä–µ–≥–∞—Ü–∏—è `MAX(min, max)` –ø–æ —Å–∫–ª–∞–¥–∞–º
- –î–∞–Ω–Ω—ã–µ –∑–∞–ø–∏—Å–∞–Ω—ã –≤ GSheet ‚Üí —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞–Ω—ã –≤ `min_stock_level` (70 –∑–∞–ø–∏—Å–µ–π)

**3. –û—á–∏—Å—Ç–∫–∞ –æ–¥–Ω–æ—Ä–∞–∑–æ–≤–æ–≥–æ –∫–æ–¥–∞**
- –£–¥–∞–ª—ë–Ω –ø–∞—Ä–∞–º–µ—Ç—Ä `db_levels` –∏–∑ `sync_products_to_sheet()` (–æ–¥–Ω–æ—Ä–∞–∑–æ–≤—ã–π pre-fill –≤—ã–ø–æ–ª–Ω–µ–Ω)
- –£–¥–∞–ª—ë–Ω –±–ª–æ–∫ –∏–∑–≤–ª–µ—á–µ–Ω–∏—è storeBalanceLevels –∏–∑ `sync_nomenclature_to_gsheet()`
- –£–¥–∞–ª—ë–Ω –∏–º–ø–æ—Ä—Ç `Store` –∏–∑ `sync_min_stock.py`
- –ò—Å—Ç–æ—á–Ω–∏–∫ –º–∏–Ω/–º–∞–∫—Å —Ç–µ–ø–µ—Ä—å: —Ç–æ–ª—å–∫–æ —Ä—É—á–Ω–æ–π –≤–≤–æ–¥ –≤ GSheet –∏–ª–∏ —á–µ—Ä–µ–∑ Telegram-–±–æ—Ç

---

### 2026-02-11 ‚Äî Retry-–ª–æ–≥–∏–∫–∞ –¥–ª—è iiko API + ProductGroup + GSheet —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ + –≥—Ä—É–ø–ø–∏—Ä–æ–≤–∫–∞ –ø–æ –¥–µ—Ä–µ–≤—É

**1. Retry-–ª–æ–≥–∏–∫–∞ –¥–ª—è iiko API GET-–∑–∞–ø—Ä–æ—Å–æ–≤**

–ü—Ä–æ–±–ª–µ–º–∞: Store sync –≤—ã–ø–∞–¥–∞–ª —Å `Server disconnected without sending a response`.
–†–µ—à–µ–Ω–∏–µ: `_get_with_retry()` ‚Äî 3 –ø–æ–ø—ã—Ç–∫–∏, backoff 1‚Üí3‚Üí7 —Å–µ–∫. POST –±–µ–∑ retry.
–ò–∑–º–µ–Ω–µ–Ω–æ: `adapters/iiko_api.py` ‚Äî –≤—Å–µ 11 GET fetch-—Ñ—É–Ω–∫—Ü–∏–π.

**2. –ù–æ–º–µ–Ω–∫–ª–∞—Ç—É—Ä–Ω—ã–µ –≥—Ä—É–ø–ø—ã (ProductGroup)**

–ü—Ä–æ–±–ª–µ–º–∞: `sync_product_groups` —É–ø–æ–º–∏–Ω–∞–ª–∞—Å—å, –Ω–æ –Ω–µ —Å—É—â–µ—Å—Ç–≤–æ–≤–∞–ª–∞.
–†–µ—à–µ–Ω–∏–µ: –ü–æ–ª–Ω–æ—Ü–µ–Ω–Ω–∞—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è –Ω–æ–º–µ–Ω–∫–ª–∞—Ç—É—Ä–Ω—ã—Ö –≥—Ä—É–ø–ø.
–ò–∑–º–µ–Ω–µ–Ω–æ: `db/models.py` (ProductGroup), `adapters/iiko_api.py` (fetch_product_groups), `use_cases/sync.py` (sync_product_groups), `bot/handlers.py`.

**3. –§–∏–ª—å—Ç—Ä–∞—Ü–∏—è —Ç–æ–≤–∞—Ä–æ–≤ –ø–æ –¥–µ—Ä–µ–≤—É –≥—Ä—É–ø–ø –∏–∑ –ë–î**

–ü—Ä–æ–±–ª–µ–º–∞: –í GSheet –≤—ã–≥—Ä—É–∂–∞–ª–∏—Å—å –≤—Å–µ —Ç–æ–≤–∞—Ä—ã (GOODS), –∞ –Ω—É–∂–Ω–æ —Ç–æ–ª—å–∫–æ –∏–∑ –ø–∞–ø–∫–∏ ¬´–¢–æ–≤–∞—Ä—ã¬ª.
–†–µ—à–µ–Ω–∏–µ: –¢–∞–±–ª–∏—Ü–∞ `gsheet_export_group` + BFS-–æ–±—Ö–æ–¥ –¥–µ—Ä–µ–≤–∞ `iiko_product_group`.
–ò–∑–º–µ–Ω–µ–Ω–æ: `db/models.py` (GSheetExportGroup), `use_cases/sync_min_stock.py`.

**4. Google Sheets ‚Äî –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Å–∫—Ä—ã—Ç–∏—è —Å—Ç—Ä–æ–∫/—Å—Ç–æ–ª–±—Ü–æ–≤ + —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ**

–ü—Ä–æ–±–ª–µ–º–∞: Row 1 –∏ column B –Ω–µ —Å–∫—Ä—ã–≤–∞–ª–∏—Å—å.
–†–µ—à–µ–Ω–∏–µ: –†–∞–∑–¥–µ–ª–µ–Ω–∏–µ batch_update, SOLID_MEDIUM –≥—Ä–∞–Ω–∏—Ü—ã, 75px‚Üí60px.
–ò–∑–º–µ–Ω–µ–Ω–æ: `adapters/google_sheets.py`.

**5. –†–µ–æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏—è –∫–Ω–æ–ø–æ–∫ –±–æ—Ç–∞ + –∞—É–¥–∏—Ç**

–£–¥–∞–ª–µ–Ω—ã —Ç–µ—Å—Ç–æ–≤—ã–µ —Ñ–∞–π–ª—ã. –ü—Ä–æ–≤–µ—Ä–µ–Ω–æ: 0 stale-—Å—Å—ã–ª–æ–∫, 0 syntax errors.

---

### 2026-02-11 ‚Äî –ü–µ—Ä–µ–ø–∏—Å–∞–Ω–∞ —Å–∏—Å—Ç–µ–º–∞ –º–∏–Ω–∏–º–∞–ª—å–Ω—ã—Ö/–º–∞–∫—Å–∏–º–∞–ª—å–Ω—ã—Ö –æ—Å—Ç–∞—Ç–∫–æ–≤ (Google –¢–∞–±–ª–∏—Ü–∞)

**–ó–∞–¥–∞—á–∞:** –ü–µ—Ä–µ–ø–∏—Å–∞—Ç—å —Å–∏—Å—Ç–µ–º—É –º–∏–Ω/–º–∞–∫—Å –æ—Å—Ç–∞—Ç–∫–æ–≤. –ò—Å—Ç–æ—á–Ω–∏–∫ –∏—Å—Ç–∏–Ω—ã ‚Äî Google –¢–∞–±–ª–∏—Ü–∞ —Å–æ —Å—Ç–æ–ª–±—Ü–∞–º–∏ –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –ø–æ–¥—Ä–∞–∑–¥–µ–ª–µ–Ω–∏—è.

**–ù–æ–≤–∞—è –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞:**
- Google –¢–∞–±–ª–∏—Ü–∞ ‚Äî –µ–¥–∏–Ω—ã–π –∏—Å—Ç–æ—á–Ω–∏–∫ –º–∏–Ω/–º–∞–∫—Å —É—Ä–æ–≤–Ω–µ–π
- –§–æ—Ä–º–∞—Ç: —Å—Ç—Ä–æ–∫–∞ 1 = dept UUID (–º–µ—Ç–∞), —Å—Ç—Ä–æ–∫–∞ 2 = –∑–∞–≥–æ–ª–æ–≤–∫–∏, —Å—Ç—Ä–æ–∫–∞ 3+ = —Ç–æ–≤–∞—Ä—ã
- –ö–∞–∂–¥—ã–π department = 2 —Å—Ç–æ–ª–±—Ü–∞ (–º–∏–Ω, –º–∞–∫—Å)
- –ë–î (min_stock_level) = –∑–µ—Ä–∫–∞–ª–æ Google –¢–∞–±–ª–∏—Ü—ã

**–£–¥–∞–ª–µ–Ω–æ:** `update_product()` –∏–∑ iiko_api.py, `check_tomato.py`, `test_iiko_update.py`, –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç—å –æ—Ç storeBalanceLevels.

**–ò–∑–º–µ–Ω–µ–Ω–æ:** `adapters/google_sheets.py`, `use_cases/sync_min_stock.py`, `use_cases/edit_min_stock.py`, `use_cases/check_min_stock.py`, `bot/handlers.py`, `bot/min_stock_handlers.py`, `config.py`.

---

### 2026-02-10 ‚Äî –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –º–∏–Ω–∏–º–∞–ª—å–Ω—ã—Ö –æ—Å—Ç–∞—Ç–∫–æ–≤ —á–µ—Ä–µ–∑ –±–æ—Ç–∞

**–§–ª–æ—É:** –û—Ç—á—ë—Ç—ã ‚Üí ‚úèÔ∏è –ò–∑–º–µ–Ω–∏—Ç—å ‚Üí –ø–æ–∏—Å–∫ —Ç–æ–≤–∞—Ä–∞ ‚Üí –≤—ã–±–æ—Ä ‚Üí –≤—ã–±–æ—Ä —Å–∫–ª–∞–¥–∞ ‚Üí –≤–≤–æ–¥ –Ω–æ–≤–æ–≥–æ –º–∏–Ω ‚Üí iiko API + –ë–î.

**–ù–æ–≤—ã–µ —Ñ–∞–π–ª—ã:** `use_cases/edit_min_stock.py`, `bot/min_stock_handlers.py`.
**–ò–∑–º–µ–Ω–µ–Ω–æ:** `adapters/iiko_api.py` (update_product), `bot/handlers.py`, `main.py`.

---

### 2026-02-10 ‚Äî –ü—Ä–æ–≤–µ—Ä–∫–∞ –º–∏–Ω–∏–º–∞–ª—å–Ω—ã—Ö –æ—Å—Ç–∞—Ç–∫–æ–≤ –ø–æ –ø–æ–¥—Ä–∞–∑–¥–µ–ª–µ–Ω–∏—è–º

**–ó–∞–¥–∞—á–∞:** –°–æ–æ–±—â–µ–Ω–∏–µ –æ —Ç–æ–≤–∞—Ä–∞—Ö –Ω–∏–∂–µ –º–∏–Ω. –æ—Å—Ç–∞—Ç–∫–æ–≤ –¥–ª—è —Ä–µ—Å—Ç–æ—Ä–∞–Ω–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è.

**–†–µ—à–µ–Ω–∏–µ (v2):** storeBalanceLevels –∏–∑ raw_json, —Å—É–º–º–∏—Ä–æ–≤–∞–Ω–∏–µ –ø–æ –≤—Å–µ–º —Å–∫–ª–∞–¥–∞–º dept, MAX(min) –ø—Ä–∏ –¥–µ–¥—É–ø–ª–∏–∫–∞—Ü–∏–∏.

**–ù–æ–≤—ã–π —Ñ–∞–π–ª:** `use_cases/check_min_stock.py`.
**–ò–∑–º–µ–Ω–µ–Ω–æ:** `bot/handlers.py` (btn_check_min_stock).

---

### 2026-02-10 ‚Äî –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ: –º–∏–Ω. –æ—Å—Ç–∞—Ç–∫–∏ –Ω–µ –Ω–∞—Ö–æ–¥–∏–ª–∏—Å—å –¥–ª—è –Ω–æ–≤–æ–≥–æ —Ä–µ—Å—Ç–æ—Ä–∞–Ω–∞

**–ü—Ä–æ–±–ª–µ–º–∞:** `btn_check_min_stock` –Ω–µ –≤—ã–∑—ã–≤–∞–ª `sync_products()` ‚Äî storeBalanceLevels –≤ raw_json —É—Å—Ç–∞—Ä–µ–≤—à–∏–µ.
**–†–µ—à–µ–Ω–∏–µ:** –î–æ–±–∞–≤–ª–µ–Ω `sync_products()` –ø–µ—Ä–µ–¥ `sync_stock_balances()`.

---

### 2026-02-10 ‚Äî –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è –æ—Å—Ç–∞—Ç–∫–æ–≤ –ø–æ —Å–∫–ª–∞–¥–∞–º (sync_stock_balances)

**–ü–∞—Ç—Ç–µ—Ä–Ω:** Full-replace (DELETE + batch INSERT) –≤ –æ–¥–Ω–æ–π —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏.
**–ù–æ–≤—ã–π —Ñ–∞–π–ª:** `use_cases/sync_stock_balances.py`.
**–ò–∑–º–µ–Ω–µ–Ω–æ:** `adapters/iiko_api.py` (fetch_stock_balances), `db/models.py` (StockBalance).

---

### 2026-02-09 ‚Äî –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Ç–æ—á–Ω–æ—Å—Ç–∏ sync_stock_balances (timestamp)

**–ü—Ä–æ–±–ª–µ–º–∞:** timestamp –±–µ–∑ –≤—Ä–µ–º–µ–Ω–∏ ‚Üí iiko –æ—Ç–¥–∞–≤–∞–ª –æ—Å—Ç–∞—Ç–∫–∏ –Ω–∞ –Ω–∞—á–∞–ª–æ –¥–Ω—è.
**–†–µ—à–µ–Ω–∏–µ:** `datetime.now().strftime("%Y-%m-%dT%H:%M:%S")` –≤–º–µ—Å—Ç–æ `date.today().isoformat()`.
**–ò–∑–º–µ–Ω–µ–Ω–æ:** `adapters/iiko_api.py`, `use_cases/sync_stock_balances.py`.

---

### 2026-02-09 ‚Äî –ü–æ–ª–Ω–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –≤—Å–µ—Ö –¥–µ–π—Å—Ç–≤–∏–π

**–ü—Ä–æ–±–ª–µ–º–∞:** 94% —Ö—ç–Ω–¥–ª–µ—Ä–æ–≤ (62 –∏–∑ 68) –Ω–µ –∏–º–µ–ª–∏ entry-–ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è.
**–†–µ—à–µ–Ω–∏–µ:** –ï–¥–∏–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç `[module] –¥–µ–π—Å—Ç–≤–∏–µ tg:USER_ID, params`.
**–ò–∑–º–µ–Ω–µ–Ω–æ:** `handlers.py` (+25 –ª–æ–≥–æ–≤), `writeoff_handlers.py` (+23), `admin_handlers.py` (+10).

---

### 2026-02-09 ‚Äî –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è —Å–∫–æ—Ä–æ—Å—Ç–∏ —Å–æ–∑–¥–∞–Ω–∏—è –∞–∫—Ç–∞ —Å–ø–∏—Å–∞–Ω–∏—è

**–†–µ—à–µ–Ω–∏–µ:** asyncio.gather –¥–ª—è start_writeoff, batch-resolve –µ–¥–∏–Ω–∏—Ü, pre-warm admin_ids.
**–ò–∑–º–µ–Ω–µ–Ω–æ:** `writeoff.py`, `writeoff_handlers.py`.

---

### 2026-02-09 ‚Äî –ö–æ–º–ø–ª–µ–∫—Å–Ω–∞—è –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏

**–û–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏:** user_context 1 JOIN (‚àí800–º—Å), btn_check_min_stock asyncio.gather (‚àí3-5 —Å–µ–∫), check_min_stock asyncio.gather (‚àí400–º—Å), sync_stock_balances –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω—ã–π API+DB (‚àí300-500–º—Å).

---

### 2026-02-09 ‚Äî –§–æ–Ω–æ–≤–∞—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è –ø—Ä–∏ –æ—Ç–∫—Ä—ã—Ç–∏–∏ ¬´–î–æ–∫—É–º–µ–Ω—Ç—ã¬ª

**–†–µ—à–µ–Ω–∏–µ:** `asyncio.create_task` + `asyncio.gather(sync_products, sync_all_entities)` ‚Äî –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –∂–¥—ë—Ç.
**–ò–∑–º–µ–Ω–µ–Ω–æ:** `handlers.py` (btn_documents_menu, _bg_sync_for_documents).

---

### 2026-02-09 ‚Äî –ê–≤—Ç–æ-–≤—ã–±–æ—Ä —Å–∫–ª–∞–¥–∞ –ø–æ –¥–æ–ª–∂–Ω–æ—Å—Ç–∏ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –∞–∫—Ç–∞ —Å–ø–∏—Å–∞–Ω–∏—è

**–õ–æ–≥–∏–∫–∞:** –ë–æ—Ç-–∞–¥–º–∏–Ω ‚Üí —Ä—É—á–Ω–æ–π, –ë–∞—Ä ‚Üí –∞–≤—Ç–æ-–±–∞—Ä, –ö—É—Ö–Ω—è ‚Üí –∞–≤—Ç–æ-–∫—É—Ö–Ω—è, –ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ ‚Üí —Ä—É—á–Ω–æ–π.
**–ò–∑–º–µ–Ω–µ–Ω–æ:** `user_context.py` (role_name), `auth.py`, `writeoff.py`, `writeoff_handlers.py`.

---

### 2026-02-09 ‚Äî –ê—É–¥–∏—Ç –∏ —á–∏—Å—Ç–∫–∞ –∫–æ–¥–æ–≤–æ–π –±–∞–∑—ã

–£–¥–∞–ª–µ–Ω—ã: `f.json`, `FinTablo-v1-swagger (1).yaml`, `__pycache__/`.
–û—á–∏—â–µ–Ω—ã –Ω–µ–∏—Å–ø–æ–ª—å–∑—É–µ–º—ã–µ –∏–º–ø–æ—Ä—Ç—ã (9 —Ñ–∞–π–ª–æ–≤).
–ò—Å–ø—Ä–∞–≤–ª–µ–Ω—ã: writeoff_handlers.py _sending_lock, iiko_auth.py unreachable raise.

---

### 2026-02-08 ‚Äî Mirror-sync (–∑–µ—Ä–∫–∞–ª—å–Ω–∞—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è)

**–ü—Ä–æ–±–ª–µ–º–∞:** –£–¥–∞–ª—ë–Ω–Ω—ã–µ –≤ iiko/FinTablo –æ–±—ä–µ–∫—Ç—ã –æ—Å—Ç–∞–≤–∞–ª–∏—Å—å –≤ –ë–î.
**–†–µ—à–µ–Ω–∏–µ:** `_mirror_delete()` –ø–æ—Å–ª–µ –∫–∞–∂–¥–æ–≥–æ UPSERT. –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å: 0 –∑–∞–ø–∏—Å–µ–π ‚Üí skip.
**–ò–∑–º–µ–Ω–µ–Ω–æ:** `sync.py`, `sync_fintablo.py`. –ó–∞—Ç—Ä–æ–Ω—É—Ç—ã –≤—Å–µ 22 —Ç–∞–±–ª–∏—Ü—ã.

---

### 2026-02-08 ‚Äî –†–µ—Å—Ç—Ä—É–∫—Ç—É—Ä–∏–∑–∞—Ü–∏—è –º–µ–Ω—é –±–æ—Ç–∞

–ì–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é: üè† –°–º–µ–Ω–∏—Ç—å —Ä–µ—Å—Ç–æ—Ä–∞–Ω | üìÇ –ö–æ–º–∞–Ω–¥—ã | üìä –û—Ç—á—ë—Ç—ã | üìÑ –î–æ–∫—É–º–µ–Ω—Ç—ã.
**–ò–∑–º–µ–Ω–µ–Ω–æ:** `handlers.py`.

---

### 2026-02-08 ‚Äî In-memory –∫–µ—à –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (UserContext)

**–ü—Ä–æ–±–ª–µ–º–∞:** +400–º—Å –Ω–∞ –∫–∞–∂–¥—ã–π –∑–∞–ø—Ä–æ—Å department_id.
**–†–µ—à–µ–Ω–∏–µ:** dict –≤ RAM, –ª–µ–Ω–∏–≤–∞—è –∑–∞–≥—Ä—É–∑–∫–∞, –∏–Ω–≤–∞–ª–∏–¥–∞—Ü–∏—è –ø—Ä–∏ —Å–º–µ–Ω–µ —Ä–µ—Å—Ç–æ—Ä–∞–Ω–∞.
**–ù–æ–≤—ã–π —Ñ–∞–π–ª:** `use_cases/user_context.py`.
**–ò–∑–º–µ–Ω–µ–Ω–æ:** `handlers.py`, `auth.py`.
