# ‚úÖ –ò—Å—Ç–æ—Ä–∏—è –∏–∑–º–µ–Ω–µ–Ω–∏–π (Changelog)

> –ß–∏—Ç–∞–π —ç—Ç–æ—Ç —Ñ–∞–π–ª –ø—Ä–∏: –ø–æ–Ω–∏–º–∞–Ω–∏–µ –∏—Å—Ç–æ—Ä–∏–∏ —Ä–µ—à–µ–Ω–∏–π, –ø—Ä–æ–≤–µ—Ä–∫–∞ —á—Ç–æ —É–∂–µ –±—ã–ª–æ —Å–¥–µ–ª–∞–Ω–æ, –∫–æ–Ω—Ç–µ–∫—Å—Ç –ø—Ä–æ—à–ª—ã—Ö –±–∞–≥–æ–≤.

---

### 2026-02-20 ‚Äî –†–∞—Å—á—ë—Ç —Å–µ–±–µ—Å—Ç–æ–∏–º–æ—Å—Ç–∏: 3 –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏—Ö –±–∞–≥–∞ + —Ñ–∏–ª—å—Ç—Ä —Å–∫–ª–∞–¥–æ–≤ –ø–æ–¥—Ä–∞–∑–¥–µ–ª–µ–Ω–∏—è

**–§–∞–π–ª—ã:** `use_cases/outgoing_invoice.py`

#### 1. –§–∏–ª—å—Ç—Ä —Å–∫–ª–∞–¥–æ–≤ –ø–æ–¥—Ä–∞–∑–¥–µ–ª–µ–Ω–∏—è –¥–ª—è –°–¶–°

**–ë—ã–ª–æ:** –°–¶–° —Å—á–∏—Ç–∞–ª–∞—Å—å –ø–æ –æ—Å—Ç–∞—Ç–∫–∞–º **–≤—Å–µ—Ö** —Å–∫–ª–∞–¥–æ–≤ —Å–∏—Å—Ç–µ–º—ã. –ï—Å–ª–∏ –æ–¥–∏–Ω–∞–∫–æ–≤—ã–π —Ç–æ–≤–∞—Ä
—Ö—Ä–∞–Ω–∏—Ç—Å—è –Ω–∞ –Ω–µ—Å–∫–æ–ª—å–∫–∏—Ö —Å–∫–ª–∞–¥–∞—Ö —Ä–∞–∑–Ω—ã—Ö –ø–æ–¥—Ä–∞–∑–¥–µ–ª–µ–Ω–∏–π –ø–æ —Ä–∞–∑–Ω—ã–º —Ü–µ–Ω–∞–º ‚Äî —Ü–µ–Ω–∞ —Ä–∞–∑–º—ã–≤–∞–ª–∞—Å—å
–º–µ–∂–¥—É –Ω–∏–º–∏ –∏ –ø–µ—Ä–µ—Å—Ç–∞–≤–∞–ª–∞ –æ—Ç—Ä–∞–∂–∞—Ç—å —Ä–µ–∞–ª—å–Ω—É—é –∑–∞–∫—É–ø–æ—á–Ω—É—é —Ü–µ–Ω—É –¥–ª—è –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–π —Ç–æ—á–∫–∏.

**–°—Ç–∞–ª–æ:** `calculate_goods_cost_prices(store_ids)` –ø—Ä–∏–Ω–∏–º–∞–µ—Ç –º–Ω–æ–∂–µ—Å—Ç–≤–æ —Å–∫–ª–∞–¥–æ–≤
–≤—ã–±—Ä–∞–Ω–Ω–æ–≥–æ –ø–æ–¥—Ä–∞–∑–¥–µ–ª–µ–Ω–∏—è –∏–∑ GSheet ¬´–ù–∞—Å—Ç—Ä–æ–π–∫–∏¬ª. –°–¶–° —Å—á–∏—Ç–∞–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ –ø–æ —ç—Ç–∏–º —Å–∫–ª–∞–¥–∞–º.
**–î–≤—É—Ö—É—Ä–æ–≤–Ω–µ–≤—ã–π fallback:** dept-—Å–∫–ª–∞–¥—ã ‚Üí all-stores (–µ—Å–ª–∏ —Ç–æ–≤–∞—Ä –Ω–µ –Ω–∞—à—ë–ª—Å—è –≤ dept) ‚Üí
–ø–æ—Å–ª–µ–¥–Ω—è—è –Ω–∞–∫–ª–∞–¥–Ω–∞—è (–µ—Å–ª–∏ –Ω–µ—Ç –Ω–∏ –≤ –∫–∞–∫–∏—Ö –æ—Å—Ç–∞—Ç–∫–∞—Ö).

–î–æ —Ñ–∏–∫—Å–∞: 89 —Ç–æ–≤–∞—Ä–æ–≤ (–≤ —Ç.—á. –ø/—Ñ –ß–∏–∞–±–∞—Ç—Ç–∞, –®—É –º–µ—Ä–µ–Ω–≥–∞, –°—Ç—Ä–∞—á–∞—Ç–µ–ª–ª–∞) –ø–æ–ª—É—á–∞–ª–∏ —Ü–µ–Ω—É 0,
—Ç.–∫. —Ö—Ä–∞–Ω—è—Ç—Å—è –Ω–∞ –ø—Ä–æ–∏–∑–≤–æ–¥—Å—Ç–≤–µ–Ω–Ω—ã—Ö —Å–∫–ª–∞–¥–∞—Ö –¥—Ä—É–≥–æ–≥–æ –æ—Ç–¥–µ–ª–∞.

#### 2. –ë–∞–≥: –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω–æ–µ –ø–æ–ª–µ `"amount"` –¥–ª—è preparedCharts

**–ë—ã–ª–æ:** `_pick_effective(prepared_charts, "amount")` ‚Äî –ø–æ–ª–µ `amount` **–Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç**
–≤ –æ—Ç–≤–µ—Ç–µ API –¥–ª—è preparedCharts.

**–°—Ç–∞–ª–æ:** `_pick_effective(prepared_charts, "amountOut")` ‚Äî –≤ –æ–±–æ–∏—Ö —Ç–∏–ø–∞—Ö —Ç–µ—Ö–∫–∞—Ä—Ç
(`assemblyCharts` –∏ `preparedCharts`) –ø—Ä–∞–≤–∏–ª—å–Ω–æ–µ –ø–æ–ª–µ = `amountOut` (–∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∏–Ω–≥—Ä–µ–¥–∏–µ–Ω—Ç–∞
–ø–æ—Å–ª–µ –ø–æ—Ç–µ—Ä—å –ø—Ä–∏ –æ–±—Ä–∞–±–æ—Ç–∫–µ).

#### 3. –ë–∞–≥: –Ω–µ –¥–µ–ª–∏–ª–æ—Å—å –Ω–∞ `assembledAmount`

**–ë—ã–ª–æ:** `all_costs[dish_id] = round(total_cost, 2)` ‚Äî —Å—É–º–º–∞—Ä–Ω–∞—è —Å—Ç–æ–∏–º–æ—Å—Ç—å –∏–Ω–≥—Ä–µ–¥–∏–µ–Ω—Ç–æ–≤
–≤—Å–µ–π –ø–∞—Ä—Ç–∏–∏ –∑–∞–ø–∏—Å—ã–≤–∞–ª–∞—Å—å –∫–∞–∫ —Ü–µ–Ω–∞ **–æ–¥–Ω–æ–π –µ–¥–∏–Ω–∏—Ü—ã**.

**–°—Ç–∞–ª–æ:** `cost_per_unit = total_cost / assembledAmount`. –ü–æ–ª–µ `assembledAmount` –Ω–∞ —É—Ä–æ–≤–Ω–µ
—Ç–µ—Ö–∫–∞—Ä—Ç—ã —É–∫–∞–∑—ã–≤–∞–µ—Ç, —Å–∫–æ–ª—å–∫–æ –µ–¥–∏–Ω–∏—Ü –±–ª—é–¥–∞/–ø/—Ñ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç —Ä–µ—Ü–µ–ø—Ç. –ü—Ä–∏–º–µ—Ä: ¬´–ø/—Ñ –ì—Ä–µ–Ω–∫–∏ –Ω–∞ –¶–µ–∑–∞—Ä—å¬ª
–∏–º–µ–µ—Ç `assembledAmount = 0.165` (–ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç 165 –≥), –∞ –Ω–µ 1 –ø–æ—Ä—Ü–∏—é.

**–≠—Ñ—Ñ–µ–∫—Ç –Ω–∞ —Ü–µ–Ω—ã (–ø—Ä–∏–º–µ—Ä):**

| –ë–ª—é–¥–æ | –î–æ | –ü–æ—Å–ª–µ |
|---|---|---|
| –ì—Ä–µ–Ω–∫–∏ –Ω–∞ —Ü–µ–∑–∞—Ä—å —Ü–µ—Ö | 39.75 | 250.74 |
| –°–æ—É—Å —Ñ–∏—à –º–∞–π–æ —Ü–µ—Ö | 73.76 | 253.81 |
| –®—É —à–æ–∫–æ–ª–∞–¥–Ω—ã–µ —Ü–µ—Ö | 211.73 | 32.89 |
| –ü—Ä_–®—É —à–æ–∫–æ–ª–∞–¥–Ω—ã–π | 423.47 | 65.78 |
| –ì–æ–≤—è–∂—å—è –≤—ã—Ä–µ–∑–∫–∞ –Ω–∞ —Ç–∞—Ä —Ç–∞—Ä —Ü–µ—Ö | 1499.80 | 1499.80 ‚úì (–Ω–µ –∏–∑–º–µ–Ω–∏–ª–∞—Å—å) |

---

### 2026-02-20 ‚Äî Redis FSM + Persistent Pending Writeoffs

**–¶–µ–ª—å:** –ë–æ—Ç –ø–µ—Ä–µ–∂–∏–≤–∞–µ—Ç —Ä–µ—Å—Ç–∞—Ä—Ç –±–µ–∑ –ø–æ—Ç–µ—Ä–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏—Ö —Å–µ—Å—Å–∏–π –∏ –æ–∂–∏–¥–∞—é—â–∏—Ö –∞–∫—Ç–æ–≤ —Å–ø–∏—Å–∞–Ω–∏—è.

#### 1. FSM Storage ‚Üí Redis (`RedisStorage`)

**–ë—ã–ª–æ:** `Dispatcher()` ‚Äî `MemoryStorage` –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é. –ü—Ä–∏ —Ä–µ—Å—Ç–∞—Ä—Ç–µ –≤—Å–µ FSM-—Å–æ—Å—Ç–æ—è–Ω–∏—è
(—à–∞–≥ –¥–∏–∞–ª–æ–≥–∞, –Ω–∞–∫–æ–ø–ª–µ–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ) —Ç–µ—Ä—è–ª–∏—Å—å. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å ¬´–∑–∞–≤–∏—Å–∞–ª¬ª –±–µ–∑ –æ—Ç–≤–µ—Ç–∞.

**–°—Ç–∞–ª–æ:** `Dispatcher(storage=RedisStorage.from_url(REDIS_URL))`. FSM-—Å–æ—Å—Ç–æ—è–Ω–∏—è —Ö—Ä–∞–Ω—è—Ç—Å—è
–≤ Redis –Ω–∞ Railway ‚Üí –ø–µ—Ä–µ–∂–∏–≤–∞—é—Ç —Ä–µ—Å—Ç–∞—Ä—Ç. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø—Ä–æ–¥–æ–ª–∂–∞–µ—Ç flow —Å —Ç–æ–≥–æ –∂–µ —à–∞–≥–∞.

**–§–∞–π–ª—ã:** `config.py` (+`REDIS_URL`), `main.py` (RedisStorage), `requirements.txt` (+`redis>=5.0.0`)

#### 2. Pending Writeoffs ‚Üí PostgreSQL

**–ë—ã–ª–æ:** `_pending: dict[str, PendingWriteoff] = {}` –≤ RAM. –ü—Ä–∏ —Ä–µ—Å—Ç–∞—Ä—Ç–µ –∞–∫—Ç—ã,
–æ–∂–∏–¥–∞—é—â–∏–µ –ø—Ä–æ–≤–µ—Ä–∫–∏ –∞–¥–º–∏–Ω–æ–º, —Ç–µ—Ä—è–ª–∏—Å—å –±–µ–∑–≤–æ–∑–≤—Ä–∞—Ç–Ω–æ (–±—ã–ª warning –≤ –ª–æ–≥–∞—Ö).

**–°—Ç–∞–ª–æ:** –¢–∞–±–ª–∏—Ü–∞ `pending_writeoff` –≤ PostgreSQL —Å –ø–æ–ª—è–º–∏: `doc_id`, `author_chat_id`,
`store_id`, `account_id`, `items` (JSONB), `admin_msg_ids` (JSONB), `is_locked` (–∞—Ç–æ–º–∞—Ä–Ω—ã–π –ª–æ–∫).
TTL 24—á ‚Äî –∞–≤—Ç–æ–æ—á–∏—Å—Ç–∫–∞ expired –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤. –ö–æ–Ω–∫—É—Ä–µ–Ω—Ç–Ω–æ—Å—Ç—å: `UPDATE ... WHERE is_locked = false`.

**–§–∞–π–ª—ã:** `db/models.py` (+`PendingWriteoffDoc`), `use_cases/pending_writeoffs.py` (–ø–æ–ª–Ω—ã–π —Ä–µ—Ä–∞–π—Ç sync‚Üíasync),
`bot/writeoff_handlers.py` (+`await` –Ω–∞ ~40 –≤—ã–∑–æ–≤–∞—Ö), `db/init_db.py` (+–∏–Ω–¥–µ–∫—Å—ã)

#### 3. –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è

–û–±–Ω–æ–≤–ª–µ–Ω—ã: `PROJECT_MAP.md` (—Å–µ–∫—Ü–∏–∏ 5, 10), `SECURITY_AND_RELIABILITY.md` (—Å–µ–∫—Ü–∏—è 7, —á–µ–∫–ª–∏—Å—Ç), `DATABASE.md`

---

### 2026-02-20 ‚Äî OCR –º–∞–ø–ø–∏–Ω–≥: –¥—Ä–æ–ø–¥–∞—É–Ω, –¥–µ–¥—É–ø–ª–∏–∫–∞—Ü–∏—è, UX-–∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è

**–ö–æ–º–º–∏—Ç—ã:** `4892cc3` ‚Üí `b7ce77d`

#### Dropdown ¬´–ú–∞–ø–ø–∏–Ω–≥ –ò–º–ø–æ—Ä—Ç¬ª: –≤—Å–µ —Ç–æ–≤–∞—Ä—ã –≤–∏–¥–∏–º—ã –ø–æ –ø–æ–∏—Å–∫—É

**–ü—Ä–æ–±–ª–µ–º–∞:** Google Sheets –ø–æ–∏—Å–∫ –≤ dropdown ‚Äî **–ø–æ –ø—Ä–µ—Ñ–∏–∫—Å—É**. –¢–æ–≤–∞—Ä—ã `—Ç_–±—É—Ç—ã–ª–∫–∞`,
`–ø/—Ñ —Å–∏—Ä–æ–ø` –∏ –ø—Ä–æ—á–∏–µ —Å —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–∏–º–∏ –ø—Ä–µ—Ñ–∏–∫—Å–∞–º–∏ –±—ã–ª–∏ –Ω–µ–¥–æ—Å—Ç–∏–∂–∏–º—ã ‚Äî –æ–Ω–∏ –ª–µ–∂–∞–ª–∏ –≤
–∫–æ–Ω—Ü–µ —Å–ø–∏—Å–∫–∞ (lower-case —Å–æ—Ä—Ç–∏—Ä—É–µ—Ç—Å—è –ø–æ—Å–ª–µ upper-case –≤ —Ä—É—Å—Å–∫–æ–º), –∞ –ø–æ–∏—Å–∫ ¬´–±—É—Ç¬ª
–Ω–∞—Ö–æ–¥–∏–ª —Ç–æ–ª—å–∫–æ ¬´–ë—É—Ç—ã–ª–∫–∞¬ª.

**–†–µ—à–µ–Ω–∏–µ: —Å–∫—Ä—ã—Ç—ã–π —Å–ø—Ä–∞–≤–æ—á–Ω—ã–π –ª–∏—Å—Ç + display_name**
- `adapters/google_sheets.py` ‚Äî –¥–æ–±–∞–≤–ª–µ–Ω –ª–∏—Å—Ç `¬´–ú–∞–ø–ø–∏–Ω–≥ –°–ø—Ä–∞–≤–æ—á–Ω–∏–∫¬ª` (—Å–∫—Ä—ã—Ç—ã–π):
  - `_write_ref_column()` ‚Äî –ø–∏—à–µ—Ç –∏–º–µ–Ω–∞ –≤ –∫–æ–ª–æ–Ω–∫—É A
  - `refresh_import_sheet_dropdown()` ‚Äî –ø–µ—Ä–µ–∑–∞–ø–∏—Å—ã–≤–∞–µ—Ç ref-–ª–∏—Å—Ç + —Å—Ç–∞–≤–∏—Ç `ONE_OF_RANGE` –≤–∞–ª–∏–¥–∞—Ü–∏—é –Ω–∞ –≤—Å–µ —Ç–æ–≤–∞—Ä–Ω—ã–µ —Å—Ç—Ä–æ–∫–∏ (–¥–∏–∞–ø–∞–∑–æ–Ω `prd_start_row` + 1000)
- `use_cases/ocr_mapping.py`:
  - `_strip_tech_prefix()` ‚Äî —É–±–∏—Ä–∞–µ—Ç `—Ç_`, `–ø/—Ñ `, `–ø/—Ñ_`, `–ø/—Ñ` –∏–∑ –∏–º–µ–Ω–∏
  - `_load_iiko_goods_products()` ‚Äî –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Ç–æ–ª—å–∫–æ GOODS; –∫–∞–∂–¥–∞—è –∑–∞–ø–∏—Å—å —Å–æ–¥–µ—Ä–∂–∏—Ç `name` (—Ä–µ–∞–ª—å–Ω–æ–µ –≤ iiko) –∏ `display_name` (–±–µ–∑ –ø—Ä–µ—Ñ–∏–∫—Å–∞); —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞ –ø–æ `display_name.lower()`
  - –í ref-–ª–∏—Å—Ç –ø–∏—à—É—Ç—Å—è `display_name` ‚Üí ¬´–±—É—Ç—ã–ª–∫–∞ 2–ª –ü–≠–¢ —Å –∫—Ä—ã—à–∫–æ–π¬ª –≤–º–µ—Å—Ç–æ ¬´—Ç_–±—É—Ç—ã–ª–∫–∞ 2–ª –ü–≠–¢ —Å –∫—Ä—ã—à–∫–æ–π¬ª
  - `finalize_transfer()` ‚Äî –ø—Ä–∏ –ø–æ–∏—Å–∫–µ –ø–æ iiko_name –¥–æ–±–∞–≤–ª—è—é—Ç—Å—è reverse-–∞–ª–∏–∞—Å—ã: ¬´–±—É—Ç—ã–ª–∫–∞ 2–ª –ü–≠–¢ —Å –∫—Ä—ã—à–∫–æ–π¬ª ‚Üí –Ω–∞—Ö–æ–¥–∏—Ç ¬´—Ç_–±—É—Ç—ã–ª–∫–∞ 2–ª –ü–≠–¢ —Å –∫—Ä—ã—à–∫–æ–π¬ª –≤ –ë–î
  - `refresh_ref_sheet()` ‚Äî –æ–±–Ω–æ–≤–ª—è–µ—Ç ref-–ª–∏—Å—Ç –∞–∫—Ç—É–∞–ª—å–Ω—ã–º–∏ GOODS display-–∏–º–µ–Ω–∞–º–∏
- –ö–Ω–æ–ø–∫–∞ **¬´üîÑ –û–±–Ω–æ–≤–∏—Ç—å —Å–ø–∏—Å–æ–∫ —Ç–æ–≤–∞—Ä–æ–≤¬ª** –≤ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–∏ –±—É—Ö–≥–∞–ª—Ç–µ—Ä—É ‚Üí `cb_refresh_mapping_ref` handler
- –ï–∂–µ–¥–Ω–µ–≤–Ω–∞—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è (—à–∞–≥ 6) ‚Äî –æ–±–Ω–æ–≤–ª—è–µ—Ç ref-–ª–∏—Å—Ç –≤ 07:00
- –†–µ–∑—É–ª—å—Ç–∞—Ç: –ø–æ–∏—Å–∫ ¬´–±—É—Ç¬ª –Ω–∞—Ö–æ–¥–∏—Ç –≤—Å–µ ¬´–±—É—Ç—ã–ª–∫–∞*¬ª –≤–∫–ª—é—á–∞—è ¬´—Ç_–±—É—Ç—ã–ª–∫–∞*¬ª

#### iiko XML: —Å—Ç–∞—Ç—É—Å –Ω–∞–∫–ª–∞–¥–Ω–æ–π
- `adapters/iiko_api.py` ‚Äî `documentStatus` –∏–∑–º–µ–Ω—ë–Ω `CLOSED` ‚Üí `PROCESSED` (–ø—Ä–∞–≤–∏–ª—å–Ω—ã–π —Å—Ç–∞—Ç—É—Å –ø–æ iiko XML-—Å—Ö–µ–º–µ)

#### –î–µ–¥—É–ø–ª–∏–∫–∞—Ü–∏—è OcrDocument
- `_save_ocr_document()` ‚Äî –ø–µ—Ä–µ–¥ —Å–æ–∑–¥–∞–Ω–∏–µ–º –Ω–æ–≤–æ–≥–æ –¥–æ–∫—É–º–µ–Ω—Ç–∞ —É–¥–∞–ª—è–µ—Ç —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ `recognized`/`pending_mapping` —Å —Ç–µ–º –∂–µ `doc_number + doc_type` (—Å–Ω–∞—á–∞–ª–∞ `ocr_item`, –∑–∞—Ç–µ–º `ocr_document` ‚Äî FK –±–µ–∑ ON DELETE CASCADE)
- `get_pending_ocr_documents(doc_ids=‚Ä¶)` ‚Äî –ø—Ä–∏ –∑–∞–ø—Ä–æ—Å–µ –ø–æ ID —Å—Ç–∞—Ç—É—Å –Ω–µ —Ñ–∏–ª—å—Ç—Ä—É–µ—Ç—Å—è (–¥–æ–∫—É–º–µ–Ω—Ç—ã —É–∂–µ –≤ `pending_mapping`); –¥–æ–±–∞–≤–ª–µ–Ω–∞ Python-–¥–µ–¥—É–ø–ª–∏–∫–∞—Ü–∏—è –ø–æ `(doc_number, doc_type)` –∫–∞–∫ —Å—Ç—Ä–∞—Ö–æ–≤–∫–∞
- –£–¥–∞–ª–µ–Ω–æ 20 –Ω–∞–∫–æ–ø–∏–≤—à–∏—Ö—Å—è –¥—É–±–ª–µ–π –∏–∑ –ë–î –≤—Ä—É—á–Ω—É—é

#### –ü–æ—Å–ª–µ –º–∞–ø–ø–∏–Ω–≥–∞ ‚Äî —Ç–æ–ª—å–∫–æ –¥–æ–∫—É–º–µ–Ω—Ç—ã —Ç–µ–∫—É—â–µ–π —Å–µ—Å—Å–∏–∏
- `_handle_mapping_done()` —Ç–µ–ø–µ—Ä—å –±–µ—Ä—ë—Ç `_pending_doc_ids.pop(tg_id)` –∏ –≥—Ä—É–∑–∏—Ç –¥–æ–∫—É–º–µ–Ω—Ç—ã **—ç—Ç–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏–∑ —ç—Ç–æ–π –∑–∞–≥—Ä—É–∑–∫–∏** —á–µ—Ä–µ–∑ `get_pending_ocr_documents(doc_ids=current_doc_ids)` ‚Äî —Ä–∞–Ω–µ–µ –≥—Ä—É–∑–∏–ª–∏—Å—å –≤—Å–µ `pending_mapping` –≤—Å–µ—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –∑–∞ –≤—Å—ë –≤—Ä–µ–º—è

#### UX-–∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è
- `_repush()` ‚Äî —Ç–µ–ø–µ—Ä—å —Ä–µ–¥–∞–∫—Ç–∏—Ä—É–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–µ –Ω–∞ –º–µ—Å—Ç–µ —á–µ—Ä–µ–∑ `bot.edit_message_text(chat_id, message_id, ‚Ä¶)`. Fallback: delete + send –Ω–æ–≤—ã–º, –µ—Å–ª–∏ edit –Ω–µ —É–¥–∞–ª–æ—Å—å
- –ü—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ ¬´‚ö†Ô∏è –ù–µ –≤—Å–µ –ø–æ–∑–∏—Ü–∏–∏ –∑–∞–ø–æ–ª–Ω–µ–Ω—ã¬ª —Å–æ–¥–µ—Ä–∂–∏—Ç –∫–Ω–æ–ø–∫—É **¬´‚úÖ –ú–∞–ø–ø–∏–Ω–≥ –≥–æ—Ç–æ–≤¬ª** –¥–ª—è –ø–æ–≤—Ç–æ—Ä–Ω–æ–π –æ—Ç–ø—Ä–∞–≤–∫–∏
- **–ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–π –±–∞–≥:** `async def _handle_mapping_done(placeholder, tg_id)` ‚Äî —Å—Ç—Ä–æ–∫–∞ —Å –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ–º —Ñ—É–Ω–∫—Ü–∏–∏ –±—ã–ª–∞ —É—Ç–µ—Ä—è–Ω–∞, —Ç–µ–ª–æ —Ñ—É–Ω–∫—Ü–∏–∏ –≤–∏—Å–µ–ª–æ –≤–Ω—É—Ç—Ä–∏ `cb_refresh_mapping_ref`. –≠—Ç–æ –≤—ã–∑—ã–≤–∞–ª–æ `NameError` –ø—Ä–∏ –Ω–∞–∂–∞—Ç–∏–∏ ¬´–ú–∞–ø–ø–∏–Ω–≥ –≥–æ—Ç–æ–≤¬ª ‚Äî –±–æ—Ç –∑–∞–≤–∏—Å–∞–ª –Ω–∞ ¬´‚è≥ –ü—Ä–æ–≤–µ—Ä—è—é‚Ä¶¬ª –Ω–∞–≤—Å–µ–≥–¥–∞
- `_save_ocr_document()` ‚Äî –∏—Å–ø—Ä–∞–≤–ª–µ–Ω `NameError: name 'select' is not defined` (–∏–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω –∫–∞–∫ `_sa_select`)

#### –ï–∂–µ–¥–Ω–µ–≤–Ω–∞—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è: 6 —à–∞–≥–æ–≤
`use_cases/scheduler.py` ‚Äî —Ä–∞—Å—à–∏—Ä–µ–Ω—ã —à–∞–≥–∏ daily sync:
1. iiko ‚Üí –ë–î (–≤—Å–µ —Å–ø—Ä–∞–≤–æ—á–Ω–∏–∫–∏)
2. FinTablo ‚Üí –ë–î
3. –û—Å—Ç–∞—Ç–∫–∏ –ø–æ —Å–∫–ª–∞–¥–∞–º ‚Üí –ë–î
4. GSheet –º–∏–Ω/–º–∞–∫—Å ‚Üí –ë–î
5. –ë–î –Ω–æ–º–µ–Ω–∫–ª–∞—Ç—É—Ä–∞ ‚Üí GSheet ¬´–ú–∏–Ω –æ—Å—Ç–∞—Ç–∫–∏¬ª
6. **NEW** –ë–î GOODS display-–∏–º–µ–Ω–∞ ‚Üí GSheet ¬´–ú–∞–ø–ø–∏–Ω–≥ –°–ø—Ä–∞–≤–æ—á–Ω–∏–∫¬ª

---

### 2026-02-19 ‚Äî OCR Pipeline: –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è –ù–î–° –∏ –≥—Ä—É–ø–ø–∏—Ä–æ–≤–∫–∏ –º–Ω–æ–≥–æ—Å—Ç—Ä–∞–Ω–∏—á–Ω—ã—Ö –Ω–∞–∫–ª–∞–¥–Ω—ã—Ö

**–ö–æ–º–º–∏—Ç:** `31537f9`  
**–§–∞–π–ª:** `use_cases/ocr_pipeline.py`

**–ë–∞–≥ 1 ‚Äî –ª–æ–∂–Ω–æ–µ –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ ¬´—Å—É–º–º–∞ –Ω–µ —Å–æ–≤–ø–∞–¥–∞–µ—Ç —Å —Ä–∞—Å—á—ë—Ç–Ω–æ–π¬ª:**
- **–°–∏–º–ø—Ç–æ–º:** –î–ª—è –ø–æ–∑–∏—Ü–∏–∏ —Å –ù–î–° 22% –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ `—Å—É–º–º–∞ 850.0 –Ω–µ —Å–æ–≤–ø–∞–¥–∞–µ—Ç —Å —Ä–∞—Å—á—ë—Ç–Ω–æ–π 696.7`
- **–ü—Ä–∏—á–∏–Ω–∞:** `22%` –æ—Ç—Å—É—Ç—Å—Ç–≤–æ–≤–∞–ª–∞ –≤ `_VAT_RATE_MAP` ‚Üí `_parse_vat("22%") = None` ‚Üí `vat_dec = 0` ‚Üí expected = qty √ó price –±–µ–∑ –ù–î–°
- **–ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ 1:** –î–æ–±–∞–≤–ª–µ–Ω–æ `"22%": Decimal("0.22")` –≤ `_VAT_RATE_MAP`
- **–ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ 2:** –í–≤–µ–¥—ë–Ω —Ñ–ª–∞–≥ `vat_unknown = True` –∫–æ–≥–¥–∞ —Å—Ç–∞–≤–∫–∞ –µ—Å—Ç—å –≤ –¥–æ–∫—É–º–µ–Ω—Ç–µ –Ω–æ –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç –≤ –∫–∞—Ä—Ç–µ ‚Äî –≤ —ç—Ç–æ–º —Å–ª—É—á–∞–µ –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ –æ –Ω–µ—Å–æ–≤–ø–∞–¥–µ–Ω–∏–∏ —Å—É–º–º—ã **–Ω–µ –≥–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç—Å—è**: —Å—É–º–º–∞ –∏–∑ –¥–æ–∫—É–º–µ–Ω—Ç–∞ (—Å—Ç–æ–ª–±–µ—Ü ¬´–°—Ç–æ–∏–º–æ—Å—Ç—å —Å –Ω–∞–ª–æ–≥–æ–º¬ª) –ø—Ä–∏–Ω–∏–º–∞–µ—Ç—Å—è –∫–∞–∫ –∞–≤—Ç–æ—Ä–∏—Ç–µ—Ç–Ω–∞—è

**–ë–∞–≥ 2 ‚Äî –≤—Ç–æ—Ä–∞—è —Å—Ç—Ä–∞–Ω–∏—Ü–∞ –Ω–∞–∫–ª–∞–¥–Ω–æ–π –Ω–µ –æ–±—ä–µ–¥–∏–Ω—è–µ—Ç—Å—è —Å –ø–µ—Ä–≤–æ–π:**
- **–°–∏–º–ø—Ç–æ–º:** –î–≤—É—Ö—Å—Ç—Ä–∞–Ω–∏—á–Ω–∞—è –Ω–∞–∫–ª–∞–¥–Ω–∞—è (–õ–∏—Å—Ç 1 / –õ–∏—Å—Ç 2) –ø–æ—è–≤–ª—è–ª–∞—Å—å –∫–∞–∫ –¥–≤–∞ –æ—Ç–¥–µ–ª—å–Ω—ã—Ö –¥–æ–∫—É–º–µ–Ω—Ç–∞
- **–ü—Ä–∏—á–∏–Ω–∞:** ¬´–õ–∏—Å—Ç 2¬ª –Ω–µ —Å–æ–¥–µ—Ä–∂–∏—Ç —à–∞–ø–∫—É —Å doc_number ‚Üí `group_key` –Ω–µ —Å—Ç—Ä–æ–∏–ª—Å—è ‚Üí —Å—Ç—Ä–∞–Ω–∏—Ü–∞ —É—Ö–æ–¥–∏–ª–∞ –≤ `single_*`
- **–ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ:** –î–≤—É—Ö–ø—Ä–æ—Ö–æ–¥–Ω–∞—è –≥—Ä—É–ø–ø–∏—Ä–æ–≤–∫–∞:
  - –ü—Ä–æ—Ö–æ–¥ 1: –≤—Å–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã —Å —è–≤–Ω—ã–º `group_key` + —Å—Ç—Ä–∞–Ω–∏—Ü–∞ 1 –±–µ–∑ –∫–ª—é—á–∞ (–∫–∞–∫ —Ä–∞–Ω—å—à–µ)
  - –ü—Ä–æ—Ö–æ–¥ 2: ¬´–æ—Å–∏—Ä–æ—Ç–µ–≤—à–∏–µ¬ª —Å—Ç—Ä–∞–Ω–∏—Ü—ã 2+ –±–µ–∑ `group_key` ‚Üí —Å–æ–ø–æ—Å—Ç–∞–≤–ª–µ–Ω–∏–µ –ø–æ `supplier_inn + date`
  - –ï—Å–ª–∏ —Å–æ–≤–ø–∞–¥–µ–Ω–∏–µ –Ω–∞–π–¥–µ–Ω–æ ‚Üí –ø—Ä–∏—Å–æ–µ–¥–∏–Ω—è–µ–º –∫ —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–π –≥—Ä—É–ø–ø–µ
  - –ï—Å–ª–∏ –Ω–µ—Ç —Å–æ–≤–ø–∞–¥–µ–Ω–∏—è ‚Üí —Å–æ–∑–¥–∞—ë–º –Ω–æ–≤—ã–π –æ–¥–∏–Ω–æ—á–Ω—ã–π –¥–æ–∫—É–º–µ–Ω—Ç + `logger.warning`

**–¢–µ—Å—Ç—ã:** 67 ‚úÖ

---

### 2026-02-19 ‚Äî OCR ‚Üí iiko: –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –æ—Ç–ø—Ä–∞–≤–∫–∞ –ø—Ä–∏—Ö–æ–¥–Ω—ã—Ö –Ω–∞–∫–ª–∞–¥–Ω—ã—Ö

**–¶–µ–ª—å:** –ü–æ—Å–ª–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è –º–∞–ø–ø–∏–Ω–≥–∞ –±—É—Ö–≥–∞–ª—Ç–µ—Ä –≤–∏–¥–∏—Ç –ø—Ä–µ–≤—å—é –ø—Ä–∏—Ö–æ–¥–Ω—ã—Ö –Ω–∞–∫–ª–∞–¥–Ω—ã—Ö –∏ –æ–¥–Ω–æ–π –∫–Ω–æ–ø–∫–æ–π –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –∏—Ö –≤ iiko (POST XML).

**–ù–æ–≤—ã–µ —Ñ–∞–π–ª—ã:**
- `use_cases/incoming_invoice.py` ‚Äî –ø–æ–ª–Ω–∞—è –±–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫–∞ –ø–æ–¥–≥–æ—Ç–æ–≤–∫–∏ –∏ –æ—Ç–ø—Ä–∞–≤–∫–∏ –Ω–∞–∫–ª–∞–¥–Ω—ã—Ö:
  `get_pending_ocr_documents`, `build_iiko_invoices`, `send_invoices_to_iiko`,
  `format_invoice_preview`, `format_send_result`, `mark_documents_imported`, `mark_documents_cancelled`,
  `_load_product_units` (main_unit UUID –¥–ª—è amountUnit), `_load_supplier_ids_from_db`
- `tests/test_store_type.py` ‚Äî 26 —Ç–µ—Å—Ç–æ–≤ –¥–ª—è `_normalize_store_type` + `extract_store_type`
- `tests/test_incoming_invoice.py` ‚Äî 23 —Ç–µ—Å—Ç–∞ –¥–ª—è XML, –ø—Ä–µ–≤—å—é, —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤
- `tests/test_build_invoices.py` ‚Äî 9 async-—Ç–µ—Å—Ç–æ–≤ `build_iiko_invoices` (mocked DB)
- `pytest.ini` ‚Äî `asyncio_mode = auto`, `testpaths = tests`

**–ò–∑–º–µ–Ω—ë–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã:**
- `use_cases/product_request.py` ‚Äî –¥–æ–±–∞–≤–ª–µ–Ω—ã `_STORE_TYPE_ALIASES` + `_normalize_store_type()`:
  ¬´–•–æ–∑. —Ç–æ–≤–∞—Ä—ã (–ú–æ—Å–∫–æ–≤—Å–∫–∏–π)¬ª‚Üí¬´—Ö–æ–∑—ã¬ª, ¬´–¢–ú–¶ –°–µ–ª—å–º–∞¬ª‚Üí¬´—Ç–º—Ü¬ª, –º–∞–ø–ø–∏–Ω–≥ –ø–æ prefix
- `bot/document_handlers.py`:
  - `_save_ocr_document` —Ç–µ–ø–µ—Ä—å —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç `supplier_id`
  - `_handle_mapping_done` –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç –ø—Ä–µ–≤—å—é –Ω–∞–∫–ª–∞–¥–Ω—ã—Ö + –∫–Ω–æ–ø–∫–∏ ¬´üì§ –û—Ç–ø—Ä–∞–≤–∏—Ç—å –≤ iiko¬ª / ¬´‚ùå –û—Ç–º–µ–Ω–∏—Ç—å¬ª
  - –î–æ–±–∞–≤–ª–µ–Ω—ã callback-—Ö–µ–Ω–¥–ª–µ—Ä—ã `cb_iiko_invoice_send` –∏ `cb_iiko_invoice_cancel`
  - `_pending_invoices: dict[int, list[dict]]` –¥–ª—è in-memory —Ö—Ä–∞–Ω–µ–Ω–∏—è –¥–æ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è

**–ö–ª—é—á–µ–≤—ã–µ —Ä–µ—à–µ–Ω–∏—è:**
- –û–¥–∏–Ω OcrDocument ‚Üí N iiko-–Ω–∞–∫–ª–∞–¥–Ω—ã—Ö (–ø–æ –æ–¥–Ω–æ–π –Ω–∞ –∫–∞–∂–¥—ã–π store_type)
- –ù–æ–º–µ—Ä –Ω–∞–∫–ª–∞–¥–Ω–æ–π: ¬´–£–ü–î-1-–ö–£–•¬ª, ¬´–£–ü–î-1-–ë–ê–†¬ª –ø—Ä–∏ –Ω–µ—Å–∫–æ–ª—å–∫–∏—Ö —Å–∫–ª–∞–¥–∞—Ö
- `main_unit` (UUID –∏–∑ —Ç–∞–±–ª–∏—Ü—ã iiko_product) –ø–µ—Ä–µ–¥–∞—ë—Ç—Å—è –∫–∞–∫ `amountUnit` –≤ XML
- Fallback: –µ—Å–ª–∏ supplier_id –Ω–µ –Ω–∞–π–¥–µ–Ω –≤ –¥–æ–∫—É–º–µ–Ω—Ç–µ ‚Äî –∏—â–µ–º –≤ DB –ø–æ –∏–º–µ–Ω–∏

**–¢–µ—Å—Ç—ã:** 67 —Ç–µ—Å—Ç–æ–≤, –≤—Å–µ ‚úÖ

---

### 2026-02-18 ‚Äî OCR –Ω–∞–∫–ª–∞–¥–Ω—ã—Ö: –¥–≤—É—Ö—Ç–∞–±–ª–∏—á–Ω—ã–π –º–∞–ø–ø–∏–Ω–≥ OCR‚Üíiiko

**–¶–µ–ª—å:** –ë—É—Ö–≥–∞–ª—Ç–µ—Ä –∑–∞–≥—Ä—É–∂–∞–µ—Ç —Ñ–æ—Ç–æ –Ω–∞–∫–ª–∞–¥–Ω—ã—Ö ‚Üí –±–æ—Ç —Ä–∞—Å–ø–æ–∑–Ω–∞—ë—Ç ‚Üí –∫–ª–∞—Å—Å–∏—Ñ–∏—Ü–∏—Ä—É–µ—Ç ‚Üí –∫–ª–∞–¥—ë—Ç –Ω–µ–∑–∞–º–∞–ø–ª–µ–Ω–Ω—ã–µ –ø–æ–∑–∏—Ü–∏–∏ –≤ ¬´–ú–∞–ø–ø–∏–Ω–≥ –ò–º–ø–æ—Ä—Ç¬ª ‚Üí –±—É—Ö–≥–∞–ª—Ç–µ—Ä –≤—ã–±–∏—Ä–∞–µ—Ç –∏–∑ dropdown ‚Üí ¬´‚úÖ –ú–∞–ø–ø–∏–Ω–≥ –≥–æ—Ç–æ–≤¬ª ‚Üí –¥–∞–Ω–Ω—ã–µ —É—Ö–æ–¥—è—Ç –≤ ¬´–ú–∞–ø–ø–∏–Ω–≥¬ª (–±–∞–∑–∞).

**–ù–æ–≤—ã–µ —Ñ–∞–π–ª—ã:**
- `use_cases/ocr_mapping.py` ‚Äî –ø–æ–ª–Ω–∞—è –ª–æ–≥–∏–∫–∞ –¥–≤—É—Ö—Ç–∞–±–ª–∏—á–Ω–æ–≥–æ –º–∞–ø–ø–∏–Ω–≥–∞:
  `get_base_mapping`, `apply_mapping`, `write_transfer`, `check_transfer_ready`, `finalize_transfer`, `notify_accountants`
- `bot/document_handlers.py` ‚Äî –Ω–æ–≤—ã–π FSM-–ø–æ—Ç–æ–∫ OCR:
  `OcrStates.waiting_photos` ‚Üí debounce ‚Üí classify ‚Üí apply_mapping ‚Üí write_transfer ‚Üí summary
  `btn_mapping_done` ‚Üí check_transfer_ready ‚Üí finalize_transfer ‚Üí clear import

**–ò–∑–º–µ–Ω—ë–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã:**
- `adapters/google_sheets.py` ‚Äî –¥–æ–±–∞–≤–ª–µ–Ω—ã —Ñ—É–Ω–∫—Ü–∏–∏ –º–∞–ø–ø–∏–Ω–≥–æ–≤—ã—Ö –≤–∫–ª–∞–¥–æ–∫:
  `read_base_mapping_sheet`, `write_mapping_import_sheet` (—Å ONE_OF_LIST dropdown),
  `read_mapping_import_sheet`, `upsert_base_mapping`, `clear_mapping_import_sheet`
- `bot/_utils.py` ‚Äî `ocr_keyboard()`: –∫–Ω–æ–ø–∫–∏ ¬´üì§ –ó–∞–≥—Ä—É–∑–∏—Ç—å –Ω–∞–∫–ª–∞–¥–Ω—ã–µ¬ª + ¬´‚úÖ –ú–∞–ø–ø–∏–Ω–≥ –≥–æ—Ç–æ–≤¬ª
- `bot/global_commands.py` ‚Äî `NAV_BUTTONS` –æ–±–Ω–æ–≤–ª—ë–Ω (—É–±—Ä–∞–Ω–æ —Å—Ç–∞—Ä–æ–µ, –¥–æ–±–∞–≤–ª–µ–Ω—ã 2 –Ω–æ–≤—ã–µ –∫–Ω–æ–ø–∫–∏)
- `models/ocr.py` ‚Äî `OcrItem` –ø–æ–ª—É—á–∏–ª –ø–æ–ª—è `iiko_id` –∏ `iiko_name`
- `db/init_db.py` ‚Äî –º–∏–≥—Ä–∞—Ü–∏—è `ADD COLUMN IF NOT EXISTS iiko_id / iiko_name` –≤ `ocr_item`

**–£–¥–∞–ª–µ–Ω—ã (–æ—á–∏—Å—Ç–∫–∞):**
- 16 —Ñ–∞–π–ª–æ–≤: `test_incoming_service.py`, `test_ocr_*.py`, `test_openai_ocr.py`,
  `get_iam_token.py`, `run_new_photo_ocr.py`, `build_final_report.py`,
  `photo_test_ocr_results.json`, `photo_test_ocr_merged.json`, `photo_test_final_report.json`,
  `ocr_results.json`, `ocr_results_merged.json`, `16_02_2026_*.json`, `docs (4).json`,
  –ø–∞–ø–∫–∏ `tests/` (—á–∞—Å—Ç–∏—á–Ω–∞—è –æ—á–∏—Å—Ç–∫–∞), `photo_test/`

**–ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ GSheet:**
- `MIN_STOCK_SHEET_ID`: –¥–≤–µ –≤–∫–ª–∞–¥–∫–∏ ¬´–ú–∞–ø–ø–∏–Ω–≥¬ª –∏ ¬´–ú–∞–ø–ø–∏–Ω–≥ –ò–º–ø–æ—Ä—Ç¬ª
- ¬´–ú–∞–ø–ø–∏–Ω–≥¬ª (–±–∞–∑–∞): A=—Ç–∏–ø, B=OCR-–∏–º—è, C=iiko-–∏–º—è, D=iiko-id ‚Äî –ø–æ—Å—Ç–æ—è–Ω–Ω–∞—è, —Ç–æ–ª—å–∫–æ UPSERT
- ¬´–ú–∞–ø–ø–∏–Ω–≥ –ò–º–ø–æ—Ä—Ç¬ª (—Ç—Ä–∞–Ω—Å—Ñ–µ—Ä): —Ç–µ –∂–µ —Å—Ç–æ–ª–±—Ü—ã, col C = dropdown ONE_OF_LIST –∏–∑ –ë–î (–º–∞–∫—Å 500)
  ‚Äî –∑–∞–ø–∏—Å—ã–≤–∞–µ—Ç—Å—è –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ, –æ—á–∏—â–∞–µ—Ç—Å—è –ø–æ—Å–ª–µ finalize_transfer

**–ö–ª–∞—Å—Å–∏—Ñ–∏–∫–∞—Ü–∏—è doc_type:**
- `rejected_qr` ‚Üí –ø—Ä–æ–ø—É—Å–∫–∞–µ–º
- `cash_order` / `act` –±–µ–∑ —Å—É–º–º—ã ‚Üí —É—Å–ª—É–≥–∞ ‚Üí notify_accountants
- `upd` / `act` —Å —Å—É–º–º–æ–π ‚Üí –Ω–∞–∫–ª–∞–¥–Ω–∞—è ‚Üí apply_mapping ‚Üí write_transfer –µ—Å–ª–∏ –Ω–µ–∑–∞–º–∞–ø–ª–µ–Ω–Ω—ã–µ

---

### 2025-07-25 ‚Äî –ê—É–¥–∏—Ç –ø—Ä–æ–µ–∫—Ç–∞: —É—Å—Ç—Ä–∞–Ω–µ–Ω–∏–µ —Ä–∞—Å—Ö–æ–∂–¥–µ–Ω–∏–π —Å PROJECT_MAP

**–¶–µ–ª—å:** –ü–æ–ª–Ω—ã–π –∞—É–¥–∏—Ç –∫–æ–¥–æ–≤–æ–π –±–∞–∑—ã –Ω–∞ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ PROJECT_MAP.md. –£—Å—Ç—Ä–∞–Ω–µ–Ω—ã –≤—Å–µ 15 –Ω–∞–π–¥–µ–Ω–Ω—ã—Ö —Ä–∞—Å—Ö–æ–∂–¥–µ–Ω–∏–π (4 HIGH, 6 MEDIUM, 5 LOW).

**–î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è:**
- `PROJECT_MAP.md` ‚Äî –∫–æ–ª-–≤–æ —Ç–∞–±–ª–∏—Ü 38‚Üí42, –¥–æ–±–∞–≤–ª–µ–Ω–∞ —Ä–æ–ª—å üìë –ë—É—Ö–≥–∞–ª—Ç–µ—Ä
- `docs/FILE_STRUCTURE.md` ‚Äî –¥–æ–±–∞–≤–ª–µ–Ω—ã 5 –æ—Ç—Å—É—Ç—Å—Ç–≤—É—é—â–∏—Ö use_cases —Ñ–∞–π–ª–æ–≤ (`_helpers.py`, `reports.py`, `price_list.py`, `pinned_stock_message.py`, `iiko_webhook_handler.py`), root-—Ñ–∞–π–ª—ã, `cooldown.py`
- `docs/DATABASE.md` ‚Äî –¥–æ–±–∞–≤–ª–µ–Ω–∞ —Ç–∞–±–ª–∏—Ü–∞ `iiko_access_tokens`, –∏—Å–ø—Ä–∞–≤–ª–µ–Ω —Å—á—ë—Ç—á–∏–∫ —Ç–∞–±–ª–∏—Ü 41‚Üí42

**–ö–æ–¥ (–Ω–æ–≤–∞—è —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç—å):**
- `use_cases/cooldown.py` ‚Äî **NEW** –º–æ–¥—É–ª—å rate-limiting –¥–ª—è —Ö—ç–Ω–¥–ª–µ—Ä–æ–≤ (`check_cooldown()`)
- `logging_config.py` ‚Äî **NEW** `TelegramAlertHandler` ‚Äî ERROR/CRITICAL ‚Üí —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –∞–¥–º–∏–Ω–∞–º –≤ Telegram (debounce 60s)
- `main.py` ‚Äî `_check_iiko()`, `_check_fintablo()` startup self-checks  
- `main.py` ‚Äî `_check_staleness()` ‚Äî –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ –µ—Å–ª–∏ SyncLog > 24—á
- `main.py` ‚Äî `_warmup_caches()` ‚Äî –ø—Ä–æ–≥—Ä–µ–≤ permissions + user_context –ø—Ä–∏ —Å—Ç–∞—Ä—Ç–µ
- `main.py` ‚Äî `_cleanup()` ‚Äî –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ pending writeoffs –ø—Ä–∏ shutdown

**–ö–æ–¥ (–∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è):**
- `iiko_auth.py` ‚Äî `datetime.now()` ‚Üí `time.monotonic()` –¥–ª—è –∫–µ—à–∞ —Ç–æ–∫–µ–Ω–∞ (–Ω–µ –∑–∞–≤–∏—Å–∏—Ç –æ—Ç TZ / NTP)
- `main.py` ‚Äî —É–¥–∞–ª—ë–Ω deprecated `admin_router` (–ø—É—Å—Ç–æ–π —Ä–æ—É—Ç–µ—Ä, –ø–µ—Ä–µ–Ω–µ—Å—ë–Ω –≤ Google –¢–∞–±–ª–∏—Ü—É)

---

### 2025-07-24 ‚Äî –ê–≤—Ç–æ-—Å–æ–ø–æ—Å—Ç–∞–≤–ª–µ–Ω–∏–µ —Å–∫–ª–∞–¥–æ–≤ –ø–æ —Ç–∏–ø—É + –ø–æ–¥—Ä–∞–∑–¥–µ–ª–µ–Ω–∏—é –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è

**–¶–µ–ª—å:** –ó–∞—è–≤–∫–∏ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –Ω–∞–ø—Ä–∞–≤–ª—è—é—Ç—Å—è –Ω–∞ —Å–∫–ª–∞–¥—ã –ø–æ–¥—Ä–∞–∑–¥–µ–ª–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è. –®–∞–≥ –≤—ã–±–æ—Ä–∞ –ø–æ—Å—Ç–∞–≤—â–∏–∫–∞ —É–¥–∞–ª—ë–Ω –¥–ª—è —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤. –ì–æ—Å—Ç–∏ –∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ ¬´–ó–∞–≤–µ–¥–µ–Ω–∏—è –¥–ª—è –∑–∞—è–≤–æ–∫¬ª –±–ª–æ–∫–∏—Ä—É—é—Ç—Å—è.

**–ò–∑–º–µ–Ω–µ–Ω–∏—è:**

**1. –ë–ª–æ–∫–∏—Ä–æ–≤–∫–∏ –ø—Ä–∏ –≤—Ö–æ–¥–µ –≤ –∑–∞—è–≤–∫—É**
- –ì–æ—Å—Ç—å (–Ω–µ—Ç `department_id`) ‚Üí ¬´–°–≤—è–∂–∏—Ç–µ—Å—å —Å –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–º¬ª
- –°–æ–≤–ø–∞–¥–µ–Ω–∏–µ —Å ¬´–ó–∞–≤–µ–¥–µ–Ω–∏–µ–º –¥–ª—è –∑–∞—è–≤–æ–∫¬ª ‚Üí ¬´–°–º–µ–Ω–∏—Ç–µ –ø–æ–¥—Ä–∞–∑–¥–µ–ª–µ–Ω–∏–µ¬ª
- –ù–µ—Ç —Å–∫–ª–∞–¥–æ–≤ –¥–ª—è –ø–æ–¥—Ä–∞–∑–¥–µ–ª–µ–Ω–∏—è ‚Üí –æ—à–∏–±–∫–∞

**2. –ê–≤—Ç–æ-—Å–æ–ø–æ—Å—Ç–∞–≤–ª–µ–Ω–∏–µ —Å–∫–ª–∞–¥–æ–≤ (store type matching)**
- `use_cases/product_request.py` ‚Äî 5 –Ω–æ–≤—ã—Ö —Ñ—É–Ω–∫—Ü–∏–π:
  - `extract_store_type()`: ¬´PizzaYolo: –ö—É—Ö–Ω—è (–ú–æ—Å–∫–æ–≤—Å–∫–∏–π)¬ª ‚Üí ¬´–∫—É—Ö–Ω—è¬ª
  - `get_all_stores_for_department()`: —Å–∫–ª–∞–¥—ã –ø–æ–¥—Ä–∞–∑–¥–µ–ª–µ–Ω–∏—è –∏–∑ –ë–î
  - `build_store_type_map()`: {—Ç–∏–ø ‚Üí {id, name}} –¥–ª—è –ø–æ–¥—Ä–∞–∑–¥–µ–ª–µ–Ω–∏—è
  - `resolve_target_store()`: —Å–æ–ø–æ—Å—Ç–∞–≤–ª–µ–Ω–∏–µ source ‚Üí target –ø–æ —Ç–∏–ø—É
  - `find_counteragent_for_store()`: –ø–æ–∏—Å–∫ `iiko_supplier` –ø–æ –∏–º–µ–Ω–∏ —Å–∫–ª–∞–¥–∞ (exact ‚Üí partial)

**3. –ü–µ—Ä–µ—Ä–∞–±–æ—Ç–∫–∞ FSM-—Ö—ç–Ω–¥–ª–µ—Ä–æ–≤**
- `bot/request_handlers.py`:
  - –£–¥–∞–ª—ë–Ω —à–∞–≥ `supplier_choose` (–∫–æ–Ω—Ç—Ä–∞–≥–µ–Ω—Ç –∞–≤—Ç–æ-–æ–ø—Ä–µ–¥–µ–ª—è–µ—Ç—Å—è)
  - `start_create_request`: –∑–∞–≥—Ä—É–∂–∞–µ—Ç `user_store_map`, –ø—Ä–æ–≤–µ—Ä—è–µ—Ç –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏
  - `enter_item_quantity`: –¥–æ–±–∞–≤–ª—è–µ—Ç `target_store_id`/`target_store_name` –∫ –∫–∞–∂–¥–æ–º—É —Ç–æ–≤–∞—Ä—É
  - `_items_summary`: –≥—Ä—É–ø–ø–∏—Ä–æ–≤–∫–∞ –ø–æ `target_store_name`
  - `confirm_send_request`: –≥—Ä—É–ø–ø–∏—Ä–æ–≤–∫–∞ –ø–æ `target_store_id`, –∞–≤—Ç–æ-–æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –∫–æ–Ω—Ç—Ä–∞–≥–µ–Ω—Ç–∞ —á–µ—Ä–µ–∑ `find_counteragent_for_store()`
  - –î—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏–µ –∑–∞—è–≤–∫–∏: –∞–Ω–∞–ª–æ–≥–∏—á–Ω–∞—è –ª–æ–≥–∏–∫–∞ –∞–≤—Ç–æ-—Å–æ–ø–æ—Å—Ç–∞–≤–ª–µ–Ω–∏—è

---

### 2026-02-16 ‚Äî –ê–≤—Ç–æ-–æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ —Å–∫–ª–∞–¥–æ–≤ –≤ –∑–∞—è–≤–∫–∞—Ö + –∫–æ–ª–æ–Ω–∫–∞ ¬´–°–∫–ª–∞–¥¬ª –≤ –ø—Ä–∞–π—Å-–ª–∏—Å—Ç–µ

**–¶–µ–ª—å:** –£–±—Ä–∞—Ç—å —Ä—É—á–Ω–æ–π –≤—ã–±–æ—Ä —Å–∫–ª–∞–¥–∞ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –∑–∞—è–≤–∫–∏. –°–∫–ª–∞–¥ –æ–ø—Ä–µ–¥–µ–ª—è–µ—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∏–∑ –ø—Ä–∞–π—Å-–ª–∏—Å—Ç–∞. –ï—Å–ª–∏ —Ç–æ–≤–∞—Ä—ã —Å —Ä–∞–∑–Ω—ã—Ö —Å–∫–ª–∞–¥–æ–≤ ‚Äî —Å–æ–∑–¥–∞—ë—Ç—Å—è N –æ—Ç–¥–µ–ª—å–Ω—ã—Ö –∑–∞—è–≤–æ–∫.

**–ö–æ–º–º–∏—Ç—ã:** `6420bf0` (store column in price list), `c5cdaca` (configurable request stores), `c101568` (auto-store requests), `a15c17d` (supplier.inn fix)

**1. –ö–æ–ª–æ–Ω–∫–∞ ¬´–°–∫–ª–∞–¥¬ª –≤ –ø—Ä–∞–π—Å-–ª–∏—Å—Ç–µ** (`6420bf0`)
- `adapters/google_sheets.py` ‚Äî `sync_invoice_prices_to_sheet()`: `num_fixed` 3‚Üí4, –Ω–æ–≤–∞—è –∫–æ–ª–æ–Ω–∫–∞ C ¬´–°–∫–ª–∞–¥¬ª —Å dropdown –∏–∑ –≤–∫–ª—é—á—ë–Ω–Ω—ã—Ö —Å–∫–ª–∞–¥–æ–≤ –≤ ¬´–ù–∞—Å—Ç—Ä–æ–π–∫–∏¬ª
- `adapters/google_sheets.py` ‚Äî `read_invoice_prices()`: —á–∏—Ç–∞–µ—Ç store_id/store_name –∏–∑ –∫–æ–ª–æ–Ω–∫–∏ C; –∞–≤—Ç–æ–¥–µ—Ç–µ–∫—Ç —Å—Ç–∞—Ä–æ–≥–æ (num_fixed=3) vs –Ω–æ–≤–æ–≥–æ —Ñ–æ—Ä–º–∞—Ç–∞ (num_fixed=4)
- `db/models.py` ‚Äî `PriceProduct`: –¥–æ–±–∞–≤–ª–µ–Ω—ã `store_id` (UUID, nullable), `store_name` (String(500), nullable)
- `db/init_db.py` ‚Äî –º–∏–≥—Ä–∞—Ü–∏—è: `ALTER TABLE price_product ADD COLUMN IF NOT EXISTS store_id UUID`, `store_name VARCHAR(500)`
- `use_cases/outgoing_invoice.py` ‚Äî `_sync_prices_to_db()`: —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç store_id/store_name –ø—Ä–∏ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏

**2. –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º—ã–µ —Å–∫–ª–∞–¥—ã –¥–ª—è –∑–∞—è–≤–æ–∫** (`c5cdaca`)
- `adapters/google_sheets.py` ‚Äî `read_request_stores()`: —á—Ç–µ–Ω–∏–µ –∏–∑ GSheet ¬´–ù–∞—Å—Ç—Ä–æ–π–∫–∏¬ª —Å–µ–∫—Ü–∏–∏ ¬´–°–∫–ª–∞–¥—ã –¥–ª—è –∑–∞—è–≤–æ–∫¬ª
- `adapters/google_sheets.py` ‚Äî `sync_request_stores_to_sheet()`: –∑–∞–ø–∏—Å—å —Å–∫–ª–∞–¥–æ–≤ —Å —á–µ–∫–±–æ–∫—Å–∞–º–∏ –≤ GSheet
- `use_cases/product_request.py` ‚Äî `get_request_stores()`, `sync_request_stores_sheet()`: use-case –æ–±—ë—Ä—Ç–∫–∏

**3. –ê–≤—Ç–æ-–æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ —Å–∫–ª–∞–¥–æ–≤ –≤ –∑–∞—è–≤–∫–∞—Ö** (`c101568`)
- `bot/request_handlers.py` ‚Äî –ø–æ–ª–Ω–∞—è –ø–µ—Ä–µ—Ä–∞–±–æ—Ç–∫–∞ FSM:
  - –£–¥–∞–ª—ë–Ω —à–∞–≥ –≤—ã–±–æ—Ä–∞ —Å–∫–ª–∞–¥–∞ (`CreateRequestStates.store`), —É–¥–∞–ª–µ–Ω—ã `_stores_kb()` –∏ `choose_store()`
  - –ü–æ–¥—Ä–∞–∑–¥–µ–ª–µ–Ω–∏–µ (department) –ø–æ–¥—Å—Ç–∞–≤–ª—è–µ—Ç—Å—è auto –∏–∑ `user_context`
  - –°–∫–ª–∞–¥ (store) –æ–ø—Ä–µ–¥–µ–ª—è–µ—Ç—Å—è –∏–∑ `PriceProduct.store_id/store_name` –¥–ª—è –∫–∞–∂–¥–æ–≥–æ —Ç–æ–≤–∞—Ä–∞
  - `_items_summary()` ‚Äî –≥—Ä—É–ø–ø–∏—Ä–æ–≤–∫–∞ –ø–æ —Å–∫–ª–∞–¥–∞–º —Å `üè¶` emoji
  - `preview_request()` ‚Äî –≤–∞–ª–∏–¥–∞—Ü–∏—è: –µ—Å–ª–∏ —É —Ç–æ–≤–∞—Ä–∞ –Ω–µ—Ç store_id ‚Üí –±–ª–æ–∫–∏—Ä–æ–≤–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏
  - `confirm_send_request()` ‚Äî –≥—Ä—É–ø–ø–∏—Ä–æ–≤–∫–∞ —Ç–æ–≤–∞—Ä–æ–≤ –ø–æ `store_id` —á–µ—Ä–µ–∑ `OrderedDict` ‚Üí —Å–æ–∑–¥–∞–Ω–∏–µ N –æ—Ç–¥–µ–ª—å–Ω—ã—Ö –∑–∞—è–≤–æ–∫
  - –î—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏–µ –∑–∞—è–≤–æ–∫: `start_duplicate_request()` –æ–±–æ–≥–∞—â–∞–µ—Ç —Ç–æ–≤–∞—Ä—ã –∞–∫—Ç—É–∞–ª—å–Ω—ã–º–∏ —Å–∫–ª–∞–¥–∞–º–∏ —á–µ—Ä–µ–∑ `get_product_store_map()`
  - `dup_confirm_send()` ‚Äî –∞–Ω–∞–ª–æ–≥–∏—á–Ω–∞—è —Ä–∞–∑–±–∏–≤–∫–∞ –ø–æ —Å–∫–ª–∞–¥–∞–º
- `use_cases/outgoing_invoice.py`:
  - `search_price_products()` ‚Äî —Ç–µ–ø–µ—Ä—å –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç `store_id` –∏ `store_name`
  - `get_product_store_map()` ‚Äî –Ω–æ–≤–∞—è —Ñ—É–Ω–∫—Ü–∏—è: bulk-–∑–∞–ø—Ä–æ—Å PriceProduct –¥–ª—è —Å–ø–∏—Å–∫–∞ product_ids ‚Üí `{product_id: {store_id, store_name}}`

**4. –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ Supplier.inn** (`a15c17d`)
- `adapters/iiko_api.py` ‚Äî `inn` –ø–æ–ª–µ: –∫–æ—Ä—Ä–µ–∫—Ç–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ nullable –∑–Ω–∞—á–µ–Ω–∏—è (–±—ã–ª–æ: crash –ø—Ä–∏ None)
- `adapters/google_sheets.py` ‚Äî –Ω–æ–≤—ã–µ –ª–∏—Å—Ç—ã: `_ALL_Products`, `_ALL_Suppliers`, `_ALL_Units`, `_ALL_Stores` –¥–ª—è –ø–æ–ª–Ω–æ–≥–æ —Å–ø—Ä–∞–≤–æ—á–Ω–∏–∫–∞

---

### 2026-02-15 ‚Äî –ê—É–¥–∏—Ç –ø—Ä–æ–µ–∫—Ç–∞: –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Ä–∞—Å—Ö–æ–∂–¥–µ–Ω–∏–π –∫–æ–¥–∞ –∏ –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏

**–¶–µ–ª—å:** –ü—Ä–∏–≤–µ—Å—Ç–∏ PROJECT_MAP.md, DATABASE.md, FILE_STRUCTURE.md –≤ –ø–æ–ª–Ω–æ–µ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ —Å –∫–æ–¥–æ–º.

**1. config.py**
- –£–¥–∞–ª—ë–Ω `STOCK_CHECK_ORDER_INTERVAL` (deprecated, –Ω–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–ª—Å—è –ø–æ—Å–ª–µ –ø–µ—Ä–µ—Ö–æ–¥–∞ –Ω–∞ –ø—Ä–æ–≤–µ—Ä–∫—É –ø—Ä–∏ –∫–∞–∂–¥–æ–º –≤–µ–±—Ö—É–∫–µ)

**2. db/ft_models.py**
- –£–¥–∞–ª–µ–Ω–∞ –¥—É–±–ª–∏—Ä—É—é—â–∞—è `_utcnow()` ‚Äî —Ç–µ–ø–µ—Ä—å –∏–º–ø–æ—Ä—Ç–∏—Ä—É–µ—Ç—Å—è –∏–∑ `db/models.py` (DRY)

**3. use_cases/stoplist_report.py**
- –ï–∂–µ–≤–µ—á–µ—Ä–Ω–∏–π –æ—Ç—á—ë—Ç (22:00) —Ç–µ–ø–µ—Ä—å –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è **–ø–æ–¥–ø–∏—Å—á–∏–∫–∞–º —Ä–æ–ª–∏ üö´ –°—Ç–æ–ø-–ª–∏—Å—Ç** (—Ä–∞–Ω–µ–µ ‚Äî –≤—Å–µ–º –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω–Ω—ã–º)
- Bootstrap-fallback: –µ—Å–ª–∏ –Ω–∏ —É –∫–æ–≥–æ –Ω–µ—Ç —Ñ–ª–∞–≥–∞ ‚Üí –æ—Ç–ø—Ä–∞–≤–∫–∞ –≤—Å–µ–º (–∫–∞–∫ –≤ pinned-—Å–æ–æ–±—â–µ–Ω–∏—è—Ö)

**4. docs/DATABASE.md**
- –î–æ–±–∞–≤–ª–µ–Ω—ã 4 –Ω–µ–¥–æ–∫—É–º–µ–Ω—Ç–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ —Ç–∞–±–ª–∏—Ü—ã: `price_product` (#35), `price_supplier_column` (#36), `price_supplier_price` (#37), `stock_alert_message` (#38)
- –û–±–Ω–æ–≤–ª—ë–Ω —Å—á—ë—Ç—á–∏–∫: 34 ‚Üí 38 —Ç–∞–±–ª–∏—Ü (25 iiko/bot + 13 FinTablo)

**5. docs/FILE_STRUCTURE.md**
- –î–æ–±–∞–≤–ª–µ–Ω—ã: `tests/test_iiko_webhook.py`, `test_incoming_service.py`

**6. PROJECT_MAP.md**
- –¢–∞–±–ª–∏—Ü–∞ env: —É–¥–∞–ª–µ–Ω—ã —Ñ–∞–Ω—Ç–æ–º—ã (`OPENAI_API_KEY`, `GOOGLE_SHEETS_ID`), –¥–æ–±–∞–≤–ª–µ–Ω—ã —Ä–µ–∞–ª—å–Ω—ã–µ (`IIKO_VERIFY_SSL`, `WEBHOOK_SECRET`, `WEBAPP_HOST`, `MIN_STOCK_SHEET_ID`)
- `TIMEZONE` ‚Äî –æ—Ç–º–µ—á–µ–Ω –∫–∞–∫ —Ö–∞—Ä–¥–∫–æ–¥ (–Ω–µ env)
- `set_cancel_kb()` / `restore_menu_kb()` ‚Äî –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∞ —Å—Å—ã–ª–∫–∞: `bot/_utils.py` ‚Üí `bot/middleware.py`
- –°—á—ë—Ç—á–∏–∫ —Ç–∞–±–ª–∏—Ü: 31 ‚Üí 38

---

### 2026-02-14 ‚Äî –ú–∞–ø–ø–∏–Ω–≥ –ø–æ–¥—Ä–∞–∑–¥–µ–ª–µ–Ω–∏–π ‚Üí Cloud-–æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏–π —á–µ—Ä–µ–∑ Google –¢–∞–±–ª–∏—Ü—É

**–¶–µ–ª—å:** –ì–∏–±–∫–∞—è –ø—Ä–∏–≤—è–∑–∫–∞ –ø–æ–¥—Ä–∞–∑–¥–µ–ª–µ–Ω–∏–π iiko Server –∫ –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏—è–º iikoCloud.
–ö–∞–∂–¥—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø–æ–ª—É—á–∞–µ—Ç —Å—Ç–æ–ø-–ª–∏—Å—Ç —Å–≤–æ–µ–≥–æ –∑–∞–≤–µ–¥–µ–Ω–∏—è, –∞ –Ω–µ –æ–¥–Ω–æ–≥–æ –∑–∞—Ö–∞—Ä–¥–∫–æ–∂–µ–Ω–Ω–æ–≥–æ –∏–∑ env.
–ù–æ–≤–æ–µ –∑–∞–≤–µ–¥–µ–Ω–∏–µ ‚Äî –¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å —Å—Ç—Ä–æ–∫—É –≤ GSheet.

**1. Google –¢–∞–±–ª–∏—Ü–∞: –ª–∏—Å—Ç ¬´–ù–∞—Å—Ç—Ä–æ–π–∫–∏¬ª**
- `adapters/google_sheets.py`: –Ω–æ–≤—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ `read_cloud_org_mapping()`, `sync_cloud_org_mapping_to_sheet()`
- –†–∞–∑–¥–µ–ª ¬´## –û—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏–∏ iikoCloud¬ª: –ü–æ–¥—Ä–∞–∑–¥–µ–ª–µ–Ω–∏–µ (name, uuid) ‚Üî Cloud-–æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏—è (name, uuid)
- –°–∫—Ä—ã—Ç—ã–µ —Å—Ç–æ–ª–±—Ü—ã UUID (B, D) + —Å–ø—Ä–∞–≤–æ—á–Ω–∏–∫ Cloud-–æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏–π –Ω–∏–∂–µ –¥–∞–Ω–Ω—ã—Ö

**2. Use-case: cloud_org_mapping**
- –ù–æ–≤—ã–π —Ñ–∞–π–ª: `use_cases/cloud_org_mapping.py`
  - `resolve_cloud_org_id(department_id)` ‚Äî dept_uuid ‚Üí cloud_org_uuid
  - `resolve_cloud_org_id_for_user(telegram_id)` ‚Äî –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (—á–µ—Ä–µ–∑ user_context)
  - `get_all_cloud_org_ids()` ‚Äî –≤—Å–µ –ø—Ä–∏–≤—è–∑–∞–Ω–Ω—ã–µ org_id (–¥–ª—è –≤–µ–±—Ö—É–∫–æ–≤)
  - In-memory –∫–µ—à (TTL 5 –º–∏–Ω), graceful degradation (–µ—Å–ª–∏ GSheet –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω)

**3. –°—Ç–æ–ø-–ª–∏—Å—Ç: per-user org_id**
- `use_cases/stoplist.py`: `fetch_stoplist_items(org_id=...)` –ø—Ä–∏–Ω–∏–º–∞–µ—Ç –ø–∞—Ä–∞–º–µ—Ç—Ä org_id
- `use_cases/pinned_stoplist_message.py`: `send_stoplist_for_user()` —Ä–µ–∑–æ–ª–≤–∏—Ç org_id —á–µ—Ä–µ–∑ cloud_org_mapping
- `use_cases/iiko_webhook_handler.py`: StopListUpdate –±–µ—Ä—ë—Ç org_id –∏–∑ —Å–æ–±—ã—Ç–∏—è –∏–ª–∏ –∏–∑ –º–∞–ø–ø–∏–Ω–≥–∞

**4. –ê–¥–º–∏–Ω-–∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å**
- –ù–æ–≤–∞—è –∫–Ω–æ–ø–∫–∞ ¬´üîó –ü—Ä–∏–≤—è–∑–∞—Ç—å –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏–∏¬ª –≤ –ø–æ–¥–º–µ–Ω—é iikoCloud:
  –≤—ã–≥—Ä—É–∂–∞–µ—Ç –ø–æ–¥—Ä–∞–∑–¥–µ–ª–µ–Ω–∏—è + Cloud-–æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏–∏ –≤ GSheet (dept ‚Üî cloud org)
- –í–µ–±—Ö—É–∫ + —Å—Ç–∞—Ç—É—Å —Ç–µ–ø–µ—Ä—å –±–µ—Ä—É—Ç org_id –∏–∑ –º–∞–ø–ø–∏–Ω–≥–∞ (fallback –Ω–∞ env)
- `bot/global_commands.py`: –∫–Ω–æ–ø–∫–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∞ –≤ NAV_BUTTONS

---

### 2026-02-14 ‚Äî –°—Ç–æ–ø-–ª–∏—Å—Ç iikoCloud + –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ ORG_ID

**–¶–µ–ª—å:** –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å—Ç–æ–ø-–ª–∏—Å—Ç–∞ –∏–∑ iikoCloud ‚Äî –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ —Ç–æ–≤–∞—Ä–æ–≤ –≤ —Å—Ç–æ–ø–µ, –∑–∞–∫—Ä–µ–ø–ª—ë–Ω–Ω—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è, –µ–∂–µ–≤–µ—á–µ—Ä–Ω–∏–π –æ—Ç—á—ë—Ç, –≤–µ–±—Ö—É–∫-–æ–±—Ä–∞–±–æ—Ç–∫–∞. –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –±–∞–≥–∞ —Å –ø—É—Å—Ç—ã–º —Å—Ç–æ–ø-–ª–∏—Å—Ç–æ–º.

**1. –°—Ç–æ–ø-–ª–∏—Å—Ç: –±–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫–∞**
- –ù–æ–≤—ã–π —Ñ–∞–π–ª: `use_cases/stoplist.py`
  - `fetch_stoplist_items()` ‚Äî –∑–∞–ø—Ä–æ—Å —Å—Ç–æ–ø-–ª–∏—Å—Ç–∞ –∏–∑ iikoCloud (terminal groups ‚Üí stop_lists)
  - `diff_and_update(items)` ‚Äî —Å—Ä–∞–≤–Ω–µ–Ω–∏–µ —Å –ë–î (active_stoplist), –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ, –∑–∞–ø–∏—Å—å –∏—Å—Ç–æ—Ä–∏–∏
  - `_enrich_names(items)` ‚Äî –ø–æ–¥—Ç—è–≥–∏–≤–∞–Ω–∏–µ –Ω–∞–∑–≤–∞–Ω–∏–π –∏–∑ `iiko_product`
  - StoplistHistory: –∑–∞–ø–∏—Å—å started_at/ended_at –ø—Ä–∏ –≤—Ö–æ–¥–µ/–≤—ã—Ö–æ–¥–µ —Ç–æ–≤–∞—Ä–∞ –∏–∑ —Å—Ç–æ–ø–∞

**2. –ó–∞–∫—Ä–µ–ø–ª—ë–Ω–Ω—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è**
- –ù–æ–≤—ã–π —Ñ–∞–π–ª: `use_cases/pinned_stoplist_message.py`
  - `send_stoplist_for_user(bot, chat_id)` ‚Äî —Å–æ–∑–¥–∞–Ω–∏–µ/–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ pinned msg —Å–æ —Å—Ç–æ–ø-–ª–∏—Å—Ç–æ–º
  - `update_all_stoplist_messages(bot)` ‚Äî –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ —É –≤—Å–µ—Ö –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
  - snapshot_hash –¥–ª—è –¥–µ–¥—É–ø–ª–∏–∫–∞—Ü–∏–∏ (–Ω–µ –æ–±–Ω–æ–≤–ª—è—Ç—å –µ—Å–ª–∏ –¥–∞–Ω–Ω—ã–µ –Ω–µ –∏–∑–º–µ–Ω–∏–ª–∏—Å—å)

**3. –ï–∂–µ–≤–µ—á–µ—Ä–Ω–∏–π –æ—Ç—á—ë—Ç**
- –ù–æ–≤—ã–π —Ñ–∞–π–ª: `use_cases/stoplist_report.py`
  - `send_daily_stoplist_report(bot)` ‚Äî –æ—Ç—á—ë—Ç –∑–∞ –¥–µ–Ω—å (22:00) –≤—Å–µ–º –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω–Ω—ã–º
  - –°—É–º–º–∞—Ä–Ω–æ–µ –≤—Ä–µ–º—è –≤ —Å—Ç–æ–ø–µ –ø–æ –∫–∞–∂–¥–æ–º—É —Ç–æ–≤–∞—Ä—É –∑–∞ –¥–µ–Ω—å

**4. –í–µ–±—Ö—É–∫ StopListUpdate**
- `use_cases/iiko_webhook_handler.py`: –æ–±—Ä–∞–±–æ—Ç–∫–∞ —Å–æ–±—ã—Ç–∏—è StopListUpdate
- `adapters/iiko_cloud_api.py`: –¥–æ–±–∞–≤–ª–µ–Ω —Ñ–∏–ª—å—Ç—Ä `stopListUpdateFilter` –ø—Ä–∏ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ –≤–µ–±—Ö—É–∫–∞
- `adapters/iiko_cloud_api.py`: `fetch_terminal_groups()`, `fetch_stop_lists()` ‚Äî –Ω–æ–≤—ã–µ –º–µ—Ç–æ–¥—ã

**5. –ü–ª–∞–Ω–∏—Ä–æ–≤—â–∏–∫**
- `use_cases/scheduler.py`: –¥–æ–±–∞–≤–ª–µ–Ω–∞ –∑–∞–¥–∞—á–∞ `_daily_stoplist_report` –Ω–∞ 22:00

**6. –ë–î (3 –Ω–æ–≤—ã–µ —Ç–∞–±–ª–∏—Ü—ã)**
- `active_stoplist` ‚Äî —Ç–µ–∫—É—â–∏–π —Å—Ç–æ–ø-–ª–∏—Å—Ç (–∑–µ—Ä–∫–∞–ª–æ iikoCloud)
- `stoplist_message` ‚Äî –∑–∞–∫—Ä–µ–ø–ª—ë–Ω–Ω—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è (chat_id, message_id, snapshot_hash)
- `stoplist_history` ‚Äî –∏—Å—Ç–æ—Ä–∏—è –≤—Ö–æ–¥–∞/–≤—ã—Ö–æ–¥–∞ –∏–∑ —Å—Ç–æ–ø–∞ (–¥–ª—è –µ–∂–µ–≤–µ—á–µ—Ä–Ω–µ–≥–æ –æ—Ç—á—ë—Ç–∞)
- `db/init_db.py`: 9 –Ω–æ–≤—ã—Ö –∏–Ω–¥–µ–∫—Å–æ–≤

**7. –ë–∞–≥—Ñ–∏–∫—Å: —Å—Ç–æ–ø-–ª–∏—Å—Ç –ø—É—Å—Ç (ORG_ID)**
- **–°–∏–º–ø—Ç–æ–º:** ¬´–°—Ç–æ–ø-–ª–∏—Å—Ç –ø—É—Å—Ç¬ª –Ω–µ—Å–º–æ—Ç—Ä—è –Ω–∞ –Ω–∞–ª–∏—á–∏–µ –ø–æ–∑–∏—Ü–∏–π –≤ iiko
- **–ü—Ä–∏—á–∏–Ω–∞:** Railway env —Å–æ–¥–µ—Ä–∂–∏—Ç `ORG_ID` (–∏–∑ —Å—Ç–∞—Ä–æ–≥–æ —Å–∫—Ä–∏–ø—Ç–∞), –Ω–æ –±–æ—Ç —á–∏—Ç–∞–ª `IIKO_CLOUD_ORG_ID`
- **–†–µ—à–µ–Ω–∏–µ:** `config.py` ‚Äî fallback: `os.getenv("IIKO_CLOUD_ORG_ID") or os.getenv("ORG_ID")`

**8. –û—á–∏—Å—Ç–∫–∞**
- –£–¥–∞–ª–µ–Ω—ã —É—Å—Ç–∞—Ä–µ–≤—à–∏–µ —Ñ–∞–π–ª—ã: `main-stoplist.py`, `daily_report-stoplist.py` (—Å—Ç–∞—Ä—ã–µ standalone-—Å–∫—Ä–∏–ø—Ç—ã)
- –£–¥–∞–ª–µ–Ω–∞ –≤—Ä–µ–º–µ–Ω–Ω–∞—è –¥–∏–∞–≥–Ω–æ—Å—Ç–∏—á–µ—Å–∫–∞—è –∫–Ω–æ–ø–∫–∞ ¬´üîç –¢–µ—Å—Ç —Å—Ç–æ–ø-–ª–∏—Å—Ç–∞¬ª

---

### 2026-02-14 ‚Äî iikoCloud –≤–µ–±—Ö—É–∫–∏ + –∞–≤—Ç–æ–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –æ—Å—Ç–∞—Ç–∫–æ–≤

**–¶–µ–ª—å:** –û–ø–µ—Ä–∞—Ç–∏–≤–Ω–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –æ—Å—Ç–∞—Ç–∫–æ–≤ –Ω–∏–∂–µ –º–∏–Ω–∏–º—É–º–∞ ‚Äî –Ω–µ –ø–æ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏—é, –∞ –ø–æ —Å–æ–±—ã—Ç–∏—è–º (–∑–∞–∫—Ä—ã—Ç–∏–µ –∑–∞–∫–∞–∑–æ–≤ –≤ iiko). –ó–∞–∫—Ä–µ–ø–ª—ë–Ω–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ —Å –æ—Å—Ç–∞—Ç–∫–∞–º–∏ –≤ –ª–∏—á–∫–µ –∫–∞–∂–¥–æ–≥–æ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω–Ω–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è.

**1. –ê–¥–∞–ø—Ç–µ—Ä iikoCloud API**
- –ù–æ–≤—ã–π —Ñ–∞–π–ª: `adapters/iiko_cloud_api.py`
  - –¢–æ–∫–µ–Ω —á–∏—Ç–∞–µ—Ç—Å—è –∏–∑ —Ç–∞–±–ª–∏—Ü—ã `iiko_access_tokens` (–≤–Ω–µ—à–Ω–∏–π cron –æ–±–Ω–æ–≤–ª—è–µ—Ç –∫–∞–∂–¥—ã–µ 5 –º–∏–Ω)
  - `get_organizations()` ‚Äî –ø–æ–ª—É—á–∏—Ç—å Organization ID
  - `register_webhook()` ‚Äî —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –≤–µ–±—Ö—É–∫–∞ —Å —Ñ–∏–ª—å—Ç—Ä–æ–º –Ω–∞ Closed –∑–∞–∫–∞–∑—ã (delivery + table)
  - `get_webhook_settings()` ‚Äî —Ç–µ–∫—É—â–∏–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –≤–µ–±—Ö—É–∫–∞
  - `verify_webhook_auth()` ‚Äî –≤–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏—è –≤—Ö–æ–¥—è—â–∏—Ö –≤–µ–±—Ö—É–∫–æ–≤

**2. –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –≤–µ–±—Ö—É–∫–æ–≤**
- –ù–æ–≤—ã–π —Ñ–∞–π–ª: `use_cases/iiko_webhook_handler.py`
  - In-memory —Å—á—ë—Ç—á–∏–∫ –∑–∞–∫—Ä—ã—Ç—ã—Ö –∑–∞–∫–∞–∑–æ–≤
  - –ö–∞–∂–¥—ã–µ N –∑–∞–∫–∞–∑–æ–≤ (env: `STOCK_CHECK_ORDER_INTERVAL`, –¥–µ—Ñ–æ–ª—Ç 5):
    - `sync_stock_balances()` ‚Üí `check_min_stock_levels()` ‚Üí –¥–µ–ª—å—Ç–∞-—Å—Ä–∞–≤–Ω–µ–Ω–∏–µ
    - –ï—Å–ª–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–µ > –ø–æ—Ä–æ–≥–∞ (env: `STOCK_CHANGE_THRESHOLD_PCT`, –¥–µ—Ñ–æ–ª—Ç 5%) ‚Üí –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å–æ–æ–±—â–µ–Ω–∏–π
  - `force_stock_check()` ‚Äî –ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ (–∏–≥–Ω–æ—Ä–∏—Ä—É–µ—Ç —Å—á—ë—Ç—á–∏–∫ –∏ –ø–æ—Ä–æ–≥)

**3. –ó–∞–∫—Ä–µ–ø–ª—ë–Ω–Ω—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è —Å –æ—Å—Ç–∞—Ç–∫–∞–º–∏**
- –ù–æ–≤—ã–π —Ñ–∞–π–ª: `use_cases/pinned_stock_message.py`
  - –î–ª—è –∫–∞–∂–¥–æ–≥–æ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω–Ω–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è ‚Äî –æ–¥–Ω–æ —Å–æ–æ–±—â–µ–Ω–∏–µ –≤ –ª–∏—á–∫–µ
  - edit_message_text –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ (–Ω–µ –Ω–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ)
  - pin_chat_message –ø—Ä–∏ –ø–µ—Ä–≤–æ–º —Å–æ–∑–¥–∞–Ω–∏–∏
  - snapshot_hash –¥–ª—è –¥–µ–¥—É–ø–ª–∏–∫–∞—Ü–∏–∏ (–Ω–µ –æ–±–Ω–æ–≤–ª—è—Ç—å –µ—Å–ª–∏ –Ω–∏—á–µ–≥–æ –Ω–µ –∏–∑–º–µ–Ω–∏–ª–æ—Å—å)

**4. HTTP-—ç–Ω–¥–ø–æ–∏–Ω—Ç `/iiko-webhook`**
- `main.py`: –¥–æ–±–∞–≤–ª–µ–Ω POST `/iiko-webhook` (aiohttp, —Ç–æ–ª—å–∫–æ –≤ webhook-—Ä–µ–∂–∏–º–µ)
  - –í–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏—è authToken
  - –ë—ã—Å—Ç—Ä—ã–π 200 –æ—Ç–≤–µ—Ç + —Ñ–æ–Ω–æ–≤–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ —á–µ—Ä–µ–∑ asyncio.create_task

**5. –ê–¥–º–∏–Ω-–∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å**
- `bot/handlers.py`: –Ω–æ–≤–æ–µ –ø–æ–¥–º–µ–Ω—é ¬´‚òÅÔ∏è iikoCloud –≤–µ–±—Ö—É–∫¬ª –≤ –ù–∞—Å—Ç—Ä–æ–π–∫–∞—Ö
  - üìã –ü–æ–ª—É—á–∏—Ç—å –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏–∏ ‚Äî –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å Organization ID
  - üîó –ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å –≤–µ–±—Ö—É–∫ ‚Äî –æ—Ç–ø—Ä–∞–≤–∏—Ç—å –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –≤ iikoCloud
  - ‚ÑπÔ∏è –°—Ç–∞—Ç—É—Å –≤–µ–±—Ö—É–∫–∞ ‚Äî —Ç–µ–∫—É—â–∏–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏
  - üîÑ –û–±–Ω–æ–≤–∏—Ç—å –æ—Å—Ç–∞—Ç–∫–∏ —Å–µ–π—á–∞—Å ‚Äî –ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ + —Ä–∞—Å—Å—ã–ª–∫–∞

**6. –ë–î**
- –ù–æ–≤–∞—è —Ç–∞–±–ª–∏—Ü–∞: `stock_alert_message` (chat_id, message_id, snapshot_hash, updated_at)
- –ú–∏–≥—Ä–∞—Ü–∏—è –≤ `init_db.py`: –∏–Ω–¥–µ–∫—Å –Ω–∞ chat_id

**7. –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è (–Ω–æ–≤—ã–µ env)**
- `IIKO_CLOUD_ORG_ID` ‚Äî UUID –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏–∏ –≤ iikoCloud
- `IIKO_CLOUD_BASE_URL` ‚Äî –±–∞–∑–æ–≤—ã–π URL (–¥–µ—Ñ–æ–ª—Ç `https://api-ru.iiko.services`)
- `STOCK_CHECK_ORDER_INTERVAL` ‚Äî –∫–∞–∂–¥—ã–µ N –∑–∞–∫–∞–∑–æ–≤ –ø—Ä–æ–≤–µ—Ä—è—Ç—å (–¥–µ—Ñ–æ–ª—Ç 5)
- `STOCK_CHANGE_THRESHOLD_PCT` ‚Äî –ø–æ—Ä–æ–≥ –∏–∑–º–µ–Ω–µ–Ω–∏—è –≤ % (–¥–µ—Ñ–æ–ª—Ç 5.0)
- `IIKO_CLOUD_WEBHOOK_SECRET` ‚Äî authToken –¥–ª—è –≤–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏–∏ –≤—Ö–æ–¥—è—â–∏—Ö –≤–µ–±—Ö—É–∫–æ–≤

---

### 2026-02-13 ‚Äî –ö–∞–ª–∏–Ω–∏–Ω–≥—Ä–∞–¥—Å–∫–æ–µ –≤—Ä–µ–º—è + –ï–∂–µ–¥–Ω–µ–≤–Ω–∞—è –∞–≤—Ç–æ—Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è

**–¶–µ–ª—å:** –í—Å–µ –¥–∞—Ç—ã –∏ –≤—Ä–µ–º—è –≤ –ø—Ä–æ–µ–∫—Ç–µ ‚Äî –ø–æ –ö–∞–ª–∏–Ω–∏–Ω–≥—Ä–∞–¥—É (Europe/Kaliningrad, UTC+2). –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –ø–æ–ª–Ω–∞—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è –∫–∞–∂–¥—ã–π –¥–µ–Ω—å –≤ 07:00.

**1. –ß–∞—Å–æ–≤–æ–π –ø–æ—è—Å Europe/Kaliningrad (UTC+2)**
- `use_cases/_helpers.py`: –¥–æ–±–∞–≤–ª–µ–Ω `now_kgd()` ‚Äî –µ–¥–∏–Ω—ã–π —Ö–µ–ª–ø–µ—Ä, –≤–æ–∑–≤—Ä–∞—â–∞—é—â–∏–π naive datetime –ø–æ –ö–∞–ª–∏–Ω–∏–Ω–≥—Ä–∞–¥—É. `utcnow()` –æ—Å—Ç–∞–≤–ª–µ–Ω –∫–∞–∫ deprecated alias.
- `db/models.py`, `db/ft_models.py`: `_utcnow()` —Ç–µ–ø–µ—Ä—å –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç –∫–∞–ª–∏–Ω–∏–Ω–≥—Ä–∞–¥—Å–∫–æ–µ –≤—Ä–µ–º—è (—á–µ—Ä–µ–∑ `ZoneInfo`).
- `config.py`: –¥–æ–±–∞–≤–ª–µ–Ω–∞ –∫–æ–Ω—Å—Ç–∞–Ω—Ç–∞ `TIMEZONE = "Europe/Kaliningrad"`.
- –ó–∞–º–µ–Ω–µ–Ω—ã –≤—Å–µ `datetime.utcnow()` –∏ `datetime.now()` –Ω–∞ `now_kgd()` –≤:
  - `use_cases/sync_fintablo.py` (started/finished_at, mapping)
  - `use_cases/writeoff.py` (dateIncoming –≤ iiko)
  - `use_cases/pdf_invoice.py` (–¥–∞—Ç–∞ –¥–æ–∫—É–º–µ–Ω—Ç–∞, –∏–º—è —Ñ–∞–π–ª–∞)
  - `use_cases/product_request.py` (approve/cancel timestamps)
  - `use_cases/outgoing_invoice.py` (dateIncoming, —Ä–∞—Å—á—ë—Ç —Å–µ–±–µ—Å—Ç–æ–∏–º–æ—Å—Ç–∏, —Ç–µ—Ö–∫–∞—Ä—Ç—ã)
  - `adapters/iiko_api.py` (timestamp –¥–ª—è –æ—Å—Ç–∞—Ç–∫–æ–≤)
- –í—Å–µ –∑–∞–ø–∏—Å–∏ –≤ –ë–î (SyncLog, synced_at, created_at –∏ —Ç.–¥.) —Ç–µ–ø–µ—Ä—å –≤ –∫–∞–ª–∏–Ω–∏–Ω–≥—Ä–∞–¥—Å–∫–æ–º –≤—Ä–µ–º–µ–Ω–∏.
- PDF-–¥–æ–∫—É–º–µ–Ω—Ç—ã (–Ω–∞–∫–ª–∞–¥–Ω—ã–µ, –∑–∞—è–≤–∫–∏) ‚Äî –¥–∞—Ç–∞ –ø–æ –ö–∞–ª–∏–Ω–∏–Ω–≥—Ä–∞–¥—É.
- iiko API –∑–∞–ø—Ä–æ—Å—ã (–æ—Å—Ç–∞—Ç–∫–∏, —Å–ø–∏—Å–∞–Ω–∏—è, –Ω–∞–∫–ª–∞–¥–Ω—ã–µ) ‚Äî –∫–∞–ª–∏–Ω–∏–Ω–≥—Ä–∞–¥—Å–∫–∏–π timestamp.

**2. –ï–∂–µ–¥–Ω–µ–≤–Ω–∞—è –∞–≤—Ç–æ—Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è (APScheduler)**
- –ù–æ–≤—ã–π —Ñ–∞–π–ª: `use_cases/scheduler.py`
  - `_daily_full_sync()`: iiko + FinTablo + –æ—Å—Ç–∞—Ç–∫–∏ + min/max –∏–∑ GSheet ‚Äî –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ.
  - `start_scheduler(bot)` / `stop_scheduler()` ‚Äî —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∂–∏–∑–Ω–µ–Ω–Ω—ã–º —Ü–∏–∫–ª–æ–º.
  - CronTrigger: 07:00 Europe/Kaliningrad, misfire_grace_time=3600—Å.
  - –ü–æ—Å–ª–µ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏ ‚Äî —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –≤—Å–µ—Ö –∞–¥–º–∏–Ω–æ–≤ –≤ Telegram —Å –æ—Ç—á—ë—Ç–æ–º.
- `main.py`: scheduler –∑–∞–ø—É—Å–∫–∞–µ—Ç—Å—è –≤ –æ–±–æ–∏—Ö —Ä–µ–∂–∏–º–∞—Ö (webhook + polling), –æ—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç—Å—è –ø—Ä–∏ shutdown.
- `requirements.txt`: –¥–æ–±–∞–≤–ª–µ–Ω `apscheduler>=3.10.0`.

**–ó–∞—Ç—Ä–æ–Ω—É—Ç—ã–µ —Ñ–∞–π–ª—ã:**
- `config.py`, `use_cases/_helpers.py`, `db/models.py`, `db/ft_models.py`
- `use_cases/sync_fintablo.py`, `use_cases/writeoff.py`, `use_cases/pdf_invoice.py`
- `use_cases/product_request.py`, `use_cases/outgoing_invoice.py`
- `adapters/iiko_api.py`, `main.py`, `requirements.txt`
- –ù–æ–≤—ã–π: `use_cases/scheduler.py`
- –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è: `PROJECT_MAP.md`, `docs/FILE_STRUCTURE.md`, `docs/CHANGELOG.md`

---

### 2026-02-15 ‚Äî Security Hardening: –∞—É–¥–∏—Ç –∏ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —É—è–∑–≤–∏–º–æ—Å—Ç–µ–π

**–¶–µ–ª—å:** –ü–æ–ª–Ω—ã–π –∞—É–¥–∏—Ç –ø—Ä–æ–µ–∫—Ç–∞ –ø–æ PROJECT_MAP.md (—Ä–∞–∑–¥–µ–ª 7‚Äì8: –í–∞–ª–∏–¥–∞—Ü–∏—è –≤—Ö–æ–¥–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö, –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å).
–ù–∞–π–¥–µ–Ω—ã –∏ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω—ã —É—è–∑–≤–∏–º–æ—Å—Ç–∏ –≤–æ –≤—Å–µ—Ö handler-—Ñ–∞–π–ª–∞—Ö.

**1. –í–∞–ª–∏–¥–∞—Ü–∏—è callback_data** (`bot/writeoff_handlers.py`, `bot/handlers.py`, `bot/min_stock_handlers.py`)
- –î–æ–±–∞–≤–ª–µ–Ω—ã —É—Ç–∏–ª–∏—Ç—ã –≤ `bot/middleware.py`: `extract_callback_value()`, `validate_callback_uuid()`, `validate_callback_int()`, `truncate_input()`, –∫–æ–Ω—Å—Ç–∞–Ω—Ç—ã `MAX_TEXT_SEARCH=200`, `MAX_TEXT_REASON=500`, `MAX_TEXT_GENERAL=2000`, `MAX_TEXT_NAME=100`
- **writeoff_handlers.py**: 12+ callback_data UUID/int —Ç–µ–ø–µ—Ä—å –≤–∞–ª–∏–¥–∏—Ä—É—é—Ç—Å—è —á–µ—Ä–µ–∑ `validate_callback_uuid()`/`validate_callback_int()` (store_id, account_id, product_id, page, item_idx –∏ –¥—Ä.)
- **handlers.py**: UUID-–≤–∞–ª–∏–¥–∞—Ü–∏—è –¥–ª—è auth-–∫–æ–ª–±—ç–∫–æ–≤ (`process_choose_employee`, `process_choose_department`, `process_change_department`)
- **min_stock_handlers.py**: UUID-–≤–∞–ª–∏–¥–∞—Ü–∏—è –¥–ª—è `select_product`

**2. –ö–†–ò–¢–ò–ß–ï–°–ö–ò–ï —Ñ–∏–∫—Å—ã: admin permission checks** (`bot/writeoff_handlers.py`)
- `admin_approve`, `admin_reject`, `admin_edit_start` ‚Äî **—Ä–∞–Ω–µ–µ –Ω–µ –ø—Ä–æ–≤–µ—Ä—è–ª–∏ admin-–ø—Ä–∞–≤–∞!** –õ—é–±–æ–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –º–æ–≥ –æ–¥–æ–±—Ä–∏—Ç—å/–æ—Ç–∫–ª–æ–Ω–∏—Ç—å —Å–ø–∏—Å–∞–Ω–∏–µ, –∑–Ω–∞—è callback_data. –î–æ–±–∞–≤–ª–µ–Ω–∞ –ø—Ä–æ–≤–µ—Ä–∫–∞ `admin_uc.is_admin()`.

**3. Sync-–±–ª–æ–∫–∏—Ä–æ–≤–∫–∏ –∫–æ–Ω–∫—É—Ä–µ–Ω—Ç–Ω–æ—Å—Ç–∏** (`bot/handlers.py`)
- –í—Å–µ 14 sync-–æ–±—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤ —Ç–µ–ø–µ—Ä—å –∏—Å–ø–æ–ª—å–∑—É—é—Ç `asyncio.Lock` per entity type —á–µ—Ä–µ–∑ `get_sync_lock()` –≤ `sync_with_progress()`
- –ê–≥—Ä–µ–≥–∞—Ç–æ—Ä—ã (`sync_entities`, `sync_all_iiko`, `ft_sync_all`, `sync_everything`) –ø—Ä–æ–≤–µ—Ä—è—é—Ç `.locked()` –ø–µ—Ä–µ–¥ –∑–∞–ø—É—Å–∫–æ–º

**4. –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ –¥–ª–∏–Ω—ã —Ç–µ–∫—Å—Ç–æ–≤–æ–≥–æ –≤–≤–æ–¥–∞**
- `writeoff_handlers.py`: search_product, admin_search_new_product, hist_edit_add_item_search ‚Üí `truncate_input(query, MAX_TEXT_SEARCH)`
- `handlers.py`: process_last_name ‚Üí `truncate_input(text, MAX_TEXT_NAME)`
- `min_stock_handlers.py`: search_product ‚Üí `truncate_input(query, MAX_TEXT_SEARCH)`
- `invoice_handlers.py`: enter_quantities ‚Üí `raw[:2000]`

**5. logging_config.py** ‚Äî –ò—Å–ø—Ä–∞–≤–ª–µ–Ω FileHandler(mode="w") ‚Üí `RotatingFileHandler(maxBytes=5MB, backupCount=3)` (–∫–∞–∫ –∑–∞—è–≤–ª–µ–Ω–æ –≤ docstring)

**6. SSL-–≤–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏—è iiko** ‚Äî –í–≤–µ–¥–µ–Ω–∞ –ø–µ—Ä–µ–º–µ–Ω–Ω–∞—è `IIKO_VERIFY_SSL` –≤ `config.py`:
- `adapters/iiko_api.py` –∏ `iiko_auth.py` —Ç–µ–ø–µ—Ä—å –∏—Å–ø–æ–ª—å–∑—É—é—Ç –Ω–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º—ã–π –ø–∞—Ä–∞–º–µ—Ç—Ä –≤–º–µ—Å—Ç–æ —Ö–∞—Ä–¥–∫–æ–¥ `verify=False`
- –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é `false` (–æ–±—Ä–∞—Ç–Ω–∞—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å —Å self-signed —Å–µ—Ä—Ç–∞–º–∏ iiko on-premise)
- –ú–æ–∂–Ω–æ –∑–∞–¥–∞—Ç—å `true` –∏–ª–∏ –ø—É—Ç—å –∫ CA-bundle

---

### 2026-02-14 ‚Äî –°–∫—Ä—ã—Ç–∏–µ Reply-–∫–ª–∞–≤–∏–∞—Ç—É—Ä—ã –≤–æ –≤—Ä–µ–º—è dialog-flow'–æ–≤

**–¶–µ–ª—å:** –ü—Ä–∏ –∑–∞–ø–æ–ª–Ω–µ–Ω–∏–∏ –¥–æ–∫—É–º–µ–Ω—Ç–∞ (—Å–ø–∏—Å–∞–Ω–∏–µ, –Ω–∞–∫–ª–∞–¥–Ω–∞—è, –∑–∞—è–≤–∫–∞, —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –º–∏–Ω. –æ—Å—Ç–∞—Ç–∫–∞) Reply-–∫–ª–∞–≤–∏–∞—Ç—É—Ä–∞ –ø–æ–¥–º–µ–Ω—é –¥–æ–ª–∂–Ω–∞ —Å–∫—Ä—ã–≤–∞—Ç—å—Å—è, —á—Ç–æ–±—ã –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –º–æ–≥ —Å–ª—É—á–∞–π–Ω–æ –Ω–∞–∂–∞—Ç—å –Ω–∞–≤–∏–≥–∞—Ü–∏–æ–Ω–Ω—ã–µ –∫–Ω–æ–ø–∫–∏. –í–º–µ—Å—Ç–æ –Ω–µ—ë –æ—Ç–æ–±—Ä–∞–∂–∞–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ –∫–Ω–æ–ø–∫–∞ ¬´‚ùå –û—Ç–º–µ–Ω–∞¬ª.

**1. –•–µ–ª–ø–µ—Ä—ã** (`bot/middleware.py`)
- `CANCEL_KB` ‚Äî `ReplyKeyboardMarkup` —Å –æ–¥–Ω–æ–π –∫–Ω–æ–ø–∫–æ–π ¬´‚ùå –û—Ç–º–µ–Ω–∞¬ª
- `set_cancel_kb(bot, chat_id, state)` ‚Äî –ø—Ä–∏ –í–•–û–î–ï –≤ flow: —É–¥–∞–ª—è–µ—Ç —Å—Ç–∞—Ä–æ–µ Reply-—Å–æ–æ–±—â–µ–Ω–∏–µ –ø–æ–¥–º–µ–Ω—é (`_menu_msg_id`), –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –≤—Ä–µ–º–µ–Ω–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ —Å `CANCEL_KB` (–∏ —É–¥–∞–ª—è–µ—Ç –µ–≥–æ), —á—Ç–æ –º–µ–Ω—è–µ—Ç Reply-–∫–ª–∞–≤–∏–∞—Ç—É—Ä—É –Ω–∞ cancel-only
- `restore_menu_kb(bot, chat_id, state, menu_text, kb)` ‚Äî –ø—Ä–∏ –í–´–•–û–î–ï –∏–∑ flow: –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –Ω–æ–≤–æ–µ Reply-—Å–æ–æ–±—â–µ–Ω–∏–µ —Å –∫–ª–∞–≤–∏–∞—Ç—É—Ä–æ–π –ø–æ–¥–º–µ–Ω—é, —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç `_menu_msg_id`

**2. Keyboard-—Ñ—É–Ω–∫—Ü–∏–∏ –≤—ã–Ω–µ—Å–µ–Ω—ã –≤ `bot/_utils.py`**
- `writeoffs_keyboard()`, `invoices_keyboard()`, `requests_keyboard()`, `reports_keyboard()`
- –ò—Å–ø–æ–ª—å–∑—É—é—Ç—Å—è —Å–æ–≤–º–µ—Å—Ç–Ω–æ –∏–∑ `handlers.py` –∏ –≤—Å–µ—Ö handler-—Ñ–∞–π–ª–æ–≤

**3. ¬´‚ùå –û—Ç–º–µ–Ω–∞¬ª –¥–æ–±–∞–≤–ª–µ–Ω–∞ –≤ `NAV_BUTTONS`** (`bot/global_commands.py`)
- `NavResetMiddleware` –ø–µ—Ä–µ—Ö–≤–∞—Ç—ã–≤–∞–µ—Ç –Ω–∞–∂–∞—Ç–∏–µ –∫–Ω–æ–ø–∫–∏ ¬´‚ùå –û—Ç–º–µ–Ω–∞¬ª –∏ —Å–±—Ä–∞—Å—ã–≤–∞–µ—Ç FSM

**4. `set_cancel_kb` –¥–æ–±–∞–≤–ª–µ–Ω –Ω–∞ —Å—Ç–∞—Ä—Ç –≤—Å–µ—Ö 7 flow'–æ–≤:**
- `start_writeoff`, `start_history` (writeoff_handlers)
- `start_template`, `start_from_template` (invoice_handlers)
- `start_create_request`, `start_duplicate_request` (request_handlers)
- `btn_edit_min_stock` (min_stock_handlers)

**5. `restore_menu_kb` –¥–æ–±–∞–≤–ª–µ–Ω –Ω–∞ –í–°–ï —Ç–æ—á–∫–∏ –≤—ã—Ö–æ–¥–∞:**
- **writeoff** (3): finalize no-admin, finalize admin, cancel_writeoff
- **writeoff history** (5): hist_close, hist_reuse √ó2 (admin/no-admin), hist_edit_send √ó2
- **invoice** (3): save_template, confirm_send, cancel_template
- **request** (5): cancel_request, confirm_send √ó2 (no-receiver/normal), confirm_dup_send √ó2
- **min_stock** (2): enter_min_level, cancel_edit

---

### 2026-02-13 ‚Äî –ì–ª–æ–±–∞–ª—å–Ω–∞—è –æ—Ç–º–µ–Ω–∞, –∑–∞—â–∏—Ç–∞ –æ—Ç –∑–∞–≤–∏—Å–∞–Ω–∏—è FSM, edit-first –ø–∞—Ç—Ç–µ—Ä–Ω

**–¶–µ–ª—å:** –ë–æ—Ç –º–æ–≥ "–∑–∞–≤–∏—Å–Ω—É—Ç—å" –≤ —Å–æ—Å—Ç–æ—è–Ω–∏–∏ –≤–≤–æ–¥–∞ (–ø–æ–∏—Å–∫ —Ç–æ–≤–∞—Ä–∞), –≥–¥–µ Reply-–∫–Ω–æ–ø–∫–∏ –Ω–∞–≤–∏–≥–∞—Ü–∏–∏ –ø–µ—Ä–µ—Ö–≤–∞—Ç—ã–≤–∞–ª–∏—Å—å –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–æ–º –ø–æ–∏—Å–∫–∞, —É–¥–∞–ª—è–ª–∏—Å—å, –∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –º–æ–≥ –≤—ã–π—Ç–∏.

**1. –ì–ª–æ–±–∞–ª—å–Ω–∞—è –∫–æ–º–∞–Ω–¥–∞ `/cancel`** (`bot/global_commands.py` ‚Äî –ù–û–í–´–ô –§–ê–ô–õ)
- –†–∞–±–æ—Ç–∞–µ—Ç –∏–∑ –õ–Æ–ë–û–ì–û FSM-—Å–æ—Å—Ç–æ—è–Ω–∏—è (–∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è, —Å–ø–∏—Å–∞–Ω–∏—è, –Ω–∞–∫–ª–∞–¥–Ω—ã–µ, –∑–∞—è–≤–∫–∏, –º–∏–Ω. –æ—Å—Ç–∞—Ç–∫–∏, —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ)
- –†–µ–¥–∞–∫—Ç–∏—Ä—É–µ—Ç prompt-—Å–æ–æ–±—â–µ–Ω–∏–µ —Å —Ç–µ–∫—Å—Ç–æ–º –æ—Ç–º–µ–Ω—ã (edit-first, fallback –Ω–∞ answer)
- –£–¥–∞–ª—è–µ—Ç –æ—Å—Ç–∞–ª—å–Ω—ã–µ –±–æ—Ç-—Å–æ–æ–±—â–µ–Ω–∏—è (header, selection –∏ —Ç.–¥.)
- –û—á–∏—â–∞–µ—Ç FSM-—Å–æ—Å—Ç–æ—è–Ω–∏–µ
- –†–æ—É—Ç–µ—Ä –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω –ü–ï–†–í–´–ú –≤ `main.py`

**2. `NavResetMiddleware`** (`bot/global_commands.py`)
- Outer-middleware –Ω–∞ `dp.message` ‚Äî –ø–µ—Ä–µ—Ö–≤–∞—Ç—ã–≤–∞–µ—Ç –í–°–ï Reply-–∫–Ω–æ–ø–∫–∏ –Ω–∞–≤–∏–≥–∞—Ü–∏–∏
- –ï—Å–ª–∏ —É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∞–∫—Ç–∏–≤–Ω–æ–µ FSM-—Å–æ—Å—Ç–æ—è–Ω–∏–µ –∏ –Ω–∞–∂–∞—Ç–∞ –Ω–∞–≤–∏–≥–∞—Ü–∏–æ–Ω–Ω–∞—è –∫–Ω–æ–ø–∫–∞ ‚Üí —Å–±—Ä–æ—Å FSM + cleanup
- State-filtered –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ (search_product, enter_quantity) –ù–ï –º–∞—Ç—á–∞—Ç—Å—è ‚Üí –∫–Ω–æ–ø–∫–∞ –ø—Ä–æ—Ö–æ–¥–∏—Ç –∫ —à—Ç–∞—Ç–Ω–æ–º—É —Ö—ç–Ω–¥–ª–µ—Ä—É
- `NAV_BUTTONS` ‚Äî frozenset –∏–∑ 55+ —Ç–µ–∫—Å—Ç–æ–≤ –≤—Å–µ—Ö Reply-–∫–Ω–æ–ø–æ–∫ –∏–∑ –≤—Å–µ—Ö –º–µ–Ω—é

**3. Guard-—Ö—ç–Ω–¥–ª–µ—Ä—ã –¥–ª—è 10 inline-only —Å–æ—Å—Ç–æ—è–Ω–∏–π**
- `writeoff_handlers.py`: `AdminEditStates` (5 —Å–æ—Å—Ç–æ—è–Ω–∏–π), `HistoryStates.browsing/viewing` (2 —Å–æ—Å—Ç–æ—è–Ω–∏—è)
- `request_handlers.py`: `ReceiverMgmtStates` (3 —Å–æ—Å—Ç–æ—è–Ω–∏—è)
- –í—Å–µ —É–¥–∞–ª—è—é—Ç —Å–ª—É—á–∞–π–Ω—ã–π —Ç–µ–∫—Å—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ —Å–æ—Å—Ç–æ—è–Ω–∏—è—Ö, –≥–¥–µ –æ–∂–∏–¥–∞–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ inline-–≤–≤–æ–¥

**4. Edit-first –≤ `/cancel`**
- –í–º–µ—Å—Ç–æ —É–¥–∞–ª–µ–Ω–∏—è –≤—Å–µ—Ö —Å–æ–æ–±—â–µ–Ω–∏–π + –æ—Ç–ø—Ä–∞–≤–∫–∏ –Ω–æ–≤–æ–≥–æ ‚Üí —Ä–µ–¥–∞–∫—Ç–∏—Ä—É–µ—Ç prompt-—Å–æ–æ–±—â–µ–Ω–∏–µ —Å ¬´‚úÖ –î–µ–π—Å—Ç–≤–∏–µ –æ—Ç–º–µ–Ω–µ–Ω–æ¬ª
- –£–¥–∞–ª—è–µ—Ç —Ç–æ–ª—å–∫–æ –ø—Ä–æ—á–∏–µ –±–æ—Ç-—Å–æ–æ–±—â–µ–Ω–∏—è (header, selection)

**5. –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ `save_quantity` –≤ writeoff**
- –£–±—Ä–∞–Ω–æ –ª–∏—à–Ω–µ–µ —É–¥–∞–ª–µ–Ω–∏–µ `quantity_prompt_id` (—Å–æ–≤–ø–∞–¥–∞–ª —Å `prompt_msg_id`)
- –¢–µ–ø–µ—Ä—å `_send_prompt` —É—Å–ø–µ—à–Ω–æ —Ä–µ–¥–∞–∫—Ç–∏—Ä—É–µ—Ç —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –≤–º–µ—Å—Ç–æ fallback –Ω–∞ send

**6. –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –≤ `main.py`**
- `dp.message.outer_middleware(NavResetMiddleware())` ‚Äî –ø–µ—Ä–µ–¥ –≤—Å–µ–º–∏ —Ä–æ—É—Ç–µ—Ä–∞–º–∏
- `dp.include_router(global_router)` ‚Äî –ø–µ—Ä–≤—ã–π —Ä–æ—É—Ç–µ—Ä

---

### 2026-02-13 ‚Äî PDF-–¥–æ–∫—É–º–µ–Ω—Ç—ã —Ä–∞—Å—Ö–æ–¥–Ω—ã—Ö –Ω–∞–∫–ª–∞–¥–Ω—ã—Ö –∏ –∑–∞—è–≤–æ–∫

**–¶–µ–ª—å:** –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ —Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏–µ PDF –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ —Ä–∞—Å—Ö–æ–¥–Ω–æ–π –Ω–∞–∫–ª–∞–¥–Ω–æ–π (–ø–æ —à–∞–±–ª–æ–Ω—É) –∏ –ø—Ä–∏ –æ–¥–æ–±—Ä–µ–Ω–∏–∏/—Å–æ–∑–¥–∞–Ω–∏–∏ –∑–∞—è–≤–∫–∏. –î–æ–∫—É–º–µ–Ω—Ç —Å–æ–¥–µ—Ä–∂–∏—Ç 2 –∫–æ–ø–∏–∏ (–¥–ª—è –æ—Ç–ø—Ä–∞–≤–∏—Ç–µ–ª—è –∏ –ø–æ–ª—É—á–∞—Ç–µ–ª—è).

**1. Use-case** (`use_cases/pdf_invoice.py`)
- `generate_invoice_pdf()` ‚Äî —Ñ–æ—Ä–º–∏—Ä—É–µ—Ç PDF —Å –¥–≤—É–º—è –∫–æ–ø–∏—è–º–∏ –¥–æ–∫—É–º–µ–Ω—Ç–∞ (–Ω–æ–∂–Ω–∏—Ü—ã-—Ä–∞–∑–¥–µ–ª–∏—Ç–µ–ª—å)
- –ê–¥–∞–ø—Ç–∏–≤–Ω—ã–π —Ä–∞–∑–º–µ—Ä —à—Ä–∏—Ñ—Ç–∞ –∏ –≤—ã—Å–æ—Ç—ã —Å—Ç—Ä–æ–∫: ‚â§10 –ø–æ–∑. ‚Üí 9pt, ‚â§20 ‚Üí 8pt, ‚â§35 ‚Üí 7pt, ‚â§50 ‚Üí 6.5pt, >50 ‚Üí 6pt
- –°–æ–¥–µ—Ä–∂–∏–º–æ–µ: –∑–∞–≥–æ–ª–æ–≤–æ–∫, –¥–∞—Ç–∞, –ø–æ–¥—Ä–∞–∑–¥–µ–ª–µ–Ω–∏–µ, —Å–∫–ª–∞–¥ (–æ—Ç–∫—É–¥–∞), –∫–æ–Ω—Ç—Ä–∞–≥–µ–Ω—Ç (–∫—É–¥–∞), —Å—á—ë—Ç, –∞–≤—Ç–æ—Ä, –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π
- –¢–∞–±–ª–∏—Ü–∞: ‚Ññ, –ù–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ, –ï–¥., –ö–æ–ª-–≤–æ, –¶–µ–Ω–∞, –°—É–º–º–∞ + –∏—Ç–æ–≥–æ
- –ü–æ–¥–ø–∏—Å–∏: ¬´–û—Ç–ø—É—Å—Ç–∏–ª / –ü–æ–ª—É—á–∏–ª¬ª
- `generate_invoice_filename()` ‚Äî —Ç—Ä–∞–Ω—Å–ª–∏—Ç–µ—Ä–∏—Ä–æ–≤–∞–Ω–Ω–æ–µ –∏–º—è —Ñ–∞–π–ª–∞ –¥–ª—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏
- `_download_fonts()` ‚Äî –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ —Å–∫–∞—á–∏–≤–∞–Ω–∏–µ DejaVu Sans –ø—Ä–∏ –æ—Ç—Å—É—Ç—Å—Ç–≤–∏–∏ (Railway)

**2. –®—Ä–∏—Ñ—Ç—ã** (`fonts/`)
- DejaVu Sans + DejaVu Sans Bold ‚Äî –≤—Å—Ç—Ä–æ–µ–Ω—ã –≤ –ø—Ä–æ–µ–∫—Ç (Git)
- –ö–∏—Ä–∏–ª–ª–∏—Ü–∞ —Ä–∞–±–æ—Ç–∞–µ—Ç –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ –±–µ–∑ —É—Å—Ç–∞–Ω–æ–≤–∫–∏ —Å–∏—Å—Ç–µ–º–Ω—ã—Ö —à—Ä–∏—Ñ—Ç–æ–≤
- –ê–≤—Ç–æ—Å–∫–∞—á–∏–≤–∞–Ω–∏–µ –∏–∑ GitHub releases –µ—Å–ª–∏ —Ñ–∞–π–ª—ã –æ—Ç—Å—É—Ç—Å—Ç–≤—É—é—Ç

**3. –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è ‚Äî –Ω–∞–∫–ª–∞–¥–Ω—ã–µ –ø–æ —à–∞–±–ª–æ–Ω—É** (`bot/invoice_handlers.py`)
- –ü–æ—Å–ª–µ —É—Å–ø–µ—à–Ω–æ–π –æ—Ç–ø—Ä–∞–≤–∫–∏ –≤ iiko ‚Üí –≥–µ–Ω–µ—Ä–∞—Ü–∏—è PDF ‚Üí –æ—Ç–ø—Ä–∞–≤–∫–∞ –¥–æ–∫—É–º–µ–Ω—Ç–æ–º –≤ —á–∞—Ç
- `BufferedInputFile` ‚Äî PDF –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è –∫–∞–∫ Telegram-–¥–æ–∫—É–º–µ–Ω—Ç

**4. –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è ‚Äî –∑–∞—è–≤–∫–∏** (`bot/request_handlers.py`)
- –ü—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –∑–∞—è–≤–∫–∏: PDF –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è –≤–º–µ—Å—Ç–µ —Å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ–º –∫–∞–∂–¥–æ–º—É –ø–æ–ª—É—á–∞—Ç–µ–ª—é
- –ü—Ä–∏ –æ–¥–æ–±—Ä–µ–Ω–∏–∏ –∑–∞—è–≤–∫–∏: PDF –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è –æ–¥–æ–±—Ä–∏–≤—à–µ–º—É + —Å–æ–∑–¥–∞—Ç–µ–ª—é –∑–∞—è–≤–∫–∏

**5. –ó–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏**
- –î–æ–±–∞–≤–ª–µ–Ω–∞ `reportlab>=4.0.0` –≤ `requirements.txt`

---

### 2026-02-13 ‚Äî –ì—Ä–∞–Ω—É–ª—è—Ä–Ω—ã–µ –ø—Ä–∞–≤–∞ –¥–æ—Å—Ç—É–ø–∞ —á–µ—Ä–µ–∑ Google –¢–∞–±–ª–∏—Ü—É

**–¶–µ–ª—å:** –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø—Ä–∞–≤–∞–º–∏ –¥–æ—Å—Ç—É–ø–∞ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤ –∫ —Ä–∞–∑–¥–µ–ª–∞–º –±–æ—Ç–∞ —á–µ—Ä–µ–∑ Google –¢–∞–±–ª–∏—Ü—É (–±–µ–∑ –¥–µ–ø–ª–æ—è –∏ –∫–æ–¥–∞).

**1. Use-case** (`use_cases/permissions.py`)
- In-memory –∫–µ—à –ø—Ä–∞–≤ —Å TTL 5 –º–∏–Ω (graceful degradation ‚Äî –µ—Å–ª–∏ GSheet –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω, –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è —Å—Ç–∞—Ä—ã–π –∫–µ—à)
- `has_permission(telegram_id, perm_key)` ‚Äî –ø—Ä–æ–≤–µ—Ä–∫–∞ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–≥–æ –ø—Ä–∞–≤–∞; –∞–¥–º–∏–Ω—ã –∏–º–µ—é—Ç bypass (–≤—Å—ë —Ä–∞–∑—Ä–µ—à–µ–Ω–æ)
- `get_allowed_keys(telegram_id)` ‚Äî –º–Ω–æ–∂–µ—Å—Ç–≤–æ —Ä–∞–∑—Ä–µ—à—ë–Ω–Ω—ã—Ö –∫–ª—é—á–µ–π (–¥–ª—è —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏ –∫–ª–∞–≤–∏–∞—Ç—É—Ä—ã)
- `sync_permissions_to_gsheet()` ‚Äî –≤—ã–≥—Ä—É–∑–∫–∞ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω–Ω—ã—Ö —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤ + —Å—Ç–æ–ª–±—Ü–æ–≤ –ø—Ä–∞–≤
  - –î–æ–±–∞–≤–ª—è–µ—Ç –Ω–æ–≤—ã—Ö —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤ —Å –ø—É—Å—Ç—ã–º–∏ –ø—Ä–∞–≤–∞–º–∏
  - –î–æ–±–∞–≤–ª—è–µ—Ç –Ω–æ–≤—ã–µ —Å—Ç–æ–ª–±—Ü—ã –µ—Å–ª–∏ PERMISSION_KEYS —Ä–∞—Å—à–∏—Ä–∏–ª—Å—è
  - –ù–ï —É–¥–∞–ª—è–µ—Ç —Å—Ç—Ä–æ–∫–∏ —É–≤–æ–ª–µ–Ω–Ω—ã—Ö, –ù–ï —Å—Ç–∏—Ä–∞–µ—Ç —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ ‚úÖ/‚ùå
- `PERMISSION_KEYS` = [üìù –°–ø–∏—Å–∞–Ω–∏—è, üì¶ –ù–∞–∫–ª–∞–¥–Ω—ã–µ, üìã –ó–∞—è–≤–∫–∏, üìä –û—Ç—á—ë—Ç—ã, ‚öôÔ∏è –ù–∞—Å—Ç—Ä–æ–π–∫–∏]

**2. GSheet –∞–¥–∞–ø—Ç–µ—Ä** (`adapters/google_sheets.py`)
- –ù–æ–≤—ã–π –ª–∏—Å—Ç ¬´–ü—Ä–∞–≤–∞ –¥–æ—Å—Ç—É–ø–∞¬ª –≤ —Ç–æ–π –∂–µ —Ç–∞–±–ª–∏—Ü–µ
- `read_permissions_sheet()` ‚Äî —á—Ç–µ–Ω–∏–µ –º–∞—Ç—Ä–∏—Ü—ã –ø—Ä–∞–≤ ‚Üí [{telegram_id, perms: {key: bool}}]
- `sync_permissions_to_sheet(employees, permission_keys)` ‚Äî –∑–∞–ø–∏—Å—å —Å –∑–∞—â–∏—Ç–æ–π –æ—Ç –ø–æ—Ç–µ—Ä–∏ –¥–∞–Ω–Ω—ã—Ö
- –§–æ—Ä–º–∞—Ç: —Å—Ç—Ä–æ–∫–∞ 1=–º–µ—Ç–∞, —Å—Ç—Ä–æ–∫–∞ 2=–∑–∞–≥–æ–ª–æ–≤–∫–∏, —Å—Ç—Ä–æ–∫–∞ 3+=—Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∏ —Å ‚úÖ/–ø—É—Å—Ç–æ
- Data validation (dropdown ‚úÖ/–ø—É—Å—Ç–æ) –¥–ª—è —Å—Ç–æ–ª–±—Ü–æ–≤ –ø—Ä–∞–≤
- –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ: —Å–∫—Ä—ã—Ç–∞—è –º–µ—Ç–∞-—Å—Ç—Ä–æ–∫–∞, –∑–∞–º–æ—Ä–æ–∑–∫–∞ 2 —Å—Ç—Ä–æ–∫ + 1 —Å—Ç–æ–ª–±—Ü–∞

**3. Middleware** (`bot/middleware.py`)
- –ù–æ–≤—ã–π –¥–µ–∫–æ—Ä–∞—Ç–æ—Ä `permission_required(perm_key)` ‚Äî –ø—Ä–æ–≤–µ—Ä—è–µ—Ç –ø—Ä–∞–≤–æ —á–µ—Ä–µ–∑ `perm_uc.has_permission()`
- –ü—Ä–∏–º–µ–Ω—ë–Ω –Ω–∞ –≤—Å–µ —Ä–∞–∑–¥–µ–ª—ã –≥–ª–∞–≤–Ω–æ–≥–æ –º–µ–Ω—é: –°–ø–∏—Å–∞–Ω–∏—è, –ù–∞–∫–ª–∞–¥–Ω—ã–µ, –ó–∞—è–≤–∫–∏, –û—Ç—á—ë—Ç—ã, –ù–∞—Å—Ç—Ä–æ–π–∫–∏

**4. –ö–ª–∞–≤–∏–∞—Ç—É—Ä–∞** (`bot/handlers.py`)
- `_main_keyboard(allowed)` ‚Äî –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∞—è —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏—è –∫–Ω–æ–ø–æ–∫ –ø–æ –º–Ω–æ–∂–µ—Å—Ç–≤—É —Ä–∞–∑—Ä–µ—à—ë–Ω–Ω—ã—Ö –ø—Ä–∞–≤
- `_get_main_kb(tg_id)` ‚Äî async-–æ–±—ë—Ä—Ç–∫–∞, –ø–æ–¥–≥—Ä—É–∂–∞–µ—Ç –ø—Ä–∞–≤–∞ –∏ —Å—Ç—Ä–æ–∏—Ç –∫–ª–∞–≤–∏–∞—Ç—É—Ä—É
- ¬´üè† –°–º–µ–Ω–∏—Ç—å —Ä–µ—Å—Ç–æ—Ä–∞–Ω¬ª ‚Äî –≤—Å–µ–≥–¥–∞ –≤–∏–¥–Ω–∞ (–Ω–µ –∫–æ–Ω—Ç—Ä–æ–ª–∏—Ä—É–µ—Ç—Å—è –ø—Ä–∞–≤–∞–º–∏)
- –ù–æ–≤–∞—è –∫–Ω–æ–ø–∫–∞ –≤ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞—Ö: ¬´üîë –ü—Ä–∞–≤–∞ –¥–æ—Å—Ç—É–ø–∞ ‚Üí GSheet¬ª

**–ü—Ä–∏–Ω—Ü–∏–ø —Ä–∞–±–æ—Ç—ã:**
- –ö–∞–∂–¥—ã–π –∑–∞–ø—Ä–æ—Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è ‚Üí –ø—Ä–æ–≤–µ—Ä–∫–∞ –ø—Ä–∞–≤ –∏–∑ in-memory –∫–µ—à–∞ (TTL 5 –º–∏–Ω)
- –ü—Ä–∏ –ø—Ä–æ–º–∞—Ö–µ –∫–µ—à–∞ ‚Üí —á—Ç–µ–Ω–∏–µ –ª–∏—Å—Ç–∞ –∏–∑ Google –¢–∞–±–ª–∏—Ü—ã ~1-2 —Å–µ–∫
- –ö–Ω–æ–ø–∫–∞ ¬´üîë –ü—Ä–∞–≤–∞ –¥–æ—Å—Ç—É–ø–∞ ‚Üí GSheet¬ª ‚Äî —Ç–æ–ª—å–∫–æ –¥–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –Ω–æ–≤—ã—Ö —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤/—Å—Ç–æ–ª–±—Ü–æ–≤
- –ê–¥–º–∏–Ω –ø—Ä–∞–≤–∏—Ç ‚úÖ/‚ùå –ø—Ä—è–º–æ –≤ —Ç–∞–±–ª–∏—Ü–µ ‚Üí —á–µ—Ä–µ–∑ 5 –º–∏–Ω (–∏–ª–∏ –ø–æ—Å–ª–µ –∏–Ω–≤–∞–ª–∏–¥–∞—Ü–∏–∏) –∏–∑–º–µ–Ω–µ–Ω–∏—è –≤—Å—Ç—É–ø–∞—é—Ç –≤ —Å–∏–ª—É

---

### 2026-02-12 ‚Äî –°–∏—Å—Ç–µ–º–∞ –∑–∞—è–≤–æ–∫ –Ω–∞ —Ç–æ–≤–∞—Ä—ã + –∏—Å—Ç–æ—Ä–∏—è —Å –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏–µ–º

**–¶–µ–ª—å:** –¢–æ—á–∫–∏ —Å–æ–∑–¥–∞—é—Ç –∑–∞—è–≤–∫–∏ –Ω–∞ —Ç–æ–≤–∞—Ä—ã ‚Üí –ø–æ–ª—É—á–∞—Ç–µ–ª–∏ –æ–¥–æ–±—Ä—è—é—Ç/—Ä–µ–¥–∞–∫—Ç–∏—Ä—É—é—Ç ‚Üí —Ä–∞—Å—Ö–æ–¥–Ω–∞—è –Ω–∞–∫–ª–∞–¥–Ω–∞—è –≤ iiko. –ü–æ–≤—Ç–æ—Ä–Ω–∞—è –æ—Ç–ø—Ä–∞–≤–∫–∞ –∏–∑ –∏—Å—Ç–æ—Ä–∏–∏.

**1. –ú–æ–¥–µ–ª–∏ –ë–î** (`db/models.py`)
- `RequestReceiver` ‚Äî —Ç–∞–±–ª–∏—Ü–∞ `request_receiver`: telegram_id (unique+indexed), employee_id, employee_name, added_at, added_by
- `ProductRequest` ‚Äî —Ç–∞–±–ª–∏—Ü–∞ `product_request`: pk, status (pending/approved/cancelled), requester_tg (indexed), department_id (indexed), store_id, counteragent_id, account_id, items (JSONB), total_sum, comment, approved_by, created_at, approved_at
- –ò–Ω–¥–µ–∫—Å—ã: `ix_request_receiver_telegram_id`, `ix_product_request_requester`, `ix_product_request_dept`, `ix_product_request_status`

**2. –ë–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫–∞** (`use_cases/product_request.py`)
- –ö–µ—à –ø–æ–ª—É—á–∞—Ç–µ–ª–µ–π: `_receiver_ids_cache` (in-memory, –∫–∞–∫ admin_ids)
- CRUD –ø–æ–ª—É—á–∞—Ç–µ–ª–µ–π: `add_receiver()`, `remove_receiver()`, `list_receivers()`, `is_receiver()`, `get_available_for_receiver()`
- –ó–∞—è–≤–∫–∏: `create_request()`, `get_request_by_pk()`, `get_pending_requests()`, `approve_request()`, `cancel_request()`
- –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ: `update_request_items()` ‚Äî –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø–æ–∑–∏—Ü–∏–π –∏ —Å—É–º–º—ã –ø–æ–ª—É—á–∞—Ç–µ–ª–µ–º
- –ò—Å—Ç–æ—Ä–∏—è: `get_user_requests(telegram_id, limit)` ‚Äî –ø–æ—Å–ª–µ–¥–Ω–∏–µ –∑–∞—è–≤–∫–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
- –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ: `format_request_text()`, `format_receiver_list()`

**3. –•—ç–Ω–¥–ª–µ—Ä—ã** (`bot/request_handlers.py`)
- **A) –°–æ–∑–¥–∞–Ω–∏–µ –∑–∞—è–≤–∫–∏** ‚Äî `CreateRequestStates`: store ‚Üí supplier_choose ‚Üí add_items ‚Üí enter_item_qty ‚Üí confirm
  - –ü–æ–∏—Å–∫ —Ç–æ–≤–∞—Ä–æ–≤ –ø–æ –Ω–∞–∑–≤–∞–Ω–∏—é (`search_price_products()`), –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ –ø–æ –æ–¥–Ω–æ–º—É —Å –≤–≤–æ–¥–æ–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞
  - –ö–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏—è –µ–¥–∏–Ω–∏—Ü (–≥‚Üí–∫–≥, –º–ª‚Üí–ª), –∞–∫—Ç—É–∞–ª—å–Ω—ã–µ —Ü–µ–Ω—ã –∏–∑ –ø—Ä–∞–π—Å-–ª–∏—Å—Ç–∞
  - –ö–Ω–æ–ø–∫–∏: ¬´‚úÖ –û—Ç–ø—Ä–∞–≤–∏—Ç—å –∑–∞—è–≤–∫—É (N –ø–æ–∑.)¬ª, ¬´üóë –£–¥–∞–ª–∏—Ç—å –ø–æ—Å–ª–µ–¥–Ω–∏–π¬ª, ¬´‚ùå –û—Ç–º–µ–Ω–∞¬ª
  - –ü—Ä–∏ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–∏: —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –≤ –ë–î ‚Üí —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –≤—Å–µ—Ö –ø–æ–ª—É—á–∞—Ç–µ–ª–µ–π
- **B) –û–¥–æ–±—Ä–µ–Ω–∏–µ/—Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ** ‚Äî –ø–æ–ª—É—á–∞—Ç–µ–ª–∏:
  - ¬´‚úÖ –û—Ç–ø—Ä–∞–≤–∏—Ç—å¬ª ‚Üí `build_outgoing_invoice_document()` + `send_outgoing_invoice_document()` ‚Üí iiko (XML-–∏–º–ø–æ—Ä—Ç, —Å—Ç–∞—Ç—É—Å PROCESSED)
  - ¬´‚úèÔ∏è –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞¬ª ‚Üí `EditRequestStates.enter_quantities` ‚Üí –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –≤ –ë–î ‚Üí –ø–æ–≤—Ç–æ—Ä–Ω—ã–π –ø–æ–∫–∞–∑ —Å –∫–Ω–æ–ø–∫–∞–º–∏
  - ¬´‚ùå –û—Ç–º–µ–Ω–∏—Ç—å¬ª ‚Üí cancelled + —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ —Å–æ–∑–¥–∞—Ç–µ–ª—è
- **C) –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø–æ–ª—É—á–∞—Ç–µ–ª—è–º–∏** ‚Äî `ReceiverMgmtStates`: menu ‚Üí choosing_employee ‚Üí confirm_remove (—Ç–æ–ª—å–∫–æ –∞–¥–º–∏–Ω—ã)
- **D) –ò—Å—Ç–æ—Ä–∏—è –∑–∞—è–≤–æ–∫ + –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏–µ** ‚Äî `DuplicateRequestStates`: enter_quantities ‚Üí confirm
  - ¬´üìã –ò—Å—Ç–æ—Ä–∏—è –∑–∞—è–≤–æ–∫¬ª ‚Äî –ø–æ—Å–ª–µ–¥–Ω–∏–µ 10 –∑–∞—è–≤–æ–∫ —Å –∫–Ω–æ–ø–∫–∞–º–∏ –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ –∏ üîÑ (–ø–æ–≤—Ç–æ—Ä–∏—Ç—å)
  - –î—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏–µ: –ø–æ–∫–∞–∑ –ø–æ–∑–∏—Ü–∏–π —Å—Ç–∞—Ä–æ–π –∑–∞—è–≤–∫–∏ ‚Üí –≤–≤–æ–¥ –Ω–æ–≤—ã—Ö –∫–æ–ª–∏—á–µ—Å—Ç–≤ ‚Üí –ø—Ä–µ–≤—å—é ‚Üí –æ—Ç–ø—Ä–∞–≤–∫–∞ –ø–æ–ª—É—á–∞—Ç–µ–ª—è–º
  - –¶–µ–Ω—ã –æ–±–Ω–æ–≤–ª—è—é—Ç—Å—è –∏–∑ –∞–∫—Ç—É–∞–ª—å–Ω–æ–≥–æ –ø—Ä–∞–π—Å-–ª–∏—Å—Ç–∞ –ø—Ä–∏ –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏–∏

**4. –ö–Ω–æ–ø–∫–∏ –º–µ–Ω—é** (`bot/handlers.py`)
- –ü–æ–¥–º–µ–Ω—é ¬´–î–æ–∫—É–º–µ–Ω—Ç—ã¬ª: –¥–æ–±–∞–≤–ª–µ–Ω—ã ¬´üìù –°–æ–∑–¥–∞—Ç—å –∑–∞—è–≤–∫—É¬ª, ¬´üìã –ò—Å—Ç–æ—Ä–∏—è –∑–∞—è–≤–æ–∫¬ª, ¬´üì¨ –í—Ö–æ–¥—è—â–∏–µ –∑–∞—è–≤–∫–∏¬ª
- –ü–æ–¥–º–µ–Ω—é ¬´–°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è¬ª: ¬´üì¨ –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø–æ–ª—É—á–∞—Ç–µ–ª—è–º–∏¬ª (admin-only)

**5. –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è —Ä–∞—Å—Ö–æ–¥–Ω—ã—Ö –Ω–∞–∫–ª–∞–¥–Ω—ã—Ö** (`use_cases/outgoing_invoice.py`, `adapters/iiko_api.py`)
- ContainerId: —Ä–µ–∞–ª—å–Ω—ã–π ID –∏–∑ `iiko_product.raw_json -> containers[0].id` (–Ω–µ null UUID)
- XML-–≤–∞–ª–∏–¥–∞—Ü–∏—è: –ø–∞—Ä—Å–∏–Ω–≥ `<valid>false</valid>` –∏–∑ –æ—Ç–≤–µ—Ç–∞ iiko (HTTP 200 –¥–∞–∂–µ –ø—Ä–∏ –æ—à–∏–±–∫–µ)
- –°—Ç–∞—Ç—É—Å: `"status": "PROCESSED"` –≤–º–µ—Å—Ç–æ `"NEW"`

---

### 2026-02-12 ‚Äî –ü—Ä–∞–π—Å-–ª–∏—Å—Ç –Ω–∞–∫–ª–∞–¥–Ω—ã—Ö + —Å–µ–±–µ—Å—Ç–æ–∏–º–æ—Å—Ç—å –∏–∑ iiko

**–¶–µ–ª—å:** Google –¢–∞–±–ª–∏—Ü–∞ —Å —Ç–æ–≤–∞—Ä–∞–º–∏ –¥–ª—è —Ä–∞—Å—Ö–æ–¥–Ω—ã—Ö –Ω–∞–∫–ª–∞–¥–Ω—ã—Ö, –∞–≤—Ç–æ-—Ä–∞—Å—á—ë—Ç —Å–µ–±–µ—Å—Ç–æ–∏–º–æ—Å—Ç–∏.

**1. iiko API ‚Äî –¥–≤–∞ –Ω–æ–≤—ã—Ö —ç–Ω–¥–ø–æ–∏–Ω—Ç–∞** (`adapters/iiko_api.py`)
- `fetch_incoming_invoices(date_from, date_to)` ‚Äî GET `/resto/api/documents/export/incomingInvoice` (XML ‚Üí list[dict])
- `fetch_assembly_charts(date_from, date_to)` ‚Äî GET `/resto/api/v2/assemblyCharts/getAll` (JSON, includePreparedCharts)

**2. –†–∞—Å—á—ë—Ç —Å–µ–±–µ—Å—Ç–æ–∏–º–æ—Å—Ç–∏** (`use_cases/outgoing_invoice.py`)
- `calculate_goods_cost_prices(days_back=90)` ‚Äî —Ü–µ–Ω–∞ GOODS –ø–æ –ø–æ—Å–ª–µ–¥–Ω–µ–º—É –ø—Ä–∏—Ö–æ–¥—É (–ø—Ä–∏—Ö–æ–¥–Ω—ã–µ –Ω–∞–∫–ª–∞–¥–Ω—ã–µ –∑–∞ N –¥–Ω–µ–π)
- `calculate_dish_cost_prices(goods_costs)` ‚Äî —Å–µ–±–µ—Å—Ç–æ–∏–º–æ—Å—Ç—å DISH: sum(ingredient.amountOut √ó ingredient_cost) –ø–æ —Ç–µ—Ö–∫–∞—Ä—Ç–∞–º
- `sync_price_sheet()` ‚Äî –ø–æ–ª–Ω—ã–π –ø–∞–π–ø–ª–∞–π–Ω: –¥–µ—Ä–µ–≤–æ —Ç–æ–≤–∞—Ä–æ–≤ ‚Üí GOODS cost ‚Üí DISH cost ‚Üí Google Sheet

**3. Google Sheet ¬´–ü—Ä–∞–π—Å-–ª–∏—Å—Ç¬ª** (`adapters/google_sheets.py`)
- `sync_invoice_prices_to_sheet(products, cost_prices)` ‚Äî –∑–∞–ø–∏—Å—å —Å —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ–º —Ä—É—á–Ω—ã—Ö —Ü–µ–Ω (D —Å—Ç–æ–ª–±–µ—Ü)
- `read_invoice_prices()` ‚Äî —á—Ç–µ–Ω–∏–µ –ø—Ä–∞–π—Å-–ª–∏—Å—Ç–∞
- –°—Ç–æ–ª–±—Ü—ã: A=–¢–æ–≤–∞—Ä, B=ID (—Å–∫—Ä—ã—Ç—ã–π), C=–°–µ–±–µ—Å—Ç–æ–∏–º–æ—Å—Ç—å (–∞–≤—Ç–æ), D=–¶–µ–Ω–∞ –æ—Ç–≥—Ä—É–∑–∫–∏ (—Ä—É—á–Ω–∞—è)
- –ü–∞—Ç—Ç–µ—Ä–Ω stable-rows: –ø—Ä–∏–≤—è–∑–∫–∞ –ø–æ product_id, –Ω–æ–≤—ã–µ –ø–æ–∑–∏—Ü–∏–∏ –Ω–µ —Å–¥–≤–∏–≥–∞—é—Ç —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ

**4. –ö–Ω–æ–ø–∫–∞ –±–æ—Ç–∞** (`bot/handlers.py`)
- ¬´üí∞ –ü—Ä–∞–π—Å-–ª–∏—Å—Ç ‚Üí GSheet¬ª –≤ –ø–æ–¥–º–µ–Ω—é ¬´–ö–æ–º–∞–Ω–¥—ã¬ª (admin_required)
- –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è: INVOICE_PRICE_SHEET_ID (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é = MIN_STOCK_SHEET_ID)

---

### 2026-02-12 ‚Äî –†–∞—Å—Ö–æ–¥–Ω–∞—è –Ω–∞–∫–ª–∞–¥–Ω–∞—è: —à–∞–±–ª–æ–Ω—ã (Phase 1)

**–¶–µ–ª—å:** –°–æ–∑–¥–∞–Ω–∏–µ —à–∞–±–ª–æ–Ω–æ–≤ —Ä–∞—Å—Ö–æ–¥–Ω—ã—Ö –Ω–∞–∫–ª–∞–¥–Ω—ã—Ö –¥–ª—è –±—ã—Å—Ç—Ä–æ–≥–æ –ø–æ–≤—Ç–æ—Ä–Ω–æ–≥–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è.

**1. –ú–æ–¥–µ–ª—å `InvoiceTemplate`** (`db/models.py`)
- –¢–∞–±–ª–∏—Ü–∞ ‚Ññ16 iiko/bot (‚Ññ29 –æ–±—â–∞—è), JSONB-–ø–æ–ª–µ items [{product_id, name, unit_name}]
- –î–µ–Ω–æ—Ä–º–∞–ª–∏–∑–æ–≤–∞–Ω–Ω—ã–µ –ø–æ–ª—è: counteragent_name, account_name, store_name
- –ò–Ω–¥–µ–∫—Å—ã: created_by, department_id

**2. –ö–µ—à `use_cases/invoice_cache.py`**
- TTL 600—Å: suppliers, revenue_account, stores (–ø–æ dept), products_tree
- –ü–∞—Ç—Ç–µ—Ä–Ω writeoff_cache: in-memory dict {key: (data, timestamp)}

**3. –ë–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫–∞ `use_cases/outgoing_invoice.py`**
- `load_all_suppliers()` + `search_suppliers(query)` ‚Äî –ø–æ–∏—Å–∫ –∫–æ–Ω—Ç—Ä–∞–≥–µ–Ω—Ç–æ–≤
- `get_revenue_account()` ‚Äî –∞–≤—Ç–æ-–ø–æ–∏—Å–∫ —Å—á—ë—Ç–∞ ¬´—Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è –Ω–∞ —Ç–æ—á–∫–∏¬ª
- `get_stores_for_department()` ‚Äî —Ç–æ–ª—å–∫–æ –±–∞—Ä/–∫—É—Ö–Ω—è
- `preload_products_tree()` ‚Äî BFS –ø–æ gsheet_export_group ‚Üí —Ñ–∏–ª—å—Ç—Ä GOODS+DISH
- `save_template()`, `get_templates_for_department()`, `delete_template()`

**4. –•—ç–Ω–¥–ª–µ—Ä—ã `bot/invoice_handlers.py`**
- FSM: store ‚Üí supplier_search ‚Üí supplier_choose ‚Üí add_items ‚Üí template_name
- Summary+prompt –ø–∞—Ç—Ç–µ—Ä–Ω, guard-—Ö—ç–Ω–¥–ª–µ—Ä—ã, inline-–∫–Ω–æ–ø–∫–∏
- –ö–Ω–æ–ø–∫–∞ ¬´üìã –°–æ–∑–¥–∞—Ç—å —à–∞–±–ª–æ–Ω –Ω–∞–∫–ª–∞–¥–Ω–æ–π¬ª –≤ –º–µ–Ω—é ¬´–î–æ–∫—É–º–µ–Ω—Ç—ã¬ª

---

### 2026-02-12 ‚Äî –ö–µ—à –Ω–æ–º–µ–Ω–∫–ª–∞—Ç—É—Ä—ã –¥–ª—è –º–≥–Ω–æ–≤–µ–Ω–Ω–æ–≥–æ –ø–æ–∏—Å–∫–∞ —Ç–æ–≤–∞—Ä–æ–≤

**–ü—Ä–æ–±–ª–µ–º–∞:** –ü–æ–∏—Å–∫ —Ç–æ–≤–∞—Ä–æ–≤ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ —Å–ø–∏—Å–∞–Ω–∏—è = ~2.3 —Å–µ–∫ (DB round-trip Railway).
**–†–µ—à–µ–Ω–∏–µ:** In-memory –∫–µ—à –≤—Å–µ—Ö GOODS/PREPARED —Ç–æ–≤–∞—Ä–æ–≤ —Å –ø—Ä–µ–¥—Ä–µ–∑–æ–ª–≤–ª–µ–Ω–Ω—ã–º–∏ –µ–¥–∏–Ω–∏—Ü–∞–º–∏ –∏–∑–º–µ—Ä–µ–Ω–∏—è.
- `preload_products()` –≤ `writeoff.py` ‚Äî –∑–∞–≥—Ä—É–∂–∞–µ—Ç –≤—Å–µ 1942 —Ç–æ–≤–∞—Ä–∞ + –±–∞—Ç—á-—Ä–µ–∑–æ–ª–≤ units ‚Üí –∫–µ—à (~400 –ö–ë RAM)
- `search_products()` ‚Äî —Å–Ω–∞—á–∞–ª–∞ –∏—â–µ—Ç –≤ –∫–µ—à–µ (0 –º—Å), fallback –Ω–∞ –ë–î –µ—Å–ª–∏ –∫–µ—à –ø—É—Å—Ç
- –ü—Ä–æ–≥—Ä–µ–≤ –ø—Ä–∏ –≤—Ö–æ–¥–µ –≤ ¬´–î–æ–∫—É–º–µ–Ω—Ç—ã¬ª –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ —Å–æ —Å–∫–ª–∞–¥–∞–º–∏/—Å—á–µ—Ç–∞–º–∏/admin_ids
- TTL 10 –º–∏–Ω (–∫–∞–∫ —Å–∫–ª–∞–¥—ã/—Å—á–µ—Ç–∞)
- `get_products()` / `set_products()` –≤ `writeoff_cache.py`

---

### 2026-02-12 ‚Äî –ò—Å—Ç–æ—Ä–∏—è —Å–ø–∏—Å–∞–Ω–∏–π (writeoff_history)

**1. –ù–æ–≤–∞—è —Ç–∞–±–ª–∏—Ü–∞ `writeoff_history`**
- –ú–æ–¥–µ–ª—å `WriteoffHistory` –≤ `db/models.py` (—Ç–∞–±–ª–∏—Ü–∞ ‚Ññ15 iiko/bot, ‚Ññ28 –æ–±—â–∞—è)
- JSONB-–ø–æ–ª–µ `items` –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è –ø–æ–∑–∏—Ü–∏–π —Å–ø–∏—Å–∞–Ω–∏—è
- `store_type` (bar/kitchen/NULL) –¥–ª—è —Ä–æ–ª–µ–≤–æ–π —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏
- –ò–Ω–¥–µ–∫—Å—ã: telegram_id, department_id, store_type, created_at
- –ú–∏–≥—Ä–∞—Ü–∏—è: 4 CREATE INDEX IF NOT EXISTS –≤ `db/init_db.py`

**2. –ë–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫–∞ `use_cases/writeoff_history.py`**
- `save_to_history()` ‚Äî —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –æ–¥–æ–±—Ä–µ–Ω–Ω–æ–≥–æ —Å–ø–∏—Å–∞–Ω–∏—è + –∞–≤—Ç–æ-–æ—á–∏—Å—Ç–∫–∞ (>200 –∑–∞–ø–∏—Å–µ–π –Ω–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è)
- `get_history(telegram_id, department_id, role_type, page)` ‚Äî —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏—è: –±–∞—Ä ‚Üí —Ç–æ–ª—å–∫–æ –±–∞—Ä, –∫—É—Ö–Ω—è ‚Üí —Ç–æ–ª—å–∫–æ –∫—É—Ö–Ω—è, admin/unknown ‚Üí –≤—Å–µ
- `get_history_entry(pk)`, `build_history_summary()` ‚Äî –¥–µ—Ç–∞–ª–∏ –∑–∞–ø–∏—Å–∏
- `_detect_store_type()` ‚Äî –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ —Ç–∏–ø–∞ —Å–∫–ª–∞–¥–∞ (–±–∞—Ä/–∫—É—Ö–Ω—è) –ø–æ –∏–º–µ–Ω–∏
- MAX_HISTORY_PER_USER=200, HISTORY_PAGE_SIZE=10

**3. Telegram-—Ö—ç–Ω–¥–ª–µ—Ä—ã (bot/writeoff_handlers.py)**
- FSM `HistoryStates`: browsing ‚Üí viewing ‚Üí editing_reason / editing_items / editing_quantity
- –ü—Ä–æ—Å–º–æ—Ç—Ä: —Å–ø–∏—Å–æ–∫ —Å –ø–∞–≥–∏–Ω–∞—Ü–∏–µ–π, –¥–µ—Ç–∞–ª–∏ –∑–∞–ø–∏—Å–∏, –∫–Ω–æ–ø–∫–∏ ¬´–ø–æ–≤—Ç–æ—Ä–∏—Ç—å –∫–∞–∫ –µ—Å—Ç—å¬ª / ¬´—Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –∏ –æ—Ç–ø—Ä–∞–≤–∏—Ç—å¬ª
- –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –ø–µ—Ä–µ–¥ –ø–æ–≤—Ç–æ—Ä–æ–º: –ø—Ä–∏—á–∏–Ω–∞, –ø–æ–∑–∏—Ü–∏–∏ (–∫–æ–ª–∏—á–µ—Å—Ç–≤–æ, —É–¥–∞–ª–µ–Ω–∏–µ, –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ –Ω–æ–≤–æ–≥–æ —Ç–æ–≤–∞—Ä–∞)
- Callback-–ø—Ä–µ—Ñ–∏–∫—Å—ã: `woh_` (history browse), `wohe_` (history edit)
- –í–∞–ª–∏–¥–∞—Ü–∏—è callback_data: –≤—Å–µ int-–ø–∞—Ä—Å–∏–Ω–≥–∏ –æ–±—ë—Ä–Ω—É—Ç—ã –≤ try/except (ValueError, IndexError)
- –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ: tg_id + –¥–µ–π—Å—Ç–≤–∏–µ –≤–æ –≤—Å–µ—Ö —Ö—ç–Ω–¥–ª–µ—Ä–∞—Ö

**4. –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è save_to_history**
- `admin_approve` ‚Äî –ø–æ—Å–ª–µ —É—Å–ø–µ—à–Ω–æ–π –æ—Ç–ø—Ä–∞–≤–∫–∏ –≤ iiko
- `finalize_writeoff` (no-admin) ‚Äî –ø–æ—Å–ª–µ –ø—Ä—è–º–æ–π –æ—Ç–ø—Ä–∞–≤–∫–∏
- `hist_reuse` (no-admin) ‚Äî –ø–æ–≤—Ç–æ—Ä –∏–∑ –∏—Å—Ç–æ—Ä–∏–∏
- `hist_edit_send` (no-admin) ‚Äî –ø–æ–≤—Ç–æ—Ä —Å –∏–∑–º–µ–Ω–µ–Ω–∏—è–º–∏

**5. UI**
- –ö–Ω–æ–ø–∫–∞ ¬´üìã –ò—Å—Ç–æ—Ä–∏—è —Å–ø–∏—Å–∞–Ω–∏–π¬ª –≤ –ø–æ–¥–º–µ–Ω—é ¬´–î–æ–∫—É–º–µ–Ω—Ç—ã¬ª (`bot/handlers.py`)

**6. –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è**
- `docs/DATABASE.md`: —Ç–∞–±–ª–∏—Ü–∞ ‚Ññ28, —Å—á—ë—Ç—á–∏–∫–∏ 27‚Üí28, 14‚Üí15
- `docs/FILE_STRUCTURE.md`: writeoff_history.py, HistoryStates, –∫–Ω–æ–ø–∫–∞ ¬´üìã –ò—Å—Ç–æ—Ä–∏—è¬ª
- `PROJECT_MAP.md`: –æ–ø–∏—Å–∞–Ω–∏–µ —Ñ–∞–∑—ã, –Ω–∞–≤–∏–≥–∞—Ü–∏–æ–Ω–Ω–∞—è —Ç–∞–±–ª–∏—Ü–∞ 27‚Üí28 —Å—Ö–µ–º

---

### 2026-02-11 ‚Äî –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ GSheet + –º–∏–≥—Ä–∞—Ü–∏—è –º–∏–Ω/–º–∞–∫—Å –∏–∑ storeBalanceLevels + –æ—á–∏—Å—Ç–∫–∞

**1. –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ Google –¢–∞–±–ª–∏—Ü—ã**
- –ó–∞–≥–æ–ª–æ–≤–∫–∏ –ø–æ–¥—Ä–∞–∑–¥–µ–ª–µ–Ω–∏–π: merge_cells –∏—Å–ø—Ä–∞–≤–ª–µ–Ω (A1-notation –≤–º–µ—Å—Ç–æ keyword args)
- –°—É–±–∑–∞–≥–æ–ª–æ–≤–∫–∏ –ú–ò–ù/–ú–ê–ö–°: —Ü–µ–Ω—Ç—Ä–∏—Ä–æ–≤–∞–Ω–∏–µ (`horizontalAlignment: "CENTER"`)
- –®–∏—Ä–∏–Ω–∞ –ú–ò–ù/–ú–ê–ö–°: 60px (–±—ã–ª–æ 75px)

**2. –û–¥–Ω–æ—Ä–∞–∑–æ–≤–∞—è –º–∏–≥—Ä–∞—Ü–∏—è –º–∏–Ω/–º–∞–∫—Å –∏–∑ iiko**
- –ò–∑–≤–ª–µ—á–µ–Ω—ã `storeBalanceLevels` –∏–∑ `iiko_product.raw_json` ‚Üí 70 –∑–∞–ø–∏—Å–µ–π (product√ódept)
- –ú–∞–ø–ø–∏–Ω–≥: `store.parent_id ‚Üí dept_id`, –∞–≥—Ä–µ–≥–∞—Ü–∏—è `MAX(min, max)` –ø–æ —Å–∫–ª–∞–¥–∞–º
- –î–∞–Ω–Ω—ã–µ –∑–∞–ø–∏—Å–∞–Ω—ã –≤ GSheet ‚Üí —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞–Ω—ã –≤ `min_stock_level` (70 –∑–∞–ø–∏—Å–µ–π)

**3. –û—á–∏—Å—Ç–∫–∞ –æ–¥–Ω–æ—Ä–∞–∑–æ–≤–æ–≥–æ –∫–æ–¥–∞**
- –£–¥–∞–ª—ë–Ω –ø–∞—Ä–∞–º–µ—Ç—Ä `db_levels` –∏–∑ `sync_products_to_sheet()` (–æ–¥–Ω–æ—Ä–∞–∑–æ–≤—ã–π pre-fill –≤—ã–ø–æ–ª–Ω–µ–Ω)
- –£–¥–∞–ª—ë–Ω –±–ª–æ–∫ –∏–∑–≤–ª–µ—á–µ–Ω–∏—è storeBalanceLevels –∏–∑ `sync_nomenclature_to_gsheet()`
- –£–¥–∞–ª—ë–Ω –∏–º–ø–æ—Ä—Ç `Store` –∏–∑ `sync_min_stock.py`
- –ò—Å—Ç–æ—á–Ω–∏–∫ –º–∏–Ω/–º–∞–∫—Å —Ç–µ–ø–µ—Ä—å: —Ç–æ–ª—å–∫–æ —Ä—É—á–Ω–æ–π –≤–≤–æ–¥ –≤ GSheet –∏–ª–∏ —á–µ—Ä–µ–∑ Telegram-–±–æ—Ç

---

### 2026-02-11 ‚Äî Retry-–ª–æ–≥–∏–∫–∞ –¥–ª—è iiko API + ProductGroup + GSheet —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ + –≥—Ä—É–ø–ø–∏—Ä–æ–≤–∫–∞ –ø–æ –¥–µ—Ä–µ–≤—É

**1. Retry-–ª–æ–≥–∏–∫–∞ –¥–ª—è iiko API GET-–∑–∞–ø—Ä–æ—Å–æ–≤**

–ü—Ä–æ–±–ª–µ–º–∞: Store sync –≤—ã–ø–∞–¥–∞–ª —Å `Server disconnected without sending a response`.
–†–µ—à–µ–Ω–∏–µ: `_get_with_retry()` ‚Äî 3 –ø–æ–ø—ã—Ç–∫–∏, backoff 1‚Üí3‚Üí7 —Å–µ–∫. POST –±–µ–∑ retry.
–ò–∑–º–µ–Ω–µ–Ω–æ: `adapters/iiko_api.py` ‚Äî –≤—Å–µ 11 GET fetch-—Ñ—É–Ω–∫—Ü–∏–π.

**2. –ù–æ–º–µ–Ω–∫–ª–∞—Ç—É—Ä–Ω—ã–µ –≥—Ä—É–ø–ø—ã (ProductGroup)**

–ü—Ä–æ–±–ª–µ–º–∞: `sync_product_groups` —É–ø–æ–º–∏–Ω–∞–ª–∞—Å—å, –Ω–æ –Ω–µ —Å—É—â–µ—Å—Ç–≤–æ–≤–∞–ª–∞.
–†–µ—à–µ–Ω–∏–µ: –ü–æ–ª–Ω–æ—Ü–µ–Ω–Ω–∞—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è –Ω–æ–º–µ–Ω–∫–ª–∞—Ç—É—Ä–Ω—ã—Ö –≥—Ä—É–ø–ø.
–ò–∑–º–µ–Ω–µ–Ω–æ: `db/models.py` (ProductGroup), `adapters/iiko_api.py` (fetch_product_groups), `use_cases/sync.py` (sync_product_groups), `bot/handlers.py`.

**3. –§–∏–ª—å—Ç—Ä–∞—Ü–∏—è —Ç–æ–≤–∞—Ä–æ–≤ –ø–æ –¥–µ—Ä–µ–≤—É –≥—Ä—É–ø–ø –∏–∑ –ë–î**

–ü—Ä–æ–±–ª–µ–º–∞: –í GSheet –≤—ã–≥—Ä—É–∂–∞–ª–∏—Å—å –≤—Å–µ —Ç–æ–≤–∞—Ä—ã (GOODS), –∞ –Ω—É–∂–Ω–æ —Ç–æ–ª—å–∫–æ –∏–∑ –ø–∞–ø–∫–∏ ¬´–¢–æ–≤–∞—Ä—ã¬ª.
–†–µ—à–µ–Ω–∏–µ: –¢–∞–±–ª–∏—Ü–∞ `gsheet_export_group` + BFS-–æ–±—Ö–æ–¥ –¥–µ—Ä–µ–≤–∞ `iiko_product_group`.
–ò–∑–º–µ–Ω–µ–Ω–æ: `db/models.py` (GSheetExportGroup), `use_cases/sync_min_stock.py`.

**4. Google Sheets ‚Äî –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Å–∫—Ä—ã—Ç–∏—è —Å—Ç—Ä–æ–∫/—Å—Ç–æ–ª–±—Ü–æ–≤ + —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ**

–ü—Ä–æ–±–ª–µ–º–∞: Row 1 –∏ column B –Ω–µ —Å–∫—Ä—ã–≤–∞–ª–∏—Å—å.
–†–µ—à–µ–Ω–∏–µ: –†–∞–∑–¥–µ–ª–µ–Ω–∏–µ batch_update, SOLID_MEDIUM –≥—Ä–∞–Ω–∏—Ü—ã, 75px‚Üí60px.
–ò–∑–º–µ–Ω–µ–Ω–æ: `adapters/google_sheets.py`.

**5. –†–µ–æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏—è –∫–Ω–æ–ø–æ–∫ –±–æ—Ç–∞ + –∞—É–¥–∏—Ç**

–£–¥–∞–ª–µ–Ω—ã —Ç–µ—Å—Ç–æ–≤—ã–µ —Ñ–∞–π–ª—ã. –ü—Ä–æ–≤–µ—Ä–µ–Ω–æ: 0 stale-—Å—Å—ã–ª–æ–∫, 0 syntax errors.

---

### 2026-02-11 ‚Äî –ü–µ—Ä–µ–ø–∏—Å–∞–Ω–∞ —Å–∏—Å—Ç–µ–º–∞ –º–∏–Ω–∏–º–∞–ª—å–Ω—ã—Ö/–º–∞–∫—Å–∏–º–∞–ª—å–Ω—ã—Ö –æ—Å—Ç–∞—Ç–∫–æ–≤ (Google –¢–∞–±–ª–∏—Ü–∞)

**–ó–∞–¥–∞—á–∞:** –ü–µ—Ä–µ–ø–∏—Å–∞—Ç—å —Å–∏—Å—Ç–µ–º—É –º–∏–Ω/–º–∞–∫—Å –æ—Å—Ç–∞—Ç–∫–æ–≤. –ò—Å—Ç–æ—á–Ω–∏–∫ –∏—Å—Ç–∏–Ω—ã ‚Äî Google –¢–∞–±–ª–∏—Ü–∞ —Å–æ —Å—Ç–æ–ª–±—Ü–∞–º–∏ –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –ø–æ–¥—Ä–∞–∑–¥–µ–ª–µ–Ω–∏—è.

**–ù–æ–≤–∞—è –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞:**
- Google –¢–∞–±–ª–∏—Ü–∞ ‚Äî –µ–¥–∏–Ω—ã–π –∏—Å—Ç–æ—á–Ω–∏–∫ –º–∏–Ω/–º–∞–∫—Å —É—Ä–æ–≤–Ω–µ–π
- –§–æ—Ä–º–∞—Ç: —Å—Ç—Ä–æ–∫–∞ 1 = dept UUID (–º–µ—Ç–∞), —Å—Ç—Ä–æ–∫–∞ 2 = –∑–∞–≥–æ–ª–æ–≤–∫–∏, —Å—Ç—Ä–æ–∫–∞ 3+ = —Ç–æ–≤–∞—Ä—ã
- –ö–∞–∂–¥—ã–π department = 2 —Å—Ç–æ–ª–±—Ü–∞ (–º–∏–Ω, –º–∞–∫—Å)
- –ë–î (min_stock_level) = –∑–µ—Ä–∫–∞–ª–æ Google –¢–∞–±–ª–∏—Ü—ã

**–£–¥–∞–ª–µ–Ω–æ:** `update_product()` –∏–∑ iiko_api.py, `check_tomato.py`, `test_iiko_update.py`, –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç—å –æ—Ç storeBalanceLevels.

**–ò–∑–º–µ–Ω–µ–Ω–æ:** `adapters/google_sheets.py`, `use_cases/sync_min_stock.py`, `use_cases/edit_min_stock.py`, `use_cases/check_min_stock.py`, `bot/handlers.py`, `bot/min_stock_handlers.py`, `config.py`.

---

### 2026-02-10 ‚Äî –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –º–∏–Ω–∏–º–∞–ª—å–Ω—ã—Ö –æ—Å—Ç–∞—Ç–∫–æ–≤ —á–µ—Ä–µ–∑ –±–æ—Ç–∞

**–§–ª–æ—É:** –û—Ç—á—ë—Ç—ã ‚Üí ‚úèÔ∏è –ò–∑–º–µ–Ω–∏—Ç—å ‚Üí –ø–æ–∏—Å–∫ —Ç–æ–≤–∞—Ä–∞ ‚Üí –≤—ã–±–æ—Ä ‚Üí –≤—ã–±–æ—Ä —Å–∫–ª–∞–¥–∞ ‚Üí –≤–≤–æ–¥ –Ω–æ–≤–æ–≥–æ –º–∏–Ω ‚Üí iiko API + –ë–î.

**–ù–æ–≤—ã–µ —Ñ–∞–π–ª—ã:** `use_cases/edit_min_stock.py`, `bot/min_stock_handlers.py`.
**–ò–∑–º–µ–Ω–µ–Ω–æ:** `adapters/iiko_api.py` (update_product), `bot/handlers.py`, `main.py`.

---

### 2026-02-10 ‚Äî –ü—Ä–æ–≤–µ—Ä–∫–∞ –º–∏–Ω–∏–º–∞–ª—å–Ω—ã—Ö –æ—Å—Ç–∞—Ç–∫–æ–≤ –ø–æ –ø–æ–¥—Ä–∞–∑–¥–µ–ª–µ–Ω–∏—è–º

**–ó–∞–¥–∞—á–∞:** –°–æ–æ–±—â–µ–Ω–∏–µ –æ —Ç–æ–≤–∞—Ä–∞—Ö –Ω–∏–∂–µ –º–∏–Ω. –æ—Å—Ç–∞—Ç–∫–æ–≤ –¥–ª—è —Ä–µ—Å—Ç–æ—Ä–∞–Ω–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è.

**–†–µ—à–µ–Ω–∏–µ (v2):** storeBalanceLevels –∏–∑ raw_json, —Å—É–º–º–∏—Ä–æ–≤–∞–Ω–∏–µ –ø–æ –≤—Å–µ–º —Å–∫–ª–∞–¥–∞–º dept, MAX(min) –ø—Ä–∏ –¥–µ–¥—É–ø–ª–∏–∫–∞—Ü–∏–∏.

**–ù–æ–≤—ã–π —Ñ–∞–π–ª:** `use_cases/check_min_stock.py`.
**–ò–∑–º–µ–Ω–µ–Ω–æ:** `bot/handlers.py` (btn_check_min_stock).

---

### 2026-02-10 ‚Äî –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ: –º–∏–Ω. –æ—Å—Ç–∞—Ç–∫–∏ –Ω–µ –Ω–∞—Ö–æ–¥–∏–ª–∏—Å—å –¥–ª—è –Ω–æ–≤–æ–≥–æ —Ä–µ—Å—Ç–æ—Ä–∞–Ω–∞

**–ü—Ä–æ–±–ª–µ–º–∞:** `btn_check_min_stock` –Ω–µ –≤—ã–∑—ã–≤–∞–ª `sync_products()` ‚Äî storeBalanceLevels –≤ raw_json —É—Å—Ç–∞—Ä–µ–≤—à–∏–µ.
**–†–µ—à–µ–Ω–∏–µ:** –î–æ–±–∞–≤–ª–µ–Ω `sync_products()` –ø–µ—Ä–µ–¥ `sync_stock_balances()`.

---

### 2026-02-10 ‚Äî –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è –æ—Å—Ç–∞—Ç–∫–æ–≤ –ø–æ —Å–∫–ª–∞–¥–∞–º (sync_stock_balances)

**–ü–∞—Ç—Ç–µ—Ä–Ω:** Full-replace (DELETE + batch INSERT) –≤ –æ–¥–Ω–æ–π —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏.
**–ù–æ–≤—ã–π —Ñ–∞–π–ª:** `use_cases/sync_stock_balances.py`.
**–ò–∑–º–µ–Ω–µ–Ω–æ:** `adapters/iiko_api.py` (fetch_stock_balances), `db/models.py` (StockBalance).

---

### 2026-02-09 ‚Äî –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Ç–æ—á–Ω–æ—Å—Ç–∏ sync_stock_balances (timestamp)

**–ü—Ä–æ–±–ª–µ–º–∞:** timestamp –±–µ–∑ –≤—Ä–µ–º–µ–Ω–∏ ‚Üí iiko –æ—Ç–¥–∞–≤–∞–ª –æ—Å—Ç–∞—Ç–∫–∏ –Ω–∞ –Ω–∞—á–∞–ª–æ –¥–Ω—è.
**–†–µ—à–µ–Ω–∏–µ:** `datetime.now().strftime("%Y-%m-%dT%H:%M:%S")` –≤–º–µ—Å—Ç–æ `date.today().isoformat()`.
**–ò–∑–º–µ–Ω–µ–Ω–æ:** `adapters/iiko_api.py`, `use_cases/sync_stock_balances.py`.

---

### 2026-02-09 ‚Äî –ü–æ–ª–Ω–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –≤—Å–µ—Ö –¥–µ–π—Å—Ç–≤–∏–π

**–ü—Ä–æ–±–ª–µ–º–∞:** 94% —Ö—ç–Ω–¥–ª–µ—Ä–æ–≤ (62 –∏–∑ 68) –Ω–µ –∏–º–µ–ª–∏ entry-–ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è.
**–†–µ—à–µ–Ω–∏–µ:** –ï–¥–∏–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç `[module] –¥–µ–π—Å—Ç–≤–∏–µ tg:USER_ID, params`.
**–ò–∑–º–µ–Ω–µ–Ω–æ:** `handlers.py` (+25 –ª–æ–≥–æ–≤), `writeoff_handlers.py` (+23), `admin_handlers.py` (+10).

---

### 2026-02-09 ‚Äî –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è —Å–∫–æ—Ä–æ—Å—Ç–∏ —Å–æ–∑–¥–∞–Ω–∏—è –∞–∫—Ç–∞ —Å–ø–∏—Å–∞–Ω–∏—è

**–†–µ—à–µ–Ω–∏–µ:** asyncio.gather –¥–ª—è start_writeoff, batch-resolve –µ–¥–∏–Ω–∏—Ü, pre-warm admin_ids.
**–ò–∑–º–µ–Ω–µ–Ω–æ:** `writeoff.py`, `writeoff_handlers.py`.

---

### 2026-02-09 ‚Äî –ö–æ–º–ø–ª–µ–∫—Å–Ω–∞—è –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏

**–û–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏:** user_context 1 JOIN (‚àí800–º—Å), btn_check_min_stock asyncio.gather (‚àí3-5 —Å–µ–∫), check_min_stock asyncio.gather (‚àí400–º—Å), sync_stock_balances –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω—ã–π API+DB (‚àí300-500–º—Å).

---

### 2026-02-09 ‚Äî –§–æ–Ω–æ–≤–∞—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è –ø—Ä–∏ –æ—Ç–∫—Ä—ã—Ç–∏–∏ ¬´–î–æ–∫—É–º–µ–Ω—Ç—ã¬ª

**–†–µ—à–µ–Ω–∏–µ:** `asyncio.create_task` + `asyncio.gather(sync_products, sync_all_entities)` ‚Äî –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –∂–¥—ë—Ç.
**–ò–∑–º–µ–Ω–µ–Ω–æ:** `handlers.py` (btn_documents_menu, _bg_sync_for_documents).

---

### 2026-02-09 ‚Äî –ê–≤—Ç–æ-–≤—ã–±–æ—Ä —Å–∫–ª–∞–¥–∞ –ø–æ –¥–æ–ª–∂–Ω–æ—Å—Ç–∏ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –∞–∫—Ç–∞ —Å–ø–∏—Å–∞–Ω–∏—è

**–õ–æ–≥–∏–∫–∞:** –ë–æ—Ç-–∞–¥–º–∏–Ω ‚Üí —Ä—É—á–Ω–æ–π, –ë–∞—Ä ‚Üí –∞–≤—Ç–æ-–±–∞—Ä, –ö—É—Ö–Ω—è ‚Üí –∞–≤—Ç–æ-–∫—É—Ö–Ω—è, –ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ ‚Üí —Ä—É—á–Ω–æ–π.
**–ò–∑–º–µ–Ω–µ–Ω–æ:** `user_context.py` (role_name), `auth.py`, `writeoff.py`, `writeoff_handlers.py`.

---

### 2026-02-09 ‚Äî –ê—É–¥–∏—Ç –∏ —á–∏—Å—Ç–∫–∞ –∫–æ–¥–æ–≤–æ–π –±–∞–∑—ã

–£–¥–∞–ª–µ–Ω—ã: `f.json`, `FinTablo-v1-swagger (1).yaml`, `__pycache__/`.
–û—á–∏—â–µ–Ω—ã –Ω–µ–∏—Å–ø–æ–ª—å–∑—É–µ–º—ã–µ –∏–º–ø–æ—Ä—Ç—ã (9 —Ñ–∞–π–ª–æ–≤).
–ò—Å–ø—Ä–∞–≤–ª–µ–Ω—ã: writeoff_handlers.py _sending_lock, iiko_auth.py unreachable raise.

---

### 2026-02-08 ‚Äî Mirror-sync (–∑–µ—Ä–∫–∞–ª—å–Ω–∞—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è)

**–ü—Ä–æ–±–ª–µ–º–∞:** –£–¥–∞–ª—ë–Ω–Ω—ã–µ –≤ iiko/FinTablo –æ–±—ä–µ–∫—Ç—ã –æ—Å—Ç–∞–≤–∞–ª–∏—Å—å –≤ –ë–î.
**–†–µ—à–µ–Ω–∏–µ:** `_mirror_delete()` –ø–æ—Å–ª–µ –∫–∞–∂–¥–æ–≥–æ UPSERT. –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å: 0 –∑–∞–ø–∏—Å–µ–π ‚Üí skip.
**–ò–∑–º–µ–Ω–µ–Ω–æ:** `sync.py`, `sync_fintablo.py`. –ó–∞—Ç—Ä–æ–Ω—É—Ç—ã –≤—Å–µ 22 —Ç–∞–±–ª–∏—Ü—ã.

---

### 2026-02-08 ‚Äî –†–µ—Å—Ç—Ä—É–∫—Ç—É—Ä–∏–∑–∞—Ü–∏—è –º–µ–Ω—é –±–æ—Ç–∞

–ì–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é: üè† –°–º–µ–Ω–∏—Ç—å —Ä–µ—Å—Ç–æ—Ä–∞–Ω | üìÇ –ö–æ–º–∞–Ω–¥—ã | üìä –û—Ç—á—ë—Ç—ã | üìÑ –î–æ–∫—É–º–µ–Ω—Ç—ã.
**–ò–∑–º–µ–Ω–µ–Ω–æ:** `handlers.py`.

---

### 2026-02-08 ‚Äî In-memory –∫–µ—à –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (UserContext)

**–ü—Ä–æ–±–ª–µ–º–∞:** +400–º—Å –Ω–∞ –∫–∞–∂–¥—ã–π –∑–∞–ø—Ä–æ—Å department_id.
**–†–µ—à–µ–Ω–∏–µ:** dict –≤ RAM, –ª–µ–Ω–∏–≤–∞—è –∑–∞–≥—Ä—É–∑–∫–∞, –∏–Ω–≤–∞–ª–∏–¥–∞—Ü–∏—è –ø—Ä–∏ —Å–º–µ–Ω–µ —Ä–µ—Å—Ç–æ—Ä–∞–Ω–∞.
**–ù–æ–≤—ã–π —Ñ–∞–π–ª:** `use_cases/user_context.py`.
**–ò–∑–º–µ–Ω–µ–Ω–æ:** `handlers.py`, `auth.py`.
