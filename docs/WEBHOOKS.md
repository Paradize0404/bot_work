# üîî –í–µ–±—Ö—É–∫–∏ iikoCloud –∏ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è

> **–ó–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏:** PROJECT_MAP.md (–ø—Ä–æ—á–∏—Ç–∞–Ω).  
> –ï—Å–ª–∏ –∑–∞–¥–µ–≤–∞–µ—à—å –ë–î ‚Üí –∑–∞–≥—Ä—É–∑–∏ —Å–µ–∫—Ü–∏–∏ `stock_alert_message`, `stoplist_*`, `active_stoplist` –∏–∑ DATABASE.md.  
> –ï—Å–ª–∏ –Ω–æ–≤—ã–π handler ‚Üí –∑–∞–≥—Ä—É–∑–∏ UX_PATTERNS.md.

---

## –ö–æ–Ω—Ç—Ä–∞–∫—Ç—ã –¥–æ–º–µ–Ω–∞

- **W1:** –í–µ–±—Ö—É–∫ –≤—Å–µ–≥–¥–∞ debounce (60 —Å–µ–∫ —Å—Ç–æ–ø-–ª–∏—Å—Ç, –∞–Ω—Ç–∏—Å–ø–∞–º –æ—Å—Ç–∞—Ç–∫–∏). –ü–µ—Ä–µ—Å–º–æ—Ç—Ä–µ—Ç—å –∫–æ–≥–¥–∞: real-time —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è.
- **W2:** UX –≤—Å–µ–≥–¥–∞ delete ‚Üí send ‚Üí pin (–Ω–µ edit). –ü—Ä–∏—á–∏–Ω–∞: —Å–≤–µ–∂–µ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –≤—Å–ø–ª—ã–≤–∞–µ—Ç –Ω–∞–≤–µ—Ä—Ö –≤ —á–∞—Ç–µ.
- **W3:** –ü–æ–ª—É—á–∞—Ç–µ–ª–∏ –∏–∑ GSheet —Ä–æ–ª–µ–π. –ù–µ—Ç –æ—Ç–º–µ—á–µ–Ω–Ω—ã—Ö ‚Üí –≤—Å–µ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω–Ω—ã–µ (bootstrap).
- **W4:** –ü–æ–∫–æ–º–ø–æ–Ω–µ–Ω—Ç–Ω–æ–µ —Å—Ä–∞–≤–Ω–µ–Ω–∏–µ –æ—Å—Ç–∞—Ç–∫–æ–≤ ‚Äî –∫–∞–∂–¥–∞—è –ø–æ–∑–∏—Ü–∏—è –ø—Ä–æ–≤–µ—Ä—è–µ—Ç—Å—è –æ—Ç–¥–µ–ª—å–Ω–æ (–Ω–µ —Å—É–º–º–∞—Ä–Ω–æ–µ).

---

## –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏

```
iikoCloud POST /iiko-webhook
  ‚îú‚îÄ StopListUpdate ‚Üí debounce 60 —Å–µ–∫ ‚Üí fetch ‚Üí diff ‚Üí delete old msg ‚Üí send new ‚Üí pin
  ‚îÇ   ‚îî‚îÄ –ü–æ–ª—É—á–∞—Ç–µ–ª–∏: —Ä–æ–ª—å ¬´üö´ –°—Ç–æ–ø-–ª–∏—Å—Ç¬ª (fallback ‚Üí –≤—Å–µ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω–Ω—ã–µ)
  ‚îÇ   ‚îî‚îÄ Debounce: —Å–µ—Ä–∏—è –≤–µ–±—Ö—É–∫–æ–≤ (10 –ø–æ–∑–∏—Ü–∏–π = 10 –≤–µ–±—Ö—É–∫–æ–≤) ‚Üí 60 —Å–µ–∫ —Ç–∏—à–∏–Ω—ã ‚Üí –æ–¥–∏–Ω flush
  ‚îÇ
  ‚îî‚îÄ DeliveryOrderUpdate / TableOrderUpdate (status=Closed)
      ‚Üí sync –æ—Å—Ç–∞—Ç–∫–æ–≤ –∏–∑ iiko REST API
      ‚Üí –ø–æ–∫–æ–º–ø–æ–Ω–µ–Ω—Ç–Ω–æ–µ —Å—Ä–∞–≤–Ω–µ–Ω–∏–µ: –∫–∞–∂–¥–∞—è –ø–æ–∑–∏—Ü–∏—è –Ω–∏–∂–µ –º–∏–Ω–∏–º—É–º–∞
      ‚Üí —Ç—Ä–∏–≥–≥–µ—Ä –æ—Ç–ø—Ä–∞–≤–∫–∏ –µ—Å–ª–∏ —Ö–æ—Ç—è –±—ã –æ–¥–Ω–æ –∏–∑:
          ‚Ä¢ –õ—é–±–∞—è –ø–æ–∑–∏—Ü–∏—è ‚â• 3% –∏–∑–º–µ–Ω–µ–Ω–∏–µ (STOCK_CHANGE_THRESHOLD_PCT)
          ‚Ä¢ –ù–æ–≤—ã–µ –ø–æ–∑–∏—Ü–∏–∏ –Ω–∏–∂–µ –º–∏–Ω–∏–º—É–º–∞
          ‚Ä¢ –ü–æ–∑–∏—Ü–∏–∏ –∏—Å—á–µ–∑–ª–∏ (—Å—Ç–∞–ª–∏ –≤—ã—à–µ –º–∏–Ω–∏–º—É–º–∞)
          ‚Ä¢ –ü—Ä–æ—à–ª–æ ‚â• 30 –º–∏–Ω —Å –ø–æ—Å–ª–µ–¥–Ω–µ–π –æ—Ç–ø—Ä–∞–≤–∫–∏ –ò –µ—Å—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è
      ‚Üí delete old msg ‚Üí send new ‚Üí pin
      ‚îî‚îÄ –ü–æ–ª—É—á–∞—Ç–µ–ª–∏: —Ä–æ–ª—å ¬´üì¶ –û—Å—Ç–∞—Ç–∫–∏¬ª (fallback ‚Üí –≤—Å–µ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω–Ω—ã–µ)
```

---

## –°—Ç–æ–ø-–ª–∏—Å—Ç: —Ñ–æ—Ä–º–∞—Ç —Å–æ–æ–±—â–µ–Ω–∏—è

```
–ù–æ–≤—ã–µ –±–ª—é–¥–∞ –≤ —Å—Ç–æ–ø-–ª–∏—Å—Ç–µ üö´
‚ñ´Ô∏è –ë–ª—é –º–∞–Ω–∫–∏ ‚Äî —Å—Ç–æ–ø
‚ñ´Ô∏è –¢–∞—Ä—Ç–∞—Ä –∏–∑ –≥–æ–≤—è–¥–∏–Ω—ã ‚Äî —Å—Ç–æ–ø

–£–¥–∞–ª–µ–Ω—ã –∏–∑ —Å—Ç–æ–ø-–ª–∏—Å—Ç–∞ ‚úÖ
‚ñ´Ô∏è ‚Äî

–û—Å—Ç–∞–ª–∏—Å—å –≤ —Å—Ç–æ–ø-–ª–∏—Å—Ç–µ
‚ñ´Ô∏è –ö–æ–∫–æ—Å–æ–≤–æ–µ –º–æ–ª–æ–∫–æ ‚Äî —Å—Ç–æ–ø

#—Å—Ç–æ–ø–ª–∏—Å—Ç
```

- –ü–æ–∑–∏—Ü–∏–∏ –æ—Ç—Å–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω—ã –ø–æ –∞–ª—Ñ–∞–≤–∏—Ç—É –≤–Ω—É—Ç—Ä–∏ –±–ª–æ–∫–∞
- –ü—Ä–∏ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ / —Å–º–µ–Ω–µ –ø–æ–¥—Ä–∞–∑–¥–µ–ª–µ–Ω–∏—è ‚Äî –ø–æ–ª–Ω—ã–π —Å—Ç–æ–ø-–ª–∏—Å—Ç (–±–µ–∑ –¥–∏—Ñ–∞)

---

## –û—Å—Ç–∞—Ç–∫–∏: –ª–æ–≥–∏–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è

**–¢—Ä–∏–≥–≥–µ—Ä—ã –æ—Ç–ø—Ä–∞–≤–∫–∏** (—Ö–æ—Ç—è –±—ã –æ–¥–∏–Ω):
1. ‚úÖ –ü–µ—Ä–≤–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ—Å–ª–µ —Ä–µ—Å—Ç–∞—Ä—Ç–∞ (–Ω–µ—Ç –ø—Ä–µ–¥—ã–¥—É—â–µ–≥–æ —Å–Ω—ç–ø—à–æ—Ç–∞)
2. ‚úÖ –õ—é–±–∞—è –ø–æ–∑–∏—Ü–∏—è –∏–∑–º–µ–Ω–∏–ª–∞—Å—å ‚â• `STOCK_CHANGE_THRESHOLD_PCT` (–¥–µ—Ñ–æ–ª—Ç 3%)
3. ‚úÖ –ü–æ—è–≤–∏–ª–∏—Å—å –Ω–æ–≤—ã–µ –ø–æ–∑–∏—Ü–∏–∏ –Ω–∏–∂–µ –º–∏–Ω–∏–º—É–º–∞
4. ‚úÖ –ò—Å—á–µ–∑–ª–∏ –ø–æ–∑–∏—Ü–∏–∏ (—Å—Ç–∞–ª–∏ –≤—ã—à–µ –º–∏–Ω–∏–º—É–º–∞)
5. ‚úÖ –ü—Ä–æ—à–ª–æ ‚â• `STOCK_UPDATE_INTERVAL_MIN` (30 –º–∏–Ω) + –µ—Å—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è

**–ê–Ω—Ç–∏—Å–ø–∞–º (–ù–ï –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º):**
- ‚ùå –•–µ—à –Ω–µ –∏–∑–º–µ–Ω–∏–ª—Å—è
- ‚ùå –í—Å–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è < 3% –ò –ø—Ä–æ—à–ª–æ < 30 –º–∏–Ω

**UX:** Per-department: –∫–∞–∂–¥—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤–∏–¥–∏—Ç –æ—Å—Ç–∞—Ç–∫–∏ **—Å–≤–æ–µ–≥–æ** –ø–æ–¥—Ä–∞–∑–¥–µ–ª–µ–Ω–∏—è.

---

## –ú–∞–ø–ø–∏–Ω–≥ –ø–æ–¥—Ä–∞–∑–¥–µ–ª–µ–Ω–∏–π ‚Üí Cloud-–æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏–π

- iiko Server `department_id` ‚â† iikoCloud `organization_id` (—Ä–∞–∑–Ω—ã–µ —Å–∏—Å—Ç–µ–º—ã)
- –ú–∞–ø–ø–∏–Ω–≥ —Ö—Ä–∞–Ω–∏—Ç—Å—è –≤ GSheet ¬´–ù–∞—Å—Ç—Ä–æ–π–∫–∏¬ª (–ª–∏—Å—Ç —Å–æ–∑–¥–∞—ë—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏)
- –ö–æ–ª–æ–Ω–∫–∞ C ‚Äî –≤—ã–ø–∞–¥–∞—é—â–∏–π —Å–ø–∏—Å–æ–∫ Cloud-–æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏–π, UUID —á–µ—Ä–µ–∑ VLOOKUP
- –ö–µ—à: in-memory dict —Å TTL 5 –º–∏–Ω (`use_cases/cloud_org_mapping.py`)
- Fallback: env `IIKO_CLOUD_ORG_ID` ‚Üí env `ORG_ID` ‚Üí None
- –ö–Ω–æ–ø–∫–∞ ¬´üîó –ü—Ä–∏–≤—è–∑–∞—Ç—å –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏–∏¬ª ‚Äî —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è –≤ GSheet

---

## –ü–æ–¥–ø–∏—Å–∫–∏ –Ω–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è (—Ä–æ–ª–∏ –≤ GSheet)

| –†–æ–ª—å / –ü—Ä–∞–≤–æ | –°—Ç–æ–ª–±–µ—Ü GSheet | –ü–æ–ª—É—á–∞–µ—Ç |
|------|----------------|----------|
| üîß –°–∏—Å.–ê–¥–º–∏–Ω | ¬´üîß –°–∏—Å.–ê–¥–º–∏–Ω¬ª | –¢–æ–ª—å–∫–æ —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ –∞–ª–µ—Ä—Ç—ã ERROR/CRITICAL |
| ‚öôÔ∏è –ù–∞—Å—Ç—Ä–æ–π–∫–∏ | ¬´‚öôÔ∏è –ù–∞—Å—Ç—Ä–æ–π–∫–∏¬ª | –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è, –ø—Ä–∞–≤–∞, GSheet-–æ–ø–µ—Ä–∞—Ü–∏–∏ |
| üì¨ –ü–æ–ª—É—á–∞—Ç–µ–ª—å | ¬´üì¨ –ü–æ–ª—É—á–∞—Ç–µ–ª—å¬ª | –ó–∞—è–≤–∫–∏ –Ω–∞ —Ç–æ–≤–∞—Ä—ã |
| üì¶ –û—Å—Ç–∞—Ç–∫–∏ | ¬´üì¶ –û—Å—Ç–∞—Ç–∫–∏¬ª | Pinned –æ—Å—Ç–∞—Ç–∫–∏ –Ω–∏–∂–µ –º–∏–Ω–∏–º—É–º–∞ |
| üö´ –°—Ç–æ–ø-–ª–∏—Å—Ç | ¬´üö´ –°—Ç–æ–ø-–ª–∏—Å—Ç¬ª | Pinned —Å—Ç–æ–ø-–ª–∏—Å—Ç + –æ—Ç—á—ë—Ç 22:00 |
| üìë –ë—É—Ö–≥–∞–ª—Ç–µ—Ä | ¬´üìë –ë—É—Ö–≥–∞–ª—Ç–µ—Ä¬ª | OCR-—É—Å–ª—É–≥–∏ + –∑–∞–ø—Ä–æ—Å –º–∞–ø–ø–∏–Ω–≥–∞ |
| üìã –û—Ç—á—ë—Ç –¥–Ω—è | ¬´üìã –û—Ç—á—ë—Ç –¥–Ω—è¬ª | –ü–æ–ª—É—á–∞–µ—Ç –æ—Ç—á—ë—Ç —Å–º–µ–Ω—ã –æ—Ç —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞ |

–ï—Å–ª–∏ **–Ω–∏–∫—Ç–æ** –Ω–µ –æ—Ç–º–µ—á–µ–Ω ‚Üí —Ä–∞—Å—Å—ã–ª–∫–∞ **–≤—Å–µ–º** –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω–Ω—ã–º.

---

## –ú–æ–¥—É–ª–∏

| –ú–æ–¥—É–ª—å | –†–æ–ª—å | –ó–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ |
|--------|------|-------------|
| `use_cases/iiko_webhook_handler.py` | –û–±—Ä–∞–±–æ—Ç–∫–∞ –≤–µ–±—Ö—É–∫–æ–≤, –¥–µ–ª—å—Ç–∞-—Å—Ä–∞–≤–Ω–µ–Ω–∏–µ | `cloud_org_mapping`, `sync_stock_balances`, `check_min_stock` |
| `use_cases/pinned_stock_message.py` | Pinned –æ—Å—Ç–∞—Ç–∫–∏: delete ‚Üí send ‚Üí pin | `check_min_stock`, `_helpers.compute_hash` |
| `use_cases/pinned_stoplist_message.py` | Pinned —Å—Ç–æ–ø-–ª–∏—Å—Ç: delete ‚Üí send ‚Üí pin | `stoplist`, `_helpers.compute_hash` |
| `use_cases/stoplist.py` | Fetch + diff —Å—Ç–æ–ø-–ª–∏—Å—Ç–∞ | `iiko_cloud_api`, `active_stoplist` —Ç–∞–±–ª–∏—Ü–∞ |
| `use_cases/stoplist_report.py` | –ï–∂–µ–≤–µ—á–µ—Ä–Ω–∏–π –æ—Ç—á—ë—Ç 22:00 | `stoplist_history`, `permissions` |
| `use_cases/cloud_org_mapping.py` | dept_id ‚Üí cloud_org_id, TTL 5 –º–∏–Ω | `google_sheets`, `iiko_cloud_api` |
| `adapters/iiko_cloud_api.py` | –¢–æ–∫–µ–Ω, register_webhook, fetch_stop_lists | `iiko_access_tokens` —Ç–∞–±–ª–∏—Ü–∞ |

## –¢–∞–±–ª–∏—Ü—ã (–∫–æ–º–ø–∞–∫—Ç–Ω–æ)

| –¢–∞–±–ª–∏—Ü–∞ | –ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ | –ö–ª—é—á |
|---------|-----------|------|
| `stock_alert_message` | Pinned –æ—Å—Ç–∞—Ç–∫–∏ (chat_id, msg_id, hash) | chat_id |
| `stoplist_message` | Pinned —Å—Ç–æ–ø-–ª–∏—Å—Ç | chat_id |
| `active_stoplist` | –ó–µ—Ä–∫–∞–ª–æ iikoCloud —Å—Ç–æ–ø-–ª–∏—Å—Ç–∞ | product_id |
| `stoplist_history` | –í—Ö–æ–¥/–≤—ã—Ö–æ–¥ –∏–∑ —Å—Ç–æ–ø–∞ | product_id + started_at |
| `iiko_access_tokens` | Cloud-—Ç–æ–∫–µ–Ω—ã (–≤–Ω–µ—à–Ω–∏–π cron) | org_id |

## –ß–∞—Å—Ç—ã–µ –æ—à–∏–±–∫–∏ –≤ —ç—Ç–æ–º –¥–æ–º–µ–Ω–µ

1. **–°—Ç–æ–ø-–ª–∏—Å—Ç –ø—É—Å—Ç:** `ORG_ID` ‚â† `IIKO_CLOUD_ORG_ID` ‚Üí fallback –≤ config.py
2. **–í–µ–±—Ö—É–∫ –Ω–µ –ø—Ä–∏—Ö–æ–¥–∏—Ç:** –ü—Ä–æ–≤–µ—Ä—å —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—é —á–µ—Ä–µ–∑ –∫–Ω–æ–ø–∫—É ¬´‚ÑπÔ∏è –°—Ç–∞—Ç—É—Å –≤–µ–±—Ö—É–∫–∞¬ª
3. **Edit –≤–º–µ—Å—Ç–æ delete+send:** –ù–∞—Ä—É—à–µ–Ω–∏–µ W2 ‚Äî —Å–æ–æ–±—â–µ–Ω–∏–µ –Ω–µ –≤—Å–ø–ª—ã–≤–∞–µ—Ç –Ω–∞–≤–µ—Ä—Ö
4. **–ì–ª–æ–±–∞–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –±–µ–∑ Lock:** –ì–æ–Ω–∫–∞ –¥–∞–Ω–Ω—ã—Ö –≤ webhook handler (—Å–º. K6 –≤ CHANGELOG 2026-02-22)
